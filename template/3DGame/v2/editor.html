<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>3D地图编辑器 v2</title>
	<link rel="stylesheet" href="modal/modal-base.css">
	<link rel="stylesheet" href="modal/components.css">
	<link rel="stylesheet" href="modal/gallery.css">
	<link rel="stylesheet" href="modal/item-editor.css">
	<link rel="stylesheet" href="modal/add-resource.css">
	<link rel="stylesheet" href="modal/settings.css">
	<style>
* {
	margin: 0;
	padding: 0;
	box-sizing: border-box;
	user-select: none;
}

body {
	background: #050505;
	font-family: system-ui, sans-serif;
	color: #fff;
	height: 100vh;
	overflow: hidden;
	display: flex;
	flex-direction: column;
}

.toolbar {
	height: 48px;
	background: #1a1a1a;
	border-bottom: 1px solid #333;
	display: flex;
	align-items: center;
	padding: 0 12px;
	gap: 8px;
	flex-shrink: 0;
}

.tool-group {
	display: flex;
	gap: 4px;
	padding: 0 8px;
	border-right: 1px solid #333;
}

.tool-group:last-child {
	border-right: none;
}

.tool-btn {
	width: 36px;
	height: 36px;
	background: transparent;
	border: 1px solid transparent;
	border-radius: 6px;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
	transition: all 0.15s;
}

.tool-btn:hover {
	background: #333;
}

.tool-btn.active {
	background: #166d3b;
	border-color: #1c8548;
}

.tool-btn svg {
	width: 20px;
	height: 20px;
	stroke: #aaa;
	fill: none;
	stroke-width: 1.5;
}

.tool-btn.active svg {
	stroke: #fff;
}

.tool-btn:disabled {
	opacity: 0.4;
	cursor: not-allowed;
}

.main-container {
	flex: 1;
	display: flex;
	min-height: 0;
	position: relative;
}

.panel-wrapper {
	display: flex;
	flex-direction: column;
}

.panel-resizer {
	position: absolute;
	z-index: 10;
}

.panel-resizer.horizontal {
	width: 4px;
	cursor: ew-resize;
	top: 0;
	bottom: 0;
}

.panel-resizer.vertical {
	height: 4px;
	cursor: ns-resize;
	left: 0;
	right: 0;
}

.panel-resizer:hover,
.panel-resizer.active {
	background: #166d3b;
}

.left-resizer {
	left: 200px;
}

.right-resizer {
	right: 240px;
}

.bottom-resizer {
	bottom: 160px;
}

.panel-toggle {
	width: 24px;
	height: 24px;
	background: transparent;
	border: none;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
	margin-left: auto;
}

.panel-toggle svg {
	width: 14px;
	height: 14px;
	stroke: #888;
	fill: none;
	stroke-width: 2;
	transition: transform 0.2s;
}

.panel-toggle:hover svg {
	stroke: #fff;
}

.panel-title {
	display: flex;
	align-items: center;
	padding: 12px;
	font-size: 13px;
	font-weight: 600;
	color: #888;
	text-transform: uppercase;
	letter-spacing: 0.5px;
	border-bottom: 1px solid #333;
}

.panel-title-text {
	flex: 1;
}

.left-panel {
	width: 200px;
	background: #111111;
	border-right: 1px solid #333;
	display: flex;
	flex-direction: column;
	flex-shrink: 0;
	transition: width 0.2s;
	overflow: hidden;
}

.left-panel.collapsed {
	width: 32px;
}

.left-panel.collapsed .layer-list,
.left-panel.collapsed .layer-buttons,
.left-panel.collapsed .panel-title-text {
	display: none;
}

.left-panel.collapsed .panel-title {
	writing-mode: vertical-rl;
	text-orientation: mixed;
	padding: 12px 8px;
	justify-content: flex-start;
}

.left-panel.collapsed .panel-toggle svg {
	transform: rotate(180deg);
}

.layer-list {
	flex: 1;
	overflow-y: auto;
	padding: 8px;
}

.layer-item {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 8px;
	border-radius: 6px;
	cursor: pointer;
	margin-bottom: 4px;
}

.layer-item:hover {
	background: #1a1a1a;
}

.layer-item.selected {
	background: #252525;
}

.layer-icon {
	width: 20px;
	height: 20px;
}

.layer-icon svg {
	width: 100%;
	height: 100%;
	stroke: #888;
	fill: none;
	stroke-width: 1.5;
}

.layer-name {
	flex: 1;
	font-size: 13px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

.layer-actions {
	display: flex;
	gap: 4px;
}

.layer-action-btn {
	width: 24px;
	height: 24px;
	background: transparent;
	border: none;
	border-radius: 4px;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
}

.layer-action-btn:hover {
	background: #444;
}

.layer-action-btn svg {
	width: 14px;
	height: 14px;
	stroke: #888;
	fill: none;
	stroke-width: 1.5;
}

.layer-action-btn.active svg {
	stroke: #166d3b;
}

.layer-buttons {
	padding: 8px;
	border-top: 1px solid #333;
	display: flex;
	gap: 4px;
}

.layer-add-btn {
	flex: 1;
	height: 32px;
	background: #333;
	border: none;
	border-radius: 6px;
	color: #aaa;
	font-size: 12px;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
	gap: 4px;
}

.layer-add-btn:hover {
	background: #444;
}

.layer-add-btn svg {
	width: 14px;
	height: 14px;
	stroke: currentColor;
	fill: none;
	stroke-width: 2;
}

.canvas-container {
	flex: 1;
	position: relative;
	overflow: hidden;
	background: #050505;
}

#editorCanvas {
	position: absolute;
	top: 0;
	left: 0;
}

.canvas-info {
	position: absolute;
	bottom: 10px;
	left: 10px;
	background: rgba(0,0,0,0.7);
	padding: 6px 12px;
	border-radius: 4px;
	font-size: 12px;
	color: #888;
}

.view-cube-wrapper {
	position: absolute;
	top: 10px;
	right: 10px;
	width: 100px;
	height: 120px;
	display: flex;
	flex-direction: column;
	align-items: center;
}

.view-cube {
	width: 80px;
	height: 80px;
	perspective: 200px;
	cursor: grab;
	display: flex;
	align-items: center;
	justify-content: center;
}

.view-cube:active {
	cursor: grabbing;
}

.view-cube-inner {
	width: 50px;
	height: 50px;
	position: relative;
	transform-style: preserve-3d;
	transition: transform 0.3s ease;
}

.view-cube-face {
	position: absolute;
	width: 50px;
	height: 50px;
	background: rgba(30, 30, 30, 0.9);
	border: 1px solid #444;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 10px;
	color: #888;
	backface-visibility: visible;
	cursor: pointer;
	transition: background 0.15s, color 0.15s;
}

.view-cube-face:hover {
	background: rgba(22, 109, 59, 0.9);
	color: #fff;
}

.view-cube-front {
	transform: translateZ(25px);
}

.view-cube-back {
	transform: rotateY(180deg) translateZ(25px);
}

.view-cube-left {
	transform: rotateY(-90deg) translateZ(25px);
}

.view-cube-right {
	transform: rotateY(90deg) translateZ(25px);
}

.view-cube-top {
	transform: rotateX(90deg) translateZ(25px);
}

.view-cube-bottom {
	transform: rotateX(-90deg) translateZ(25px);
}

.view-cube-edge {
	position: absolute;
	background: rgba(60, 60, 60, 0.8);
	cursor: pointer;
	transition: background 0.15s;
}

.view-cube-edge:hover {
	background: rgba(22, 109, 59, 0.9);
}

.view-cube-edge-front-top {
	width: 36px;
	height: 7px;
	transform: translate3d(-18px, -28.5px, 25px);
}

.view-cube-edge-front-bottom {
	width: 36px;
	height: 7px;
	transform: translate3d(-18px, 21.5px, 25px);
}

.view-cube-edge-front-left {
	width: 7px;
	height: 36px;
	transform: translate3d(-28.5px, -18px, 25px);
}

.view-cube-edge-front-right {
	width: 7px;
	height: 36px;
	transform: translate3d(21.5px, -18px, 25px);
}

.view-cube-edge-back-top {
	width: 36px;
	height: 7px;
	transform: translate3d(-18px, -28.5px, -25px);
}

.view-cube-edge-back-bottom {
	width: 36px;
	height: 7px;
	transform: translate3d(-18px, 21.5px, -25px);
}

.view-cube-edge-back-left {
	width: 7px;
	height: 36px;
	transform: translate3d(-28.5px, -18px, -25px);
}

.view-cube-edge-back-right {
	width: 7px;
	height: 36px;
	transform: translate3d(21.5px, -18px, -25px);
}

.view-cube-edge-top-left {
	width: 7px;
	height: 36px;
	transform: translate3d(-28.5px, -25px, -18px) rotateX(90deg);
}

.view-cube-edge-top-right {
	width: 7px;
	height: 36px;
	transform: translate3d(21.5px, -25px, -18px) rotateX(90deg);
}

.view-cube-edge-bottom-left {
	width: 7px;
	height: 36px;
	transform: translate3d(-28.5px, 25px, -18px) rotateX(90deg);
}

.view-cube-edge-bottom-right {
	width: 7px;
	height: 36px;
	transform: translate3d(21.5px, 25px, -18px) rotateX(90deg);
}

.view-cube-corner {
	position: absolute;
	width: 7px;
	height: 7px;
	background: rgba(80, 80, 80, 0.9);
	cursor: pointer;
	transition: background 0.15s;
}

.view-cube-corner:hover {
	background: rgba(22, 109, 59, 0.9);
}

.view-cube-corner-ftl {
	transform: translate3d(-28.5px, -28.5px, 25px);
}

.view-cube-corner-ftr {
	transform: translate3d(21.5px, -28.5px, 25px);
}

.view-cube-corner-fbl {
	transform: translate3d(-28.5px, 21.5px, 25px);
}

.view-cube-corner-fbr {
	transform: translate3d(21.5px, 21.5px, 25px);
}

.view-cube-corner-btl {
	transform: translate3d(-28.5px, -28.5px, -25px);
}

.view-cube-corner-btr {
	transform: translate3d(21.5px, -28.5px, -25px);
}

.view-cube-corner-bbl {
	transform: translate3d(-28.5px, 21.5px, -25px);
}

.view-cube-corner-bbr {
	transform: translate3d(21.5px, 21.5px, -25px);
}

.right-panel {
	width: 240px;
	background: #111111;
	border-left: 1px solid #333;
	display: flex;
	flex-direction: column;
	flex-shrink: 0;
	transition: width 0.2s;
	overflow: hidden;
}

.right-panel.collapsed {
	width: 32px;
}

.right-panel.collapsed .property-section,
.right-panel.collapsed .panel-title-text {
	display: none;
}

.right-panel.collapsed .panel-title {
	writing-mode: vertical-rl;
	text-orientation: mixed;
	padding: 12px 8px;
	justify-content: flex-start;
}

.right-panel.collapsed .panel-toggle svg {
	transform: rotate(180deg);
}

.property-section {
	padding: 12px;
	border-bottom: 1px solid #333;
}

.property-label {
	font-size: 11px;
	color: #666;
	margin-bottom: 6px;
}

.property-input {
	width: 100%;
	height: 32px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	padding: 0 10px;
	color: #fff;
	font-size: 13px;
}

.property-input:focus {
	outline: none;
	border-color: #166d3b;
}

.property-row {
	display: flex;
	gap: 8px;
	margin-bottom: 8px;
}

.property-row:last-child {
	margin-bottom: 0;
}

.property-col {
	flex: 1;
}

.bottom-panel {
	height: 160px;
	background: #111111;
	border-top: 1px solid #333;
	display: flex;
	flex-direction: column;
	flex-shrink: 0;
	transition: height 0.2s;
	overflow: hidden;
}

.bottom-panel.collapsed {
	height: 36px;
}

.bottom-panel.collapsed .resource-btns,
.bottom-panel.collapsed .resource-grid {
	display: none;
}

.bottom-panel.collapsed .panel-collapse-btn svg {
	transform: rotate(180deg);
}

.resource-tabs {
	display: flex;
	padding: 0 12px;
	border-bottom: 1px solid #333;
	align-items: center;
}

.resource-tabs-left {
	display: flex;
	flex: 1;
}

.resource-tabs-right {
	display: flex;
	align-items: center;
	gap: 4px;
}

.panel-collapse-btn {
	width: 28px;
	height: 28px;
	background: transparent;
	border: none;
	border-radius: 4px;
	color: #888;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
}

.panel-collapse-btn:hover {
	background: #333;
	color: #fff;
}

.panel-collapse-btn svg {
	width: 16px;
	height: 16px;
	stroke: currentColor;
	fill: none;
	stroke-width: 2;
	transition: transform 0.2s;
}

.resource-tab {
	padding: 10px 16px;
	font-size: 13px;
	color: #888;
	cursor: pointer;
	border-bottom: 2px solid transparent;
	margin-bottom: -1px;
}

.resource-tab:hover {
	color: #aaa;
}

.resource-tab.active {
	color: #fff;
	border-bottom-color: #166d3b;
}

.resource-btns {
	display: flex;
	gap: 8px;
	padding: 8px 12px 0;
}

.resource-btn {
	height: 28px;
	padding: 0 12px;
	background: #333;
	border: none;
	border-radius: 4px;
	color: #aaa;
	font-size: 12px;
	cursor: pointer;
}

.resource-btn:hover {
	background: #444;
	color: #fff;
}

.resource-grid {
	flex: 1;
	overflow-x: auto;
	overflow-y: hidden;
	padding: 12px;
	display: flex;
	gap: 8px;
}

.resource-item {
	width: 64px;
	height: 80px;
	background: #1a1a1a;
	border: 2px solid transparent;
	border-radius: 6px;
	cursor: pointer;
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	flex-shrink: 0;
}

.resource-item:hover {
	background: #333;
}

.resource-item.selected {
	border-color: #166d3b;
}

.resource-preview {
	width: 40px;
	height: 40px;
	display: flex;
	align-items: center;
	justify-content: center;
	margin-bottom: 4px;
}

.resource-name {
	font-size: 10px;
	color: #888;
	text-align: center;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
	width: 100%;
	padding: 0 4px;
}

.file-buttons {
	margin-left: auto;
	display: flex;
	gap: 8px;
}

.file-btn {
	height: 32px;
	padding: 0 12px;
	background: #333;
	border: none;
	border-radius: 6px;
	color: #aaa;
	font-size: 12px;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 6px;
}

.file-btn:hover {
	background: #444;
}

.file-btn.primary {
	background: #166d3b;
	color: #fff;
}

.file-btn.primary:hover {
	background: #1c8548;
}

.file-btn svg {
	width: 16px;
	height: 16px;
	stroke: currentColor;
	fill: none;
	stroke-width: 1.5;
}

.context-menu {
	position: fixed;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 6px;
	padding: 4px 0;
	min-width: 120px;
	z-index: 1000;
	display: none;
}

.context-menu.open {
	display: block;
}

.context-menu-item {
	padding: 8px 16px;
	font-size: 13px;
	color: #ccc;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 8px;
}

.context-menu-item:hover {
	background: #333;
}

.context-menu-item svg {
	width: 14px;
	height: 14px;
	stroke: currentColor;
	fill: none;
	stroke-width: 1.5;
}

.add-resource-modal {
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	background: rgba(0,0,0,0.7);
	display: none;
	align-items: center;
	justify-content: center;
	z-index: 2000;
}

.add-resource-modal.open {
	display: flex;
}

.add-resource-modal-box {
	width: 320px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 12px;
	padding: 20px;
}

.add-resource-modal-title {
	font-size: 16px;
	font-weight: 600;
	margin-bottom: 16px;
	color: #fff;
}

.add-resource-modal-row {
	margin-bottom: 12px;
}

.add-resource-modal-row label {
	display: block;
	font-size: 12px;
	color: #888;
	margin-bottom: 6px;
}

.add-resource-modal-row input[type="text"],
.add-resource-modal-row input[type="number"] {
	width: 100%;
	height: 36px;
	background: #252525;
	border: 1px solid #333;
	border-radius: 6px;
	padding: 0 12px;
	color: #fff;
	font-size: 13px;
}

.add-resource-modal-row input:focus {
	outline: none;
	border-color: #166d3b;
}

.color-picker-row {
	display: flex;
	align-items: center;
	gap: 12px;
}

.color-picker-row input[type="color"] {
	width: 48px;
	height: 36px;
	border: none;
	border-radius: 6px;
	cursor: pointer;
	background: transparent;
}

.color-picker-row .color-hex {
	flex: 1;
	height: 36px;
	background: #252525;
	border: 1px solid #333;
	border-radius: 6px;
	padding: 0 12px;
	color: #fff;
	font-size: 13px;
}

.add-resource-modal-btns {
	display: flex;
	gap: 8px;
	margin-top: 20px;
}

.btn-confirm {
	flex: 1;
	height: 32px;
	background: #166d3b;
	border: none;
	border-radius: 6px;
	color: #fff;
	font-size: 13px;
	cursor: pointer;
}

.btn-confirm:hover {
	background: #1c8548;
}

.btn-cancel {
	flex: 1;
	height: 32px;
	background: #444;
	border: none;
	border-radius: 6px;
	color: #fff;
	font-size: 13px;
	cursor: pointer;
}

.btn-cancel:hover {
	background: #555;
}

.terrain-edit-panel {
	display: none;
	padding: 12px;
	gap: 12px;
	flex-direction: column;
}

.terrain-edit-panel.active {
	display: flex;
}

.terrain-tools {
	display: flex;
	gap: 8px;
}

.terrain-tool-btn {
	width: 64px;
	height: 64px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 8px;
	cursor: pointer;
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	gap: 4px;
}

.terrain-tool-btn:hover {
	background: #2a2a2a;
	border-color: #444;
}

.terrain-tool-btn.active {
	background: #166d3b;
	border-color: #1c8548;
}

.terrain-tool-btn svg {
	width: 24px;
	height: 24px;
	stroke: #aaa;
	fill: none;
	stroke-width: 1.5;
}

.terrain-tool-btn.active svg {
	stroke: #fff;
}

.terrain-tool-btn span {
	font-size: 11px;
	color: #888;
}

.terrain-tool-btn.active span {
	color: #fff;
}

.terrain-value-row {
	display: flex;
	align-items: center;
	gap: 8px;
	font-size: 12px;
	color: #888;
}

.terrain-value-row input {
	width: 80px;
	height: 28px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	padding: 0 8px;
	color: #fff;
	font-size: 12px;
}

.terrain-value-row input:focus {
	outline: none;
	border-color: #166d3b;
}
	</style>
</head>
<script src="webgl/math.js"></script>
<script src="webgl/shaders.js"></script>
<script src="webgl/textures.js"></script>
<script src="webgl/model.js"></script>
<script src="webgl/renderer.js"></script>
<body>
	<div class="toolbar">
		<div class="tool-group" id="drawToolGroup">
			<button class="tool-btn active" data-tool="select" title="选择">
				<svg viewBox="0 0 24 24"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/></svg>
			</button>
			<button class="tool-btn" data-tool="rect" title="矩形">
				<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
			</button>
			<button class="tool-btn" data-tool="eraser" title="橡皮">
				<svg viewBox="0 0 24 24"><path d="M20 20H7L3 16c-.8-.8-.8-2 0-2.8L13.6 2.6c.8-.8 2-.8 2.8 0L21 7.2c.8.8.8 2 0 2.8L12 19"/></svg>
			</button>
		</div>
		<div class="tool-group">
			<button class="tool-btn" id="undoBtn" title="撤销" disabled>
				<svg viewBox="0 0 24 24"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
			</button>
			<button class="tool-btn" id="redoBtn" title="重做" disabled>
				<svg viewBox="0 0 24 24"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"/></svg>
			</button>
		</div>
		<div class="tool-group">
			<button class="tool-btn active" id="gridBtn" title="显示网格">
				<svg viewBox="0 0 24 24"><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/></svg>
			</button>
		</div>
		<div class="file-buttons">
			<button class="file-btn" id="importBtn">
				<svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
				导入
			</button>
			<button class="file-btn primary" id="exportBtn">
				<svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
				导出
			</button>
		</div>
	</div>
	<div class="main-container">
		<div class="left-panel" id="leftPanel">
			<div class="panel-title">
				<span class="panel-title-text">图层</span>
				<button class="panel-toggle" id="leftPanelToggle">
					<svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
				</button>
			</div>
			<div class="layer-list" id="layerList"></div>
			<div class="layer-buttons">
				<button class="layer-add-btn" id="addLayerBtn">
					<svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
					添加图层
				</button>
			</div>
		</div>
		<div class="panel-resizer horizontal left-resizer" id="leftResizer"></div>
		<div class="canvas-container" id="canvasContainer">
			<canvas id="editorCanvas"></canvas>
			<div class="canvas-info" id="canvasInfo">坐标: 0, 0 | 缩放: 100%</div>
			<div class="view-cube-wrapper">
				<div class="view-cube" id="viewCube">
					<div class="view-cube-inner" id="viewCubeInner">
						<div class="view-cube-face view-cube-front" data-view="front">前</div>
						<div class="view-cube-face view-cube-back" data-view="back">后</div>
						<div class="view-cube-face view-cube-left" data-view="left">左</div>
						<div class="view-cube-face view-cube-right" data-view="right">右</div>
						<div class="view-cube-face view-cube-top" data-view="top">上</div>
						<div class="view-cube-face view-cube-bottom" data-view="bottom">下</div>
						<div class="view-cube-edge view-cube-edge-front-top" data-edge="front-top"></div>
						<div class="view-cube-edge view-cube-edge-front-bottom" data-edge="front-bottom"></div>
						<div class="view-cube-edge view-cube-edge-front-left" data-edge="front-left"></div>
						<div class="view-cube-edge view-cube-edge-front-right" data-edge="front-right"></div>
						<div class="view-cube-edge view-cube-edge-back-top" data-edge="back-top"></div>
						<div class="view-cube-edge view-cube-edge-back-bottom" data-edge="back-bottom"></div>
						<div class="view-cube-edge view-cube-edge-back-left" data-edge="back-left"></div>
						<div class="view-cube-edge view-cube-edge-back-right" data-edge="back-right"></div>
						<div class="view-cube-edge view-cube-edge-top-left" data-edge="top-left"></div>
						<div class="view-cube-edge view-cube-edge-top-right" data-edge="top-right"></div>
						<div class="view-cube-edge view-cube-edge-bottom-left" data-edge="bottom-left"></div>
						<div class="view-cube-edge view-cube-edge-bottom-right" data-edge="bottom-right"></div>
						<div class="view-cube-corner view-cube-corner-ftl" data-corner="ftl"></div>
						<div class="view-cube-corner view-cube-corner-ftr" data-corner="ftr"></div>
						<div class="view-cube-corner view-cube-corner-fbl" data-corner="fbl"></div>
						<div class="view-cube-corner view-cube-corner-fbr" data-corner="fbr"></div>
						<div class="view-cube-corner view-cube-corner-btl" data-corner="btl"></div>
						<div class="view-cube-corner view-cube-corner-btr" data-corner="btr"></div>
						<div class="view-cube-corner view-cube-corner-bbl" data-corner="bbl"></div>
						<div class="view-cube-corner view-cube-corner-bbr" data-corner="bbr"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="panel-resizer horizontal right-resizer" id="rightResizer"></div>
		<div class="right-panel" id="rightPanel">
			<div class="panel-title">
				<span class="panel-title-text">属性</span>
				<button class="panel-toggle" id="rightPanelToggle">
					<svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
				</button>
			</div>
			<div class="property-section">
				<div class="property-label">地图尺寸</div>
				<div class="property-row">
					<div class="property-col">
						<input type="number" class="property-input" id="mapWidth" value="30" min="10" max="100">
					</div>
					<div class="property-col">
						<input type="number" class="property-input" id="mapHeight" value="30" min="10" max="100">
					</div>
				</div>
			</div>
			<div class="property-section" id="selectionProps" style="display:none">
				<div class="property-label">选中对象</div>
				<div class="property-row">
					<div class="property-col">
						<div class="property-label">X</div>
						<input type="number" class="property-input" id="selX">
					</div>
					<div class="property-col">
						<div class="property-label">Y</div>
						<input type="number" class="property-input" id="selY">
					</div>
					<div class="property-col">
						<div class="property-label">Z</div>
						<input type="number" class="property-input" id="selZ" min="0" step="0.5">
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="panel-resizer vertical bottom-resizer" id="bottomResizer"></div>
	<div class="bottom-panel" id="bottomPanel">
		<div class="resource-tabs">
			<div class="resource-tabs-left">
				<div class="resource-tab active" data-tab="terrain">地形</div>
				<div class="resource-tab" data-tab="terrainedit">地貌</div>
				<div class="resource-tab" data-tab="entity">实体</div>
				<div class="resource-tab" data-tab="trigger">触发器</div>
			</div>
			<div class="resource-tabs-right">
				<button class="panel-collapse-btn" id="bottomPanelCollapse" title="折叠">
					<svg viewBox="0 0 24 24"><polyline points="18 15 12 9 6 15"/></svg>
				</button>
			</div>
		</div>
		<div class="resource-btns">
			<button class="resource-btn" id="addResourceBtn">+ 添加</button>
		</div>
		<div class="resource-grid" id="resourceGrid"></div>
		<div class="terrain-edit-panel" id="terrainEditPanel">
			<div class="terrain-tools">
				<button class="terrain-tool-btn" data-tool="raise">
					<svg viewBox="0 0 24 24"><path d="M12 3L6 9h4v12h4V9h4z"/></svg>
					<span>升高</span>
				</button>
				<button class="terrain-tool-btn" data-tool="lower">
					<svg viewBox="0 0 24 24"><path d="M12 21l6-6h-4V3h-4v12H6z"/></svg>
					<span>降低</span>
				</button>
				<button class="terrain-tool-btn" data-tool="flatten">
					<svg viewBox="0 0 24 24"><rect x="4" y="10" width="16" height="4" rx="1"/></svg>
					<span>平整</span>
				</button>
			</div>
			<div class="terrain-value-row">
				<span>高度变化:</span>
				<input type="number" id="terrainEditValue" value="0.5" min="0.1" max="10" step="0.1">
			</div>
		</div>
	</div>
	<div class="context-menu" id="contextMenu">
		<div class="context-menu-item" data-action="edit">
			<svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
			编辑
		</div>
		<div class="context-menu-item" data-action="delete">
			<svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
			删除
		</div>
	</div>
	<div class="add-resource-modal" id="addResourceModal">
		<div class="add-resource-modal-box">
			<div class="add-resource-modal-title" id="addResourceModalTitle">添加地形</div>
			<div class="add-resource-modal-row">
				<label>名称</label>
				<input type="text" id="newResourceName" placeholder="输入名称...">
			</div>
			<div class="add-resource-modal-row">
				<label>颜色</label>
				<div class="color-picker-row">
					<input type="color" id="newResourceColor" value="#166d3b">
					<input type="text" class="color-hex" id="newResourceColorHex" value="#166d3b">
				</div>
			</div>
			<div class="add-resource-modal-btns">
				<button class="btn-confirm" id="addResourceConfirm">确定</button>
				<button class="btn-cancel" id="addResourceCancel">取消</button>
			</div>
		</div>
	</div>
<script>
const canvas = document.getElementById('editorCanvas')
const container = document.getElementById('canvasContainer')
let renderer = null
const state = {
	tool: 'select',
	showGrid: true,
	isPanning: false,
	panStartX: 0,
	panStartY: 0,
	isRotating: false,
	rotateStartX: 0,
	rotateStartY: 0,
	rotateStartAz: 0,
	rotateStartEl: 0,
	startTarget: null,
	tileMap: new Map(),
	mapBounds: { minX: 0, maxX: 29, minY: 0, maxY: 29 },
	selectedLayer: 0,
	selectedResource: null,
	selectedEntity: null,
	isDragging: false,
	dragStartX: 0,
	dragStartY: 0,
	mouseX: 0,
	mouseY: 0,
	isDrawing: false,
	history: [],
	historyIndex: -1,
	layers: [
		{ name: '地形层', visible: true, locked: false, type: 'terrain', data: [] },
		{ name: '装饰层', visible: true, locked: false, type: 'decor', data: [] },
		{ name: '实体层', visible: true, locked: false, type: 'entity', data: [] }
	],
	entities: [],
	triggers: [],
	needsRender: true,
	terrainDirty: true,
	currentTab: 'terrain',
	terrainTool: null,
	selectedTile: null
}
const resources = {
	terrain: [
		{ id: 'void', name: '虚空', color: '#000000', undeletable: true },
		{ id: 'walkable', name: '可行走', color: '#4a7c23', undeletable: true },
		{ id: 'unwalkable', name: '不可行走', color: '#8b4513', undeletable: true }
	],
	entity: [],
	trigger: [
		{ id: 'trigger_zone', name: '触发区域', color: 'rgba(155,89,182,0.5)' },
		{ id: 'teleport', name: '传送点', color: 'rgba(52,152,219,0.5)' },
		{ id: 'dialogue', name: '对话触发', color: 'rgba(46,204,113,0.5)' }
	]
}
const resourceMap = new Map()
function rebuildResourceMap() {
	resourceMap.clear()
	for (const cat of Object.keys(resources)) {
		for (const r of resources[cat]) {
			resourceMap.set(r.id, r)
		}
	}
}
rebuildResourceMap()
function initRenderer() {
	try {
		renderer = new GLRenderer(canvas)
		renderer.init()
		resizeCanvas()
		initDefaultTerrain()
		render()
	} catch (e) {
		console.error('WebGL initialization failed:', e)
		alert('WebGL 2.0 不支持，请使用现代浏览器')
	}
}
function resizeCanvas() {
	const rect = container.getBoundingClientRect()
	renderer.resize(rect.width, rect.height)
	state.needsRender = true
}
function initDefaultTerrain() {
	for (let y = state.mapBounds.minY; y <= state.mapBounds.maxY; y++) {
		for (let x = state.mapBounds.minX; x <= state.mapBounds.maxX; x++) {
			const key = `${x},${y}`
			state.tileMap.set(key, { terrain: 'walkable', z: 0 })
		}
	}
	state.terrainDirty = true
}
function render() {
	if (!renderer) return
	if (state.terrainDirty) {
		renderer.buildTerrainMesh(state.tileMap, state.mapBounds, resourceMap)
		state.terrainDirty = false
	}
	renderer.render({ entities: state.entities, resources: resourceMap, showGrid: state.showGrid, selectedTile: state.selectedTile })
	updateViewCube()
	requestAnimationFrame(render)
}
function updateViewCube() {
	const inner = document.getElementById('viewCubeInner')
	const az = renderer.camera.azimuth
	const el = renderer.camera.elevation
	inner.style.transform = `rotateX(${-el}deg) rotateZ(${-az}deg)`
}
function updateCanvasInfo() {
	const world = renderer.screenToWorld(state.mouseX, state.mouseY, 0)
	if (world) {
		const x = Math.floor(world.x)
		const y = Math.floor(world.y)
		document.getElementById('canvasInfo').textContent = `坐标: ${x}, ${y} | 距离: ${renderer.camera.distance.toFixed(1)}`
	}
}
container.addEventListener('mousedown', e => {
	const rect = canvas.getBoundingClientRect()
	state.mouseX = e.clientX - rect.left
	state.mouseY = e.clientY - rect.top
	if (e.button === 1) {
		e.preventDefault()
		state.isPanning = true
		state.panStartX = e.clientX
		state.panStartY = e.clientY
		state.startTarget = { ...renderer.camera.target }
	} else if (e.button === 2) {
		e.preventDefault()
		state.isRotating = true
		state.rotateStartX = e.clientX
		state.rotateStartY = e.clientY
		state.rotateStartAz = renderer.camera.azimuth
		state.rotateStartEl = renderer.camera.elevation
	} else if (e.button === 0) {
		const world = renderer.screenToWorld(state.mouseX, state.mouseY, 0)
		if (state.tool === 'select' && world) {
			const x = Math.floor(world.x)
			const y = Math.floor(world.y)
			const key = `${x},${y}`
			const tile = state.tileMap.get(key)
			if (tile && tile.terrain !== 'void') {
				state.selectedTile = { x, y, z: tile.z || 0 }
			} else {
				state.selectedTile = null
			}
			state.needsRender = true
		}
		saveHistory()
		if (state.tool === 'rect' && state.selectedResource) {
			state.isDrawing = true
			const world = renderer.screenToWorld(state.mouseX, state.mouseY, 0)
			if (world) {
				const x = Math.floor(world.x)
				const y = Math.floor(world.y)
				const key = `${x},${y}`
				state.tileMap.set(key, { terrain: state.selectedResource, z: 0 })
				state.terrainDirty = true
			}
		} else if (state.tool === 'eraser') {
			state.isDrawing = true
			const world = renderer.screenToWorld(state.mouseX, state.mouseY, 0)
			if (world) {
				const x = Math.floor(world.x)
				const y = Math.floor(world.y)
				const key = `${x},${y}`
				state.tileMap.set(key, { terrain: 'void', z: 0 })
				state.entities = state.entities.filter(e => !(Math.floor(e.x) === x && Math.floor(e.y) === y))
				state.terrainDirty = true
			}
		} else if (state.currentTab === 'terrainedit' && state.terrainTool) {
			state.isDrawing = true
			const world = renderer.screenToWorld(state.mouseX, state.mouseY, 0)
			if (world) {
				const x = Math.floor(world.x)
				const y = Math.floor(world.y)
				applyTerrainTool(x, y)
			}
		} else if (state.currentTab === 'entity' && state.selectedResource && world) {
			const x = Math.floor(world.x)
			const y = Math.floor(world.y)
			const key = `${x},${y}`
			const tile = state.tileMap.get(key)
			const z = tile ? (tile.z || 0) : 0
			state.entities.push({ id: Date.now(), type: state.selectedResource, x, y, z })
			state.needsRender = true
		}
	}
})
document.addEventListener('mousemove', e => {
	const rect = canvas.getBoundingClientRect()
	state.mouseX = e.clientX - rect.left
	state.mouseY = e.clientY - rect.top
	if (state.isPanning) {
		const dx = e.clientX - state.panStartX
		const dy = e.clientY - state.panStartY
		const scale = renderer.camera.distance * 0.002
		const azRad = renderer.camera.azimuth * Math.PI / 180
		const cosAz = Math.cos(azRad)
		const sinAz = Math.sin(azRad)
		renderer.camera.target.x = state.startTarget.x - (dx * cosAz - dy * sinAz) * scale
		renderer.camera.target.y = state.startTarget.y - (dx * sinAz + dy * cosAz) * scale
		state.needsRender = true
	}
	if (state.isRotating) {
		const dx = e.clientX - state.rotateStartX
		const dy = e.clientY - state.rotateStartY
		renderer.camera.azimuth = state.rotateStartAz + dx * 0.5
		renderer.camera.elevation = Math.max(-89, Math.min(-5, state.rotateStartEl - dy * 0.5))
		state.needsRender = true
	}
	if (state.isDrawing) {
		const world = renderer.screenToWorld(state.mouseX, state.mouseY, 0)
		if (world) {
			const x = Math.floor(world.x)
			const y = Math.floor(world.y)
			const key = `${x},${y}`
			if (state.tool === 'rect' && state.selectedResource) {
				state.tileMap.set(key, { terrain: state.selectedResource, z: 0 })
				state.terrainDirty = true
			} else if (state.tool === 'eraser') {
				state.tileMap.set(key, { terrain: 'void', z: 0 })
				state.entities = state.entities.filter(e => !(Math.floor(e.x) === x && Math.floor(e.y) === y))
				state.terrainDirty = true
			} else if (state.currentTab === 'terrainedit' && state.terrainTool) {
				applyTerrainTool(x, y)
			}
		}
	}
	updateCanvasInfo()
})
document.addEventListener('mouseup', e => {
	if (e.button === 1) state.isPanning = false
	if (e.button === 2) state.isRotating = false
	if (e.button === 0) state.isDrawing = false
})
container.addEventListener('wheel', e => {
	e.preventDefault()
	const delta = e.deltaY > 0 ? 1.1 : 0.9
	renderer.camera.distance = Math.max(5, Math.min(200, renderer.camera.distance * delta))
	state.needsRender = true
	updateCanvasInfo()
}, { passive: false })
container.addEventListener('contextmenu', e => e.preventDefault())
window.addEventListener('resize', () => resizeCanvas())
document.querySelectorAll('#drawToolGroup .tool-btn').forEach(btn => {
	btn.addEventListener('click', () => {
		document.querySelectorAll('#drawToolGroup .tool-btn').forEach(b => b.classList.remove('active'))
		btn.classList.add('active')
		state.tool = btn.dataset.tool
	})
})
document.getElementById('gridBtn').addEventListener('click', function() {
	this.classList.toggle('active')
	state.showGrid = this.classList.contains('active')
})
document.querySelectorAll('.resource-tab').forEach(tab => {
	tab.addEventListener('click', () => {
		document.querySelectorAll('.resource-tab').forEach(t => t.classList.remove('active'))
		tab.classList.add('active')
		state.currentTab = tab.dataset.tab
		updateBottomPanel()
	})
})
function updateBottomPanel() {
	const resourceGrid = document.getElementById('resourceGrid')
	const resourceBtns = document.querySelector('.resource-btns')
	const terrainEditPanel = document.getElementById('terrainEditPanel')
	if (state.currentTab === 'terrainedit') {
		resourceGrid.style.display = 'none'
		resourceBtns.style.display = 'none'
		terrainEditPanel.classList.add('active')
	} else {
		resourceGrid.style.display = 'flex'
		resourceBtns.style.display = 'flex'
		terrainEditPanel.classList.remove('active')
		renderResourceGrid()
	}
}
document.querySelectorAll('.terrain-tool-btn').forEach(btn => {
	btn.addEventListener('click', () => {
		document.querySelectorAll('.terrain-tool-btn').forEach(b => b.classList.remove('active'))
		btn.classList.add('active')
		state.terrainTool = btn.dataset.tool
	})
})
function saveHistory() {
	const snapshot = {
		tileMap: new Map(state.tileMap),
		entities: JSON.parse(JSON.stringify(state.entities))
	}
	state.history = state.history.slice(0, state.historyIndex + 1)
	state.history.push(snapshot)
	state.historyIndex++
	if (state.history.length > 50) {
		state.history.shift()
		state.historyIndex--
	}
	updateUndoRedoButtons()
}
function undo() {
	if (state.historyIndex <= 0) return
	state.historyIndex--
	const snapshot = state.history[state.historyIndex]
	state.tileMap = new Map(snapshot.tileMap)
	state.entities = JSON.parse(JSON.stringify(snapshot.entities))
	state.terrainDirty = true
	updateUndoRedoButtons()
}
function redo() {
	if (state.historyIndex >= state.history.length - 1) return
	state.historyIndex++
	const snapshot = state.history[state.historyIndex]
	state.tileMap = new Map(snapshot.tileMap)
	state.entities = JSON.parse(JSON.stringify(snapshot.entities))
	state.terrainDirty = true
	updateUndoRedoButtons()
}
function updateUndoRedoButtons() {
	document.getElementById('undoBtn').disabled = state.historyIndex <= 0
	document.getElementById('redoBtn').disabled = state.historyIndex >= state.history.length - 1
}
document.getElementById('undoBtn').addEventListener('click', undo)
document.getElementById('redoBtn').addEventListener('click', redo)
function applyTerrainTool(x, y) {
	const key = `${x},${y}`
	let tile = state.tileMap.get(key)
	if (!tile) tile = { terrain: 'walkable', z: 0 }
	const editValue = parseFloat(document.getElementById('terrainEditValue').value) || 0.5
	if (state.terrainTool === 'raise') {
		tile.z = (tile.z || 0) + editValue
	} else if (state.terrainTool === 'lower') {
		tile.z = Math.max(0, (tile.z || 0) - editValue)
	} else if (state.terrainTool === 'flatten') {
		tile.z = 0
	}
	state.tileMap.set(key, tile)
	state.terrainDirty = true
}
function renderResourceGrid() {
	const grid = document.getElementById('resourceGrid')
	grid.innerHTML = ''
	const list = resources[state.currentTab] || []
	list.forEach(res => {
		const item = document.createElement('div')
		item.className = 'resource-item' + (state.selectedResource === res.id ? ' selected' : '')
		item.innerHTML = `
			<div class="resource-preview" style="background:${res.color};border-radius:4px"></div>
			<div class="resource-name">${res.name}</div>
		`
		item.addEventListener('click', () => {
			state.selectedResource = res.id
			renderResourceGrid()
		})
		grid.appendChild(item)
	})
}
function renderLayers() {
	const list = document.getElementById('layerList')
	list.innerHTML = ''
	state.layers.forEach((layer, i) => {
		const item = document.createElement('div')
		item.className = 'layer-item' + (state.selectedLayer === i ? ' selected' : '')
		item.innerHTML = `
			<div class="layer-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/></svg></div>
			<span class="layer-name">${layer.name}</span>
			<div class="layer-actions">
				<button class="layer-action-btn${layer.visible ? ' active' : ''}" data-action="visibility">
					<svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
				</button>
			</div>
		`
		item.addEventListener('click', () => {
			state.selectedLayer = i
			renderLayers()
		})
		list.appendChild(item)
	})
}
const viewAngles = {
	'front': { azimuth: 180, elevation: -35 },
	'back': { azimuth: 0, elevation: -35 },
	'left': { azimuth: -90, elevation: -35 },
	'right': { azimuth: 90, elevation: -35 },
	'top': { azimuth: 45, elevation: -89 },
	'bottom': { azimuth: 45, elevation: -5 }
}
document.querySelectorAll('.view-cube-face').forEach(face => {
	face.addEventListener('click', () => {
		const view = face.dataset.view
		if (viewAngles[view]) {
			renderer.camera.azimuth = viewAngles[view].azimuth
			renderer.camera.elevation = viewAngles[view].elevation
			state.needsRender = true
		}
	})
})
document.getElementById('leftPanelToggle').addEventListener('click', () => {
	document.getElementById('leftPanel').classList.toggle('collapsed')
	setTimeout(resizeCanvas, 200)
})
document.getElementById('rightPanelToggle').addEventListener('click', () => {
	document.getElementById('rightPanel').classList.toggle('collapsed')
	setTimeout(resizeCanvas, 200)
})
document.getElementById('bottomPanelCollapse').addEventListener('click', () => {
	document.getElementById('bottomPanel').classList.toggle('collapsed')
	setTimeout(resizeCanvas, 200)
})
document.getElementById('addResourceBtn').addEventListener('click', () => {
	document.getElementById('addResourceModal').classList.add('open')
	document.getElementById('addResourceModalTitle').textContent = state.currentTab === 'terrain' ? '添加地形' : state.currentTab === 'entity' ? '添加实体' : '添加触发器'
})
document.getElementById('addResourceCancel').addEventListener('click', () => {
	document.getElementById('addResourceModal').classList.remove('open')
})
document.getElementById('addResourceConfirm').addEventListener('click', () => {
	const name = document.getElementById('newResourceName').value.trim()
	const color = document.getElementById('newResourceColor').value
	if (!name) return
	const id = 'custom_' + Date.now()
	resources[state.currentTab].push({ id, name, color })
	rebuildResourceMap()
	renderResourceGrid()
	document.getElementById('addResourceModal').classList.remove('open')
	document.getElementById('newResourceName').value = ''
})
document.getElementById('newResourceColor').addEventListener('input', e => {
	document.getElementById('newResourceColorHex').value = e.target.value
})
document.getElementById('newResourceColorHex').addEventListener('input', e => {
	const val = e.target.value
	if (/^#[0-9a-fA-F]{6}$/.test(val)) {
		document.getElementById('newResourceColor').value = val
	}
})
document.getElementById('exportBtn').addEventListener('click', () => {
	const data = {
		version: '2.0',
		mapBounds: state.mapBounds,
		tiles: Array.from(state.tileMap.entries()),
		entities: state.entities,
		triggers: state.triggers,
		layers: state.layers,
		resources: resources
	}
	const blob = new Blob([JSON.stringify(data)], { type: 'application/json' })
	const url = URL.createObjectURL(blob)
	const a = document.createElement('a')
	a.href = url
	a.download = 'map.json'
	a.click()
	URL.revokeObjectURL(url)
})
document.getElementById('importBtn').addEventListener('click', () => {
	const input = document.createElement('input')
	input.type = 'file'
	input.accept = '.json'
	input.onchange = e => {
		const file = e.target.files[0]
		if (!file) return
		const reader = new FileReader()
		reader.onload = ev => {
			try {
				const data = JSON.parse(ev.target.result)
				if (data.mapBounds) state.mapBounds = data.mapBounds
				if (data.tiles) state.tileMap = new Map(data.tiles)
				if (data.entities) state.entities = data.entities
				if (data.triggers) state.triggers = data.triggers
				if (data.layers) state.layers = data.layers
				if (data.resources) {
					Object.assign(resources, data.resources)
					rebuildResourceMap()
				}
				state.terrainDirty = true
				renderResourceGrid()
				renderLayers()
			} catch (err) {
				alert('导入失败: ' + err.message)
			}
		}
		reader.readAsText(file)
	}
	input.click()
})
renderResourceGrid()
renderLayers()
initRenderer()
saveHistory()
</script>
</body>
</html>
