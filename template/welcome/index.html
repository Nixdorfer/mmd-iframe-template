<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:var(--bg);color:#fff;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden}
.container{background:var(--modal);border-radius:16px;max-width:500px;width:90%;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
.modal-header{padding:24px 24px 16px;text-align:center;flex-shrink:0}
.modal-header h1{color:#fff;margin:0}
.modal-content{flex:1;overflow-y:auto;padding:0 24px;scrollbar-width:thin;scrollbar-color:rgba(0,0,0,0.5) transparent}
.modal-content::-webkit-scrollbar{width:6px;background:transparent}
.modal-content::-webkit-scrollbar-track{background:transparent}
.modal-content::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.5);border-radius:3px}
.modal-footer{padding:16px 24px 24px;flex-shrink:0;display:flex;gap:10px;flex-wrap:wrap}
.desc{display:block;color:#888;font-size:14px;margin-bottom:16px;white-space:pre-wrap}
.desc.align-left{text-align:left}.desc.align-right{text-align:right}.desc.align-middle{text-align:center}
.desc.style-quote{border-left:3px solid #444;padding-left:12px;color:#aaa;font-style:italic}
.desc.style-title{font-size:18px;font-weight:bold;color:#fff}
.desc.style-bold{font-weight:bold}
.desc.style-tilt{font-style:italic}
.desc.style-underline{text-decoration:underline}
.desc.style-delete{text-decoration:line-through}
.desc.style-url{color:#4a9eff;text-decoration:underline;cursor:pointer}
.desc.no-enter{display:inline;margin-bottom:0;margin-right:4px}
.desc.dist-none{margin-bottom:0}.desc.dist-min{margin-bottom:4px}.desc.dist-1{margin-bottom:8px}.desc.dist-2{margin-bottom:16px}.desc.dist-3{margin-bottom:24px}.desc.dist-max{margin-bottom:32px}
.url-confirm{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000}
.url-confirm-box{background:#1a1a1a;border-radius:12px;padding:20px;max-width:360px;width:90%}
.url-confirm-title{color:#fff;font-size:16px;font-weight:bold;margin-bottom:12px}
.url-confirm-link{color:#4a9eff;font-size:13px;word-break:break-all;margin-bottom:8px}
.url-confirm-warn{color:#ff6b6b;font-size:12px;margin-bottom:16px}
.url-confirm-btns{display:flex;justify-content:flex-end;gap:10px}
.url-confirm-btns button{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:14px}
.url-confirm-close{background:#333;color:#888}
.url-confirm-ok{background:var(--btn);color:#fff}
.form-group{margin-bottom:16px}
label{display:block;margin-bottom:8px;color:#fff}
input,select{width:100%;padding:12px;border:none;border-radius:8px;background:#1a1a1a;color:#fff;font-size:16px}
input:focus,select:focus{outline:2px solid var(--btn)}
input.error{outline:2px solid #ff4444;animation:shake 0.5s ease}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-8px)}40%,80%{transform:translateX(8px)}}
.btn{flex:1;padding:14px;border:none;border-radius:8px;font-size:16px;cursor:pointer;transition:all 0.3s}
.btn-primary{background:var(--btn);color:#fff}
.btn-primary:hover{filter:brightness(1.2)}
.btn-secondary{background:#333;color:#888}
.btn-secondary:hover{background:#444}
.btn-prev{background:var(--btn);color:#fff}
.btn-prev:hover{filter:brightness(1.2)}
.hidden{display:none}
@keyframes aSlide{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes aFade{from{opacity:0}to{opacity:1}}
@keyframes aRotate{from{transform:rotate(-180deg) scale(0);opacity:0}to{transform:rotate(0) scale(1);opacity:1}}
@keyframes aZoomin{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes aZoomout{from{transform:scale(2);opacity:0}to{transform:scale(1);opacity:1}}
.anim-slide{animation:aSlide var(--dur) ease-out}
.anim-fade{animation:aFade var(--dur) ease-out}
.anim-rotate{animation:aRotate var(--dur) ease-out}
.anim-zoomin{animation:aZoomin var(--dur) ease-out}
.anim-zoomout{animation:aZoomout var(--dur) ease-out}
.custom-btn{display:inline-block;padding:10px 20px;border:none;border-radius:8px;color:#fff;font-size:14px;cursor:pointer;margin:8px 4px;transition:filter 0.2s}
.custom-btn:hover{filter:brightness(1.2)}
.custom-btn.disabled{opacity:0.5;cursor:not-allowed}
.btn-wrap{display:block;margin:8px 0}
.btn-wrap.align-left{text-align:left}
.btn-wrap.align-middle{text-align:center}
.btn-wrap.align-right{text-align:right}
.row{display:flex;gap:8px;margin:8px 0}
.row-col{display:flex;flex-direction:column}
.row-col.align-left{align-items:flex-start}
.row-col.align-middle{align-items:center}
.row-col.align-right{align-items:flex-end}
.row-col.valign-top{justify-content:flex-start}
.row-col.valign-middle{justify-content:center}
.row-col.valign-bottom{justify-content:flex-end}
.row-col .custom-btn{margin:0}
.row-col .custom-img{margin:0}
.row-col .desc{margin-bottom:0}
.custom-img{max-width:100%;border-radius:8px;margin:8px 0}
.custom-img.align-left{display:block;margin-left:0;margin-right:auto}
.custom-img.align-right{display:block;margin-left:auto;margin-right:0}
.custom-img.align-middle{display:block;margin-left:auto;margin-right:auto}
.custom-img.clickable{cursor:pointer}
.cover-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001}
.version{width:100%;text-align:center;color:#444;font-size:10px;margin-top:8px}
</style>
</head>
<body>
<div class="container" id="root"></div>
<script>
/*__CONFIG__*/
(function() {
var C = window.CONFIG || {};
var CK = window.CONFIG_KEYS || [];
var modalColor = C.modalColor || '0d0d0d';
var btnColor = C.btnColor || '166d3b';
var bgColor = C.backgroundColor || '050505';
var globalAlign = C['page.content.align'] || 'middle';
var globalStyle = C['page.content.style'] || '';
var globalDistance = C['page.content.distance'] || '';
var globalAnimType = C['page.animation.type'] || '';
var globalAnimDur = parseInt(C['page.animation.duration']) || 300;
document.documentElement.style.setProperty('--bg', '#'+bgColor);
document.documentElement.style.setProperty('--modal', '#'+modalColor);
document.documentElement.style.setProperty('--btn', '#'+btnColor);
var pages = [];
var pageKeys = Object.keys(C).filter(function(k){return k.match(/^page\.\d+\./);});
var pageNums = [];
pageKeys.forEach(function(k) {
  var n = parseInt(k.split('.')[1]);
  if (pageNums.indexOf(n) === -1) pageNums.push(n);
});
pageNums.sort(function(a,b){return a-b;});
function getKeyOrder(k) {
  var idx = CK.indexOf(k);
  return idx >= 0 ? idx : 9999;
}
pageNums.forEach(function(n) {
  var pg = {n:n, title:'', elements:[], nextContent:'', lastContent:'', hideContent:'', bgColor:'', modalColor:'', btnColor:'', defaultAlign:'', defaultStyle:'', defaultDistance:'', animType:'', animDur:300};
  pg.title = C['page.'+n+'.title'] || '';
  pg.defaultAlign = C['page.'+n+'.content.align'] || '';
  pg.defaultStyle = C['page.'+n+'.content.style'] || '';
  pg.defaultDistance = C['page.'+n+'.content.distance'] || '';
  pg.nextContent = C['page.'+n+'.next.content'] || '';
  pg.lastContent = C['page.'+n+'.last.content'] || '上一页';
  pg.hideContent = C['page.'+n+'.hide.content'] || '隐藏';
  pg.bgColor = C['page.'+n+'.background.color'] || '';
  pg.modalColor = C['page.'+n+'.modal.color'] || '';
  pg.btnColor = C['page.'+n+'.btn.color'] || '';
  pg.animType = C['page.'+n+'.animation.type'] || globalAnimType;
  pg.animDur = parseInt(C['page.'+n+'.animation.duration']) || globalAnimDur;
  var contentNums = [];
  Object.keys(C).forEach(function(k) {
    var m = k.match(new RegExp('^page\\.'+n+'\\.content\\.(\\d+)'));
    if (m && contentNums.indexOf(parseInt(m[1])) === -1) contentNums.push(parseInt(m[1]));
  });
  contentNums.forEach(function(y) {
    var ct = {type:'content', idx:y, text:'', align:'', style:'', url:'', enter:true, distance:'', order:0};
    ct.text = C['page.'+n+'.content.'+y] || '';
    ct.align = C['page.'+n+'.content.'+y+'.align'] || '';
    ct.style = C['page.'+n+'.content.'+y+'.style'] || '';
    ct.url = C['page.'+n+'.content.'+y+'.url'] || '';
    ct.enter = C['page.'+n+'.content.'+y+'.enter'] !== 'false';
    ct.distance = C['page.'+n+'.content.'+y+'.distance'] || '';
    ct.order = getKeyOrder('page.'+n+'.content.'+y);
    pg.elements.push(ct);
  });
  if (contentNums.length === 0 && C['page.'+n+'.content']) {
    pg.elements.push({type:'content', idx:1, text:C['page.'+n+'.content'], align:'', style:'', order:getKeyOrder('page.'+n+'.content')});
  }
  var optNums = [];
  Object.keys(C).forEach(function(k) {
    var m = k.match(new RegExp('^page\\.'+n+'\\.options\\.(\\d+)\\.'));
    if (m && optNums.indexOf(parseInt(m[1])) === -1) optNums.push(parseInt(m[1]));
  });
  optNums.forEach(function(y) {
    var opt = {type:'option', idx:y, title:'', options:[], defaultIdx:0, key:'', order:0};
    opt.title = C['page.'+n+'.options.'+y+'.title'] || '';
    opt.key = C['page.'+n+'.options.'+y+'.key'] || 'option'+y;
    var defVal = parseInt(C['page.'+n+'.options.'+y+'.default'] || '1');
    opt.order = getKeyOrder('page.'+n+'.options.'+y+'.title');
    var optionNums = [];
    Object.keys(C).forEach(function(k) {
      var m = k.match(new RegExp('^page\\.'+n+'\\.options\\.'+y+'\\.option\\.(\\d+)$'));
      if (m) optionNums.push(parseInt(m[1]));
    });
    optionNums.sort(function(a,b){return a-b;});
    opt.defaultIdx = optionNums.indexOf(defVal);
    if (opt.defaultIdx < 0) opt.defaultIdx = 0;
    optionNums.forEach(function(z) {
      opt.options.push(C['page.'+n+'.options.'+y+'.option.'+z] || '');
    });
    pg.elements.push(opt);
  });
  var inputNums = [];
  Object.keys(C).forEach(function(k) {
    var m = k.match(new RegExp('^page\\.'+n+'\\.input\\.(\\d+)\\.'));
    if (m && inputNums.indexOf(parseInt(m[1])) === -1) inputNums.push(parseInt(m[1]));
  });
  inputNums.forEach(function(y) {
    var inp = {type:'input', idx:y, title:'', desc:'', key:'', nullable:false, order:0};
    inp.title = C['page.'+n+'.input.'+y+'.title'] || '';
    inp.desc = C['page.'+n+'.input.'+y+'.desc'] || '';
    inp.key = C['page.'+n+'.input.'+y+'.key'] || 'input'+y;
    inp.nullable = C['page.'+n+'.input.'+y+'.nullable'] === 'true';
    inp.order = getKeyOrder('page.'+n+'.input.'+y+'.title');
    pg.elements.push(inp);
  });
  var btnNums = [];
  Object.keys(C).forEach(function(k) {
    var m = k.match(new RegExp('^page\\.'+n+'\\.btn\\.(\\d+)\\.'));
    if (m && btnNums.indexOf(parseInt(m[1])) === -1) btnNums.push(parseInt(m[1]));
  });
  btnNums.forEach(function(y) {
    var bt = {type:'btn', idx:y, content:'', color:'', modal:0, mode:'cover', reclickable:true, deathType:'disable', deathContent:'', animType:'', animDur:300, align:'', order:0};
    bt.content = C['page.'+n+'.btn.'+y+'.content'] || '';
    bt.color = C['page.'+n+'.btn.'+y+'.color'] || '';
    bt.modal = parseInt(C['page.'+n+'.btn.'+y+'.modal']) || 0;
    bt.mode = C['page.'+n+'.btn.'+y+'.mode'] || 'cover';
    bt.reclickable = C['page.'+n+'.btn.'+y+'.reclickable'] !== 'false';
    bt.deathType = C['page.'+n+'.btn.'+y+'.death.type'] || 'disable';
    bt.deathContent = C['page.'+n+'.btn.'+y+'.death.content'] || '';
    bt.animType = C['page.'+n+'.btn.'+y+'.animation.type'] || '';
    bt.animDur = parseInt(C['page.'+n+'.btn.'+y+'.animation.duration']) || 300;
    bt.align = C['page.'+n+'.btn.'+y+'.align'] || '';
    bt.order = getKeyOrder('page.'+n+'.btn.'+y+'.content');
    pg.elements.push(bt);
  });
  var imgNums = [];
  Object.keys(C).forEach(function(k) {
    var m = k.match(new RegExp('^page\\.'+n+'\\.image\\.(\\d+)\\.'));
    if (m && imgNums.indexOf(parseInt(m[1])) === -1) imgNums.push(parseInt(m[1]));
  });
  imgNums.forEach(function(y) {
    var im = {type:'image', idx:y, align:'middle', url:'', clickType:'disable', modalId:0, modalMode:'cover', modalAnimType:'', modalAnimDur:300, switchUrls:[], switchCycle:false, order:0};
    im.align = C['page.'+n+'.image.'+y+'.align'] || 'middle';
    im.url = C['page.'+n+'.image.'+y+'.url'] || '';
    im.clickType = C['page.'+n+'.image.'+y+'.click.type'] || 'disable';
    im.modalId = parseInt(C['page.'+n+'.image.'+y+'.modal.modal']) || 0;
    im.modalMode = C['page.'+n+'.image.'+y+'.modal.mode'] || 'cover';
    im.modalAnimType = C['page.'+n+'.image.'+y+'.modal.animation.type'] || '';
    im.modalAnimDur = parseInt(C['page.'+n+'.image.'+y+'.modal.animation.duration']) || 300;
    im.switchCycle = C['page.'+n+'.image.'+y+'.switch.cycle'] === 'true';
    var swNums = [];
    Object.keys(C).forEach(function(k) {
      var m = k.match(new RegExp('^page\\.'+n+'\\.image\\.'+y+'\\.switch\\.(\\d+)$'));
      if (m) swNums.push(parseInt(m[1]));
    });
    swNums.sort(function(a,b){return a-b;});
    swNums.forEach(function(z) {
      im.switchUrls.push(C['page.'+n+'.image.'+y+'.switch.'+z] || '');
    });
    im.order = getKeyOrder('page.'+n+'.image.'+y+'.url');
    pg.elements.push(im);
  });
  var rowNums = [];
  Object.keys(C).forEach(function(k) {
    var m = k.match(new RegExp('^page\\.'+n+'\\.row\\.(\\d+)\\.'));
    if (m && rowNums.indexOf(parseInt(m[1])) === -1) rowNums.push(parseInt(m[1]));
  });
  rowNums.forEach(function(y) {
    var rw = {type:'row', idx:y, ratio:[], cols:[], order:0};
    var ratioStr = C['page.'+n+'.row.'+y+'.ratio'] || '1';
    rw.ratio = ratioStr.split(':').map(function(r){return parseInt(r)||1});
    rw.order = getKeyOrder('page.'+n+'.row.'+y+'.ratio');
    var colNums = [];
    Object.keys(C).forEach(function(k) {
      var m = k.match(new RegExp('^page\\.'+n+'\\.row\\.'+y+'\\.(\\d+)\\.'));
      if (m && colNums.indexOf(parseInt(m[1])) === -1) colNums.push(parseInt(m[1]));
    });
    colNums.sort(function(a,b){return a-b});
    colNums.forEach(function(z) {
      var P = 'page.'+n+'.row.'+y+'.'+z;
      var tp = C[P+'.type'] || 'content';
      var col = {type:tp, align:C[P+'.align']||'middle', valign:C[P+'.valign']||'middle'};
      if (tp === 'content') {
        col.text = C[P+'.content'] || '';
        col.style = C[P+'.content.style'] || '';
        col.url = C[P+'.content.url'] || '';
      } else if (tp === 'btn') {
        col.content = C[P+'.btn.content'] || '';
        col.color = C[P+'.btn.color'] || '';
        col.modal = parseInt(C[P+'.btn.modal']) || 0;
        col.mode = C[P+'.btn.mode'] || 'cover';
        col.reclickable = C[P+'.btn.reclickable'] !== 'false';
        col.deathType = C[P+'.btn.death.type'] || 'disable';
        col.deathContent = C[P+'.btn.death.content'] || '';
        col.animType = C[P+'.btn.animation.type'] || '';
        col.animDur = parseInt(C[P+'.btn.animation.duration']) || 300;
      } else if (tp === 'image') {
        col.url = C[P+'.image.url'] || '';
        col.clickType = C[P+'.image.click.type'] || 'disable';
        col.modalId = parseInt(C[P+'.image.modal.modal']) || 0;
        col.modalMode = C[P+'.image.modal.mode'] || 'cover';
        col.modalAnimType = C[P+'.image.modal.animation.type'] || '';
        col.modalAnimDur = parseInt(C[P+'.image.modal.animation.duration']) || 300;
        col.switchCycle = C[P+'.image.switch.cycle'] === 'true';
        col.switchUrls = [];
        var swNums2 = [];
        Object.keys(C).forEach(function(k2) {
          var m2 = k2.match(new RegExp('^'+P.replace(/\./g,'\\.')+'\\.image\\.switch\\.(\\d+)$'));
          if (m2) swNums2.push(parseInt(m2[1]));
        });
        swNums2.sort(function(a,b){return a-b});
        swNums2.forEach(function(sw) {
          col.switchUrls.push(C[P+'.image.switch.'+sw] || '');
        });
      }
      rw.cols.push(col);
    });
    pg.elements.push(rw);
  });
  pg.rowHeight = C['page.'+n+'.row.height'] || '';
  pg.elements.sort(function(a,b){return a.order - b.order;});
  pages.push(pg);
});
if (pages.length === 0) {
  pages.push({n:1, title:'', elements:[], nextContent:'完成', lastContent:'上一页', hideContent:'隐藏', bgColor:'', modalColor:'', btnColor:'', defaultAlign:'', defaultStyle:'', animType:'', animDur:300});
}
var currentPage = 0;
var data = {};
function render() {
  var pg = pages[currentPage];
  var isFirst = currentPage === 0;
  var isLast = currentPage === pages.length - 1;
  var nextText = pg.nextContent || (isLast ? '完成' : '下一页');
  if (pg.bgColor) document.documentElement.style.setProperty('--bg', '#'+pg.bgColor);
  else document.documentElement.style.setProperty('--bg', '#'+bgColor);
  if (pg.modalColor) document.documentElement.style.setProperty('--modal', '#'+pg.modalColor);
  else document.documentElement.style.setProperty('--modal', '#'+modalColor);
  if (pg.btnColor) document.documentElement.style.setProperty('--btn', '#'+pg.btnColor);
  else document.documentElement.style.setProperty('--btn', '#'+btnColor);
  var html = '<div class="modal-header">';
  if (pg.title) html += '<h1>'+esc(pg.title)+'</h1>';
  html += '</div><div class="modal-content">';
  var prevNoEnter = false;
  pg.elements.forEach(function(el) {
    if (el.type === 'content') {
      var align = el.align || pg.defaultAlign || globalAlign;
      var style = el.style || pg.defaultStyle || globalStyle;
      var dist = el.distance || pg.defaultDistance || globalDistance;
      var cls = 'desc align-' + align;
      var isUrl = false;
      if (style) {
        style.split('\\').forEach(function(s) {
          if (s) cls += ' style-' + s;
          if (s === 'url') isUrl = true;
        });
      }
      if (dist) cls += ' dist-' + dist;
      if (!el.enter) cls += ' no-enter';
      if (prevNoEnter) cls += ' no-enter';
      prevNoEnter = !el.enter;
      if (isUrl && el.url) {
        html += '<span class="'+cls+'" data-url="'+esc(el.url)+'">'+esc(el.text)+'</span>';
      } else {
        html += '<span class="'+cls+'">'+esc(el.text)+'</span>';
      }
    } else if (el.type === 'option') {
      prevNoEnter = false;
      html += '<div class="form-group">';
      if (el.title) html += '<label>'+esc(el.title)+'</label>';
      html += '<select data-type="option" data-key="'+esc(el.key)+'">';
      el.options.forEach(function(o, j) {
        var sel = j === el.defaultIdx ? ' selected' : '';
        html += '<option value="'+esc(o)+'"'+sel+'>'+esc(o)+'</option>';
      });
      html += '</select></div>';
    } else if (el.type === 'input') {
      prevNoEnter = false;
      html += '<div class="form-group">';
      if (el.title) html += '<label>'+esc(el.title)+'</label>';
      html += '<input type="text" data-type="input" data-key="'+esc(el.key)+'" data-nullable="'+el.nullable+'" placeholder="'+esc(el.desc)+'">';
      html += '</div>';
    } else if (el.type === 'btn') {
      prevNoEnter = false;
      var bgc = el.color || btnColor;
      var btnHtml = '<button class="custom-btn" data-type="btn" data-idx="'+el.idx+'" data-modal="'+el.modal+'" data-mode="'+el.mode+'" data-reclickable="'+el.reclickable+'" data-death-type="'+el.deathType+'" data-death-content="'+esc(el.deathContent)+'" data-anim-type="'+el.animType+'" data-anim-dur="'+el.animDur+'" style="background:#'+bgc+'">'+esc(el.content)+'</button>';
      if (el.align) html += '<div class="btn-wrap align-'+el.align+'">'+btnHtml+'</div>';
      else html += btnHtml;
    } else if (el.type === 'image') {
      prevNoEnter = false;
      var cls = 'custom-img align-'+el.align;
      if (el.clickType !== 'disable') cls += ' clickable';
      html += '<img class="'+cls+'" src="'+esc(el.url)+'" data-type="image" data-idx="'+el.idx+'" data-click-type="'+el.clickType+'" data-modal-id="'+el.modalId+'" data-modal-mode="'+el.modalMode+'" data-modal-anim-type="'+el.modalAnimType+'" data-modal-anim-dur="'+el.modalAnimDur+'" data-switch-urls="'+esc(el.switchUrls.join('|'))+'" data-switch-cycle="'+el.switchCycle+'" data-switch-idx="0">';
    } else if (el.type === 'row') {
      prevNoEnter = false;
      var total = el.ratio.reduce(function(a,b){return a+b},0);
      html += '<div class="row" data-row-idx="'+el.idx+'">';
      el.cols.forEach(function(col,ci) {
        var flex = el.ratio[ci] || 1;
        var pct = (flex/total*100).toFixed(2);
        html += '<div class="row-col align-'+col.align+' valign-'+col.valign+'" style="flex:0 0 '+pct+'%">';
        if (col.type === 'content') {
          var cCls = 'desc';
          var isUrl = false;
          if (col.style) col.style.split('\\').forEach(function(s){if(s){cCls+=' style-'+s;if(s==='url')isUrl=true}});
          if (isUrl && col.url) html += '<span class="'+cCls+'" data-url="'+esc(col.url)+'">'+esc(col.text)+'</span>';
          else html += '<span class="'+cCls+'">'+esc(col.text)+'</span>';
        } else if (col.type === 'btn') {
          var bgc2 = col.color || btnColor;
          html += '<button class="custom-btn" data-type="btn" data-modal="'+col.modal+'" data-mode="'+col.mode+'" data-reclickable="'+col.reclickable+'" data-death-type="'+col.deathType+'" data-death-content="'+esc(col.deathContent)+'" data-anim-type="'+col.animType+'" data-anim-dur="'+col.animDur+'" style="background:#'+bgc2+'">'+esc(col.content)+'</button>';
        } else if (col.type === 'image') {
          var iCls = 'custom-img';
          if (col.clickType !== 'disable') iCls += ' clickable';
          html += '<img class="'+iCls+'" src="'+esc(col.url)+'" data-type="image" data-click-type="'+col.clickType+'" data-modal-id="'+col.modalId+'" data-modal-mode="'+col.modalMode+'" data-modal-anim-type="'+col.modalAnimType+'" data-modal-anim-dur="'+col.modalAnimDur+'" data-switch-urls="'+esc(col.switchUrls.join('|'))+'" data-switch-cycle="'+col.switchCycle+'" data-switch-idx="0" style="max-width:100%">';
        }
        html += '</div>';
      });
      html += '</div>';
    }
  });
  html += '</div><div class="modal-footer">';
  if (!isFirst) html += '<button class="btn btn-prev" id="prevBtn">'+esc(pg.lastContent)+'</button>';
  html += '<button class="btn btn-secondary" id="hideBtn">'+esc(pg.hideContent)+'</button>';
  html += '<button class="btn btn-primary" id="nextBtn">'+esc(nextText)+'</button>';
  html += '<div class="version">v1.0.1</div></div>';
  document.getElementById('root').innerHTML = html;
  if (!isFirst) document.getElementById('prevBtn').onclick = prev;
  document.getElementById('nextBtn').onclick = next;
  document.getElementById('hideBtn').onclick = hide;
  document.querySelectorAll('[data-url]').forEach(function(el) {
    el.onclick = function() {
      var url = el.getAttribute('data-url');
      if (url.indexOf('https://github.com/Nixdorfer') === 0) {
        window.open(url, '_blank');
      } else {
        showUrlConfirm(url);
      }
    };
  });
  document.querySelectorAll('[data-type="btn"]').forEach(function(el) {
    el.onclick = function() {
      if (el.classList.contains('disabled')) return;
      var modal = parseInt(el.getAttribute('data-modal'));
      var mode = el.getAttribute('data-mode');
      var reclickable = el.getAttribute('data-reclickable') === 'true';
      var deathType = el.getAttribute('data-death-type');
      var deathContent = el.getAttribute('data-death-content');
      var animType = el.getAttribute('data-anim-type');
      var animDur = parseInt(el.getAttribute('data-anim-dur'));
      if (!reclickable) {
        if (deathType === 'remove') el.remove();
        else {
          el.classList.add('disabled');
          if (deathContent) el.textContent = deathContent;
        }
      }
      if (modal) openModal(modal, mode, animType, animDur);
    };
  });
  document.querySelectorAll('[data-type="image"]').forEach(function(el) {
    if (el.getAttribute('data-click-type') === 'disable') return;
    el.onclick = function() {
      var clickType = el.getAttribute('data-click-type');
      if (clickType === 'modal') {
        var modalId = parseInt(el.getAttribute('data-modal-id'));
        var modalMode = el.getAttribute('data-modal-mode');
        var animType = el.getAttribute('data-modal-anim-type');
        var animDur = parseInt(el.getAttribute('data-modal-anim-dur'));
        if (modalId) openModal(modalId, modalMode, animType, animDur);
      } else if (clickType === 'switch') {
        var urls = el.getAttribute('data-switch-urls').split('|').filter(function(u){return u;});
        var cycle = el.getAttribute('data-switch-cycle') === 'true';
        var idx = parseInt(el.getAttribute('data-switch-idx'));
        if (urls.length > 0) {
          idx++;
          if (idx >= urls.length) idx = cycle ? 0 : urls.length - 1;
          el.setAttribute('data-switch-idx', idx);
          el.src = urls[idx];
        }
      }
    };
  });
  if (pg.rowHeight) {
    pg.rowHeight.split(':').forEach(function(grp) {
      var ids = grp.split(',').map(function(s){return parseInt(s.trim())});
      var rows = ids.map(function(id){return document.querySelector('[data-row-idx="'+id+'"]')}).filter(function(r){return r});
      if (rows.length > 1) {
        var maxH = Math.max.apply(null, rows.map(function(r){return r.offsetHeight}));
        rows.forEach(function(r){r.style.minHeight = maxH+'px'});
      }
    });
  }
}
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function showUrlConfirm(url) {
  var overlay = document.createElement('div');
  overlay.className = 'url-confirm';
  overlay.innerHTML = '<div class="url-confirm-box"><div class="url-confirm-title">您确认要打开这个链接吗？</div><div class="url-confirm-link">'+esc(url)+'</div><div class="url-confirm-warn">打开不安全的链接可能导致安全风险！</div><div class="url-confirm-btns"><button class="url-confirm-close" id="ucClose">关闭(5)</button><button class="url-confirm-ok" id="ucOk">确定</button></div></div>';
  document.body.appendChild(overlay);
  var countdown = 5;
  var closeBtn = document.getElementById('ucClose');
  var okBtn = document.getElementById('ucOk');
  var timer = setInterval(function() {
    countdown--;
    closeBtn.textContent = '关闭(' + countdown + ')';
    if (countdown <= 0) {
      clearInterval(timer);
      overlay.remove();
    }
  }, 1000);
  closeBtn.onclick = function() { clearInterval(timer); overlay.remove(); };
  okBtn.onclick = function() { clearInterval(timer); overlay.remove(); window.open(url, '_blank'); };
}
function collectData() {
  var selects = document.querySelectorAll('select[data-type="option"]');
  selects.forEach(function(s) {
    data[s.getAttribute('data-key')] = s.value;
  });
  var inputs = document.querySelectorAll('input[data-type="input"]');
  inputs.forEach(function(inp) {
    data[inp.getAttribute('data-key')] = inp.value;
  });
}
function validate() {
  var inputs = document.querySelectorAll('input[data-type="input"]');
  for (var i = 0; i < inputs.length; i++) {
    var inp = inputs[i];
    if (inp.getAttribute('data-nullable') !== 'true' && !inp.value.trim()) {
      inp.scrollIntoView({behavior:'smooth',block:'center'});
      inp.classList.remove('error');
      void inp.offsetWidth;
      inp.classList.add('error');
      inp.focus();
      setTimeout(function(){inp.classList.remove('error')},500);
      return false;
    }
  }
  return true;
}
function applyAnim(pg) {
  var r = document.getElementById('root');
  r.className = 'container';
  if (pg.animType && pg.animType !== 'none') {
    document.documentElement.style.setProperty('--dur', pg.animDur + 'ms');
    void r.offsetWidth;
    r.className = 'container anim-' + pg.animType;
  }
}
function prev() {
  collectData();
  if (currentPage > 0) {
    currentPage--;
    render();
  }
}
function next() {
  if (!validate()) return;
  collectData();
  var prevPg = pages[currentPage];
  if (currentPage < pages.length - 1) {
    currentPage++;
    render();
    applyAnim(prevPg);
  } else {
    var msg = Object.keys(data).map(function(k) {
      return k + '=' + data[k];
    }).join(';');
    if (prevPg.animType && prevPg.animType !== 'none') {
      var r = document.getElementById('root');
      document.documentElement.style.setProperty('--dur', prevPg.animDur + 'ms');
      r.style.animation = 'a' + prevPg.animType.charAt(0).toUpperCase() + prevPg.animType.slice(1) + ' ' + prevPg.animDur + 'ms ease-out reverse';
      setTimeout(function() { parent.postMessage({t:'done', d:data, msg:msg}, '*'); }, prevPg.animDur);
    } else {
      parent.postMessage({t:'done', d:data, msg:msg}, '*');
    }
  }
}
function hide() {
  parent.postMessage({t:'cancel'}, '*');
}
var coverStack = [];
function openModal(pageNum, mode, animType, animDur) {
  var targetIdx = -1;
  for (var i = 0; i < pages.length; i++) {
    if (pages[i].n === pageNum) { targetIdx = i; break; }
  }
  if (targetIdx < 0) return;
  if (mode === 'redirect') {
    collectData();
    currentPage = targetIdx;
    render();
    if (animType && animType !== 'none') {
      var r = document.getElementById('root');
      document.documentElement.style.setProperty('--dur', animDur + 'ms');
      void r.offsetWidth;
      r.className = 'container anim-' + animType;
    }
  } else {
    var overlay = document.createElement('div');
    overlay.className = 'cover-modal';
    var container = document.createElement('div');
    container.className = 'container';
    container.style.cssText = 'opacity:0;transform:translateY(-30px);transition:opacity 0.3s,transform 0.3s';
    overlay.appendChild(container);
    document.body.appendChild(overlay);
    coverStack.push({overlay:overlay, prevPage:currentPage});
    currentPage = targetIdx;
    renderTo(container);
    setTimeout(function() {
      container.style.opacity = '1';
      container.style.transform = 'translateY(0)';
      if (animType && animType !== 'none') {
        document.documentElement.style.setProperty('--dur', animDur + 'ms');
        container.className = 'container anim-' + animType;
      }
    }, 10);
    overlay.onclick = function(ev) {
      if (ev.target === overlay) closeCover();
    };
  }
}
function closeCover() {
  if (coverStack.length === 0) return;
  var item = coverStack.pop();
  item.overlay.querySelector('.container').style.opacity = '0';
  item.overlay.querySelector('.container').style.transform = 'scale(0.9)';
  setTimeout(function() { item.overlay.remove(); }, 300);
  currentPage = item.prevPage;
}
function renderTo(container) {
  var pg = pages[currentPage];
  var isFirst = currentPage === 0;
  var isLast = currentPage === pages.length - 1;
  var nextText = pg.nextContent || (isLast ? '完成' : '下一页');
  if (pg.bgColor) document.documentElement.style.setProperty('--bg', '#'+pg.bgColor);
  if (pg.modalColor) document.documentElement.style.setProperty('--modal', '#'+pg.modalColor);
  if (pg.btnColor) document.documentElement.style.setProperty('--btn', '#'+pg.btnColor);
  var html = '<div class="modal-header">';
  if (pg.title) html += '<h1>'+esc(pg.title)+'</h1>';
  html += '</div><div class="modal-content">';
  var prevNoEnter = false;
  pg.elements.forEach(function(el) {
    if (el.type === 'content') {
      var align = el.align || pg.defaultAlign || globalAlign;
      var style = el.style || pg.defaultStyle || globalStyle;
      var dist = el.distance || pg.defaultDistance || globalDistance;
      var cls = 'desc align-' + align;
      var isUrl = false;
      if (style) {
        style.split('\\').forEach(function(s) {
          if (s) cls += ' style-' + s;
          if (s === 'url') isUrl = true;
        });
      }
      if (dist) cls += ' dist-' + dist;
      if (!el.enter) cls += ' no-enter';
      if (prevNoEnter) cls += ' no-enter';
      prevNoEnter = !el.enter;
      if (isUrl && el.url) {
        html += '<span class="'+cls+'" data-url="'+esc(el.url)+'">'+esc(el.text)+'</span>';
      } else {
        html += '<span class="'+cls+'">'+esc(el.text)+'</span>';
      }
    } else if (el.type === 'option') {
      prevNoEnter = false;
      html += '<div class="form-group">';
      if (el.title) html += '<label>'+esc(el.title)+'</label>';
      html += '<select data-type="option" data-key="'+esc(el.key)+'">';
      el.options.forEach(function(o, j) {
        var sel = j === el.defaultIdx ? ' selected' : '';
        html += '<option value="'+esc(o)+'"'+sel+'>'+esc(o)+'</option>';
      });
      html += '</select></div>';
    } else if (el.type === 'input') {
      prevNoEnter = false;
      html += '<div class="form-group">';
      if (el.title) html += '<label>'+esc(el.title)+'</label>';
      html += '<input type="text" data-type="input" data-key="'+esc(el.key)+'" data-nullable="'+el.nullable+'" placeholder="'+esc(el.desc)+'">';
      html += '</div>';
    } else if (el.type === 'btn') {
      prevNoEnter = false;
      var bgc = el.color || btnColor;
      var btnHtml = '<button class="custom-btn" data-type="btn" data-idx="'+el.idx+'" data-modal="'+el.modal+'" data-mode="'+el.mode+'" data-reclickable="'+el.reclickable+'" data-death-type="'+el.deathType+'" data-death-content="'+esc(el.deathContent)+'" data-anim-type="'+el.animType+'" data-anim-dur="'+el.animDur+'" style="background:#'+bgc+'">'+esc(el.content)+'</button>';
      if (el.align) html += '<div class="btn-wrap align-'+el.align+'">'+btnHtml+'</div>';
      else html += btnHtml;
    } else if (el.type === 'image') {
      prevNoEnter = false;
      var cls = 'custom-img align-'+el.align;
      if (el.clickType !== 'disable') cls += ' clickable';
      html += '<img class="'+cls+'" src="'+esc(el.url)+'" data-type="image" data-idx="'+el.idx+'" data-click-type="'+el.clickType+'" data-modal-id="'+el.modalId+'" data-modal-mode="'+el.modalMode+'" data-modal-anim-type="'+el.modalAnimType+'" data-modal-anim-dur="'+el.modalAnimDur+'" data-switch-urls="'+esc(el.switchUrls.join('|'))+'" data-switch-cycle="'+el.switchCycle+'" data-switch-idx="0">';
    } else if (el.type === 'row') {
      prevNoEnter = false;
      var total = el.ratio.reduce(function(a,b){return a+b},0);
      html += '<div class="row" data-row-idx="'+el.idx+'">';
      el.cols.forEach(function(col,ci) {
        var flex = el.ratio[ci] || 1;
        var pct = (flex/total*100).toFixed(2);
        html += '<div class="row-col align-'+col.align+' valign-'+col.valign+'" style="flex:0 0 '+pct+'%">';
        if (col.type === 'content') {
          var cCls = 'desc';
          var isUrl = false;
          if (col.style) col.style.split('\\').forEach(function(s){if(s){cCls+=' style-'+s;if(s==='url')isUrl=true}});
          if (isUrl && col.url) html += '<span class="'+cCls+'" data-url="'+esc(col.url)+'">'+esc(col.text)+'</span>';
          else html += '<span class="'+cCls+'">'+esc(col.text)+'</span>';
        } else if (col.type === 'btn') {
          var bgc2 = col.color || btnColor;
          html += '<button class="custom-btn" data-type="btn" data-modal="'+col.modal+'" data-mode="'+col.mode+'" data-reclickable="'+col.reclickable+'" data-death-type="'+col.deathType+'" data-death-content="'+esc(col.deathContent)+'" data-anim-type="'+col.animType+'" data-anim-dur="'+col.animDur+'" style="background:#'+bgc2+'">'+esc(col.content)+'</button>';
        } else if (col.type === 'image') {
          var iCls = 'custom-img';
          if (col.clickType !== 'disable') iCls += ' clickable';
          html += '<img class="'+iCls+'" src="'+esc(col.url)+'" data-type="image" data-click-type="'+col.clickType+'" data-modal-id="'+col.modalId+'" data-modal-mode="'+col.modalMode+'" data-modal-anim-type="'+col.modalAnimType+'" data-modal-anim-dur="'+col.modalAnimDur+'" data-switch-urls="'+esc(col.switchUrls.join('|'))+'" data-switch-cycle="'+col.switchCycle+'" data-switch-idx="0" style="max-width:100%">';
        }
        html += '</div>';
      });
      html += '</div>';
    }
  });
  html += '</div><div class="modal-footer">';
  if (coverStack.length > 0) {
    html += '<button class="btn btn-secondary" id="coverCloseBtn">关闭</button>';
  } else {
    if (!isFirst) html += '<button class="btn btn-prev" id="prevBtn">'+esc(pg.lastContent)+'</button>';
    html += '<button class="btn btn-secondary" id="hideBtn">'+esc(pg.hideContent)+'</button>';
    html += '<button class="btn btn-primary" id="nextBtn">'+esc(nextText)+'</button>';
  }
  html += '<div class="version">v1.0.0</div></div>';
  container.innerHTML = html;
  if (coverStack.length > 0) {
    container.querySelector('#coverCloseBtn').onclick = closeCover;
  } else {
    if (!isFirst) container.querySelector('#prevBtn').onclick = prev;
    container.querySelector('#nextBtn').onclick = next;
    container.querySelector('#hideBtn').onclick = hide;
  }
  container.querySelectorAll('[data-url]').forEach(function(el) {
    el.onclick = function() {
      var url = el.getAttribute('data-url');
      if (url.indexOf('https://github.com/Nixdorfer') === 0) window.open(url, '_blank');
      else showUrlConfirm(url);
    };
  });
  container.querySelectorAll('[data-type="btn"]').forEach(function(el) {
    el.onclick = function() {
      if (el.classList.contains('disabled')) return;
      var modal = parseInt(el.getAttribute('data-modal'));
      var mode = el.getAttribute('data-mode');
      var reclickable = el.getAttribute('data-reclickable') === 'true';
      var deathType = el.getAttribute('data-death-type');
      var deathContent = el.getAttribute('data-death-content');
      var animType = el.getAttribute('data-anim-type');
      var animDur = parseInt(el.getAttribute('data-anim-dur'));
      if (!reclickable) {
        if (deathType === 'remove') el.remove();
        else {
          el.classList.add('disabled');
          if (deathContent) el.textContent = deathContent;
        }
      }
      if (modal) openModal(modal, mode, animType, animDur);
    };
  });
  container.querySelectorAll('[data-type="image"]').forEach(function(el) {
    if (el.getAttribute('data-click-type') === 'disable') return;
    el.onclick = function() {
      var clickType = el.getAttribute('data-click-type');
      if (clickType === 'modal') {
        var modalId = parseInt(el.getAttribute('data-modal-id'));
        var modalMode = el.getAttribute('data-modal-mode');
        var animType = el.getAttribute('data-modal-anim-type');
        var animDur = parseInt(el.getAttribute('data-modal-anim-dur'));
        if (modalId) openModal(modalId, modalMode, animType, animDur);
      } else if (clickType === 'switch') {
        var urls = el.getAttribute('data-switch-urls').split('|').filter(function(u){return u;});
        var cycle = el.getAttribute('data-switch-cycle') === 'true';
        var idx = parseInt(el.getAttribute('data-switch-idx'));
        if (urls.length > 0) {
          idx++;
          if (idx >= urls.length) idx = cycle ? 0 : urls.length - 1;
          el.setAttribute('data-switch-idx', idx);
          el.src = urls[idx];
        }
      }
    };
  });
}
render();
document.addEventListener('keydown',function(e){
  if(e.key==='Enter')next();
  else if(e.key==='Escape')hide();
});
})();
</script>
</body>
</html>
