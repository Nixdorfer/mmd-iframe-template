<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:var(--bg);color:#fff;height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden}
.container{background:var(--modal);border-radius:16px;display:flex;flex-direction:column;box-shadow:0 10px 40px rgba(0,0,0,0.3);position:relative;z-index:1}
.modal-header{padding:24px 24px 16px;text-align:center;flex-shrink:0}
.modal-header h1{color:#fff;margin:0}
.modal-content{flex:1;overflow-y:auto;padding:0 24px;scrollbar-width:thin;scrollbar-color:rgba(0,0,0,0.5) transparent;min-height:0}
.modal-footer{padding:16px 24px 24px;flex-shrink:0;display:flex;gap:10px}
.btn{flex:1;padding:14px;border:none;border-radius:8px;font-size:16px;cursor:pointer;transition:filter 0.2s}
.btn-primary{background:var(--btn);color:#fff}
.btn-primary:hover{filter:brightness(1.2)}
.btn-secondary{background:#333;color:#888}
.backdrop{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:0}
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideLeft{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
@keyframes slideRight{from{opacity:0;transform:translateX(-30px)}to{opacity:1;transform:translateX(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes zoomIn{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}
@keyframes zoomOut{from{opacity:0;transform:scale(1.2)}to{opacity:1;transform:scale(1)}}
@keyframes flipH{from{opacity:0;transform:rotateY(90deg)}to{opacity:1;transform:rotateY(0)}}
@keyframes flipV{from{opacity:0;transform:rotateX(90deg)}to{opacity:1;transform:rotateX(0)}}
</style>
</head>
<body>
<div class="backdrop" id="backdrop"></div>
<div class="container" id="root"></div>
<script>
L.load(['util','content','select','input','btn','image','row'],function(){
var C={};
try{C=JSON.parse(decodeURIComponent(escape(atob(L.b64||'e30='))))}catch(e){try{C=JSON.parse(atob(L.b64||'e30='))}catch(e2){}}
var P=L.platform||'pc',G=C.global||{},pages=C.pages||[],curPage=0,data={},state={p:0,d:{},s:0,r:false},btnState={};
function hex2rgba(hex,a){if(!hex)return null;var r=parseInt(hex.substr(0,2),16),g=parseInt(hex.substr(2,2),16),b=parseInt(hex.substr(4,2),16);return'rgba('+r+','+g+','+b+','+a+')';}
function applyGlobal(){
var bg='#'+(G.bgColor||G.bg||'050505');
document.documentElement.style.setProperty('--bg',bg);
document.documentElement.style.setProperty('--modal','#'+(G.defModalBg||G.modal||'0d0d0d'));
document.documentElement.style.setProperty('--btn','#'+(G.defBtnBg||G.btn||'166d3b'));
if(G.bgTransparent)document.body.style.background='transparent';
else if(P==='pc'&&G.bgImgPc)document.body.style.background='url('+G.bgImgPc+') center/cover no-repeat';
else if(P!=='pc'&&G.bgImgMobile)document.body.style.background='url('+G.bgImgMobile+') center/cover no-repeat';
else document.body.style.background=bg;
}
function applyPage(pg){
var modalBg=pg.modalBg||G.defModalBg||G.modal||'0d0d0d';
var opacity=(pg.modalOpacity!==undefined?pg.modalOpacity:(G.defModalOpacity!==undefined?G.defModalOpacity:100))/100;
var blur=pg.modalBlur||G.defModalBlur||0;
var wPct=pg.widthPct||80,hPct=pg.heightPct||80,mwPct=pg.maxWidthPct||100;
var bd=document.getElementById('backdrop'),bw=bd?bd.offsetWidth:window.innerWidth,bh=bd?bd.offsetHeight:window.innerHeight;
var h=bh*hPct/100,w=Math.min(bw*wPct/100,h*mwPct/100);
var root=document.getElementById('root');
var st='width:'+w+'px;height:'+h+'px;background:'+hex2rgba(modalBg,opacity)+';';
if(blur>0)st+='backdrop-filter:blur('+blur+'px);';
if(pg.modalBgImg)st='width:'+w+'px;height:'+h+'px;background:url('+pg.modalBgImg+') center/cover no-repeat;';
root.style.cssText=st;
}
function getAnim(name,dur){if(!name||name==='none')return'';return'animation:'+name+' '+(dur||300)+'ms ease-out';}
var css=[
'.text{display:block;margin-bottom:16px;white-space:pre-wrap}',
'.text.left{text-align:left}.text.right{text-align:right}.text.center{text-align:center}',
'.custom-btn{display:inline-block;padding:10px 20px;border:none;color:#fff;font-size:14px;cursor:pointer;margin:8px 4px;transition:filter .2s}',
'.custom-btn:hover{filter:brightness(1.2)}',
'.custom-btn.disabled{opacity:0.5;cursor:not-allowed}',
'.custom-btn.selected{outline:2px solid #fff;outline-offset:2px}',
'.btn-wrap{display:block;margin:8px 0}.btn-wrap.left{text-align:left}.btn-wrap.center{text-align:center}.btn-wrap.right{text-align:right}',
'.img-wrap{display:block;margin:8px 0;overflow:hidden}',
'.img-wrap.left{margin-right:auto}.img-wrap.right{margin-left:auto}.img-wrap.center{margin:8px auto}',
'.img-wrap img,.img-wrap video{border-radius:8px;display:block;cursor:pointer}',
'.form-group{margin-bottom:16px}',
'.form-group label{display:block;margin-bottom:8px;color:#fff}',
'.form-group select,.form-group input{width:100%;padding:12px;border:none;border-radius:8px;background:#1a1a1a;color:#fff;font-size:16px}',
'.form-group select:focus,.form-group input:focus{outline:2px solid var(--btn)}',
'input.error{outline:2px solid #ff4444;animation:shake .5s}',
'@keyframes shake{0%,100%{transform:translateX(0)}25%,75%{transform:translateX(-8px)}50%{transform:translateX(8px)}}',
'.row{display:flex;margin:8px 0}',
'.row-col{display:flex;flex-direction:column;justify-content:center;align-items:center}',
'.switch{display:flex;align-items:center;justify-content:center;margin:8px 0;gap:10px;cursor:pointer}',
'.switch-track{position:relative;width:44px;height:24px;transition:background .2s}',
'.switch-thumb{position:absolute;top:2px;width:18px;height:18px;transition:left .2s}',
'.collapse{margin:8px 0}',
'.collapse-hd{padding:10px 14px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}',
'.collapse-hd .arrow{transition:transform .2s}',
'.collapse-hd.open .arrow{transform:rotate(90deg)}',
'.collapse-bd{overflow:hidden;transition:max-height .3s;max-height:0}',
'.collapse-bd.open{max-height:1000px}',
'.detail{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:10001;cursor:pointer}',
'.detail img,.detail video{max-width:95%;max-height:95%;object-fit:contain}',
'.gallery-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.2);border:none;color:#fff;padding:20px 15px;cursor:pointer;font-size:24px}',
'.gallery-nav.prev{left:10px}.gallery-nav.next{right:10px}',
'.ed-close{position:fixed;top:10px;left:10px;background:#1a1a1a;border:none;color:#888;width:32px;height:32px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10002;transition:color .2s}.ed-close:hover{color:#fff}',
'.ed-line{border-top:1px dashed #f00;margin:4px 0}',
'.ed-nosel{user-select:none}',
'.img-placeholder{background:#2a2a2a;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#666;min-height:100px}',
'.switch-label{color:#888;font-size:14px}',
'.ed-editing{outline:2px solid var(--btn);background:#1a1a1a;padding:4px;border-radius:4px}',
'.skel{background:linear-gradient(90deg,#1a1a1a 25%,#252525 50%,#1a1a1a 75%);background-size:200% 100%;animation:skel 1.5s infinite}',
'@keyframes skel{0%{background-position:200% 0}100%{background-position:-200% 0}}',
'.skel-text{height:16px;border-radius:4px;margin:8px 0}',
'.skel-btn{height:40px;border-radius:20px;margin:8px 0}',
'.skel-img{height:100px;border-radius:8px;margin:8px 0}'
].join('\n');
var style=document.createElement('style');style.textContent=css;document.head.appendChild(style);
applyGlobal();
function renderText(el,pg){
if(L.edit&&!el.value)return'<div class="skel skel-text" style="width:60%"></div>';
var size=el.size||pg.defTextSize||G.defTextSize||14;
var color=el.color||pg.defTextColor||G.defTextColor||'888888';
var font=el.font||pg.defTextFont||G.defTextFont||'system-ui';
var st='font-size:'+size+'px;color:#'+color+';font-family:'+font+';';
if(el.bold)st+='font-weight:bold;';
if(el.italic)st+='font-style:italic;';
if(el.underline)st+='text-decoration:underline;';
if(el.strike)st+='text-decoration:line-through;';
if(el.bgColor){var bgOp=(100-(el.bgOpacity!==undefined?el.bgOpacity:0))/100;st+='background:'+hex2rgba(el.bgColor,bgOp)+';padding:4px 8px;border-radius:4px;'}
if(el.opacity!==undefined&&el.opacity>0)st+='opacity:'+((100-el.opacity)/100)+';';
return'<div class="text '+(el.align||'center')+'" style="'+st+'">'+U.esc(el.value||'')+'</div>';
}
function renderImage(el,pg){
var url=el.url||el.urlInput||'';
if(url&&url.charAt(0)==='/')url='https://r2.sexyai.top'+url;
if(!url){if(L.edit)return'<div class="img-placeholder" style="width:'+(el.width||100)+'%;height:'+(el.height||100)+'px"><svg viewBox="0 0 24 24" width="32" height="32" stroke="currentColor" fill="none" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></div>';return''}
var isVideo=/\.(mp4|webm|ogg)$/i.test(url);
var mode=el.displayMode||'fixedWidth';
var st='';
if(mode==='fixedWidth')st='width:100%;height:auto;';
else if(mode==='fixedHeight')st='height:'+(el.height||200)+'px;width:auto;';
else if(mode==='cover')st='width:100%;height:'+(el.height||200)+'px;object-fit:cover;';
else st='width:100%;height:'+(el.height||200)+'px;object-fit:contain;';
if(el.opacity!==undefined&&el.opacity<100)st+='opacity:'+(el.opacity/100)+';';
var attr=' data-detail="true"';
if(el.clickAction==='gallery'&&el.galleryUrls)attr=' data-gallery="'+U.esc(el.galleryUrls)+'"';
else if(el.clickAction&&el.clickAction!=='none')attr=' data-click="'+el.clickAction+'" data-target="'+(el.clickTarget||0)+'"';
var tag=isVideo?'<video src="'+U.esc(url)+'" style="'+st+'" autoplay loop muted playsinline'+attr+'></video>':'<img src="'+U.esc(url)+'" style="'+st+'"'+attr+'>';
return'<div class="img-wrap '+(el.align||'center')+'" style="width:'+(el.width||100)+'%">'+tag+'</div>';
}
function renderBtn(el,pg){
if(L.edit&&!el.value)return'<div class="skel skel-btn" style="width:40%"></div>';
var shape=el.shape||pg.defBtnShape||G.defBtnShape||'rounded';
var bgColor=el.bgColor||pg.defBtnBg||G.defBtnBg||'166d3b';
var textColor=el.textColor||pg.defBtnColor||G.defBtnColor||'ffffff';
var radius=el.radius!==undefined?el.radius:(G.defBtnRadius||8);
var st='background:#'+bgColor+';color:#'+textColor+';';
if(shape==='rounded')st+='border-radius:'+radius+'px;';
else if(shape==='rect')st+='border-radius:0;';
else if(shape==='hexagon')st+='clip-path:polygon('+(el.hexWidth||15)+'% 0,'+((100-(el.hexWidth||15)))+'% 0,100% 50%,'+((100-(el.hexWidth||15)))+'% 100%,'+(el.hexWidth||15)+'% 100%,0 50%);';
if(el.borderWidth)st+='box-shadow:inset 0 0 0 '+el.borderWidth+'px #'+(el.borderColor||'166d3b')+';';
if(el.textSize)st+='font-size:'+el.textSize+'px;';
if(el.textFont)st+='font-family:'+el.textFont+';';
if(el.textBold)st+='font-weight:bold;';
if(el.textItalic)st+='font-style:italic;';
if(el.textUnderline)st+='text-decoration:underline;';
if(el.textStrike)st+='text-decoration:line-through;';
if(el.textOpacity)st+='opacity:'+((100-el.textOpacity)/100)+';';
if(el.width)st+='width:'+el.width+'%;';
var attr=' data-action="'+(el.clickAction||'none')+'"';
if(el.clickTarget)attr+=' data-target="'+el.clickTarget+'"';
if(el.message)attr+=' data-msg="'+U.esc(el.message)+'"';
if(el.sysEffect==='killer')attr+=' data-killer="true"';
if(el.sysEffect==='hider')attr+=' data-hider="true"';
if(el.logicGroup)attr+=' data-group="'+U.esc(el.logicGroup)+'" data-max="'+(el.logicMax||1)+'"';
if(el.styleGroup)attr+=' data-style="'+U.esc(el.styleGroup)+'"';
if(!el.repeatable&&el.repeatable!==undefined)attr+=' data-once="true" data-after="'+(el.afterClick||'none')+'" data-disabled="'+U.esc(el.disabledStyle||'333333')+'"';
var h='<button class="custom-btn" style="'+st+'"'+attr+'>'+U.esc(el.value||'按钮')+'</button>';
if(el.align)return'<div class="btn-wrap '+el.align+'">'+h+'</div>';
return h;
}
function renderInput(el){
var h='<div class="form-group">';
if(el.title){var ts='';if(el.titleSize)ts+='font-size:'+el.titleSize+'px;';if(el.titleFont)ts+='font-family:'+el.titleFont+';';if(el.titleBold)ts+='font-weight:bold;';if(el.titleItalic)ts+='font-style:italic;';if(el.titleUnderline)ts+='text-decoration:underline;';if(el.titleStrike)ts+='text-decoration:line-through;';if(el.titleColor)ts+='color:#'+el.titleColor+';';if(el.titleOpacity)ts+='opacity:'+((100-el.titleOpacity)/100)+';';h+='<label style="'+ts+'">'+U.esc(el.title)+'</label>';}
h+='<input type="text" data-key="'+U.esc(el.key||'')+'" data-required="'+(el.required!==false)+'" placeholder="'+U.esc(el.placeholder||'')+'">';
return h+'</div>';
}
function renderSelect(el){
var h='<div class="form-group">';
if(el.title){var ts='';if(el.titleSize)ts+='font-size:'+el.titleSize+'px;';if(el.titleFont)ts+='font-family:'+el.titleFont+';';if(el.titleBold)ts+='font-weight:bold;';if(el.titleItalic)ts+='font-style:italic;';if(el.titleUnderline)ts+='text-decoration:underline;';if(el.titleStrike)ts+='text-decoration:line-through;';if(el.titleColor)ts+='color:#'+el.titleColor+';';if(el.titleOpacity)ts+='opacity:'+((100-el.titleOpacity)/100)+';';h+='<label style="'+ts+'">'+U.esc(el.title)+'</label>';}
h+='<select data-key="'+U.esc(el.key||'')+'">';
var opts=Array.isArray(el.options)?el.options:(el.options||'').split?el.options.split('\n'):[];
opts.forEach(function(o,i){h+='<option value="'+U.esc(o)+'"'+(i===(el.default||0)?' selected':'')+'>'+U.esc(o)+'</option>'});
return h+'</select></div>';
}
function renderSwitch(el){
var isOn=el.defaultOn;
var bg=isOn?(el.onBg||'166d3b'):(el.offBg||'333333');
var style=el.style||'capsule';
var br=style==='capsule'?'12px':'4px';
var tbr=style==='capsule'?'50%':'2px';
var h='';
if(el.title){var ts='color:#fff;margin-bottom:6px;';if(el.titleSize)ts+='font-size:'+el.titleSize+'px;';if(el.titleFont)ts+='font-family:'+el.titleFont+';';if(el.titleBold)ts+='font-weight:bold;';if(el.titleItalic)ts+='font-style:italic;';if(el.titleUnderline)ts+='text-decoration:underline;';if(el.titleStrike)ts+='text-decoration:line-through;';if(el.titleColor)ts+='color:#'+el.titleColor+';';if(el.titleOpacity)ts+='opacity:'+((100-el.titleOpacity)/100)+';';h+='<div style="'+ts+'">'+U.esc(el.title)+'</div>';}
h+='<div class="switch" data-key="'+U.esc(el.key||'')+'" data-on="'+U.esc(el.onValue||'on')+'" data-off="'+U.esc(el.offValue||'off')+'" data-state="'+(isOn?'on':'off')+'">';
if(el.leftText)h+='<span class="switch-label">'+U.esc(el.leftText)+'</span>';
h+='<div class="switch-track" style="background:#'+bg+';border:1px solid #'+(el.borderColor||'444444')+';border-radius:'+br+'"><div class="switch-thumb" style="left:'+(isOn?'22px':'2px')+';background:#'+(el.thumbColor||'ffffff')+';border-radius:'+tbr+'"></div></div>';
if(el.rightText)h+='<span class="switch-label">'+U.esc(el.rightText)+'</span>';
return h+'</div>';
}
function renderCollapse(el,pg){
var h='<div class="collapse"><div class="collapse-hd'+(el.defaultOpen?' open':'')+'" style="background:#'+(el.titleBg||'1a1a1a')+';border-radius:6px">';
var txtSt='font-size:'+(el.titleSize||14)+'px;color:#'+(el.titleColor||'ffffff')+';';
if(el.titleFont)txtSt+='font-family:'+el.titleFont+';';
if(el.titleBold)txtSt+='font-weight:bold;';
if(el.titleItalic)txtSt+='font-style:italic;';
if(el.titleUnderline)txtSt+='text-decoration:underline;';
if(el.titleStrike)txtSt+='text-decoration:line-through;';
if(el.titleOpacity)txtSt+='opacity:'+((100-el.titleOpacity)/100)+';';
h+='<span style="'+txtSt+'">'+U.esc(el.title||'')+'</span><span class="arrow" style="color:#'+(el.arrowColor||'888888')+'">▶</span></div>';
h+='<div class="collapse-bd'+(el.defaultOpen?' open':'')+'" style="background:#'+(el.contentBg||'0d0d0d')+';padding:0 12px;border-radius:0 0 6px 6px">';
(el.items||[]).forEach(function(item){h+=renderEl(item,pg)});
if(L.edit)h+='<div class="collapse-drop" style="height:30px;border:1px dashed #444;border-radius:4px;margin:8px 0;display:flex;align-items:center;justify-content:center;color:#666;font-size:12px">拖入组件</div>';
return h+'</div></div>';
}
function renderEl(el,pg){
if(el.type==='text')return renderText(el,pg);
if(el.type==='btn')return renderBtn(el,pg);
if(el.type==='image')return renderImage(el,pg);
if(el.type==='input')return renderInput(el);
if(el.type==='select')return renderSelect(el);
if(el.type==='switch')return renderSwitch(el);
if(el.type==='collapse')return renderCollapse(el,pg);
return'';
}
function renderRow(el,pg,elIdx){
var ratio=Array.isArray(el.ratio)?el.ratio:(el.ratio||'1').split(':').map(function(x){return parseInt(x)||1});
var total=ratio.reduce(function(a,b){return a+b},0);
var gap=el.gap||8;
var valign=el.valign||'center';
var hbind=el.heightBind?'data-hbind="'+el.heightBind+'"':'';
var h='<div class="row" style="gap:'+gap+'px;align-items:'+(valign==='top'?'flex-start':valign==='bottom'?'flex-end':'center')+'" '+hbind+'>';
(el.cols||[]).forEach(function(col,i){
var pct=(ratio[i]||1)/total*100;
var colAttr=L.edit?' data-ei="'+elIdx+'" data-ci="'+i+'"':'';
h+='<div class="row-col'+(L.edit?' ed-col':'')+'" style="flex:0 0 calc('+pct.toFixed(2)+'% - '+gap+'px)"'+colAttr+'>'+renderEl(col,pg)+'</div>';
});
return h+'</div>';
}
function syncBtnSizes(){
var groups={};
document.querySelectorAll('.custom-btn[data-lock="true"]').forEach(function(btn){
var g=btn.dataset.group||'_default';
if(!groups[g])groups[g]=[];
groups[g].push(btn);
});
Object.keys(groups).forEach(function(g){
var btns=groups[g],maxW=0,maxH=0;
btns.forEach(function(b){maxW=Math.max(maxW,b.offsetWidth);maxH=Math.max(maxH,b.offsetHeight)});
btns.forEach(function(b){b.style.width=maxW+'px';b.style.height=maxH+'px'});
});
}
function syncRowHeights(){
var groups={};
document.querySelectorAll('.row[data-hbind]').forEach(function(row){
var g=row.dataset.hbind;
if(!groups[g])groups[g]=[];
groups[g].push(row);
});
Object.keys(groups).forEach(function(g){
var rows=groups[g],maxH=0;
rows.forEach(function(r){r.style.height='auto'});
rows.forEach(function(r){maxH=Math.max(maxH,r.offsetHeight)});
rows.forEach(function(r){r.style.height=maxH+'px'});
});
}
function render(anim){
var pg=pages[curPage]||{title:'',elements:[]};
applyPage(pg);
var isFirst=curPage===0,isLast=curPage===pages.length-1;
var animStyle=anim?getAnim(anim,300):'';
var h='<div class="modal-header"'+(animStyle?' style="'+animStyle+'"':'')+'>';
if(pg.title)h+='<h1>'+U.esc(pg.title)+'</h1>';
h+='</div>';
if(L.edit)h+='<div class="ed-line"></div>';
h+='<div class="modal-content"'+(animStyle?' style="'+animStyle+'"':'')+'>';
(pg.elements||[]).forEach(function(el,idx){
var wrap=L.edit?'<div class="ed-el" data-idx="'+idx+'">':'';
var wrapEnd=L.edit?'</div>':'';
if(el.type==='row')h+=wrap+renderRow(el,pg,idx)+wrapEnd;
else h+=wrap+renderEl(el,pg)+wrapEnd;
});
h+='</div>';
if(L.edit)h+='<div class="ed-line"></div>';
if(L.edit)h+='<div class="modal-footer"></div>';
else{h+='<div class="modal-footer">';h+='<button class="btn btn-secondary" id="hideBtn">'+(pg.hideText||'隐藏')+'</button>';h+='<button class="btn btn-primary" id="nextBtn">'+(pg.nextText||(isLast?'完成':'下一页'))+'</button>';h+='</div>'}
document.getElementById('root').innerHTML=h;
if(L.edit)document.body.classList.add('ed-nosel');
if(!L.edit){document.getElementById('hideBtn').onclick=hide;document.getElementById('nextBtn').onclick=next}
bindBtns();
bindImages();
bindSwitches();
bindCollapse();
applyState();
syncBtnSizes();
syncRowHeights();
var imgs=document.querySelectorAll('.modal-content img');
var loaded=0;
imgs.forEach(function(img){
if(img.complete)loaded++;
else img.onload=function(){loaded++;if(loaded===imgs.length){syncRowHeights();syncBtnSizes()}}
});
}
function bindBtns(){
document.querySelectorAll('.custom-btn').forEach(function(el){
el.onclick=function(){
var action=el.dataset.action,target=parseInt(el.dataset.target)||0,msg=el.dataset.msg;
var once=el.dataset.once==='true',after=el.dataset.after,disColor=el.dataset.disabled;
var group=el.dataset.group,max=parseInt(el.dataset.max)||1;
if(el.classList.contains('disabled'))return;
if(group){
var selected=document.querySelectorAll('.custom-btn[data-group="'+group+'"].selected');
if(el.classList.contains('selected')){el.classList.remove('selected')}
else if(selected.length<max){el.classList.add('selected')}
else if(max===1){selected[0].classList.remove('selected');el.classList.add('selected')}
return;
}
if(once&&btnState[el.textContent]){return}
if(el.dataset.killer==='true'){collect();parent.postMessage({t:'done',d:data,msg:toMsg()},'*');return}
if(el.dataset.hider==='true'){hide();return}
if(msg){collect();parent.postMessage({t:'done',d:data,msg:toMsg()+';'+msg},'*');return}
if(action==='jumpModal'&&target>0){curPage=target-1;render(pages[curPage]?.prevAnim||'slideLeft');return}
if(once){
btnState[el.textContent]=true;
if(after==='hide')el.style.display='none';
else if(after==='disable'){el.classList.add('disabled');if(disColor)el.style.background='#'+disColor}
}
};
});
}
function bindImages(){
document.querySelectorAll('.img-wrap img,.img-wrap video').forEach(function(el){
el.onclick=function(){
var gallery=el.dataset.gallery;
if(gallery){showGallery(gallery.split('\n').filter(function(x){return x.trim()}),0);return}
var click=el.dataset.click,target=parseInt(el.dataset.target)||0;
if(click==='jumpModal'&&target>0){curPage=target-1;render();return}
if(el.dataset.detail==='true')showDetail(el.src||el.currentSrc);
};
});
}
function bindSwitches(){
document.querySelectorAll('.switch').forEach(function(sw){
sw.onclick=function(){
var isOn=sw.dataset.state==='on';
sw.dataset.state=isOn?'off':'on';
var track=sw.querySelector('.switch-track');
var thumb=sw.querySelector('.switch-thumb');
var onBg=track.style.background.match(/#[0-9a-f]{6}/i);
track.style.background=isOn?'#333333':'#166d3b';
thumb.style.left=isOn?'2px':'22px';
};
});
}
function bindCollapse(){
document.querySelectorAll('.collapse-hd').forEach(function(hd){
hd.onclick=function(){
hd.classList.toggle('open');
var bd=hd.nextElementSibling;
if(bd)bd.classList.toggle('open');
};
});
}
function showDetail(src){
var isVideo=/\.(mp4|webm|ogg)$/i.test(src);
var d=document.createElement('div');
d.className='detail';
d.innerHTML=isVideo?'<video src="'+src+'" autoplay controls></video>':'<img src="'+src+'">';
d.onclick=function(){d.remove()};
document.body.appendChild(d);
}
function showGallery(urls,idx){
var d=document.createElement('div');
d.className='detail';
function upd(){
var isVideo=/\.(mp4|webm|ogg)$/i.test(urls[idx]);
d.innerHTML=(isVideo?'<video src="'+urls[idx]+'" autoplay controls></video>':'<img src="'+urls[idx]+'">')+'<button class="gallery-nav prev">&lt;</button><button class="gallery-nav next">&gt;</button>';
d.querySelector('.prev').onclick=function(e){e.stopPropagation();idx=(idx-1+urls.length)%urls.length;upd()};
d.querySelector('.next').onclick=function(e){e.stopPropagation();idx=(idx+1)%urls.length;upd()};
}
upd();
d.onclick=function(e){if(e.target===d)d.remove()};
document.body.appendChild(d);
}
function collect(){
document.querySelectorAll('select[data-key]').forEach(function(s){data[s.dataset.key]=s.value});
document.querySelectorAll('input[data-key]').forEach(function(i){data[i.dataset.key]=i.value});
document.querySelectorAll('.switch[data-key]').forEach(function(sw){
var k=sw.dataset.key,isOn=sw.dataset.state==='on';
data[k]=isOn?sw.dataset.on:sw.dataset.off;
});
document.querySelectorAll('.custom-btn.selected').forEach(function(b){
var g=b.dataset.group;if(g){if(!data[g])data[g]=[];data[g].push(b.textContent)}
});
}
function toMsg(){return Object.keys(data).map(function(k){var v=data[k];return k+'='+(Array.isArray(v)?v.join(','):v)}).join(';')}
function validate(){
var inputs=document.querySelectorAll('input[data-required="true"]');
for(var i=0;i<inputs.length;i++){
if(!inputs[i].value.trim()){inputs[i].classList.add('error');inputs[i].focus();setTimeout(function(){inputs[i].classList.remove('error')},500);return false}
}
return true;
}
function prev(anim){collect();if(curPage>0){curPage--;render(anim||'slideRight')}}
function next(anim){
if(!validate())return;
collect();
if(curPage<pages.length-1){curPage++;render(anim||'slideLeft')}
else if(L.preview){parent.postMessage({t:'exitPreview'},'*')}
else{parent.postMessage({t:'done',d:data,msg:toMsg()},'*')}
}
function hide(){if(L.preview){parent.postMessage({t:'exitPreview'},'*');return}collect();state.p=curPage;state.d=JSON.parse(JSON.stringify(data));var mc=document.querySelector('.modal-content');state.s=mc?mc.scrollTop:0;parent.postMessage({t:'cancel'},'*')}
function applyState(){
if(!state.r&&Object.keys(state.d).length>0){curPage=state.p;data=JSON.parse(JSON.stringify(state.d))}
state.r=true;
Object.keys(data).forEach(function(k){
var sel=document.querySelector('select[data-key="'+k+'"]');if(sel)sel.value=data[k];
var inp=document.querySelector('input[data-key="'+k+'"]');if(inp)inp.value=data[k];
});
var mc=document.querySelector('.modal-content');if(mc&&state.s)mc.scrollTop=state.s;
}
render();
document.addEventListener('keydown',function(e){if(e.key==='Enter'&&!L.edit)next();else if(e.key==='Escape'&&!L.edit)hide()});
if(!L.edit)document.getElementById('backdrop').onclick=hide;
if(L.edit){
window.modalRender=function(d){C=d;G=C.global||{};pages=C.pages||[];applyGlobal();render();var cb=document.querySelector('.ed-close');if(cb)cb.style.display=(C.sys&&C.sys.unload)?'none':'block'};
var cb=document.createElement('button');cb.className='ed-close';cb.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>';cb.onclick=hide;cb.style.display=(C.sys&&C.sys.unload)?'none':'block';document.body.appendChild(cb);
document.addEventListener('dblclick',function(e){var txt=e.target.closest('.text');if(!txt)return;var el=txt.closest('.ed-el');if(!el)return;var idx=parseInt(el.dataset.idx);txt.contentEditable='true';txt.classList.add('ed-editing');txt.focus();var pg=pages[curPage];txt.onblur=function(){txt.contentEditable='false';txt.classList.remove('ed-editing');if(pg&&pg.elements&&pg.elements[idx])pg.elements[idx].value=txt.textContent;parent.postMessage({t:'edUpdate',d:C},'*')};txt.onkeydown=function(ev){if(ev.key==='Enter'&&!ev.shiftKey){ev.preventDefault();txt.blur()}}});
}
});
</script>
</body>
</html>
