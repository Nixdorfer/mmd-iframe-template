<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>世界引擎 v3</title>
	<style>
* {
	margin: 0;
	padding: 0;
	box-sizing: border-box;
	user-select: none;
}

body {
	background: #050505;
	font-family: system-ui, sans-serif;
	color: #fff;
	height: 100vh;
	overflow: hidden;
}

.app {
	display: flex;
	flex-direction: column;
	height: 100%;
}

.toolbar {
	height: 48px;
	background: #1a1a1a;
	border-bottom: 1px solid #333;
	display: flex;
	align-items: center;
	padding: 0 12px;
	gap: 8px;
	flex-shrink: 0;
}

.tool-group {
	display: flex;
	gap: 4px;
	padding: 0 8px;
	border-right: 1px solid #333;
}

.tool-group:last-child {
	border-right: none;
}

.tool-btn {
	width: 36px;
	height: 36px;
	background: transparent;
	border: 1px solid transparent;
	border-radius: 6px;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
	transition: all 0.15s;
}

.tool-btn:hover {
	background: #333;
}

.tool-btn.active {
	background: #166d3b;
	border-color: #1c8548;
}

.tool-btn svg {
	width: 20px;
	height: 20px;
	stroke: #aaa;
	fill: none;
	stroke-width: 1.5;
}

.tool-btn.active svg {
	stroke: #fff;
}

.tool-btn:disabled {
	opacity: 0.4;
	cursor: not-allowed;
}

.file-buttons {
	margin-left: auto;
	display: flex;
	gap: 8px;
}

.file-btn {
	height: 32px;
	padding: 0 12px;
	background: #333;
	border: none;
	border-radius: 6px;
	color: #aaa;
	font-size: 12px;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 6px;
}

.file-btn:hover {
	background: #444;
}

.file-btn.primary {
	background: #166d3b;
	color: #fff;
}

.file-btn.primary:hover {
	background: #1c8548;
}

.file-btn svg {
	width: 16px;
	height: 16px;
	stroke: currentColor;
	fill: none;
	stroke-width: 1.5;
}

.prv-btn {
	height: 32px;
	padding: 0 16px;
	background: #2563eb;
	border: none;
	border-radius: 6px;
	color: #fff;
	font-size: 12px;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 6px;
	margin-left: 8px;
}

.prv-btn:hover {
	background: #3b82f6;
}

.prv-btn svg {
	width: 16px;
	height: 16px;
	stroke: currentColor;
	fill: none;
	stroke-width: 1.5;
}

.section-tabs {
	height: 40px;
	background: #0a0a0a;
	border-bottom: 1px solid #333;
	display: flex;
	align-items: center;
	padding: 0 12px;
	gap: 4px;
	flex-shrink: 0;
}

.section-tab {
	height: 32px;
	padding: 0 16px;
	background: transparent;
	border: 1px solid transparent;
	border-radius: 6px;
	color: #888;
	font-size: 13px;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 6px;
	transition: all 0.15s;
}

.section-tab:hover {
	color: #aaa;
	background: #1a1a1a;
}

.section-tab.active {
	color: #fff;
	background: #1a1a1a;
	border-color: #333;
}

.section-tab svg {
	width: 16px;
	height: 16px;
	stroke: currentColor;
	fill: none;
	stroke-width: 1.5;
}

.section-cnt {
	display: none;
	flex: 1;
	overflow: auto;
	padding: 16px;
	background: #0a0a0a;
}

.section-cnt.active {
	display: block;
}

.section-split {
	flex: 1;
	display: none;
	min-height: 0;
}

.section-split.active {
	display: flex;
}

.section-split .sec-le-pn {
	width: 33.333%;
	min-width: 200px;
	max-width: 400px;
	background: #111111;
	border-right: 1px solid #333;
	display: flex;
	flex-direction: column;
	flex-shrink: 0;
}

.section-split .sec-ri-pn {
	flex: 1;
	background: #0a0a0a;
	display: flex;
	flex-direction: column;
	overflow: hidden;
}

.section-split .pn-hd {
	padding: 12px;
	font-size: 13px;
	font-weight: 600;
	color: #888;
	text-transform: uppercase;
	letter-spacing: 0.5px;
	border-bottom: 1px solid #333;
	flex-shrink: 0;
}

.section-split .pn-bd {
	flex: 1;
	overflow-y: auto;
	padding: 8px;
}

.section-split .sec-ri-pn .pn-bd {
	padding: 16px;
}

.bld-tlb {
	height: 40px;
	background: #1a1a1a;
	border-bottom: 1px solid #333;
	display: flex;
	align-items: center;
	padding: 0 12px;
	gap: 4px;
	flex-shrink: 0;
}

.bld-tool-btn {
	height: 32px;
	padding: 0 12px;
	background: transparent;
	border: 1px solid transparent;
	border-radius: 6px;
	color: #888;
	font-size: 12px;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 6px;
	transition: all 0.15s;
}

.bld-tool-btn:hover {
	background: #333;
	color: #aaa;
}

.bld-tool-btn.active {
	background: #166d3b;
	border-color: #1c8548;
	color: #fff;
}

.bld-tool-btn svg {
	width: 16px;
	height: 16px;
	stroke: currentColor;
	fill: none;
	stroke-width: 1.5;
}

.bld-lyr-lst {
	display: flex;
	flex-direction: column;
	gap: 4px;
}

.bld-lyr-item {
	display: flex;
	align-items: center;
	justify-content: space-between;
	gap: 8px;
	padding: 8px 12px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 6px;
	cursor: pointer;
	font-size: 13px;
	transition: all 0.15s;
}

.bld-lyr-item:hover {
	background: #252525;
}

.bld-lyr-item.sel {
	border-color: #166d3b;
	background: #14291f;
}

.bld-lyr-add {
	width: 100%;
	height: 32px;
	background: #166d3b;
	border: none;
	border-radius: 6px;
	color: #fff;
	font-size: 12px;
	cursor: pointer;
	margin-top: 8px;
	transition: background 0.15s;
}

.bld-lyr-add:hover {
	background: #1c8548;
}

.bld-cv-ctn {
	flex: 1;
	position: relative;
	overflow: hidden;
	background: #050505;
}

.bld-cv-ctn canvas {
	position: absolute;
	top: 0;
	left: 0;
}

.bld-info {
	position: absolute;
	bottom: 10px;
	left: 10px;
	background: rgba(0,0,0,0.7);
	padding: 6px 12px;
	border-radius: 4px;
	font-size: 12px;
	color: #888;
}

.bld-props {
	border-top: 1px solid #333;
	padding: 12px;
	max-height: 200px;
	overflow-y: auto;
	flex-shrink: 0;
}

.type-tabs {
	display: flex;
	gap: 4px;
	margin-bottom: 12px;
}

.type-tab {
	flex: 1;
	height: 28px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	color: #888;
	font-size: 11px;
	cursor: pointer;
	transition: all 0.15s;
}

.type-tab:hover {
	background: #252525;
}

.type-tab.active {
	background: #166d3b;
	border-color: #1c8548;
	color: #fff;
}

.ast-cat-lst {
	display: flex;
	flex-direction: column;
	gap: 4px;
}

.ast-cat-item {
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 6px;
}

.ast-cat-hd {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 10px 12px;
	cursor: pointer;
	font-size: 13px;
	transition: background 0.15s;
}

.ast-cat-hd:hover {
	background: #252525;
}

.ast-cat-hd .arrow {
	transition: transform 0.2s;
	stroke: #666;
}

.ast-cat-hd.open .arrow {
	transform: rotate(90deg);
}

.ast-cat-bd {
	display: none;
	padding: 8px;
	border-top: 1px solid #333;
}

.ast-cat-bd.open {
	display: block;
}

.ast-item {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 6px 8px;
	background: #252525;
	border-radius: 4px;
	margin-bottom: 4px;
	cursor: pointer;
	font-size: 12px;
	transition: background 0.15s;
}

.ast-item:hover {
	background: #333;
}

.ast-item.sel {
	background: #166d3b;
}

.ast-add-btn {
	width: 100%;
	height: 28px;
	background: transparent;
	border: 1px dashed #444;
	border-radius: 4px;
	color: #888;
	font-size: 11px;
	cursor: pointer;
	transition: all 0.15s;
}

.ast-add-btn:hover {
	background: #252525;
	border-color: #555;
}

.ast-add-btn.ai-con {
	background: #14532d;
	border-color: #166d3b;
	border-style: solid;
	color: #4ade80;
}

.ast-sub-fld {
	margin-bottom: 4px;
}

.ast-sub-hd {
	display: flex;
	align-items: center;
	gap: 6px;
	padding: 4px 6px;
	cursor: pointer;
	font-size: 11px;
	color: #888;
	border-radius: 3px;
	transition: background 0.15s;
}

.ast-sub-hd:hover {
	background: #2a2a2a;
}

.ast-sub-hd .arrow {
	transition: transform 0.2s;
	stroke: #666;
}

.ast-sub-hd.open .arrow {
	transform: rotate(90deg);
}

.ast-sub-bd {
	display: none;
	padding-left: 16px;
}

.ast-sub-bd.open {
	display: block;
}

.ast-item.sys {
	opacity: 0.7;
	cursor: default;
}

.ast-item.sys:hover {
	background: #252525;
}

.spawn-cfg-lst {
	display: flex;
	flex-direction: column;
	gap: 4px;
}

.spawn-cfg-item {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 8px 12px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 6px;
	cursor: pointer;
	font-size: 13px;
	transition: all 0.15s;
}

.spawn-cfg-item:hover {
	background: #252525;
}

.spawn-cfg-item.sel {
	border-color: #166d3b;
	background: #14291f;
}

.spawn-cfg-add {
	width: 100%;
	height: 28px;
	background: transparent;
	border: 1px dashed #444;
	border-radius: 4px;
	color: #888;
	font-size: 11px;
	cursor: pointer;
	margin-top: 4px;
	transition: all 0.15s;
}

.spawn-cfg-add:hover {
	background: #252525;
	border-color: #555;
}

.map-lst {
	display: flex;
	flex-direction: column;
	gap: 4px;
}

.map-item {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 8px 12px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 6px;
	cursor: pointer;
	font-size: 13px;
	transition: all 0.15s;
}

.map-item:hover {
	background: #252525;
}

.map-item.sel {
	border-color: #166d3b;
	background: #14291f;
}

.map-add {
	width: 100%;
	height: 32px;
	background: #166d3b;
	border: none;
	border-radius: 6px;
	color: #fff;
	font-size: 12px;
	cursor: pointer;
	margin-top: 8px;
	transition: background 0.15s;
}

.map-add:hover {
	background: #1c8548;
}

.map-cat-lst {
	display: flex;
	flex-direction: column;
	gap: 4px;
}

.map-cat-item {
	display: flex;
	align-items: center;
	padding: 10px 12px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 6px;
	cursor: pointer;
	font-size: 13px;
	transition: all 0.15s;
}

.map-cat-item:hover {
	background: #252525;
}

.map-cat-item.sel {
	border-color: #166d3b;
	background: #14291f;
}

.weather-lst {
	display: flex;
	flex-direction: column;
	gap: 4px;
}

.weather-item {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 8px 12px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 6px;
	cursor: pointer;
	font-size: 13px;
	transition: all 0.15s;
}

.weather-item:hover {
	background: #252525;
}

.weather-item.sel {
	border-color: #166d3b;
	background: #14291f;
}

.weather-add {
	width: 100%;
	height: 32px;
	background: #166d3b;
	border: none;
	border-radius: 6px;
	color: #fff;
	font-size: 12px;
	cursor: pointer;
	margin-top: 8px;
	transition: background 0.15s;
}

.weather-add:hover {
	background: #1c8548;
}

.sys-cat-lst {
	display: flex;
	flex-direction: column;
	gap: 4px;
}

.sys-cat-item {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 8px 12px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 6px;
	cursor: pointer;
	font-size: 13px;
	transition: all 0.15s;
}

.sys-cat-item:hover {
	background: #252525;
}

.sys-cat-item.sel {
	border-color: #166d3b;
	background: #14291f;
}

.skill-lst {
	display: flex;
	flex-direction: column;
	gap: 4px;
}

.skill-item {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 8px 12px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 6px;
	cursor: pointer;
	font-size: 13px;
	transition: all 0.15s;
}

.skill-item:hover {
	background: #252525;
}

.skill-item.sel {
	border-color: #166d3b;
	background: #14291f;
}

.skill-add {
	width: 100%;
	height: 32px;
	background: #166d3b;
	border: none;
	border-radius: 6px;
	color: #fff;
	font-size: 12px;
	cursor: pointer;
	margin-top: 8px;
	transition: background 0.15s;
}

.skill-add:hover {
	background: #1c8548;
}

.main {
	flex: 1;
	display: flex;
	min-height: 0;
	position: relative;
}

.le-pn {
	width: 220px;
	background: #111111;
	border-right: 1px solid #333;
	display: flex;
	flex-direction: column;
	flex-shrink: 0;
	transition: width 0.2s;
	overflow: hidden;
}

.le-pn.collapsed {
	width: 32px;
}

.le-pn.collapsed .pn-body,
.le-pn.collapsed .pn-title-text {
	display: none;
}

.le-pn.collapsed .pn-header {
	writing-mode: vertical-rl;
	text-orientation: mixed;
	padding: 12px 8px;
	justify-content: flex-start;
}

.le-pn.collapsed .pn-toggle svg {
	transform: rotate(180deg);
}

.ri-pn {
	width: 260px;
	background: #111111;
	border-left: 1px solid #333;
	display: flex;
	flex-direction: column;
	flex-shrink: 0;
	transition: width 0.2s;
	overflow: hidden;
}

.ri-pn.collapsed {
	width: 32px;
}

.ri-pn.collapsed .pn-body,
.ri-pn.collapsed .pn-title-text {
	display: none;
}

.ri-pn.collapsed .pn-header {
	writing-mode: vertical-rl;
	text-orientation: mixed;
	padding: 12px 8px;
	justify-content: flex-start;
}

.ri-pn.collapsed .pn-toggle svg {
	transform: rotate(180deg);
}

.pn-header {
	display: flex;
	align-items: center;
	padding: 12px;
	font-size: 13px;
	font-weight: 600;
	color: #888;
	text-transform: uppercase;
	letter-spacing: 0.5px;
	border-bottom: 1px solid #333;
}

.pn-title-text {
	flex: 1;
}

.pn-toggle {
	width: 24px;
	height: 24px;
	background: transparent;
	border: none;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
	margin-left: auto;
}

.pn-toggle svg {
	width: 14px;
	height: 14px;
	stroke: #888;
	fill: none;
	stroke-width: 2;
	transition: transform 0.2s;
}

.pn-toggle:hover svg {
	stroke: #fff;
}

.pn-body {
	flex: 1;
	overflow-y: auto;
	padding: 8px;
}

.pn-resizer {
	position: absolute;
	z-index: 10;
}

.pn-resizer.horizontal {
	width: 4px;
	cursor: ew-resize;
	top: 0;
	bottom: 0;
}

.pn-resizer.vertical {
	height: 4px;
	cursor: ns-resize;
	left: 0;
	right: 0;
}

.pn-resizer:hover,
.pn-resizer.active {
	background: #166d3b;
}

.le-resizer {
	left: 220px;
}

.ri-resizer {
	right: 260px;
}

.bt-resizer {
	bottom: 180px;
}

.edt-cv {
	flex: 1;
	position: relative;
	overflow: hidden;
	background: #050505;
}

#editor-canvas {
	position: absolute;
	top: 0;
	left: 0;
}

.canvas-info {
	position: absolute;
	bottom: 10px;
	left: 10px;
	background: rgba(0,0,0,0.7);
	padding: 6px 12px;
	border-radius: 4px;
	font-size: 12px;
	color: #888;
}

.gizmo-wrapper {
	position: absolute;
	top: 10px;
	right: 10px;
	width: 120px;
	height: 150px;
	display: flex;
	flex-direction: column;
	align-items: center;
}

.gizmo {
	width: 120px;
	height: 120px;
	perspective: 300px;
	cursor: grab;
	display: flex;
	align-items: center;
	justify-content: center;
}

.gizmo:active {
	cursor: grabbing;
}

.gizmo-inner {
	width: 75px;
	height: 75px;
	position: relative;
	transform-style: preserve-3d;
	transition: transform 0.3s ease;
}

.gizmo-face {
	position: absolute;
	width: 75px;
	height: 75px;
	background: rgba(30, 30, 30, 0.9);
	border: 1px solid #444;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 14px;
	color: #888;
	backface-visibility: visible;
	cursor: pointer;
	transition: background 0.15s, color 0.15s;
}

.gizmo-face:hover {
	background: rgba(22, 109, 59, 0.9);
	color: #fff;
}

.gizmo-south {
	transform: translateZ(37.5px);
}

.gizmo-north {
	transform: rotateY(180deg) translateZ(37.5px);
}

.gizmo-north span {
	transform: scaleX(-1);
}

.gizmo-east {
	transform: rotateY(-90deg) translateZ(37.5px);
}

.gizmo-west {
	transform: rotateY(90deg) translateZ(37.5px);
}

.gizmo-top {
	transform: rotateX(90deg) translateZ(37.5px);
}

.gizmo-bottom {
	transform: rotateX(-90deg) translateZ(37.5px);
}

.bt-pn {
	height: 180px;
	background: #111111;
	border-top: 1px solid #333;
	display: flex;
	flex-direction: column;
	flex-shrink: 0;
	transition: height 0.2s;
	overflow: hidden;
}

.bt-pn.collapsed {
	height: 36px;
}

.bt-pn.collapsed .bt-pn-body {
	display: none;
}

.bt-pn.collapsed .bt-collapse-btn svg {
	transform: rotate(180deg);
}

.bt-pn.fullscreen {
	position: fixed;
	top: 48px;
	left: 0;
	right: 0;
	bottom: 0;
	height: auto;
	z-index: 100;
}

.bt-pn-tabs {
	display: flex;
	padding: 0 12px;
	border-bottom: 1px solid #333;
	align-items: center;
}

.bt-pn-tabs-left {
	display: flex;
	flex: 1;
}

.bt-pn-tabs-right {
	display: flex;
	align-items: center;
	gap: 4px;
}

.bt-tab {
	padding: 10px 16px;
	font-size: 13px;
	color: #888;
	cursor: pointer;
	border-bottom: 2px solid transparent;
	margin-bottom: -1px;
}

.bt-tab:hover {
	color: #aaa;
}

.bt-tab.active {
	color: #fff;
	border-bottom-color: #166d3b;
}

.bt-ctrl-btn {
	width: 28px;
	height: 28px;
	background: transparent;
	border: none;
	border-radius: 4px;
	color: #888;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
}

.bt-ctrl-btn:hover {
	background: #333;
	color: #fff;
}

.bt-ctrl-btn svg {
	width: 16px;
	height: 16px;
	stroke: currentColor;
	fill: none;
	stroke-width: 2;
	transition: transform 0.2s;
}

.bt-pn-body {
	flex: 1;
	overflow: auto;
	padding: 12px;
}

.pn-hd-fld {
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 6px;
	margin-bottom: 8px;
}

.pn-hd-fld-header {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 8px 12px;
	cursor: pointer;
	font-size: 13px;
}

.pn-hd-fld-header:hover {
	background: #252525;
}

.pn-hd-fld-header .arrow {
	transition: transform 0.2s;
}

.pn-hd-fld-header.open .arrow {
	transform: rotate(90deg);
}

.pn-hd-fld-body {
	padding: 8px;
	border-top: 1px solid #333;
	display: none;
}

.pn-hd-fld-body.open {
	display: block;
}

.pn-hd-clk {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 6px 8px;
	background: #252525;
	border-radius: 4px;
	font-size: 12px;
	cursor: pointer;
	margin-bottom: 4px;
}

.pn-hd-clk:hover {
	background: #333;
}

.pn-hd-clk.selected {
	background: #166d3b;
}

.pn-hd-drg {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 6px 8px;
	background: #252525;
	border-radius: 4px;
	font-size: 12px;
	cursor: grab;
	margin-bottom: 4px;
}

.pn-hd-drg:hover {
	background: #333;
}

.pn-hd-drg:active {
	cursor: grabbing;
}

.pn-hd-drg.dragging {
	opacity: 0.5;
}

.drag-handle {
	color: #555;
}

.prop-section {
	padding: 12px;
	border-bottom: 1px solid #333;
}

.prop-label {
	font-size: 11px;
	color: #666;
	margin-bottom: 6px;
}

.prop-input {
	width: 100%;
	height: 32px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	padding: 0 10px;
	color: #fff;
	font-size: 13px;
}

.prop-input:focus {
	outline: none;
	border-color: #166d3b;
}

.prop-row {
	display: flex;
	gap: 8px;
	margin-bottom: 8px;
}

.prop-row:last-child {
	margin-bottom: 0;
}

.prop-col {
	flex: 1;
}

.config-section {
	margin-bottom: 16px;
}

.config-section-title {
	font-size: 12px;
	color: #888;
	margin-bottom: 8px;
	padding-bottom: 4px;
	border-bottom: 1px solid #333;
}

.config-row {
	display: flex;
	align-items: center;
	gap: 8px;
	margin-bottom: 8px;
}

.config-row label {
	width: 100px;
	font-size: 12px;
	color: #aaa;
}

.config-row input,
.config-row select {
	flex: 1;
	height: 28px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	padding: 0 8px;
	color: #fff;
	font-size: 12px;
}

.config-row input:focus,
.config-row select:focus {
	outline: none;
	border-color: #166d3b;
}

.swt {
	position: relative;
	width: 36px;
	height: 20px;
	flex-shrink: 0;
}

.swt input {
	opacity: 0;
	width: 0;
	height: 0;
}

.swt-trk {
	position: absolute;
	cursor: pointer;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	background: #333;
	border-radius: 10px;
	transition: background 0.2s;
}

.swt-trk:before {
	position: absolute;
	content: "";
	height: 16px;
	width: 16px;
	left: 2px;
	bottom: 2px;
	background: #888;
	border-radius: 50%;
	transition: all 0.2s;
}

.swt input:checked + .swt-trk {
	background: #166d3b;
}

.swt input:checked + .swt-trk:before {
	transform: translateX(16px);
	background: #fff;
}

.config-row input[type="range"] {
	padding: 0;
	max-width: 120px;
	flex: 0 0 120px;
}

.config-row .sld-val {
	width: 50px;
	text-align: right;
	font-size: 12px;
	color: #fff;
	cursor: default;
	padding: 2px 4px;
	border-radius: 3px;
	flex-shrink: 0;
}

.config-row .sld-val:hover {
	background: #252525;
}

.config-row .sld-ipt {
	width: 50px;
	height: 22px;
	background: #1a1a1a;
	border: 1px solid #166d3b;
	border-radius: 3px;
	color: #fff;
	font-size: 12px;
	text-align: right;
	padding: 0 4px;
	flex: 0 0 auto;
}

.config-row .sld-ipt:focus {
	outline: none;
}

.config-row .unit {
	color: #666;
	font-size: 11px;
	width: 30px;
	flex-shrink: 0;
}

.empty-state {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	padding: 40px 20px;
	color: #555;
	font-size: 13px;
	text-align: center;
}

.empty-state svg {
	width: 48px;
	height: 48px;
	stroke: #444;
	fill: none;
	stroke-width: 1;
	margin-bottom: 12px;
}

.voxel-toolbar {
	position: absolute;
	top: 10px;
	left: 10px;
	background: rgba(17, 17, 17, 0.95);
	border: 1px solid #333;
	border-radius: 6px;
	padding: 8px;
	display: none;
	flex-direction: column;
	gap: 4px;
}

.voxel-toolbar.active {
	display: flex;
}

.voxel-tool-btn {
	width: 36px;
	height: 36px;
	background: transparent;
	border: 1px solid transparent;
	border-radius: 6px;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
}

.voxel-tool-btn:hover {
	background: #333;
}

.voxel-tool-btn.active {
	background: #166d3b;
	border-color: #1c8548;
}

.voxel-tool-btn svg {
	width: 20px;
	height: 20px;
	stroke: #aaa;
	fill: none;
	stroke-width: 1.5;
}

.voxel-tool-btn.active svg {
	stroke: #fff;
}

.voxel-color-picker {
	width: 36px;
	height: 36px;
	border: 2px solid #333;
	border-radius: 6px;
	cursor: pointer;
	padding: 0;
	background: #166d3b;
}

.voxel-color-picker::-webkit-color-swatch-wrapper {
	padding: 0;
}

.voxel-color-picker::-webkit-color-swatch {
	border: none;
	border-radius: 4px;
}

.edit-mode-banner {
	position: absolute;
	top: 10px;
	left: 50%;
	transform: translateX(-50%);
	background: rgba(22, 109, 59, 0.9);
	padding: 8px 20px;
	border-radius: 6px;
	font-size: 13px;
	display: none;
	align-items: center;
	gap: 12px;
}

.edit-mode-banner.active {
	display: flex;
}

.edit-mode-banner .mode-name {
	font-weight: 600;
}

.edit-mode-banner .exit-btn {
	background: rgba(255,255,255,0.2);
	border: none;
	padding: 4px 12px;
	border-radius: 4px;
	color: #fff;
	cursor: pointer;
	font-size: 12px;
}

.edit-mode-banner .exit-btn:hover {
	background: rgba(255,255,255,0.3);
}

.building-props {
	display: none;
}

.building-props.active {
	display: block;
}

.voxel-size-info {
	font-size: 11px;
	color: #666;
	margin-top: 4px;
}

.color-palette {
	display: flex;
	flex-wrap: wrap;
	gap: 4px;
	margin-top: 8px;
}

.palette-color {
	width: 24px;
	height: 24px;
	border: 2px solid transparent;
	border-radius: 4px;
	cursor: pointer;
}

.palette-color:hover {
	border-color: #666;
}

.palette-color.selected {
	border-color: #fff;
}

.add-building-btn {
	width: 100%;
	height: 32px;
	background: #166d3b;
	border: none;
	border-radius: 6px;
	color: #fff;
	font-size: 12px;
	cursor: pointer;
	margin-top: 8px;
}

.add-building-btn:hover {
	background: #1c8548;
}

.event-props {
	display: none;
}

.event-props.active {
	display: block;
}

.trigger-list {
	display: flex;
	flex-direction: column;
	gap: 8px;
}

.trigger-item {
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 6px;
	padding: 8px;
}

.trigger-header {
	display: flex;
	align-items: center;
	gap: 8px;
	margin-bottom: 8px;
}

.trigger-header select {
	flex: 1;
	height: 28px;
	background: #252525;
	border: 1px solid #333;
	border-radius: 4px;
	color: #fff;
	font-size: 12px;
	padding: 0 8px;
}

.trigger-header select:focus {
	outline: none;
	border-color: #166d3b;
}

.trigger-remove {
	width: 24px;
	height: 24px;
	background: transparent;
	border: none;
	border-radius: 4px;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
}

.trigger-remove:hover {
	background: #333;
}

.trigger-remove svg {
	width: 14px;
	height: 14px;
	stroke: #888;
}

.trigger-remove:hover svg {
	stroke: #e74c3c;
}

.trigger-config {
	display: flex;
	flex-direction: column;
	gap: 6px;
}

.action-list {
	display: flex;
	flex-direction: column;
	gap: 4px;
	margin-top: 8px;
	padding-top: 8px;
	border-top: 1px solid #333;
}

.action-item {
	display: flex;
	align-items: center;
	gap: 6px;
	padding: 4px 6px;
	background: #252525;
	border-radius: 4px;
	font-size: 11px;
}

.action-item select {
	flex: 1;
	height: 24px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	color: #fff;
	font-size: 11px;
	padding: 0 6px;
}

.add-trigger-btn,
.add-action-btn {
	width: 100%;
	height: 28px;
	background: #252525;
	border: 1px dashed #444;
	border-radius: 4px;
	color: #888;
	font-size: 11px;
	cursor: pointer;
	margin-top: 8px;
}

.add-trigger-btn:hover,
.add-action-btn:hover {
	background: #333;
	border-color: #555;
	color: #aaa;
}

.new-event-btn {
	width: 100%;
	height: 32px;
	background: #166d3b;
	border: none;
	border-radius: 6px;
	color: #fff;
	font-size: 12px;
	cursor: pointer;
	margin-top: 8px;
}

.new-event-btn:hover {
	background: #1c8548;
}

.entity-props {
	display: none;
}

.entity-props.active {
	display: block;
}

.collision-box-list {
	display: flex;
	flex-direction: column;
	gap: 8px;
}

.collision-box-item {
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 6px;
	padding: 8px;
}

.collision-box-header {
	display: flex;
	align-items: center;
	justify-content: space-between;
	margin-bottom: 8px;
	font-size: 12px;
	color: #888;
}

.collision-box-fields {
	display: flex;
	flex-direction: column;
	gap: 6px;
}

.add-collision-btn {
	width: 100%;
	height: 28px;
	background: #252525;
	border: 1px dashed #444;
	border-radius: 4px;
	color: #888;
	font-size: 11px;
	cursor: pointer;
	margin-top: 8px;
}

.add-collision-btn:hover {
	background: #333;
	border-color: #555;
	color: #aaa;
}

.trigger-word-list {
	display: flex;
	flex-wrap: wrap;
	gap: 6px;
	margin-bottom: 8px;
}

.trigger-word-tag {
	display: flex;
	align-items: center;
	gap: 4px;
	padding: 4px 8px;
	background: #252525;
	border: 1px solid #333;
	border-radius: 12px;
	font-size: 11px;
	color: #aaa;
}

.trigger-word-tag .del-btn {
	width: 14px;
	height: 14px;
	background: none;
	border: none;
	color: #666;
	cursor: pointer;
	font-size: 12px;
	line-height: 1;
	padding: 0;
}

.trigger-word-tag .del-btn:hover {
	color: #f55;
}

.add-trigger-word-btn {
	width: 28px;
	height: 28px;
	background: #252525;
	border: 1px solid #333;
	border-radius: 4px;
	color: #888;
	font-size: 14px;
	cursor: pointer;
	flex-shrink: 0;
}

.add-trigger-word-btn:hover {
	background: #333;
	color: #aaa;
}

.new-entity-btn {
	width: 100%;
	height: 32px;
	background: #166d3b;
	border: none;
	border-radius: 6px;
	color: #fff;
	font-size: 12px;
	cursor: pointer;
	margin-top: 8px;
}

.new-entity-btn:hover {
	background: #1c8548;
}

.furniture-props {
	display: none;
}

.furniture-props.active {
	display: block;
}

.building-select-list {
	display: flex;
	flex-wrap: wrap;
	gap: 4px;
	margin-top: 8px;
}

.building-select-item {
	padding: 4px 8px;
	background: #252525;
	border: 1px solid #333;
	border-radius: 4px;
	font-size: 11px;
	cursor: pointer;
}

.building-select-item:hover {
	background: #333;
}

.building-select-item.selected {
	background: #166d3b;
	border-color: #1c8548;
}

.new-furniture-btn {
	width: 100%;
	height: 32px;
	background: #166d3b;
	border: none;
	border-radius: 6px;
	color: #fff;
	font-size: 12px;
	cursor: pointer;
	margin-top: 8px;
}

.new-furniture-btn:hover {
	background: #1c8548;
}

.expand-btn {
	width: 24px;
	height: 24px;
	background: transparent;
	border: none;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
	margin-right: 8px;
}

.expand-btn svg {
	width: 14px;
	height: 14px;
	stroke: #888;
	fill: none;
	stroke-width: 2;
}

.expand-btn:hover svg {
	stroke: #fff;
}

.settings-group {
	margin-bottom: 16px;
}

.settings-group-header {
	font-size: 12px;
	font-weight: 600;
	color: #888;
	margin-bottom: 8px;
	text-transform: uppercase;
	letter-spacing: 0.5px;
}

.settings-row {
	display: flex;
	align-items: center;
	margin-bottom: 8px;
	gap: 12px;
}

.settings-label {
	width: 120px;
	font-size: 12px;
	color: #aaa;
	flex-shrink: 0;
}

.settings-input {
	flex: 1;
	height: 28px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	color: #fff;
	padding: 0 8px;
	font-size: 12px;
}

.settings-input:focus {
	outline: none;
	border-color: #166d3b;
}

.settings-select {
	flex: 1;
	height: 28px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	color: #fff;
	padding: 0 8px;
	font-size: 12px;
}

.settings-checkbox {
	width: 16px;
	height: 16px;
	accent-color: #166d3b;
}

.settings-slider {
	flex: 1;
	height: 4px;
	accent-color: #166d3b;
}

.settings-color {
	width: 32px;
	height: 28px;
	border: 1px solid #333;
	border-radius: 4px;
	cursor: pointer;
}

.spawn-item-list {
	display: flex;
	flex-direction: column;
	gap: 6px;
	margin-bottom: 8px;
}

.spawn-item {
	display: flex;
	align-items: center;
	padding: 6px 8px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	gap: 8px;
}

.spawn-item-name {
	flex: 1;
	font-size: 12px;
	color: #ccc;
}

.spawn-item-count {
	font-size: 11px;
	color: #888;
	min-width: 30px;
	text-align: right;
}

.spawn-item-del {
	width: 18px;
	height: 18px;
	background: transparent;
	border: none;
	cursor: pointer;
	color: #666;
	font-size: 14px;
	padding: 0;
}

.spawn-item-del:hover {
	color: #f66;
}

.spawn-item-add {
	display: flex;
	gap: 6px;
}

.spawn-item-add select {
	flex: 1;
	height: 28px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	color: #ccc;
	font-size: 11px;
	padding: 0 8px;
}

.spawn-item-add input {
	width: 50px;
	height: 28px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	color: #ccc;
	font-size: 11px;
	text-align: center;
}

.spawn-item-btn {
	width: 28px;
	height: 28px;
	background: #166d3b;
	border: none;
	border-radius: 4px;
	color: #fff;
	font-size: 16px;
	cursor: pointer;
}

.spawn-item-btn:hover {
	background: #1c8548;
}

.weather-list {
	display: flex;
	flex-direction: column;
	gap: 8px;
}

.weather-item {
	display: flex;
	align-items: center;
	padding: 8px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	gap: 8px;
}

.weather-item.selected {
	border-color: #166d3b;
}

.weather-item-name {
	flex: 1;
	font-size: 12px;
}

.weather-item-del {
	width: 20px;
	height: 20px;
	background: transparent;
	border: none;
	cursor: pointer;
	color: #888;
	font-size: 14px;
}

.weather-item-del:hover {
	color: #f66;
}

.add-weather-btn {
	padding: 8px 12px;
	background: #166d3b;
	border: none;
	border-radius: 4px;
	color: #fff;
	font-size: 12px;
	cursor: pointer;
	margin-top: 8px;
}

.add-weather-btn:hover {
	background: #1c8548;
}

.skill-system-item {
	padding: 12px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	margin-bottom: 8px;
}

.skill-system-header {
	display: flex;
	align-items: center;
	gap: 8px;
	margin-bottom: 8px;
}

.skill-system-toggle {
	width: 16px;
	height: 16px;
	accent-color: #166d3b;
}

.skill-system-name {
	font-size: 13px;
	font-weight: 600;
	color: #fff;
}

.skill-system-body {
	display: none;
	padding-top: 8px;
	border-top: 1px solid #333;
	margin-top: 8px;
}

.skill-system-item.active .skill-system-body {
	display: block;
}

.app.preview-mode .toolbar,
.app.preview-mode .section-tabs,
.app.preview-mode #le-pn,
.app.preview-mode #ri-pn,
.app.preview-mode #le-resizer,
.app.preview-mode #ri-resizer {
	display: none !important;
}

.app.preview-mode .main {
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
}

.app.preview-mode #cv-ctn {
	position: absolute;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
}

.prv-exit-tip {
	position: fixed;
	top: 16px;
	left: 50%;
	transform: translateX(-50%);
	background: rgba(0, 0, 0, 0.7);
	color: #fff;
	padding: 8px 16px;
	border-radius: 6px;
	font-size: 13px;
	z-index: 9999;
	pointer-events: none;
	display: none;
}

.app.preview-mode .prv-exit-tip {
	display: block;
}

.section-ai {
	display: none;
	flex-direction: column;
	flex: 1;
	min-height: 0;
}

.section-ai.active {
	display: flex;
}

.ai-server-bar {
	height: 40px;
	background: #0a0a0a;
	border-bottom: 1px solid #333;
	display: flex;
	align-items: center;
	padding: 0 12px;
	gap: 8px;
	flex-shrink: 0;
}

#ai-server-lst {
	display: flex;
	align-items: center;
	gap: 6px;
	flex-wrap: wrap;
}

.ai-server-tag {
	height: 28px;
	padding: 0 10px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	color: #888;
	font-size: 12px;
	display: flex;
	align-items: center;
	gap: 6px;
	cursor: pointer;
	transition: all 0.15s;
}

.ai-server-tag:hover {
	background: #252525;
}

.ai-server-tag.connected {
	border-color: #166d3b;
	color: #4ade80;
}

.ai-server-tag.connecting {
	border-color: #2563eb;
	color: #60a5fa;
}

.ai-server-tag .status-dot {
	width: 6px;
	height: 6px;
	border-radius: 50%;
	background: #555;
}

.ai-server-tag.connected .status-dot {
	background: #4ade80;
}

.ai-server-tag.connecting .status-dot {
	background: #60a5fa;
	animation: pulse 1s infinite;
}

@keyframes pulse {
	0%, 100% { opacity: 1; }
	50% { opacity: 0.4; }
}

#ai-model-sel {
	flex: 1;
}

.ai-server-tag .del-btn {
	width: 14px;
	height: 14px;
	background: transparent;
	border: none;
	color: #666;
	cursor: pointer;
	padding: 0;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 14px;
	line-height: 1;
}

.ai-server-tag .del-btn:hover {
	color: #f87171;
}

.ai-add-server-btn {
	width: 28px;
	height: 28px;
	background: #1a1a1a;
	border: 1px dashed #444;
	border-radius: 4px;
	color: #666;
	font-size: 16px;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
}

.ai-add-server-btn:hover {
	background: #252525;
	border-color: #555;
	color: #888;
}

.ai-main {
	flex: 1;
	display: flex;
	min-height: 0;
}

.ai-le-pn {
	width: 200px;
	background: #111;
	border-right: 1px solid #333;
	display: flex;
	flex-direction: column;
	flex-shrink: 0;
}

.ai-le-pn .pn-body {
	flex: 1;
	overflow-y: auto;
	padding: 8px;
}

.ai-menu-item {
	padding: 10px 12px;
	background: transparent;
	border: none;
	border-radius: 6px;
	color: #888;
	font-size: 13px;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 8px;
	width: 100%;
	text-align: left;
	transition: all 0.15s;
}

.ai-menu-item:hover {
	background: #1a1a1a;
	color: #aaa;
}

.ai-menu-item.active {
	background: #1a1a1a;
	color: #fff;
}

.ai-menu-item svg {
	width: 16px;
	height: 16px;
	stroke: currentColor;
	fill: none;
	stroke-width: 1.5;
}

.ai-cnt {
	flex: 1;
	display: flex;
	flex-direction: column;
	min-width: 0;
}

.ai-ri-pn {
	width: 320px;
	background: #111;
	border-left: 1px solid #333;
	display: flex;
	flex-direction: column;
	flex-shrink: 0;
}

.ai-ri-pn .pn-body {
	flex: 1;
	overflow-y: auto;
	padding: 12px;
}

.ai-task-lst {
	flex: 1;
	overflow-y: auto;
	padding: 12px;
	background: #0a0a0a;
}

.ai-task-item {
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 6px;
	padding: 10px 12px;
	margin-bottom: 8px;
	cursor: pointer;
	transition: all 0.15s;
}

.ai-task-item:hover {
	border-color: #444;
}

.ai-task-item.selected {
	border-color: #2563eb;
}

.ai-task-item .task-hd {
	display: flex;
	align-items: center;
	gap: 8px;
	margin-bottom: 6px;
}

.ai-task-item .task-id {
	font-size: 12px;
	color: #888;
	font-family: monospace;
}

.ai-task-item .task-type {
	font-size: 10px;
	padding: 2px 6px;
	border-radius: 3px;
	background: #333;
	color: #888;
}

.ai-task-item .task-prompt {
	font-size: 12px;
	color: #aaa;
	line-height: 1.4;
	overflow: hidden;
	text-overflow: ellipsis;
	display: -webkit-box;
	-webkit-line-clamp: 2;
	line-clamp: 2;
	-webkit-box-orient: vertical;
}

.ai-task-item .task-workflow {
	display: flex;
	gap: 4px;
	margin-top: 8px;
	flex-wrap: wrap;
}

.ai-task-item .wf-step {
	font-size: 10px;
	padding: 2px 6px;
	border-radius: 3px;
	background: #252525;
	color: #666;
}

.ai-task-item .wf-step.done {
	background: #14532d;
	color: #4ade80;
}

.ai-task-item .wf-step.running {
	background: #1e3a5f;
	color: #60a5fa;
}

.ai-task-item .wf-step.error {
	background: #7f1d1d;
	color: #f87171;
}

.ai-task-item .wf-step.retry {
	background: #78350f;
	color: #fbbf24;
}

.ai-task-item.status-done {
	border-left: 3px solid #4ade80;
}

.ai-task-item.status-running {
	border-left: 3px solid #60a5fa;
}

.ai-task-item.status-pending {
	border-left: 3px solid #555;
}

.ai-task-item.status-error {
	border-left: 3px solid #f87171;
}

.ai-ctrl-bar {
	height: 48px;
	background: #111;
	border-top: 1px solid #333;
	display: flex;
	align-items: center;
	padding: 0 12px;
	gap: 8px;
}

.ai-ctrl-btn {
	height: 32px;
	padding: 0 16px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 6px;
	color: #aaa;
	font-size: 12px;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 6px;
}

.ai-ctrl-btn:hover {
	background: #252525;
}

.ai-ctrl-btn.primary {
	background: #166d3b;
	border-color: #1c8548;
	color: #fff;
}

.ai-ctrl-btn.primary:hover {
	background: #1c8548;
}

.ai-ctrl-btn.danger {
	background: #7f1d1d;
	border-color: #991b1b;
	color: #fff;
}

.ai-ctrl-btn.danger:hover {
	background: #991b1b;
}

.ai-ctrl-btn svg {
	width: 14px;
	height: 14px;
	stroke: currentColor;
	fill: none;
	stroke-width: 1.5;
}

.ai-stats {
	margin-left: auto;
	display: flex;
	gap: 16px;
	font-size: 12px;
	color: #666;
}

.ai-stats .stat {
	display: flex;
	align-items: center;
	gap: 4px;
}

.ai-stats .stat-val {
	color: #aaa;
}

.ai-stats .stat-val.green {
	color: #4ade80;
}

.ai-stats .stat-val.blue {
	color: #60a5fa;
}

.ai-stats .stat-val.red {
	color: #f87171;
}

.ai-config-section {
	margin-bottom: 16px;
}

.ai-config-section .section-title {
	font-size: 11px;
	color: #666;
	text-transform: uppercase;
	letter-spacing: 0.5px;
	margin-bottom: 8px;
}

.ai-config-row {
	display: flex;
	align-items: center;
	margin-bottom: 8px;
}

.ai-config-row label {
	width: 80px;
	font-size: 12px;
	color: #888;
	flex-shrink: 0;
}

.ai-config-row input,
.ai-config-row select {
	flex: 1;
	height: 28px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	color: #fff;
	font-size: 12px;
	padding: 0 8px;
}

.ai-config-row textarea {
	flex: 1;
	min-height: 80px;
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 4px;
	color: #fff;
	font-size: 12px;
	padding: 8px;
	resize: vertical;
}

.ai-empty-state {
	flex: 1;
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	color: #555;
	gap: 12px;
}

.ai-empty-state svg {
	width: 48px;
	height: 48px;
	stroke: #444;
	fill: none;
	stroke-width: 1;
}

.ai-server-md {
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	background: rgba(0, 0, 0, 0.7);
	display: none;
	align-items: center;
	justify-content: center;
	z-index: 1000;
}

.ai-server-md.show {
	display: flex;
}

.ai-server-md-cnt {
	background: #1a1a1a;
	border: 1px solid #333;
	border-radius: 8px;
	padding: 20px;
	width: 320px;
}

.ai-server-md-cnt h3 {
	font-size: 14px;
	color: #fff;
	margin-bottom: 16px;
}

.ai-server-md-cnt input {
	width: 100%;
	height: 36px;
	background: #111;
	border: 1px solid #333;
	border-radius: 6px;
	color: #fff;
	font-size: 13px;
	padding: 0 12px;
	margin-bottom: 16px;
}

.ai-server-md-cnt .md-btns {
	display: flex;
	gap: 8px;
	justify-content: flex-end;
}

.ai-server-md-cnt .md-btn {
	height: 32px;
	padding: 0 16px;
	border-radius: 6px;
	font-size: 12px;
	cursor: pointer;
	border: 1px solid #333;
}

.ai-server-md-cnt .md-btn.cancel {
	background: #252525;
	color: #aaa;
}

.ai-server-md-cnt .md-btn.confirm {
	background: #166d3b;
	border-color: #1c8548;
	color: #fff;
}
	</style>
</head>
<script src="webgl/math.js?v=2"></script>
<script src="webgl/shaders.js?v=2"></script>
<script src="webgl/textures.js?v=2"></script>
<script src="webgl/model.js?v=2"></script>
<script src="webgl/renderer.js?v=2"></script>
<body>
	<div class="app">
		<div class="prv-exit-tip">ESC 退出预览</div>
		<div class="toolbar">
			<div class="tool-group">
				<button class="tool-btn active" data-tool="select" title="选择">
					<svg viewBox="0 0 24 24"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/></svg>
				</button>
				<button class="tool-btn" data-tool="move" title="移动">
					<svg viewBox="0 0 24 24"><path d="M5 9l-3 3 3 3"/><path d="M9 5l3-3 3 3"/><path d="M15 19l-3 3-3-3"/><path d="M19 9l3 3-3 3"/><path d="M2 12h20"/><path d="M12 2v20"/></svg>
				</button>
				<button class="tool-btn" data-tool="rotate" title="旋转">
					<svg viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
				</button>
				<button class="tool-btn" data-tool="scale" title="缩放">
					<svg viewBox="0 0 24 24"><path d="M21 21l-6-6"/><path d="M3 10V3h7"/><path d="M21 14v7h-7"/><path d="M3 3l18 18"/></svg>
				</button>
			</div>
			<div class="tool-group">
				<button class="tool-btn" id="undo-btn" title="撤销" disabled>
					<svg viewBox="0 0 24 24"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
				</button>
				<button class="tool-btn" id="redo-btn" title="重做" disabled>
					<svg viewBox="0 0 24 24"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"/></svg>
				</button>
			</div>
			<div class="tool-group">
				<button class="tool-btn active" id="grid-btn" title="显示网格">
					<svg viewBox="0 0 24 24"><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/></svg>
				</button>
			</div>
			<div class="file-buttons">
				<button class="file-btn" id="import-btn">
					<svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
					导入
				</button>
				<button class="file-btn primary" id="export-btn">
					<svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
					导出
				</button>
				<button class="prv-btn" id="prv-btn">
					<svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
					预览
				</button>
			</div>
		</div>
		<div class="section-tabs">
			<button class="section-tab" data-section="building">
				<svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
				建筑
			</button>
			<button class="section-tab" data-section="spawn">
				<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
				出生设置
			</button>
			<button class="section-tab active" data-section="assets">
				<svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
				资产
			</button>
			<button class="section-tab" data-section="map">
				<svg viewBox="0 0 24 24"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
				地图
			</button>
			<button class="section-tab" data-section="weather">
				<svg viewBox="0 0 24 24"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>
				天气
			</button>
			<button class="section-tab" data-section="system">
				<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
				系统
			</button>
			<button class="section-tab" data-section="skills">
				<svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
				技能
			</button>
			<button class="section-tab" data-section="ai">
				<svg viewBox="0 0 24 24"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A2.5 2.5 0 0 0 5 15.5 2.5 2.5 0 0 0 7.5 18a2.5 2.5 0 0 0 2.5-2.5A2.5 2.5 0 0 0 7.5 13m9 0a2.5 2.5 0 0 0-2.5 2.5 2.5 2.5 0 0 0 2.5 2.5 2.5 2.5 0 0 0 2.5-2.5 2.5 2.5 0 0 0-2.5-2.5"/></svg>
				AI
			</button>
		</div>
		<div class="section-split" id="section-building">
			<div class="sec-le-pn">
				<div class="pn-hd">建筑层</div>
				<div class="pn-bd">
					<div class="bld-lyr-lst" id="bld-lyr-lst"></div>
					<button class="bld-lyr-add" id="bld-lyr-add">+ 新建层</button>
				</div>
			</div>
			<div class="sec-ri-pn">
				<div class="bld-tlb">
					<button class="bld-tool-btn active" data-bld-tool="line">
						<svg viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/></svg>
						直线
					</button>
					<button class="bld-tool-btn" data-bld-tool="ground">
						<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
						地面
					</button>
					<button class="bld-tool-btn" data-bld-tool="wall">
						<svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16"/></svg>
						造墙
					</button>
					<button class="bld-tool-btn" data-bld-tool="window">
						<svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
						开窗
					</button>
					<button class="bld-tool-btn" data-bld-tool="door">
						<svg viewBox="0 0 24 24"><rect x="5" y="3" width="14" height="18"/><circle cx="15" cy="12" r="1"/></svg>
						开门
					</button>
				</div>
				<div class="bld-cv-ctn" id="bld-cv-ctn">
					<canvas id="bld-canvas"></canvas>
					<div class="bld-info" id="bld-info">长度: 0m</div>
				</div>
				<div class="bld-props" id="bld-props">
					<div class="config-section">
						<div class="config-section-title">直线属性</div>
						<div class="config-row">
							<label>宽度</label>
							<input type="number" id="bld-line-width" value="0.2" min="0.0625" step="0.0625">
							<span class="unit">m</span>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="section-split active" id="section-assets">
			<div class="sec-le-pn">
				<div class="pn-hd">资产分类</div>
				<div class="pn-bd">
					<div class="ast-cat-lst" id="ast-cat-lst">
						<div class="ast-cat-item" data-cat="buildings">
							<div class="ast-cat-hd open">
								<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
								<span>建筑</span>
							</div>
							<div class="ast-cat-bd open" id="ast-buildings">
								<div class="ast-sub-fld">
									<div class="ast-sub-hd open" data-sub="buildings-sys">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>系统</span>
									</div>
									<div class="ast-sub-bd open" id="ast-buildings-sys"></div>
								</div>
								<div class="ast-sub-fld">
									<div class="ast-sub-hd" data-sub="buildings-cst">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>自定义</span>
									</div>
									<div class="ast-sub-bd" id="ast-buildings-cst">
										<button class="ast-add-btn" data-cat="buildings">+ 新建</button>
									</div>
								</div>
							</div>
						</div>
						<div class="ast-cat-item" data-cat="entities">
							<div class="ast-cat-hd">
								<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
								<span>实体</span>
							</div>
							<div class="ast-cat-bd" id="ast-entities">
								<div class="ast-sub-fld">
									<div class="ast-sub-hd open" data-sub="entities-sys">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>系统</span>
									</div>
									<div class="ast-sub-bd open" id="ast-entities-sys"></div>
								</div>
								<div class="ast-sub-fld">
									<div class="ast-sub-hd" data-sub="entities-cst">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>自定义</span>
									</div>
									<div class="ast-sub-bd" id="ast-entities-cst">
										<button class="ast-add-btn" data-cat="entities">+ 新建</button>
									</div>
								</div>
							</div>
						</div>
						<div class="ast-cat-item" data-cat="furniture">
							<div class="ast-cat-hd">
								<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
								<span>家具</span>
							</div>
							<div class="ast-cat-bd" id="ast-furniture">
								<div class="ast-sub-fld">
									<div class="ast-sub-hd open" data-sub="furniture-sys">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>系统</span>
									</div>
									<div class="ast-sub-bd open" id="ast-furniture-sys"></div>
								</div>
								<div class="ast-sub-fld">
									<div class="ast-sub-hd" data-sub="furniture-cst">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>自定义</span>
									</div>
									<div class="ast-sub-bd" id="ast-furniture-cst">
										<button class="ast-add-btn" data-cat="furniture">+ 新建</button>
									</div>
								</div>
							</div>
						</div>
						<div class="ast-cat-item" data-cat="items">
							<div class="ast-cat-hd">
								<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
								<span>物品</span>
							</div>
							<div class="ast-cat-bd" id="ast-items">
								<div class="ast-sub-fld">
									<div class="ast-sub-hd open" data-sub="items-sys">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>系统</span>
									</div>
									<div class="ast-sub-bd open" id="ast-items-sys"></div>
								</div>
								<div class="ast-sub-fld">
									<div class="ast-sub-hd" data-sub="items-cst">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>自定义</span>
									</div>
									<div class="ast-sub-bd" id="ast-items-cst">
										<button class="ast-add-btn" data-cat="items">+ 新建</button>
									</div>
								</div>
							</div>
						</div>
						<div class="ast-cat-item" data-cat="buffs">
							<div class="ast-cat-hd">
								<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
								<span>BUFF</span>
							</div>
							<div class="ast-cat-bd" id="ast-buffs">
								<div class="ast-sub-fld">
									<div class="ast-sub-hd open" data-sub="buffs-sys">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>系统</span>
									</div>
									<div class="ast-sub-bd open" id="ast-buffs-sys"></div>
								</div>
								<div class="ast-sub-fld">
									<div class="ast-sub-hd" data-sub="buffs-cst">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>自定义</span>
									</div>
									<div class="ast-sub-bd" id="ast-buffs-cst">
										<button class="ast-add-btn" data-cat="buffs">+ 新建</button>
									</div>
								</div>
							</div>
						</div>
						<div class="ast-cat-item" data-cat="skills">
							<div class="ast-cat-hd">
								<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
								<span>技能</span>
							</div>
							<div class="ast-cat-bd" id="ast-skills">
								<div class="ast-sub-fld">
									<div class="ast-sub-hd open" data-sub="skills-sys">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>系统</span>
									</div>
									<div class="ast-sub-bd open" id="ast-skills-sys"></div>
								</div>
								<div class="ast-sub-fld">
									<div class="ast-sub-hd" data-sub="skills-cst">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>自定义</span>
									</div>
									<div class="ast-sub-bd" id="ast-skills-cst">
										<button class="ast-add-btn" data-cat="skills">+ 新建</button>
									</div>
								</div>
							</div>
						</div>
						<div class="ast-cat-item" data-cat="walls">
							<div class="ast-cat-hd">
								<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
								<span>墙壁</span>
							</div>
							<div class="ast-cat-bd" id="ast-walls">
								<div class="ast-sub-fld">
									<div class="ast-sub-hd open" data-sub="walls-sys">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>系统</span>
									</div>
									<div class="ast-sub-bd open" id="ast-walls-sys"></div>
								</div>
								<div class="ast-sub-fld">
									<div class="ast-sub-hd" data-sub="walls-cst">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>自定义</span>
									</div>
									<div class="ast-sub-bd" id="ast-walls-cst">
										<button class="ast-add-btn" data-cat="walls">+ 新建</button>
									</div>
								</div>
							</div>
						</div>
						<div class="ast-cat-item" data-cat="floors">
							<div class="ast-cat-hd">
								<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
								<span>地面</span>
							</div>
							<div class="ast-cat-bd" id="ast-floors">
								<div class="ast-sub-fld">
									<div class="ast-sub-hd open" data-sub="floors-sys">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>系统</span>
									</div>
									<div class="ast-sub-bd open" id="ast-floors-sys"></div>
								</div>
								<div class="ast-sub-fld">
									<div class="ast-sub-hd" data-sub="floors-cst">
										<svg class="arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
										<span>自定义</span>
									</div>
									<div class="ast-sub-bd" id="ast-floors-cst">
										<button class="ast-add-btn" data-cat="floors">+ 新建</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="sec-ri-pn">
				<div class="pn-hd">资产详情</div>
				<div class="pn-bd" id="ast-detail">
					<div class="empty-state">
						<svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
						<span>选择资产以查看详情</span>
					</div>
				</div>
			</div>
		</div>
		<div class="section-split" id="section-spawn">
			<div class="sec-le-pn">
				<div class="pn-hd">出生配置</div>
				<div class="pn-bd">
					<div class="pn-hd-fld">
						<div class="pn-hd-fld-header open" data-fld="spawn-loc">
							<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
							<span>出生地点</span>
						</div>
						<div class="pn-hd-fld-body open" id="spawn-loc-lst">
							<div class="spawn-cfg-lst">
								<div class="spawn-cfg-item sel" data-id="default">默认出生点</div>
							</div>
							<button class="spawn-cfg-add" data-type="loc">+ 添加</button>
						</div>
					</div>
					<div class="pn-hd-fld">
						<div class="pn-hd-fld-header" data-fld="spawn-items">
							<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
							<span>出生物品</span>
						</div>
						<div class="pn-hd-fld-body" id="spawn-items-lst">
							<div class="spawn-cfg-lst"></div>
							<button class="spawn-cfg-add" data-type="items">+ 添加</button>
						</div>
					</div>
					<div class="pn-hd-fld">
						<div class="pn-hd-fld-header" data-fld="spawn-rel">
							<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
							<span>出生关系</span>
						</div>
						<div class="pn-hd-fld-body" id="spawn-rel-lst">
							<div class="spawn-cfg-lst"></div>
							<button class="spawn-cfg-add" data-type="rel">+ 添加</button>
						</div>
					</div>
				</div>
			</div>
			<div class="sec-ri-pn">
				<div class="pn-hd">配置详情</div>
				<div class="pn-bd" id="spawn-detail">
					<div class="config-section">
						<div class="config-section-title">出生地点设置</div>
						<div class="config-row">
							<label>出生类型</label>
							<select id="spawn-type">
								<option value="biome">生物群系</option>
								<option value="city" selected>城市区域</option>
							</select>
						</div>
						<div class="config-row" id="spawn-biome-row" style="display:none">
							<label>生物群系</label>
							<select id="spawn-biome">
								<option value="grassland">草地</option>
								<option value="polar">极地</option>
								<option value="swamp">沼泽</option>
								<option value="desert">沙漠</option>
								<option value="rainforest">雨林</option>
								<option value="tundra">冻土</option>
								<option value="savanna">稀树草原</option>
							</select>
						</div>
						<div class="config-row" id="spawn-zone-row">
							<label>城市区域</label>
							<select id="spawn-zone">
								<option value="downtown">市中心</option>
								<option value="urban">城市区</option>
								<option value="suburban" selected>结合部</option>
								<option value="rural">乡村</option>
								<option value="wild">旷野</option>
							</select>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="main" id="section-editor" style="display:none">
			<div class="le-pn" id="le-pn">
				<div class="pn-header">
					<span class="pn-title-text">资源</span>
					<button class="pn-toggle" id="le-pn-toggle">
						<svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
					</button>
				</div>
				<div class="pn-body">
					<div class="pn-hd-fld">
						<div class="pn-hd-fld-header open" data-fld="buildings">
							<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
							<span>建筑</span>
						</div>
						<div class="pn-hd-fld-body open" id="fld-buildings">
							<div class="pn-hd-drg" draggable="true" data-type="building" data-id="house">
								<span class="drag-handle">⋮⋮</span>
								<span>民居</span>
							</div>
							<div class="pn-hd-drg" draggable="true" data-type="building" data-id="shop">
								<span class="drag-handle">⋮⋮</span>
								<span>商店</span>
							</div>
							<div class="pn-hd-drg" draggable="true" data-type="building" data-id="police">
								<span class="drag-handle">⋮⋮</span>
								<span>警察局</span>
							</div>
							<button class="add-building-btn" id="new-building-btn">+ 新建建筑</button>
						</div>
					</div>
					<div class="pn-hd-fld">
						<div class="pn-hd-fld-header" data-fld="furniture">
							<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
							<span>家具</span>
						</div>
						<div class="pn-hd-fld-body" id="fld-furniture">
							<button class="new-furniture-btn" id="new-furniture-btn">+ 新建家具</button>
						</div>
					</div>
					<div class="pn-hd-fld">
						<div class="pn-hd-fld-header" data-fld="entities">
							<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
							<span>实体</span>
						</div>
						<div class="pn-hd-fld-body" id="fld-entities">
							<button class="new-entity-btn" id="new-entity-btn">+ 新建实体</button>
						</div>
					</div>
					<div class="pn-hd-fld">
						<div class="pn-hd-fld-header" data-fld="events">
							<svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
							<span>世界事件</span>
						</div>
						<div class="pn-hd-fld-body" id="fld-events">
							<button class="new-event-btn" id="new-event-btn">+ 新建事件</button>
						</div>
					</div>
				</div>
			</div>
			<div class="pn-resizer horizontal le-resizer" id="le-resizer"></div>
			<div class="edt-cv" id="edt-cv">
				<canvas id="editor-canvas"></canvas>
				<div class="canvas-info" id="canvas-info">坐标: 0, 0 | 距离: 50</div>
				<div class="voxel-toolbar" id="voxel-toolbar">
					<button class="voxel-tool-btn active" data-voxel-tool="add" title="添加方块">
						<svg viewBox="0 0 24 24"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
					</button>
					<button class="voxel-tool-btn" data-voxel-tool="remove" title="删除方块">
						<svg viewBox="0 0 24 24"><path d="M5 12h14"/></svg>
					</button>
					<button class="voxel-tool-btn" data-voxel-tool="paint" title="绘制颜色">
						<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
					</button>
					<button class="voxel-tool-btn" data-voxel-tool="eyedrop" title="吸取颜色">
						<svg viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
					</button>
					<input type="color" class="voxel-color-picker" id="voxel-color" value="#166d3b" title="选择颜色">
				</div>
				<div class="edit-mode-banner" id="edit-mode-banner">
					<span class="mode-name" id="edit-mode-name">建筑编辑</span>
					<button class="exit-btn" id="exit-edit-mode">完成</button>
				</div>
				<div class="gizmo-wrapper">
					<div class="gizmo" id="gizmo">
						<div class="gizmo-inner" id="gizmo-inner">
							<div class="gizmo-face gizmo-south" data-view="south"><span>南</span></div>
							<div class="gizmo-face gizmo-north" data-view="north"><span>北</span></div>
							<div class="gizmo-face gizmo-east" data-view="east"><span>东</span></div>
							<div class="gizmo-face gizmo-west" data-view="west"><span>西</span></div>
							<div class="gizmo-face gizmo-top" data-view="top"><span>上</span></div>
							<div class="gizmo-face gizmo-bottom" data-view="bottom"><span>下</span></div>
						</div>
					</div>
				</div>
			</div>
			<div class="pn-resizer horizontal ri-resizer" id="ri-resizer"></div>
			<div class="ri-pn" id="ri-pn">
				<div class="pn-header">
					<span class="pn-title-text">属性</span>
					<button class="pn-toggle" id="ri-pn-toggle">
						<svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
					</button>
				</div>
				<div class="pn-body">
					<div class="empty-state" id="empty-props">
						<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
						<span>选择对象以编辑属性</span>
					</div>
					<div class="prop-section" id="selection-props" style="display:none">
						<div class="prop-label">选中对象</div>
						<div class="prop-row">
							<div class="prop-col">
								<div class="prop-label">X</div>
								<input type="number" class="prop-input" id="sel-x">
							</div>
							<div class="prop-col">
								<div class="prop-label">Y</div>
								<input type="number" class="prop-input" id="sel-y">
							</div>
							<div class="prop-col">
								<div class="prop-label">Z</div>
								<input type="number" class="prop-input" id="sel-z">
							</div>
						</div>
					</div>
					<div class="prop-section" id="physics-props" style="display:none">
						<div class="prop-label">物理属性</div>
						<div class="prop-row">
							<div class="prop-col">
								<div class="prop-label">质量 kg</div>
								<input type="number" class="prop-input" id="prop-mass" value="1">
							</div>
						</div>
						<div class="prop-row">
							<div class="prop-col">
								<div class="prop-label">硬度</div>
								<input type="range" class="prop-input" id="prop-hardness" min="0" max="100" value="50">
							</div>
						</div>
						<div class="prop-row">
							<div class="prop-col">
								<div class="prop-label">弹性</div>
								<input type="range" class="prop-input" id="prop-elasticity" min="0" max="100" value="30">
							</div>
						</div>
						<div class="prop-row">
							<div class="prop-col">
								<div class="prop-label">脆度</div>
								<input type="range" class="prop-input" id="prop-fragility" min="0" max="100" value="20">
							</div>
						</div>
					</div>
					<div class="building-props" id="building-props">
						<div class="prop-section">
							<div class="prop-label">建筑信息</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">名称</div>
									<input type="text" class="prop-input" id="building-name" value="新建筑">
								</div>
							</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">种类</div>
									<select class="prop-input" id="building-category">
										<option value="residential">住宅</option>
										<option value="commercial">商业</option>
										<option value="police">警察局</option>
										<option value="fire">消防局</option>
										<option value="school">学校</option>
										<option value="hospital">医院</option>
									</select>
								</div>
							</div>
						</div>
						<div class="prop-section">
							<div class="prop-label">生成规则</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">确保生成</div>
									<label class="swt"><input type="checkbox" id="building-ensure"><span class="swt-trk"></span></label>
								</div>
							</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">可作为出生点</div>
									<label class="swt"><input type="checkbox" id="building-spawn"><span class="swt-trk"></span></label>
								</div>
							</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">出生点半径 km</div>
									<input type="number" class="prop-input" id="building-spawn-radius" value="1" min="0.1" step="0.1">
								</div>
							</div>
						</div>
						<div class="prop-section">
							<div class="prop-label">Voxel 尺寸</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">宽 (X)</div>
									<input type="number" class="prop-input" id="voxel-size-x" value="16" min="1" max="256">
								</div>
								<div class="prop-col">
									<div class="prop-label">深 (Y)</div>
									<input type="number" class="prop-input" id="voxel-size-y" value="16" min="1" max="256">
								</div>
								<div class="prop-col">
									<div class="prop-label">高 (Z)</div>
									<input type="number" class="prop-input" id="voxel-size-z" value="16" min="1" max="256">
								</div>
							</div>
							<div class="voxel-size-info">单位: 1/16 米 (6.25cm)</div>
						</div>
						<div class="prop-section">
							<div class="prop-label">调色板</div>
							<div class="color-palette" id="color-palette"></div>
						</div>
					</div>
					<div class="event-props" id="event-props">
						<div class="prop-section">
							<div class="prop-label">事件信息</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">名称</div>
									<input type="text" class="prop-input" id="event-name" value="新事件">
								</div>
							</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">唯一性</div>
									<select class="prop-input" id="event-uniqueness">
										<option value="none">无</option>
										<option value="global">全局唯一</option>
										<option value="per_entity">每实体唯一</option>
									</select>
								</div>
							</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">优先级</div>
									<input type="number" class="prop-input" id="event-priority" value="0">
								</div>
							</div>
						</div>
						<div class="prop-section">
							<div class="prop-label">触发器</div>
							<div class="trigger-list" id="trigger-list"></div>
							<button class="add-trigger-btn" id="add-trigger-btn">+ 添加触发器</button>
						</div>
					</div>
					<div class="entity-props" id="entity-props">
						<div class="prop-section">
							<div class="prop-label">实体信息</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">名称</div>
									<input type="text" class="prop-input" id="entity-name" value="新实体">
								</div>
							</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">类型</div>
									<select class="prop-input" id="entity-type">
										<option value="generic">通用</option>
										<option value="npc">NPC</option>
										<option value="enemy">敌人</option>
										<option value="item">物品</option>
										<option value="vehicle">载具</option>
									</select>
								</div>
							</div>
						</div>
						<div class="prop-section">
							<div class="prop-label">物理属性</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">质量 (kg)</div>
									<input type="number" class="prop-input" id="entity-mass" value="1" min="0.01" step="0.1">
								</div>
							</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">硬度</div>
									<input type="range" class="prop-input" id="entity-hardness" min="0" max="100" value="50">
								</div>
							</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">弹性</div>
									<input type="range" class="prop-input" id="entity-elasticity" min="0" max="100" value="30">
								</div>
							</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">脆度</div>
									<input type="range" class="prop-input" id="entity-fragility" min="0" max="100" value="20">
								</div>
							</div>
						</div>
						<div class="prop-section">
							<div class="prop-label">碰撞箱</div>
							<div class="collision-box-list" id="collision-box-list"></div>
							<button class="add-collision-btn" id="add-collision-btn">+ 添加碰撞箱</button>
						</div>
						<div class="prop-section">
							<div class="prop-label">触发词</div>
							<div class="trigger-word-list" id="entity-trigger-words"></div>
							<div class="prop-row">
								<input type="text" class="prop-input" id="entity-trigger-word-input" placeholder="输入触发词...">
								<button class="add-trigger-word-btn" id="add-trigger-word-btn">+</button>
							</div>
						</div>
						<div class="prop-section">
							<div class="prop-label">AI绑定</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">AI类型</div>
									<select class="prop-input" id="entity-ai-type">
										<option value="none">无</option>
										<option value="passive">被动</option>
										<option value="neutral">中立</option>
										<option value="hostile">敌对</option>
										<option value="friendly">友好</option>
										<option value="custom">自定义</option>
									</select>
								</div>
							</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">AI脚本ID</div>
									<input type="text" class="prop-input" id="entity-ai-script" placeholder="自定义AI脚本ID">
								</div>
							</div>
						</div>
					</div>
					<div class="furniture-props" id="furniture-props">
						<div class="prop-section">
							<div class="prop-label">家具信息</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">名称</div>
									<input type="text" class="prop-input" id="furniture-name" value="新家具">
								</div>
							</div>
							<div class="prop-row">
								<div class="prop-col">
									<div class="prop-label">占地 X</div>
									<input type="number" class="prop-input" id="furniture-size-x" value="1" min="1" max="16">
								</div>
								<div class="prop-col">
									<div class="prop-label">占地 Y</div>
									<input type="number" class="prop-input" id="furniture-size-y" value="1" min="1" max="16">
								</div>
							</div>
						</div>
						<div class="prop-section">
							<div class="prop-label">可放置建筑</div>
							<div class="building-select-list" id="furniture-buildings"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="section-split" id="section-map">
			<div class="sec-le-pn">
				<div class="pn-hd">地图设置</div>
				<div class="pn-bd">
					<div class="map-cat-lst" id="map-cat-lst">
						<div class="map-cat-item sel" data-cat="planet">星球设置</div>
						<div class="map-cat-item" data-cat="terrain">地貌参数</div>
						<div class="map-cat-item" data-cat="terrain-weight">地貌生成权重</div>
						<div class="map-cat-item" data-cat="city">城市参数</div>
						<div class="map-cat-item" data-cat="city-weight">城市生成权重</div>
					</div>
				</div>
			</div>
			<div class="sec-ri-pn">
				<div class="pn-hd">地图属性</div>
				<div class="pn-bd" id="map-detail">
					<div class="config-section" data-cat="planet">
						<div class="config-section-title">星球设置</div>
						<div class="config-row">
							<label>贴图风格</label>
							<select id="cfg-style">
								<option value="cyberpunk">赛博朋克</option>
								<option value="steampunk">蒸汽朋克</option>
								<option value="modern" selected>现代</option>
								<option value="chinese">中式</option>
								<option value="cartoon">卡通</option>
								<option value="medieval">中世纪</option>
								<option value="space">太空</option>
							</select>
						</div>
						<div class="config-row">
							<label>破败风格</label>
							<label class="swt"><input type="checkbox" id="cfg-ruined"><span class="swt-trk"></span></label>
						</div>
						<div class="config-row">
							<label>平均气温</label>
							<input type="range" id="cfg-temp" min="-100" max="100" value="20">
							<span class="unit">°C</span>
						</div>
						<div class="config-row">
							<label>白天占比</label>
							<input type="range" id="cfg-daylight" min="0" max="100" value="50">
							<span class="unit">%</span>
						</div>
						<div class="config-row">
							<label>阳光颜色</label>
							<input type="color" id="cfg-sun-color" value="#fffaf0">
						</div>
						<div class="config-row">
							<label>阳光强度</label>
							<input type="range" id="cfg-sun-intensity" min="0" max="1000" value="100">
							<span class="unit">%</span>
						</div>
						<div class="config-row">
							<label>月光颜色</label>
							<input type="color" id="cfg-moon-color" value="#c0d0ff">
						</div>
						<div class="config-row">
							<label>月光强度</label>
							<input type="range" id="cfg-moon-intensity" min="0" max="1000" value="30">
							<span class="unit">%</span>
						</div>
					</div>
					<div class="config-section" data-cat="terrain" style="display:none">
						<div class="config-section-title">地貌参数</div>
						<div class="config-row">
							<label>湖泊密度</label>
							<input type="range" id="cfg-lake-density" min="0" max="1000" value="100">
							<span class="unit">%</span>
						</div>
						<div class="config-row">
							<label>湖泊平均半径</label>
							<input type="number" id="cfg-lake-radius" value="500" min="1" max="10000">
							<span class="unit">m</span>
						</div>
						<div class="config-row">
							<label>湖泊平均水深</label>
							<input type="number" id="cfg-lake-depth" value="20" min="1" max="10000">
							<span class="unit">m</span>
						</div>
						<div class="config-row">
							<label>河流密度</label>
							<input type="range" id="cfg-river-density" min="0" max="1000" value="200">
							<span class="unit">%</span>
						</div>
						<div class="config-row">
							<label>河流平均宽度</label>
							<input type="number" id="cfg-river-width" value="50" min="1" max="1000">
							<span class="unit">m</span>
						</div>
						<div class="config-row">
							<label>河流平均水深</label>
							<input type="number" id="cfg-river-depth" value="5" min="1" max="10000">
							<span class="unit">m</span>
						</div>
						<div class="config-row">
							<label>支流密度</label>
							<input type="range" id="cfg-tributary-density" min="0" max="1000" value="100">
							<span class="unit">%</span>
						</div>
						<div class="config-row">
							<label>山脉密度</label>
							<input type="range" id="cfg-mountain-density" min="0" max="1000" value="150">
							<span class="unit">%</span>
						</div>
						<div class="config-row">
							<label>山脉平均海拔</label>
							<input type="number" id="cfg-mountain-height" value="2000" min="0" max="10000">
							<span class="unit">m</span>
						</div>
					</div>
					<div class="config-section" data-cat="terrain-weight" style="display:none">
						<div class="config-section-title">地貌生成权重</div>
						<div class="config-row"><label>草地</label><label class="swt"><input type="checkbox" id="cfg-biome-grassland" checked><span class="swt-trk"></span></label><input type="range" id="cfg-biome-grassland-weight" min="0" max="1000" value="300"></div>
						<div class="config-row"><label>极地</label><label class="swt"><input type="checkbox" id="cfg-biome-polar"><span class="swt-trk"></span></label><input type="range" id="cfg-biome-polar-weight" min="0" max="1000" value="50"></div>
						<div class="config-row"><label>沼泽</label><label class="swt"><input type="checkbox" id="cfg-biome-swamp"><span class="swt-trk"></span></label><input type="range" id="cfg-biome-swamp-weight" min="0" max="1000" value="100"></div>
						<div class="config-row"><label>沙漠</label><label class="swt"><input type="checkbox" id="cfg-biome-desert"><span class="swt-trk"></span></label><input type="range" id="cfg-biome-desert-weight" min="0" max="1000" value="150"></div>
						<div class="config-row"><label>雨林</label><label class="swt"><input type="checkbox" id="cfg-biome-rainforest"><span class="swt-trk"></span></label><input type="range" id="cfg-biome-rainforest-weight" min="0" max="1000" value="100"></div>
						<div class="config-row"><label>冻土</label><label class="swt"><input type="checkbox" id="cfg-biome-tundra"><span class="swt-trk"></span></label><input type="range" id="cfg-biome-tundra-weight" min="0" max="1000" value="80"></div>
						<div class="config-row"><label>稀树草原</label><label class="swt"><input type="checkbox" id="cfg-biome-savanna"><span class="swt-trk"></span></label><input type="range" id="cfg-biome-savanna-weight" min="0" max="1000" value="120"></div>
					</div>
					<div class="config-section" data-cat="city" style="display:none">
						<div class="config-section-title">城市参数</div>
						<div class="config-row">
							<label>城市模式</label>
							<select id="cfg-city-mode">
								<option value="none">无城市</option>
								<option value="standard" selected>标准模式</option>
								<option value="infinite">城市无限延伸</option>
								<option value="single">单城市</option>
							</select>
						</div>
						<div class="config-row">
							<label>城市间隔</label>
							<input type="number" id="cfg-city-spacing" value="8" min="1" max="100">
							<span class="unit">km</span>
						</div>
						<div class="config-row">
							<label>城市半径</label>
							<input type="number" id="cfg-city-radius" value="3" min="0.5" max="50" step="0.5">
							<span class="unit">km</span>
						</div>
					</div>
					<div class="config-section" data-cat="city-weight" style="display:none">
						<div class="config-section-title">城市生成权重</div>
						<div class="config-row"><label>市中心</label><label class="swt"><input type="checkbox" id="cfg-zone-downtown" checked><span class="swt-trk"></span></label><input type="range" id="cfg-zone-downtown-weight" min="0" max="1000" value="100"></div>
						<div class="config-row"><label>城市区</label><label class="swt"><input type="checkbox" id="cfg-zone-urban" checked><span class="swt-trk"></span></label><input type="range" id="cfg-zone-urban-weight" min="0" max="1000" value="300"></div>
						<div class="config-row"><label>结合部</label><label class="swt"><input type="checkbox" id="cfg-zone-suburban" checked><span class="swt-trk"></span></label><input type="range" id="cfg-zone-suburban-weight" min="0" max="1000" value="200"></div>
						<div class="config-row"><label>乡村</label><label class="swt"><input type="checkbox" id="cfg-zone-rural" checked><span class="swt-trk"></span></label><input type="range" id="cfg-zone-rural-weight" min="0" max="1000" value="150"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="section-split" id="section-weather">
			<div class="sec-le-pn">
				<div class="pn-hd">天气预设</div>
				<div class="pn-bd">
					<div class="weather-lst" id="weather-lst">
						<div class="weather-item sel" data-id="sunny">晴天</div>
						<div class="weather-item" data-id="cloudy">多云</div>
						<div class="weather-item" data-id="rainy">雨天</div>
					</div>
					<button class="weather-add" id="weather-add">+ 添加天气</button>
				</div>
			</div>
			<div class="sec-ri-pn">
				<div class="pn-hd">天气参数</div>
				<div class="pn-bd" id="weather-detail">
					<div class="config-section">
						<div class="config-section-title">天气列表</div>
						<div class="weather-list" id="weather-list"></div>
						<button class="add-weather-btn" id="add-weather-btn">+ 添加天气</button>
					</div>
					<div class="config-section" id="weather-editor" style="display:none">
						<div class="config-section-title">天气编辑</div>
						<div class="config-row">
							<label>天气名称</label>
							<input type="text" class="settings-input" id="weather-name" value="新天气">
						</div>
						<div class="config-row">
							<label>发生时间</label>
							<select class="settings-select" id="weather-time">
								<option value="any">不限时间</option>
								<option value="day">仅限昼间</option>
								<option value="night">仅限夜间</option>
							</select>
						</div>
						<div class="config-row">
							<label>降雨强度</label>
							<input type="range" class="settings-slider" id="weather-rain" min="0" max="100" value="0">
							<span class="unit">%</span>
						</div>
						<div class="config-row">
							<label>打闪频率</label>
							<input type="range" class="settings-slider" id="weather-lightning" min="0" max="100" value="0">
							<span class="unit">%</span>
						</div>
						<div class="config-row">
							<label>光照颜色</label>
							<input type="color" class="settings-color" id="weather-light-color" value="#ffffff">
						</div>
						<div class="config-row">
							<label>光照强度</label>
							<input type="range" class="settings-slider" id="weather-light-intensity" min="0" max="1000" value="100">
							<span class="unit">%</span>
						</div>
						<div class="config-row">
							<label>气温调整</label>
							<input type="number" class="settings-input" id="weather-temp" value="0" min="-50" max="50">
							<span class="unit">°C</span>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="section-split" id="section-system">
			<div class="sec-le-pn">
				<div class="pn-hd">设置分类</div>
				<div class="pn-bd">
					<div class="sys-cat-lst" id="sys-cat-lst">
						<div class="sys-cat-item sel" data-id="gameplay">游玩设置</div>
						<div class="sys-cat-item" data-id="graphics">画质设置</div>
						<div class="sys-cat-item" data-id="audio">音频设置</div>
						<div class="sys-cat-item" data-id="controls">控制设置</div>
					</div>
				</div>
			</div>
			<div class="sec-ri-pn">
				<div class="pn-hd">设置详情</div>
				<div class="pn-bd" id="sys-detail">
					<div class="config-section">
						<div class="config-section-title">游玩设置</div>
						<div class="config-row">
							<label>上帝模式</label>
							<label class="swt"><input type="checkbox" id="cfg-godmode"><span class="swt-trk"></span></label>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="section-split" id="section-skills">
			<div class="sec-le-pn">
				<div class="pn-hd">技能列表</div>
				<div class="pn-bd">
					<div class="skill-lst" id="skill-lst">
						<div class="skill-item sel" data-id="hacker">骇客系统</div>
						<div class="skill-item" data-id="magic">魔法系统</div>
						<div class="skill-item" data-id="qi">真气系统</div>
					</div>
					<button class="skill-add" id="skill-add">+ 添加技能</button>
				</div>
			</div>
			<div class="sec-ri-pn">
				<div class="pn-hd">技能属性</div>
				<div class="pn-bd" id="skill-detail">
					<div class="skill-system-item" data-skill="hacker">
						<div class="skill-system-header">
							<label class="swt"><input type="checkbox" class="skill-system-toggle" id="skill-hacker"><span class="swt-trk"></span></label>
							<span class="skill-system-name">骇客系统 (赛博朋克)</span>
						</div>
						<div class="skill-system-body">
							<div class="config-row"><label>最小RAM</label><input type="number" class="settings-input" value="10" min="1"></div>
							<div class="config-row"><label>最大RAM</label><input type="checkbox"><input type="number" class="settings-input" value="100" min="1"></div>
							<div class="config-row"><label>RAM回复/秒</label><input type="number" class="settings-input" value="1" step="0.1"></div>
							<div class="config-row"><label>每级增加RAM</label><input type="number" class="settings-input" value="5" min="0"></div>
							<div class="config-row"><label>最小等级</label><input type="number" class="settings-input" value="1" min="1"></div>
							<div class="config-row"><label>最大等级</label><input type="checkbox"><input type="number" class="settings-input" value="50" min="1"></div>
							<div class="config-row"><label>每级经验值</label><input type="number" class="settings-input" value="100" min="1"></div>
							<div class="config-row"><label>经验需求增长</label><input type="number" class="settings-input" value="1.2" step="0.1" min="1"></div>
							<div class="config-row"><label>击杀经验值</label><input type="number" class="settings-input" value="10" min="0"></div>
						</div>
					</div>
					<div class="skill-system-item" data-skill="magic">
						<div class="skill-system-header">
							<label class="swt"><input type="checkbox" class="skill-system-toggle" id="skill-magic"><span class="swt-trk"></span></label>
							<span class="skill-system-name">魔法系统 (哈利波特)</span>
						</div>
						<div class="skill-system-body">
							<div class="config-row"><label>最小法力</label><input type="number" class="settings-input" value="50" min="1"></div>
							<div class="config-row"><label>最大法力</label><input type="checkbox"><input type="number" class="settings-input" value="500" min="1"></div>
							<div class="config-row"><label>法力回复/秒</label><input type="number" class="settings-input" value="2" step="0.1"></div>
							<div class="config-row"><label>每级增加法力</label><input type="number" class="settings-input" value="10" min="0"></div>
							<div class="config-row"><label>最小等级</label><input type="number" class="settings-input" value="1" min="1"></div>
							<div class="config-row"><label>最大等级</label><input type="checkbox"><input type="number" class="settings-input" value="100" min="1"></div>
							<div class="config-row"><label>每级经验值</label><input type="number" class="settings-input" value="100" min="1"></div>
							<div class="config-row"><label>经验需求增长</label><input type="number" class="settings-input" value="1.15" step="0.1" min="1"></div>
							<div class="config-row"><label>击杀经验值</label><input type="number" class="settings-input" value="15" min="0"></div>
						</div>
					</div>
					<div class="skill-system-item" data-skill="qi">
						<div class="skill-system-header">
							<label class="swt"><input type="checkbox" class="skill-system-toggle" id="skill-qi"><span class="swt-trk"></span></label>
							<span class="skill-system-name">真气系统 (修仙)</span>
						</div>
						<div class="skill-system-body">
							<div class="config-row"><label>最小真气</label><input type="number" class="settings-input" value="100" min="1"></div>
							<div class="config-row"><label>最大真气</label><input type="checkbox"><input type="number" class="settings-input" value="10000" min="1"></div>
							<div class="config-row"><label>真气回复/秒</label><input type="number" class="settings-input" value="5" step="0.1"></div>
							<div class="config-row"><label>每级增加真气</label><input type="number" class="settings-input" value="50" min="0"></div>
							<div class="config-row"><label>最小境界</label><input type="number" class="settings-input" value="1" min="1"></div>
							<div class="config-row"><label>最大境界</label><input type="checkbox"><input type="number" class="settings-input" value="9" min="1"></div>
							<div class="config-row"><label>每级经验值</label><input type="number" class="settings-input" value="1000" min="1"></div>
							<div class="config-row"><label>经验需求增长</label><input type="number" class="settings-input" value="2" step="0.1" min="1"></div>
							<div class="config-row"><label>击杀经验值</label><input type="number" class="settings-input" value="50" min="0"></div>
						</div>
					</div>
					<div class="skill-system-item" data-skill="ninjutsu">
						<div class="skill-system-header">
							<label class="swt"><input type="checkbox" class="skill-system-toggle" id="skill-ninjutsu"><span class="swt-trk"></span></label>
							<span class="skill-system-name">忍术系统 (火影)</span>
						</div>
						<div class="skill-system-body">
							<div class="config-row"><label>最小查克拉</label><input type="number" class="settings-input" value="50" min="1"></div>
							<div class="config-row"><label>最大查克拉</label><input type="checkbox"><input type="number" class="settings-input" value="1000" min="1"></div>
							<div class="config-row"><label>查克拉回复/秒</label><input type="number" class="settings-input" value="3" step="0.1"></div>
							<div class="config-row"><label>每级增加查克拉</label><input type="number" class="settings-input" value="20" min="0"></div>
							<div class="config-row"><label>最小等级</label><input type="number" class="settings-input" value="1" min="1"></div>
							<div class="config-row"><label>最大等级</label><input type="checkbox"><input type="number" class="settings-input" value="100" min="1"></div>
							<div class="config-row"><label>每级经验值</label><input type="number" class="settings-input" value="200" min="1"></div>
							<div class="config-row"><label>经验需求增长</label><input type="number" class="settings-input" value="1.2" step="0.1" min="1"></div>
							<div class="config-row"><label>击杀经验值</label><input type="number" class="settings-input" value="25" min="0"></div>
						</div>
					</div>
					<div class="skill-system-item" data-skill="haki">
						<div class="skill-system-header">
							<label class="swt"><input type="checkbox" class="skill-system-toggle" id="skill-haki"><span class="swt-trk"></span></label>
							<span class="skill-system-name">霸气系统 (海贼王)</span>
						</div>
						<div class="skill-system-body">
							<div class="config-row"><label>最小霸气</label><input type="number" class="settings-input" value="30" min="1"></div>
							<div class="config-row"><label>最大霸气</label><input type="checkbox"><input type="number" class="settings-input" value="500" min="1"></div>
							<div class="config-row"><label>霸气回复/秒</label><input type="number" class="settings-input" value="1" step="0.1"></div>
							<div class="config-row"><label>每级增加霸气</label><input type="number" class="settings-input" value="15" min="0"></div>
							<div class="config-row"><label>最小等级</label><input type="number" class="settings-input" value="1" min="1"></div>
							<div class="config-row"><label>最大等级</label><input type="checkbox"><input type="number" class="settings-input" value="100" min="1"></div>
							<div class="config-row"><label>每级经验值</label><input type="number" class="settings-input" value="150" min="1"></div>
							<div class="config-row"><label>经验需求增长</label><input type="number" class="settings-input" value="1.3" step="0.1" min="1"></div>
							<div class="config-row"><label>击杀经验值</label><input type="number" class="settings-input" value="20" min="0"></div>
						</div>
					</div>
					<div class="skill-system-item" data-skill="curse">
						<div class="skill-system-header">
							<label class="swt"><input type="checkbox" class="skill-system-toggle" id="skill-curse"><span class="swt-trk"></span></label>
							<span class="skill-system-name">咒术系统 (咒术回战)</span>
						</div>
						<div class="skill-system-body">
							<div class="config-row"><label>最小咒力</label><input type="number" class="settings-input" value="40" min="1"></div>
							<div class="config-row"><label>最大咒力</label><input type="checkbox"><input type="number" class="settings-input" value="800" min="1"></div>
							<div class="config-row"><label>咒力回复/秒</label><input type="number" class="settings-input" value="2" step="0.1"></div>
							<div class="config-row"><label>每级增加咒力</label><input type="number" class="settings-input" value="20" min="0"></div>
							<div class="config-row"><label>最小等级</label><input type="number" class="settings-input" value="1" min="1"></div>
							<div class="config-row"><label>最大等级</label><input type="checkbox"><input type="number" class="settings-input" value="100" min="1"></div>
							<div class="config-row"><label>每级经验值</label><input type="number" class="settings-input" value="180" min="1"></div>
							<div class="config-row"><label>经验需求增长</label><input type="number" class="settings-input" value="1.25" step="0.1" min="1"></div>
							<div class="config-row"><label>击杀经验值</label><input type="number" class="settings-input" value="30" min="0"></div>
						</div>
					</div>
					<div class="skill-system-item" data-skill="force">
						<div class="skill-system-header">
							<label class="swt"><input type="checkbox" class="skill-system-toggle" id="skill-force"><span class="swt-trk"></span></label>
							<span class="skill-system-name">原力系统 (星球大战)</span>
						</div>
						<div class="skill-system-body">
							<div class="config-row"><label>最小原力</label><input type="number" class="settings-input" value="50" min="1"></div>
							<div class="config-row"><label>最大原力</label><input type="checkbox"><input type="number" class="settings-input" value="500" min="1"></div>
							<div class="config-row"><label>原力回复/秒</label><input type="number" class="settings-input" value="2" step="0.1"></div>
							<div class="config-row"><label>每级增加原力</label><input type="number" class="settings-input" value="15" min="0"></div>
							<div class="config-row"><label>最小等级</label><input type="number" class="settings-input" value="1" min="1"></div>
							<div class="config-row"><label>最大等级</label><input type="checkbox"><input type="number" class="settings-input" value="100" min="1"></div>
							<div class="config-row"><label>每级经验值</label><input type="number" class="settings-input" value="120" min="1"></div>
							<div class="config-row"><label>经验需求增长</label><input type="number" class="settings-input" value="1.2" step="0.1" min="1"></div>
							<div class="config-row"><label>击杀经验值</label><input type="number" class="settings-input" value="20" min="0"></div>
						</div>
					</div>
					<div class="skill-system-item" data-skill="breath">
						<div class="skill-system-header">
							<label class="swt"><input type="checkbox" class="skill-system-toggle" id="skill-breath"><span class="swt-trk"></span></label>
							<span class="skill-system-name">呼吸系统 (鬼灭之刃)</span>
						</div>
						<div class="skill-system-body">
							<div class="config-row"><label>最小呼吸</label><input type="number" class="settings-input" value="30" min="1"></div>
							<div class="config-row"><label>最大呼吸</label><input type="checkbox"><input type="number" class="settings-input" value="300" min="1"></div>
							<div class="config-row"><label>呼吸回复/秒</label><input type="number" class="settings-input" value="5" step="0.1"></div>
							<div class="config-row"><label>每级增加呼吸</label><input type="number" class="settings-input" value="10" min="0"></div>
							<div class="config-row"><label>最小等级</label><input type="number" class="settings-input" value="1" min="1"></div>
							<div class="config-row"><label>最大等级</label><input type="checkbox"><input type="number" class="settings-input" value="10" min="1"></div>
							<div class="config-row"><label>每级经验值</label><input type="number" class="settings-input" value="500" min="1"></div>
							<div class="config-row"><label>经验需求增长</label><input type="number" class="settings-input" value="1.5" step="0.1" min="1"></div>
							<div class="config-row"><label>击杀经验值</label><input type="number" class="settings-input" value="50" min="0"></div>
						</div>
					</div>
					<div class="skill-system-item" data-skill="magecraft">
						<div class="skill-system-header">
							<label class="swt"><input type="checkbox" class="skill-system-toggle" id="skill-magecraft"><span class="swt-trk"></span></label>
							<span class="skill-system-name">魔术系统 (FATE)</span>
						</div>
						<div class="skill-system-body">
							<div class="config-row"><label>最小魔力</label><input type="number" class="settings-input" value="50" min="1"></div>
							<div class="config-row"><label>最大魔力</label><input type="checkbox"><input type="number" class="settings-input" value="1000" min="1"></div>
							<div class="config-row"><label>魔力回复/秒</label><input type="number" class="settings-input" value="2" step="0.1"></div>
							<div class="config-row"><label>每级增加魔力</label><input type="number" class="settings-input" value="25" min="0"></div>
							<div class="config-row"><label>最小等级</label><input type="number" class="settings-input" value="1" min="1"></div>
							<div class="config-row"><label>最大等级</label><input type="checkbox"><input type="number" class="settings-input" value="100" min="1"></div>
							<div class="config-row"><label>每级经验值</label><input type="number" class="settings-input" value="200" min="1"></div>
							<div class="config-row"><label>经验需求增长</label><input type="number" class="settings-input" value="1.2" step="0.1" min="1"></div>
							<div class="config-row"><label>击杀经验值</label><input type="number" class="settings-input" value="25" min="0"></div>
						</div>
					</div>
					<div class="skill-system-item" data-skill="ability">
						<div class="skill-system-header">
							<label class="swt"><input type="checkbox" class="skill-system-toggle" id="skill-ability"><span class="swt-trk"></span></label>
							<span class="skill-system-name">能力系统 (魔禁)</span>
						</div>
						<div class="skill-system-body">
							<div class="config-row"><label>最小算力</label><input type="number" class="settings-input" value="20" min="1"></div>
							<div class="config-row"><label>最大算力</label><input type="checkbox"><input type="number" class="settings-input" value="500" min="1"></div>
							<div class="config-row"><label>算力回复/秒</label><input type="number" class="settings-input" value="1" step="0.1"></div>
							<div class="config-row"><label>每级增加算力</label><input type="number" class="settings-input" value="10" min="0"></div>
							<div class="config-row"><label>最小等级</label><input type="number" class="settings-input" value="0" min="0"></div>
							<div class="config-row"><label>最大等级</label><input type="checkbox"><input type="number" class="settings-input" value="5" min="1"></div>
							<div class="config-row"><label>每级经验值</label><input type="number" class="settings-input" value="1000" min="1"></div>
							<div class="config-row"><label>经验需求增长</label><input type="number" class="settings-input" value="2" step="0.1" min="1"></div>
							<div class="config-row"><label>击杀经验值</label><input type="number" class="settings-input" value="100" min="0"></div>
						</div>
					</div>
					<div class="skill-system-item" data-skill="stand">
						<div class="skill-system-header">
							<label class="swt"><input type="checkbox" class="skill-system-toggle" id="skill-stand"><span class="swt-trk"></span></label>
							<span class="skill-system-name">替身系统 (JOJO)</span>
						</div>
						<div class="skill-system-body">
							<div class="config-row"><label>替身名称</label><input type="text" class="settings-input" value="Star Platinum"></div>
							<div class="config-row"><label>破坏力 (A-E)</label><select class="settings-select"><option>A</option><option>B</option><option selected>C</option><option>D</option><option>E</option></select></div>
							<div class="config-row"><label>速度 (A-E)</label><select class="settings-select"><option>A</option><option>B</option><option selected>C</option><option>D</option><option>E</option></select></div>
							<div class="config-row"><label>射程 (A-E)</label><select class="settings-select"><option>A</option><option>B</option><option selected>C</option><option>D</option><option>E</option></select></div>
							<div class="config-row"><label>持久力 (A-E)</label><select class="settings-select"><option>A</option><option>B</option><option selected>C</option><option>D</option><option>E</option></select></div>
							<div class="config-row"><label>精密度 (A-E)</label><select class="settings-select"><option>A</option><option>B</option><option selected>C</option><option>D</option><option>E</option></select></div>
							<div class="config-row"><label>成长性 (A-E)</label><select class="settings-select"><option>A</option><option>B</option><option selected>C</option><option>D</option><option>E</option></select></div>
							<div class="config-row"><label>能力描述</label><input type="text" class="settings-input" value="时停"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="section-ai" id="section-ai">
			<div class="ai-server-bar" id="ai-server-bar">
				<span style="color:#666;font-size:12px;">服务器:</span>
				<div id="ai-server-lst"></div>
				<button class="ai-add-server-btn" id="ai-add-server-btn">+</button>
			</div>
			<div class="ai-main">
				<div class="ai-le-pn">
					<div class="pn-header">
						<span class="pn-title-text">生成</span>
					</div>
					<div class="pn-body">
						<button class="ai-menu-item" data-ai-menu="model">
							<svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
							生成模型
						</button>
						<button class="ai-menu-item" data-ai-menu="texture">
							<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
							生成贴图
						</button>
						<button class="ai-menu-item" data-ai-menu="voice">
							<svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
							生成语音
						</button>
						<button class="ai-menu-item" data-ai-menu="audio">
							<svg viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
							生成音效
						</button>
						<div style="height:1px;background:#333;margin:8px 0;"></div>
						<button class="ai-menu-item active" data-ai-menu="tasks">
							<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
							任务列表
						</button>
					</div>
				</div>
				<div class="ai-cnt" id="ai-cnt">
					<div class="ai-empty-state" id="ai-empty">
						<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
						<span>上传YAML文件以加载任务</span>
					</div>
					<div class="ai-task-lst" id="ai-task-lst"></div>
					<div class="ai-ctrl-bar">
						<button class="ai-ctrl-btn" id="ai-load-btn">
							<svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
							上传YAML
						</button>
						<button class="ai-ctrl-btn primary" id="ai-start-btn" disabled>
							<svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
							开始处理
						</button>
						<button class="ai-ctrl-btn danger" id="ai-stop-btn" style="display:none;">
							<svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12"/></svg>
							停止
						</button>
						<div class="ai-stats">
							<div class="stat">完成: <span class="stat-val green" id="ai-stat-done">0</span></div>
							<div class="stat">处理中: <span class="stat-val blue" id="ai-stat-running">0</span></div>
							<div class="stat">待处理: <span class="stat-val" id="ai-stat-pending">0</span></div>
							<div class="stat">失败: <span class="stat-val red" id="ai-stat-error">0</span></div>
						</div>
					</div>
				</div>
				<div class="ai-ri-pn" id="ai-ri-pn">
					<div class="pn-header">
						<span class="pn-title-text">配置</span>
					</div>
					<div class="pn-body" id="ai-ri-cnt">
						<div class="ai-config-section" id="ai-cfg-common">
							<div class="section-title">图像生成模型</div>
							<div class="ai-config-row">
								<label>Checkpoint</label>
								<select id="ai-model-sel"><option value="">加载中...</option></select>
							</div>
						</div>
						<div class="ai-config-section" id="ai-cfg-model" style="display:none;">
							<div class="section-title">模型生成配置</div>
							<div class="ai-config-row">
								<label>提示词</label>
								<textarea id="ai-model-prompt" placeholder="描述要生成的3D模型..."></textarea>
							</div>
							<div class="ai-config-row">
								<label>风格</label>
								<select id="ai-model-style">
									<option value="realistic">写实</option>
									<option value="cartoon">卡通</option>
									<option value="lowpoly">低模</option>
								</select>
							</div>
						</div>
						<div class="ai-config-section" id="ai-cfg-texture" style="display:none;">
							<div class="section-title">贴图生成配置</div>
							<div class="ai-config-row">
								<label>提示词</label>
								<textarea id="ai-tex-prompt" placeholder="描述要生成的贴图..."></textarea>
							</div>
							<div class="ai-config-row">
								<label>尺寸</label>
								<select id="ai-tex-size">
									<option value="512">512x512</option>
									<option value="1024" selected>1024x1024</option>
									<option value="2048">2048x2048</option>
								</select>
							</div>
							<div class="ai-config-row">
								<label>无缝</label>
								<label class="swt"><input type="checkbox" id="ai-tex-seamless" checked><span class="swt-trk"></span></label>
							</div>
						</div>
						<div class="ai-config-section" id="ai-cfg-voice" style="display:none;">
							<div class="section-title">语音生成配置</div>
							<div class="ai-config-row">
								<label>文本</label>
								<textarea id="ai-voice-text" placeholder="要转换为语音的文本..."></textarea>
							</div>
							<div class="ai-config-row">
								<label>音色</label>
								<select id="ai-voice-speaker">
									<option value="male1">男声1</option>
									<option value="male2">男声2</option>
									<option value="female1">女声1</option>
									<option value="female2">女声2</option>
								</select>
							</div>
						</div>
						<div class="ai-config-section" id="ai-cfg-audio" style="display:none;">
							<div class="section-title">音效生成配置</div>
							<div class="ai-config-row">
								<label>提示词</label>
								<textarea id="ai-audio-prompt" placeholder="描述要生成的音效..."></textarea>
							</div>
							<div class="ai-config-row">
								<label>时长</label>
								<input type="number" id="ai-audio-duration" value="5" min="1" max="30">
							</div>
						</div>
						<div class="ai-config-section" id="ai-cfg-task">
							<div class="section-title">任务详情</div>
							<div id="ai-task-detail">
								<div class="ai-empty-state" style="padding:40px 0;">
									<span style="font-size:12px;">选择任务查看详情</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="ai-server-md" id="ai-server-md">
			<div class="ai-server-md-cnt">
				<h3>添加服务器</h3>
				<input type="text" id="ai-server-ipt" placeholder="例如: localhost:9527 或 192.168.1.101:9527">
				<div class="md-btns">
					<button class="md-btn cancel" id="ai-server-cancel">取消</button>
					<button class="md-btn confirm" id="ai-server-confirm">连接</button>
				</div>
			</div>
		</div>
		<input type="file" id="ai-yaml-file" accept=".yaml,.yml" style="display:none;">
	</div>
<script>
const TriggerType = {
	IMMEDIATE: 'immediate',
	REAL_TIMER: 'real_timer',
	REAL_TIME: 'real_time',
	GAME_TIMER: 'game_timer',
	GAME_TIME: 'game_time',
	SUBSCRIBE: 'subscribe',
	RUN_COUNT: 'run_count',
	REAL_DURATION: 'real_duration',
	GAME_DURATION: 'game_duration'
}
const EventUniqueness = {
	NONE: 'none',
	GLOBAL: 'global',
	PER_ENTITY: 'per_entity'
}
class SBRSystem {
	constructor() {
		this.subscriptions = new Map()
	}
	subscribe(channel, subscriber, priority = 0) {
		if (!this.subscriptions.has(channel)) {
			this.subscriptions.set(channel, [])
		}
		const list = this.subscriptions.get(channel)
		const entry = { subscriber, priority, timestamp: Date.now() }
		let inserted = false
		for (let i = 0; i < list.length; i++) {
			if (priority > list[i].priority || (priority === list[i].priority && entry.timestamp > list[i].timestamp)) {
				list.splice(i, 0, entry)
				inserted = true
				break
			}
		}
		if (!inserted) list.push(entry)
	}
	unsubscribe(channel, subscriber) {
		if (!this.subscriptions.has(channel)) return
		const list = this.subscriptions.get(channel)
		const idx = list.findIndex(e => e.subscriber === subscriber)
		if (idx >= 0) list.splice(idx, 1)
	}
	async publish(channel, data = {}) {
		if (!this.subscriptions.has(channel)) return { ok: true, results: [] }
		const list = this.subscriptions.get(channel)
		const results = []
		let hasCancel = false
		for (const entry of list) {
			const result = await entry.subscriber.onMessage(channel, data)
			results.push(result)
			if (result.cancel) hasCancel = true
			if (result.stop) break
		}
		return { ok: !hasCancel, cancel: hasCancel, results }
	}
	toJSON() {
		const data = {}
		for (const [channel, list] of this.subscriptions) {
			data[channel] = list.map(e => ({ subscriberId: e.subscriber.id, priority: e.priority }))
		}
		return data
	}
}
class Trigger {
	constructor(config = {}) {
		this.id = config.id || Date.now() + '_' + Math.random().toString(36).substr(2, 9)
		this.type = config.type || TriggerType.IMMEDIATE
		this.enabled = config.enabled !== false
		this.config = {
			interval: config.interval || 1000,
			time: config.time || { hour: 0, minute: 0, second: 0 },
			channels: config.channels || [],
			runCount: config.runCount || 1,
			duration: config.duration || 0
		}
		this.actions = config.actions || []
	}
	toJSON() {
		return {
			id: this.id,
			type: this.type,
			enabled: this.enabled,
			config: this.config,
			actions: this.actions
		}
	}
	static fromJSON(json) {
		return new Trigger(json)
	}
}
class GameEvent {
	constructor(config = {}) {
		this.id = config.id || Date.now() + '_' + Math.random().toString(36).substr(2, 9)
		this.name = config.name || '新事件'
		this.uniqueness = config.uniqueness || EventUniqueness.NONE
		this.priority = config.priority || 0
		this.triggers = (config.triggers || []).map(t => t instanceof Trigger ? t : Trigger.fromJSON(t))
		this.state = 'idle'
		this.runCount = 0
		this.realStartTime = 0
		this.gameStartTime = 0
		this.localVars = {}
	}
	async construct(sbr) {
		const regResult = await sbr.publish(`evt.${this.id}.reg.run`, { event: this })
		if (regResult.cancel) {
			this.state = 'cancelled'
			return false
		}
		this.state = 'active'
		this.realStartTime = Date.now()
		this.gameStartTime = 0
		for (const trigger of this.triggers) {
			if (trigger.enabled && trigger.type === TriggerType.IMMEDIATE) {
				await this.executeTrigger(trigger, sbr)
			}
		}
		await sbr.publish(`evt.${this.id}.reg.end`, { event: this })
		return true
	}
	async executeTrigger(trigger, sbr) {
		const trgResult = await sbr.publish(`evt.${this.id}.trg.run`, { event: this, trigger })
		if (trgResult.cancel) return false
		for (const action of trigger.actions) {
			await this.executeAction(action, sbr)
		}
		this.runCount++
		await sbr.publish(`evt.${this.id}.trg.end`, { event: this, trigger })
		return true
	}
	async executeAction(action, sbr) {
		switch (action.type) {
			case 'set_var':
				if (action.scope === 'global') {
					window.gameVars = window.gameVars || {}
					window.gameVars[action.key] = action.value
				} else {
					this.localVars[action.key] = action.value
				}
				break
			case 'sbr_ok':
				return { ok: true }
			case 'sbr_cancel':
				return { ok: false, cancel: true }
			case 'sbr_stop':
				return { stop: true }
			case 'destruct_self':
				await this.destruct(sbr)
				break
		}
	}
	async destruct(sbr) {
		const cltResult = await sbr.publish(`evt.${this.id}.clt.run`, { event: this })
		if (cltResult.cancel) return false
		for (const trigger of this.triggers) {
			trigger.enabled = false
		}
		this.localVars = {}
		this.state = 'destroyed'
		await sbr.publish(`evt.${this.id}.clt.end`, { event: this })
		return true
	}
	onMessage(channel, data) {
		for (const trigger of this.triggers) {
			if (!trigger.enabled || trigger.type !== TriggerType.SUBSCRIBE) continue
			if (trigger.config.channels.includes(channel)) {
				return { ok: true }
			}
		}
		return { ok: true }
	}
	toJSON() {
		return {
			id: this.id,
			name: this.name,
			uniqueness: this.uniqueness,
			priority: this.priority,
			triggers: this.triggers.map(t => t.toJSON())
		}
	}
	static fromJSON(json) {
		return new GameEvent(json)
	}
}
class CollisionBox {
	constructor(config = {}) {
		this.x = config.x || 0
		this.y = config.y || 0
		this.z = config.z || 0
		this.width = config.width || 1
		this.height = config.height || 1
		this.depth = config.depth || 1
	}
	toJSON() {
		return { x: this.x, y: this.y, z: this.z, width: this.width, height: this.height, depth: this.depth }
	}
	static fromJSON(json) {
		return new CollisionBox(json)
	}
}
class PhysicsBody {
	constructor(config = {}) {
		this.mass = config.mass || 1
		this.hardness = config.hardness || 50
		this.elasticity = config.elasticity || 30
		this.fragility = config.fragility || 20
		this.collisionBoxes = (config.collisionBoxes || []).map(b => b instanceof CollisionBox ? b : CollisionBox.fromJSON(b))
	}
	addCollisionBox(box) {
		this.collisionBoxes.push(box instanceof CollisionBox ? box : new CollisionBox(box))
	}
	removeCollisionBox(index) {
		if (index >= 0 && index < this.collisionBoxes.length) {
			this.collisionBoxes.splice(index, 1)
		}
	}
	toJSON() {
		return {
			mass: this.mass,
			hardness: this.hardness,
			elasticity: this.elasticity,
			fragility: this.fragility,
			collisionBoxes: this.collisionBoxes.map(b => b.toJSON())
		}
	}
	static fromJSON(json) {
		return new PhysicsBody(json)
	}
}
class Entity {
	constructor(config = {}) {
		this.id = config.id || Date.now() + '_' + Math.random().toString(36).substr(2, 9)
		this.name = config.name || '新实体'
		this.type = config.type || 'generic'
		this.voxel = config.voxel ? (config.voxel instanceof VoxelData ? config.voxel : null) : null
		this.physics = config.physics ? (config.physics instanceof PhysicsBody ? config.physics : PhysicsBody.fromJSON(config.physics)) : new PhysicsBody()
		this.triggers = config.triggers || []
		this.triggerWords = config.triggerWords || []
		this.ai = config.ai || { type: 'none', script: '' }
		this.parts = config.parts || []
	}
	toJSON() {
		return {
			id: this.id,
			name: this.name,
			type: this.type,
			voxel: this.voxel ? this.voxel.toJSON() : null,
			physics: this.physics.toJSON(),
			triggers: this.triggers,
			triggerWords: this.triggerWords,
			ai: this.ai,
			parts: this.parts
		}
	}
	static fromJSON(json) {
		const entity = new Entity(json)
		if (json.voxel) {
			entity.voxel = new VoxelData()
			entity.voxel.fromJSON(json.voxel)
		}
		return entity
	}
}
class Furniture {
	constructor(config = {}) {
		this.id = config.id || Date.now() + '_' + Math.random().toString(36).substr(2, 9)
		this.name = config.name || '新家具'
		this.sizeX = config.sizeX || 1
		this.sizeY = config.sizeY || 1
		this.allowedBuildings = config.allowedBuildings || []
		this.voxel = config.voxel ? (config.voxel instanceof VoxelData ? config.voxel : null) : null
	}
	toJSON() {
		return {
			id: this.id,
			name: this.name,
			sizeX: this.sizeX,
			sizeY: this.sizeY,
			allowedBuildings: this.allowedBuildings,
			voxel: this.voxel ? this.voxel.toJSON() : null
		}
	}
	static fromJSON(json) {
		const furniture = new Furniture(json)
		if (json.voxel) {
			furniture.voxel = new VoxelData()
			furniture.voxel.fromJSON(json.voxel)
		}
		return furniture
	}
}
class Weather {
	constructor(config = {}) {
		this.id = config.id || Date.now() + '_' + Math.random().toString(36).substr(2, 9)
		this.name = config.name || '新天气'
		this.timeRestriction = config.timeRestriction || 'any'
		this.rain = config.rain || 0
		this.lightning = config.lightning || 0
		this.lightColor = config.lightColor || '#ffffff'
		this.lightIntensity = config.lightIntensity || 100
		this.tempAdjust = config.tempAdjust || 0
	}
	toJSON() {
		return {
			id: this.id,
			name: this.name,
			timeRestriction: this.timeRestriction,
			rain: this.rain,
			lightning: this.lightning,
			lightColor: this.lightColor,
			lightIntensity: this.lightIntensity,
			tempAdjust: this.tempAdjust
		}
	}
	static fromJSON(json) {
		return new Weather(json)
	}
}
class VoxelData {
	constructor(sizeX = 16, sizeY = 16, sizeZ = 16) {
		this.sizeX = sizeX
		this.sizeY = sizeY
		this.sizeZ = sizeZ
		this.data = new Uint32Array(sizeX * sizeY * sizeZ)
	}
	getIndex(x, y, z) {
		if (x < 0 || x >= this.sizeX || y < 0 || y >= this.sizeY || z < 0 || z >= this.sizeZ) return -1
		return x + y * this.sizeX + z * this.sizeX * this.sizeY
	}
	get(x, y, z) {
		const idx = this.getIndex(x, y, z)
		return idx >= 0 ? this.data[idx] : 0
	}
	set(x, y, z, color) {
		const idx = this.getIndex(x, y, z)
		if (idx >= 0) this.data[idx] = color
	}
	clear() {
		this.data.fill(0)
	}
	resize(sizeX, sizeY, sizeZ) {
		const newData = new Uint32Array(sizeX * sizeY * sizeZ)
		const minX = Math.min(this.sizeX, sizeX)
		const minY = Math.min(this.sizeY, sizeY)
		const minZ = Math.min(this.sizeZ, sizeZ)
		for (let z = 0; z < minZ; z++) {
			for (let y = 0; y < minY; y++) {
				for (let x = 0; x < minX; x++) {
					const oldIdx = x + y * this.sizeX + z * this.sizeX * this.sizeY
					const newIdx = x + y * sizeX + z * sizeX * sizeY
					newData[newIdx] = this.data[oldIdx]
				}
			}
		}
		this.sizeX = sizeX
		this.sizeY = sizeY
		this.sizeZ = sizeZ
		this.data = newData
	}
	toJSON() {
		const nonEmpty = []
		for (let i = 0; i < this.data.length; i++) {
			if (this.data[i] !== 0) nonEmpty.push([i, this.data[i]])
		}
		return { sizeX: this.sizeX, sizeY: this.sizeY, sizeZ: this.sizeZ, voxels: nonEmpty }
	}
	fromJSON(json) {
		this.sizeX = json.sizeX
		this.sizeY = json.sizeY
		this.sizeZ = json.sizeZ
		this.data = new Uint32Array(this.sizeX * this.sizeY * this.sizeZ)
		for (const [idx, color] of json.voxels) {
			this.data[idx] = color
		}
	}
}
class VoxelMeshBuilder {
	constructor(gl) {
		this.gl = gl
	}
	hexToRgb(hex) {
		const r = ((hex >> 16) & 0xff) / 255
		const g = ((hex >> 8) & 0xff) / 255
		const b = (hex & 0xff) / 255
		return [r, g, b]
	}
	build(voxelData, scale = 1) {
		const positions = []
		const colors = []
		const normals = []
		const faces = [
			{ dir: [1, 0, 0], corners: [[1,0,0],[1,1,0],[1,1,1],[1,0,1]] },
			{ dir: [-1, 0, 0], corners: [[0,1,0],[0,0,0],[0,0,1],[0,1,1]] },
			{ dir: [0, 1, 0], corners: [[0,1,0],[0,1,1],[1,1,1],[1,1,0]] },
			{ dir: [0, -1, 0], corners: [[0,0,1],[0,0,0],[1,0,0],[1,0,1]] },
			{ dir: [0, 0, 1], corners: [[0,0,1],[1,0,1],[1,1,1],[0,1,1]] },
			{ dir: [0, 0, -1], corners: [[1,0,0],[0,0,0],[0,1,0],[1,1,0]] }
		]
		for (let z = 0; z < voxelData.sizeZ; z++) {
			for (let y = 0; y < voxelData.sizeY; y++) {
				for (let x = 0; x < voxelData.sizeX; x++) {
					const color = voxelData.get(x, y, z)
					if (color === 0) continue
					const rgb = this.hexToRgb(color)
					for (const face of faces) {
						const nx = x + face.dir[0]
						const ny = y + face.dir[1]
						const nz = z + face.dir[2]
						if (voxelData.get(nx, ny, nz) !== 0) continue
						for (let i = 0; i < 4; i++) {
							const c = face.corners[i]
							positions.push((x + c[0]) * scale, (y + c[1]) * scale, (z + c[2]) * scale)
							colors.push(...rgb)
							normals.push(...face.dir)
						}
					}
				}
			}
		}
		return { positions: new Float32Array(positions), colors: new Float32Array(colors), normals: new Float32Array(normals) }
	}
}
const canvas = document.getElementById('editor-canvas')
const container = document.getElementById('edt-cv')
let renderer = null
let voxelMeshBuilder = null
let currentVoxel = null
let voxelMesh = null
const defaultPalette = [
	0x166d3b, 0x1c8548, 0x27ae60, 0x2ecc71,
	0xe74c3c, 0xc0392b, 0x9b59b6, 0x8e44ad,
	0x3498db, 0x2980b9, 0x1abc9c, 0x16a085,
	0xf39c12, 0xf1c40f, 0xe67e22, 0xd35400,
	0x333333, 0x555555, 0x888888, 0xaaaaaa,
	0xcccccc, 0xeeeeee, 0x000000, 0xffffff
]
const sbr = new SBRSystem()
const state = {
	tool: 'select',
	showGrid: true,
	isPanning: false,
	panStartX: 0,
	panStartY: 0,
	isRotating: false,
	rotateStartX: 0,
	rotateStartY: 0,
	rotateStartAz: 0,
	rotateStartEl: 0,
	startTarget: null,
	mouseX: 0,
	mouseY: 0,
	selectedObject: null,
	objects: [],
	currentTab: 'map',
	dragData: null,
	editMode: null,
	voxelTool: 'add',
	voxelColor: 0x166d3b,
	buildings: [],
	events: [],
	currentEvent: null,
	entities: [],
	currentEntity: null,
	furniture: [],
	currentFurniture: null,
	weathers: [],
	currentWeather: null,
	spawnItems: [],
	previewMode: false,
	player: { x: 15, y: 15, z: 0 },
	previewCamHeight: 10,
	previewKeys: { w: false, a: false, s: false, d: false }
}
function initRenderer() {
	try {
		renderer = new GLRenderer(canvas)
		renderer.init()
		resizeCanvas()
		render()
	} catch (e) {
		console.error('WebGL initialization failed:', e)
		alert('WebGL 2.0 不支持，请使用现代浏览器')
	}
}
function resizeCanvas() {
	const rect = container.getBoundingClientRect()
	renderer.resize(rect.width, rect.height)
}
function updateRiPnCollapse(hasContent) {
	const pn = document.getElementById('ri-pn')
	const resizer = document.getElementById('ri-resizer')
	if (hasContent) {
		pn.classList.remove('collapsed')
		resizer.style.right = '260px'
	} else {
		pn.classList.add('collapsed')
		resizer.style.right = '32px'
	}
	setTimeout(resizeCanvas, 200)
}
function render() {
	if (!renderer) return
	renderer.render({ entities: [], resources: new Map(), showGrid: state.showGrid })
	updateGizmo()
	requestAnimationFrame(render)
}
function updateGizmo() {
	if (!renderer || !renderer.camera) return
	const inner = document.getElementById('gizmo-inner')
	const az = renderer.camera.azimuth
	const el = renderer.camera.elevation
	inner.style.transform = `rotateX(${el}deg) rotateY(${-az}deg)`
}
function updateCanvasInfo() {
	if (!renderer || !renderer.screenToWorld) return
	const world = renderer.screenToWorld(state.mouseX, state.mouseY, 0)
	if (world) {
		const x = Math.floor(world.x)
		const y = Math.floor(world.y)
		document.getElementById('canvas-info').textContent = `坐标: ${x}, ${y} | 距离: ${renderer.camera.distance.toFixed(1)}`
	}
}
container.addEventListener('mousedown', e => {
	const rect = canvas.getBoundingClientRect()
	state.mouseX = e.clientX - rect.left
	state.mouseY = e.clientY - rect.top
	if (e.button === 2) {
		e.preventDefault()
		state.isPanning = true
		state.panStartX = e.clientX
		state.panStartY = e.clientY
		state.startTarget = { ...renderer.camera.target }
	} else if (e.button === 1) {
		e.preventDefault()
		state.isRotating = true
		state.rotateStartX = e.clientX
		state.rotateStartY = e.clientY
		state.rotateStartAz = renderer.camera.azimuth
		state.rotateStartEl = renderer.camera.elevation
	}
})
document.addEventListener('mousemove', e => {
	const rect = canvas.getBoundingClientRect()
	state.mouseX = e.clientX - rect.left
	state.mouseY = e.clientY - rect.top
	if (state.isPanning) {
		const dx = e.clientX - state.panStartX
		const dy = e.clientY - state.panStartY
		const scale = renderer.camera.distance * 0.002
		const azRad = renderer.camera.azimuth * Math.PI / 180
		const cosAz = Math.cos(azRad)
		const sinAz = Math.sin(azRad)
		renderer.camera.target.x = state.startTarget.x - (dx * cosAz + dy * sinAz) * scale
		renderer.camera.target.y = state.startTarget.y - (dx * sinAz - dy * cosAz) * scale
	}
	if (state.isRotating) {
		const dx = e.clientX - state.rotateStartX
		const dy = e.clientY - state.rotateStartY
		renderer.camera.azimuth = state.rotateStartAz - dx * 0.5
		renderer.camera.elevation = Math.max(-89, Math.min(-5, state.rotateStartEl - dy * 0.5))
	}
	updateCanvasInfo()
})
document.addEventListener('mouseup', e => {
	if (e.button === 2) state.isPanning = false
	if (e.button === 1) state.isRotating = false
})
container.addEventListener('wheel', e => {
	e.preventDefault()
	const delta = e.deltaY > 0 ? 1.1 : 0.9
	renderer.camera.distance = Math.max(5, Math.min(200, renderer.camera.distance * delta))
	updateCanvasInfo()
}, { passive: false })
container.addEventListener('contextmenu', e => e.preventDefault())
window.addEventListener('resize', () => resizeCanvas())
const viewAngles = {
	'south': { azimuth: 0, elevation: 0 },
	'north': { azimuth: 180, elevation: 0 },
	'east': { azimuth: -90, elevation: 0 },
	'west': { azimuth: 90, elevation: 0 },
	'top': { azimuth: 0, elevation: -89 },
	'bottom': { azimuth: 0, elevation: -5 }
}
let gizmoDragged = false
document.querySelectorAll('.gizmo-face').forEach(face => {
	face.addEventListener('click', () => {
		if (gizmoDragged) return
		const view = face.dataset.view
		if (viewAngles[view]) {
			renderer.camera.azimuth = viewAngles[view].azimuth
			renderer.camera.elevation = viewAngles[view].elevation
		}
	})
})
const gizmo = document.getElementById('gizmo')
let gizmoDragging = false
let gizmoDragStartX = 0
let gizmoDragStartY = 0
let gizmoDragStartAz = 0
let gizmoDragStartEl = 0
gizmo.addEventListener('mousedown', e => {
	if (e.button === 0) {
		gizmoDragging = true
		gizmoDragged = false
		gizmoDragStartX = e.clientX
		gizmoDragStartY = e.clientY
		gizmoDragStartAz = renderer.camera.azimuth
		gizmoDragStartEl = renderer.camera.elevation
		e.preventDefault()
	}
})
document.addEventListener('mousemove', e => {
	if (gizmoDragging) {
		const dx = e.clientX - gizmoDragStartX
		const dy = e.clientY - gizmoDragStartY
		if (Math.abs(dx) > 3 || Math.abs(dy) > 3) gizmoDragged = true
		renderer.camera.azimuth = gizmoDragStartAz - dx * 0.5
		renderer.camera.elevation = Math.max(-89, Math.min(89, gizmoDragStartEl - dy * 0.5))
	}
})
document.addEventListener('mouseup', e => {
	if (e.button === 0) {
		gizmoDragging = false
		setTimeout(() => gizmoDragged = false, 10)
	}
})
document.getElementById('le-pn-toggle').addEventListener('click', () => {
	const pn = document.getElementById('le-pn')
	pn.classList.toggle('collapsed')
	const resizer = document.getElementById('le-resizer')
	resizer.style.left = pn.classList.contains('collapsed') ? '32px' : '220px'
	setTimeout(resizeCanvas, 200)
})
document.getElementById('ri-pn-toggle').addEventListener('click', () => {
	const pn = document.getElementById('ri-pn')
	pn.classList.toggle('collapsed')
	const resizer = document.getElementById('ri-resizer')
	resizer.style.right = pn.classList.contains('collapsed') ? '32px' : '260px'
	setTimeout(resizeCanvas, 200)
})
document.querySelectorAll('.section-tab').forEach(tab => {
	tab.addEventListener('click', () => {
		document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'))
		tab.classList.add('active')
		const section = tab.dataset.section
		document.getElementById('section-building').classList.toggle('active', section === 'building')
		document.getElementById('section-spawn').classList.toggle('active', section === 'spawn')
		document.getElementById('section-assets').classList.toggle('active', section === 'assets')
		document.getElementById('section-map').classList.toggle('active', section === 'map')
		document.getElementById('section-weather').classList.toggle('active', section === 'weather')
		document.getElementById('section-system').classList.toggle('active', section === 'system')
		document.getElementById('section-skills').classList.toggle('active', section === 'skills')
		document.getElementById('section-ai').classList.toggle('active', section === 'ai')
		if (section === 'building') initBldEditor()
	})
})
document.querySelectorAll('.map-cat-item').forEach(item => {
	item.addEventListener('click', () => {
		document.querySelectorAll('.map-cat-item').forEach(i => i.classList.remove('sel'))
		item.classList.add('sel')
		const cat = item.dataset.cat
		document.querySelectorAll('#map-detail .config-section').forEach(sec => {
			sec.style.display = sec.dataset.cat === cat ? '' : 'none'
		})
	})
})
function initSldVals() {
	document.querySelectorAll('.config-row input[type="range"]').forEach(sld => {
		if (sld.nextElementSibling?.classList.contains('sld-val')) return
		const valSpan = document.createElement('span')
		valSpan.className = 'sld-val'
		valSpan.textContent = sld.value
		sld.after(valSpan)
		sld.addEventListener('input', () => {
			valSpan.textContent = sld.value
		})
		valSpan.addEventListener('dblclick', () => {
			const ipt = document.createElement('input')
			ipt.type = 'number'
			ipt.className = 'sld-ipt'
			ipt.value = sld.value
			ipt.min = sld.min
			ipt.max = sld.max
			ipt.step = sld.step || 1
			valSpan.replaceWith(ipt)
			ipt.focus()
			ipt.select()
			function finish() {
				let v = parseFloat(ipt.value)
				if (isNaN(v)) v = parseFloat(sld.value)
				v = Math.max(parseFloat(sld.min), Math.min(parseFloat(sld.max), v))
				sld.value = v
				valSpan.textContent = v
				ipt.replaceWith(valSpan)
				sld.dispatchEvent(new Event('input'))
			}
			ipt.addEventListener('blur', finish)
			ipt.addEventListener('keydown', e => {
				if (e.key === 'Enter') finish()
				if (e.key === 'Escape') {
					valSpan.textContent = sld.value
					ipt.replaceWith(valSpan)
				}
			})
		})
	})
}
initSldVals()
document.getElementById('prv-btn').addEventListener('click', () => {
	enterPreviewMode()
})
let previewAnimFrame = null
function enterPreviewMode() {
	state.previewMode = true
	state.player.x = renderer.camera.target.x
	state.player.y = renderer.camera.target.y
	state.player.z = 0
	state.previewCamHeight = 10
	state.previewKeys = { w: false, a: false, s: false, d: false }
	document.querySelector('.app').classList.add('preview-mode')
	setTimeout(() => {
		resizeCanvas()
		startPreviewLoop()
	}, 50)
}
function exitPreviewMode() {
	state.previewMode = false
	document.querySelector('.app').classList.remove('preview-mode')
	if (previewAnimFrame) {
		cancelAnimationFrame(previewAnimFrame)
		previewAnimFrame = null
	}
	renderer.camera.target.x = state.player.x
	renderer.camera.target.y = state.player.y
	renderer.camera.target.z = 0
	renderer.camera.azimuth = 45
	renderer.camera.elevation = -35
	renderer.camera.distance = 30
	setTimeout(resizeCanvas, 50)
}
function startPreviewLoop() {
	let lastTime = performance.now()
	function loop(now) {
		if (!state.previewMode) return
		const dt = Math.min((now - lastTime) / 1000, 0.1)
		lastTime = now
		updatePreviewPlayer(dt)
		updatePreviewCamera()
		renderPreview()
		previewAnimFrame = requestAnimationFrame(loop)
	}
	previewAnimFrame = requestAnimationFrame(loop)
}
function updatePreviewPlayer(dt) {
	const speed = 8
	let dx = 0, dy = 0
	const k = state.previewKeys
	if (k.w && !k.a && !k.s && !k.d) { dx = -1; dy = 1 }
	else if (k.a && !k.w && !k.s && !k.d) { dx = -1; dy = -1 }
	else if (k.s && !k.w && !k.a && !k.d) { dx = 1; dy = -1 }
	else if (k.d && !k.w && !k.a && !k.s) { dx = 1; dy = 1 }
	else if (k.w && k.d && !k.a && !k.s) { dx = 0; dy = 1 }
	else if (k.w && k.a && !k.d && !k.s) { dx = -1; dy = 0 }
	else if (k.s && k.d && !k.w && !k.a) { dx = 0; dy = -1 }
	else if (k.s && k.a && !k.w && !k.d) { dx = 1; dy = 0 }
	if (dx !== 0 || dy !== 0) {
		const len = Math.sqrt(dx * dx + dy * dy)
		state.player.x += (dx / len) * speed * dt
		state.player.y += (dy / len) * speed * dt
	}
}
function updatePreviewCamera() {
	const h = state.previewCamHeight
	const dist = h * 1.2
	renderer.camera.target.x = state.player.x
	renderer.camera.target.y = state.player.y
	renderer.camera.target.z = h * 0.3
	renderer.camera.distance = dist
	renderer.camera.azimuth = 45
	renderer.camera.elevation = -45
}
function renderPreview() {
	renderer.render({
		entities: [],
		resources: new Map(),
		showGrid: false,
		selectedTile: null
	})
	renderPlayerMarker()
}
function renderPlayerMarker() {
	const gl = renderer.gl
	if (!renderer.playerVAO) {
		renderer.playerVAO = gl.createVertexArray()
		renderer.playerVBO = gl.createBuffer()
		gl.bindVertexArray(renderer.playerVAO)
		gl.bindBuffer(gl.ARRAY_BUFFER, renderer.playerVBO)
		gl.enableVertexAttribArray(0)
		gl.vertexAttribPointer(0, 3, gl.FLOAT, false, 0, 0)
		gl.bindVertexArray(null)
	}
	const px = state.player.x, py = state.player.y, pz = state.player.z
	const s = 0.4
	const vertices = [
		px-s, py-s, pz+0.01, px+s, py-s, pz+0.01,
		px+s, py-s, pz+0.01, px+s, py+s, pz+0.01,
		px+s, py+s, pz+0.01, px-s, py+s, pz+0.01,
		px-s, py+s, pz+0.01, px-s, py-s, pz+0.01,
		px, py-s*0.5, pz+0.01, px, py+s*1.5, pz+0.01
	]
	gl.bindBuffer(gl.ARRAY_BUFFER, renderer.playerVBO)
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.DYNAMIC_DRAW)
	gl.depthMask(false)
	gl.enable(gl.BLEND)
	gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA)
	const program = renderer.shaders.use('grid')
	gl.uniformMatrix4fv(gl.getUniformLocation(program, 'u_projection'), false, renderer.projMatrix)
	gl.uniformMatrix4fv(gl.getUniformLocation(program, 'u_view'), false, renderer.viewMatrix)
	gl.uniform4f(gl.getUniformLocation(program, 'u_color'), 0.2, 0.8, 1, 1)
	gl.bindVertexArray(renderer.playerVAO)
	gl.drawArrays(gl.LINES, 0, 10)
	gl.bindVertexArray(null)
	gl.depthMask(true)
	gl.disable(gl.BLEND)
}
document.addEventListener('keydown', e => {
	if (!state.previewMode) return
	if (e.key === 'Escape') {
		exitPreviewMode()
		return
	}
	const key = e.key.toLowerCase()
	if (key in state.previewKeys) {
		state.previewKeys[key] = true
		e.preventDefault()
	}
})
document.addEventListener('keyup', e => {
	if (!state.previewMode) return
	const key = e.key.toLowerCase()
	if (key in state.previewKeys) {
		state.previewKeys[key] = false
	}
})
container.addEventListener('wheel', e => {
	if (!state.previewMode) return
	e.preventDefault()
	const delta = e.deltaY > 0 ? 1 : -1
	state.previewCamHeight = Math.max(3, Math.min(20, state.previewCamHeight + delta))
}, { passive: false })
document.querySelectorAll('.pn-hd-fld-header').forEach(header => {
	header.addEventListener('click', () => {
		header.classList.toggle('open')
		const fldName = header.dataset.fld
		const body = document.getElementById('fld-' + fldName)
		if (body) body.classList.toggle('open')
	})
})
document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
	btn.addEventListener('click', () => {
		document.querySelectorAll('.tool-btn[data-tool]').forEach(b => b.classList.remove('active'))
		btn.classList.add('active')
		state.tool = btn.dataset.tool
	})
})
document.getElementById('grid-btn').addEventListener('click', function() {
	this.classList.toggle('active')
	state.showGrid = this.classList.contains('active')
})
document.querySelectorAll('.pn-hd-drg').forEach(item => {
	item.addEventListener('dragstart', e => {
		state.dragData = {
			type: item.dataset.type,
			id: item.dataset.id
		}
		item.classList.add('dragging')
		e.dataTransfer.effectAllowed = 'copy'
	})
	item.addEventListener('dragend', () => {
		item.classList.remove('dragging')
		state.dragData = null
	})
})
container.addEventListener('dragover', e => {
	e.preventDefault()
	e.dataTransfer.dropEffect = 'copy'
})
container.addEventListener('drop', e => {
	e.preventDefault()
	if (!state.dragData || !renderer) return
	const rect = canvas.getBoundingClientRect()
	const x = e.clientX - rect.left
	const y = e.clientY - rect.top
	const world = renderer.screenToWorld(x, y, 0)
	if (world) {
		const obj = {
			id: Date.now(),
			type: state.dragData.type,
			subtype: state.dragData.id,
			x: Math.floor(world.x),
			y: Math.floor(world.y),
			z: 0
		}
		state.objects.push(obj)
		console.log('创建对象:', obj)
	}
	state.dragData = null
})
let leResizing = false
let riResizing = false
const leResizer = document.getElementById('le-resizer')
const riResizer = document.getElementById('ri-resizer')
leResizer.addEventListener('mousedown', () => leResizing = true)
riResizer.addEventListener('mousedown', () => riResizing = true)
document.addEventListener('mousemove', e => {
	if (leResizing) {
		const pn = document.getElementById('le-pn')
		const newWidth = Math.max(150, Math.min(400, e.clientX))
		pn.style.width = newWidth + 'px'
		leResizer.style.left = newWidth + 'px'
		pn.classList.remove('collapsed')
	}
	if (riResizing) {
		const pn = document.getElementById('ri-pn')
		const newWidth = Math.max(180, Math.min(500, window.innerWidth - e.clientX))
		pn.style.width = newWidth + 'px'
		riResizer.style.right = newWidth + 'px'
		pn.classList.remove('collapsed')
	}
})
document.addEventListener('mouseup', () => {
	if (leResizing || riResizing) {
		setTimeout(resizeCanvas, 50)
	}
	leResizing = false
	riResizing = false
})
function enterBuildingEditMode(buildingData = null) {
	state.editMode = 'building'
	if (!buildingData) {
		const sizeX = parseInt(document.getElementById('voxel-size-x').value) || 16
		const sizeY = parseInt(document.getElementById('voxel-size-y').value) || 16
		const sizeZ = parseInt(document.getElementById('voxel-size-z').value) || 16
		currentVoxel = new VoxelData(sizeX, sizeY, sizeZ)
	} else {
		currentVoxel = new VoxelData()
		currentVoxel.fromJSON(buildingData.voxel)
	}
	document.getElementById('voxel-toolbar').classList.add('active')
	document.getElementById('edit-mode-banner').classList.add('active')
	document.getElementById('edit-mode-name').textContent = '建筑编辑'
	document.getElementById('empty-props').style.display = 'none'
	document.getElementById('building-props').classList.add('active')
	updateRiPnCollapse(true)
	initColorPalette()
	renderer.camera.target = { x: currentVoxel.sizeX / 2, y: currentVoxel.sizeY / 2, z: 0 }
	renderer.camera.distance = Math.max(currentVoxel.sizeX, currentVoxel.sizeY, currentVoxel.sizeZ) * 2
}
function exitEditMode() {
	if (state.editMode === 'building' && currentVoxel) {
		const name = document.getElementById('building-name').value || '新建筑'
		const building = {
			id: Date.now(),
			name: name,
			category: document.getElementById('building-category').value,
			ensure: document.getElementById('building-ensure').checked,
			spawn: document.getElementById('building-spawn').checked,
			spawnRadius: parseFloat(document.getElementById('building-spawn-radius').value) || 1,
			voxel: currentVoxel.toJSON()
		}
		state.buildings.push(building)
		addBuildingToList(building)
	}
	state.editMode = null
	currentVoxel = null
	document.getElementById('voxel-toolbar').classList.remove('active')
	document.getElementById('edit-mode-banner').classList.remove('active')
	document.getElementById('building-props').classList.remove('active')
	document.getElementById('empty-props').style.display = 'flex'
	updateRiPnCollapse(false)
}
function addBuildingToList(building) {
	const container = document.getElementById('fld-buildings')
	const btn = container.querySelector('.add-building-btn')
	const item = document.createElement('div')
	item.className = 'pn-hd-drg'
	item.draggable = true
	item.dataset.type = 'building'
	item.dataset.id = building.id
	item.innerHTML = `<span class="drag-handle">⋮⋮</span><span>${building.name}</span>`
	item.addEventListener('dragstart', e => {
		state.dragData = { type: 'building', id: building.id }
		item.classList.add('dragging')
		e.dataTransfer.effectAllowed = 'copy'
	})
	item.addEventListener('dragend', () => {
		item.classList.remove('dragging')
		state.dragData = null
	})
	item.addEventListener('dblclick', () => {
		const bd = state.buildings.find(b => b.id === building.id)
		if (bd) enterBuildingEditMode(bd)
	})
	container.insertBefore(item, btn)
}
function initColorPalette() {
	const palette = document.getElementById('color-palette')
	palette.innerHTML = ''
	defaultPalette.forEach((color, idx) => {
		const div = document.createElement('div')
		div.className = 'palette-color' + (color === state.voxelColor ? ' selected' : '')
		div.style.background = '#' + color.toString(16).padStart(6, '0')
		div.addEventListener('click', () => {
			state.voxelColor = color
			document.getElementById('voxel-color').value = '#' + color.toString(16).padStart(6, '0')
			palette.querySelectorAll('.palette-color').forEach(p => p.classList.remove('selected'))
			div.classList.add('selected')
		})
		palette.appendChild(div)
	})
}
document.getElementById('new-building-btn').addEventListener('click', () => {
	enterBuildingEditMode()
})
document.querySelectorAll('.voxel-tool-btn').forEach(btn => {
	btn.addEventListener('click', () => {
		document.querySelectorAll('.voxel-tool-btn').forEach(b => b.classList.remove('active'))
		btn.classList.add('active')
		state.voxelTool = btn.dataset.voxelTool
	})
})
document.getElementById('voxel-color').addEventListener('input', e => {
	const hex = e.target.value.replace('#', '')
	state.voxelColor = parseInt(hex, 16)
	document.querySelectorAll('.palette-color').forEach(p => p.classList.remove('selected'))
})
function enterEventEditMode(eventData = null) {
	state.editMode = 'event'
	if (!eventData) {
		state.currentEvent = new GameEvent()
	} else {
		state.currentEvent = eventData instanceof GameEvent ? eventData : GameEvent.fromJSON(eventData)
	}
	document.getElementById('empty-props').style.display = 'none'
	document.getElementById('event-props').classList.add('active')
	updateRiPnCollapse(true)
	document.getElementById('event-name').value = state.currentEvent.name
	document.getElementById('event-uniqueness').value = state.currentEvent.uniqueness
	document.getElementById('event-priority').value = state.currentEvent.priority
	renderTriggerList()
}
function exitEventEditMode() {
	if (state.editMode === 'event' && state.currentEvent) {
		state.currentEvent.name = document.getElementById('event-name').value || '新事件'
		state.currentEvent.uniqueness = document.getElementById('event-uniqueness').value
		state.currentEvent.priority = parseInt(document.getElementById('event-priority').value) || 0
		const existing = state.events.find(e => e.id === state.currentEvent.id)
		if (!existing) {
			state.events.push(state.currentEvent)
			addEventToList(state.currentEvent)
		}
	}
	state.editMode = null
	state.currentEvent = null
	document.getElementById('event-props').classList.remove('active')
	document.getElementById('empty-props').style.display = 'flex'
	updateRiPnCollapse(false)
}
function addEventToList(evt) {
	const container = document.getElementById('fld-events')
	const btn = container.querySelector('.new-event-btn')
	const item = document.createElement('div')
	item.className = 'pn-hd-clk'
	item.dataset.type = 'event'
	item.dataset.id = evt.id
	item.innerHTML = `<span>${evt.name}</span>`
	item.addEventListener('click', () => {
		document.querySelectorAll('.pn-hd-clk').forEach(c => c.classList.remove('selected'))
		item.classList.add('selected')
		const evtData = state.events.find(e => e.id === evt.id)
		if (evtData) enterEventEditMode(evtData)
	})
	container.insertBefore(item, btn)
}
function renderTriggerList() {
	const list = document.getElementById('trigger-list')
	list.innerHTML = ''
	if (!state.currentEvent) return
	state.currentEvent.triggers.forEach((trigger, idx) => {
		const item = document.createElement('div')
		item.className = 'trigger-item'
		item.innerHTML = `
			<div class="trigger-header">
				<select class="trigger-type" data-idx="${idx}">
					<option value="immediate" ${trigger.type === 'immediate' ? 'selected' : ''}>立即触发</option>
					<option value="real_timer" ${trigger.type === 'real_timer' ? 'selected' : ''}>现实计时</option>
					<option value="real_time" ${trigger.type === 'real_time' ? 'selected' : ''}>现实时间</option>
					<option value="game_timer" ${trigger.type === 'game_timer' ? 'selected' : ''}>游戏计时</option>
					<option value="game_time" ${trigger.type === 'game_time' ? 'selected' : ''}>游戏时间</option>
					<option value="subscribe" ${trigger.type === 'subscribe' ? 'selected' : ''}>订阅消息</option>
					<option value="run_count" ${trigger.type === 'run_count' ? 'selected' : ''}>运行次数</option>
					<option value="real_duration" ${trigger.type === 'real_duration' ? 'selected' : ''}>现实时长</option>
					<option value="game_duration" ${trigger.type === 'game_duration' ? 'selected' : ''}>游戏时长</option>
				</select>
				<button class="trigger-remove" data-idx="${idx}">
					<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
				</button>
			</div>
			<div class="trigger-config" id="trigger-config-${idx}"></div>
			<div class="action-list" id="action-list-${idx}"></div>
			<button class="add-action-btn" data-idx="${idx}">+ 添加动作</button>
		`
		list.appendChild(item)
		renderTriggerConfig(trigger, idx)
		renderActionList(trigger, idx)
	})
	list.querySelectorAll('.trigger-type').forEach(sel => {
		sel.addEventListener('change', e => {
			const idx = parseInt(e.target.dataset.idx)
			state.currentEvent.triggers[idx].type = e.target.value
			renderTriggerConfig(state.currentEvent.triggers[idx], idx)
		})
	})
	list.querySelectorAll('.trigger-remove').forEach(btn => {
		btn.addEventListener('click', e => {
			const idx = parseInt(e.target.closest('.trigger-remove').dataset.idx)
			state.currentEvent.triggers.splice(idx, 1)
			renderTriggerList()
		})
	})
	list.querySelectorAll('.add-action-btn').forEach(btn => {
		btn.addEventListener('click', e => {
			const idx = parseInt(e.target.dataset.idx)
			state.currentEvent.triggers[idx].actions.push({ type: 'sbr_ok' })
			renderActionList(state.currentEvent.triggers[idx], idx)
		})
	})
}
function renderTriggerConfig(trigger, idx) {
	const container = document.getElementById('trigger-config-' + idx)
	if (!container) return
	let html = ''
	switch (trigger.type) {
		case 'real_timer':
		case 'game_timer':
			html = `<div class="prop-row"><div class="prop-col"><div class="prop-label">间隔 (ms)</div><input type="number" class="prop-input trigger-interval" value="${trigger.config.interval}" min="100"></div></div>`
			break
		case 'real_time':
		case 'game_time':
			html = `<div class="prop-row"><div class="prop-col"><div class="prop-label">时</div><input type="number" class="prop-input trigger-hour" value="${trigger.config.time.hour}" min="0" max="23"></div><div class="prop-col"><div class="prop-label">分</div><input type="number" class="prop-input trigger-minute" value="${trigger.config.time.minute}" min="0" max="59"></div><div class="prop-col"><div class="prop-label">秒</div><input type="number" class="prop-input trigger-second" value="${trigger.config.time.second}" min="0" max="59"></div></div>`
			break
		case 'subscribe':
			html = `<div class="prop-row"><div class="prop-col"><div class="prop-label">频道</div><input type="text" class="prop-input trigger-channels" value="${trigger.config.channels.join(',')}" placeholder="多个用逗号分隔"></div></div>`
			break
		case 'run_count':
			html = `<div class="prop-row"><div class="prop-col"><div class="prop-label">次数</div><input type="number" class="prop-input trigger-runcount" value="${trigger.config.runCount}" min="1"></div></div>`
			break
		case 'real_duration':
		case 'game_duration':
			html = `<div class="prop-row"><div class="prop-col"><div class="prop-label">时长 (ms)</div><input type="number" class="prop-input trigger-duration" value="${trigger.config.duration}" min="0"></div></div>`
			break
	}
	container.innerHTML = html
	container.querySelectorAll('input').forEach(input => {
		input.addEventListener('change', () => {
			if (input.classList.contains('trigger-interval')) trigger.config.interval = parseInt(input.value) || 1000
			if (input.classList.contains('trigger-hour')) trigger.config.time.hour = parseInt(input.value) || 0
			if (input.classList.contains('trigger-minute')) trigger.config.time.minute = parseInt(input.value) || 0
			if (input.classList.contains('trigger-second')) trigger.config.time.second = parseInt(input.value) || 0
			if (input.classList.contains('trigger-channels')) trigger.config.channels = input.value.split(',').map(s => s.trim()).filter(s => s)
			if (input.classList.contains('trigger-runcount')) trigger.config.runCount = parseInt(input.value) || 1
			if (input.classList.contains('trigger-duration')) trigger.config.duration = parseInt(input.value) || 0
		})
	})
}
function renderActionList(trigger, idx) {
	const container = document.getElementById('action-list-' + idx)
	if (!container) return
	container.innerHTML = ''
	trigger.actions.forEach((action, aidx) => {
		const item = document.createElement('div')
		item.className = 'action-item'
		item.innerHTML = `
			<select class="action-type" data-aidx="${aidx}">
				<option value="sbr_ok" ${action.type === 'sbr_ok' ? 'selected' : ''}>返回OK</option>
				<option value="sbr_cancel" ${action.type === 'sbr_cancel' ? 'selected' : ''}>返回Cancel</option>
				<option value="sbr_stop" ${action.type === 'sbr_stop' ? 'selected' : ''}>返回Stop</option>
				<option value="set_var" ${action.type === 'set_var' ? 'selected' : ''}>设置变量</option>
				<option value="destruct_self" ${action.type === 'destruct_self' ? 'selected' : ''}>销毁自身</option>
			</select>
			<button class="trigger-remove" data-aidx="${aidx}">
				<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
			</button>
		`
		container.appendChild(item)
		item.querySelector('.action-type').addEventListener('change', e => {
			trigger.actions[aidx].type = e.target.value
		})
		item.querySelector('.trigger-remove').addEventListener('click', () => {
			trigger.actions.splice(aidx, 1)
			renderActionList(trigger, idx)
		})
	})
}
document.getElementById('new-event-btn').addEventListener('click', () => {
	enterEventEditMode()
})
document.getElementById('add-trigger-btn').addEventListener('click', () => {
	if (!state.currentEvent) return
	state.currentEvent.triggers.push(new Trigger())
	renderTriggerList()
})
function enterEntityEditMode(entityData = null) {
	state.editMode = 'entity'
	if (!entityData) {
		state.currentEntity = new Entity()
	} else {
		state.currentEntity = entityData instanceof Entity ? entityData : Entity.fromJSON(entityData)
	}
	document.getElementById('empty-props').style.display = 'none'
	document.getElementById('entity-props').classList.add('active')
	updateRiPnCollapse(true)
	document.getElementById('entity-name').value = state.currentEntity.name
	document.getElementById('entity-type').value = state.currentEntity.type
	document.getElementById('entity-mass').value = state.currentEntity.physics.mass
	document.getElementById('entity-hardness').value = state.currentEntity.physics.hardness
	document.getElementById('entity-elasticity').value = state.currentEntity.physics.elasticity
	document.getElementById('entity-fragility').value = state.currentEntity.physics.fragility
	renderCollisionBoxList()
	renderTriggerWordList()
	document.getElementById('entity-ai-type').value = state.currentEntity.ai.type
	document.getElementById('entity-ai-script').value = state.currentEntity.ai.script || ''
	document.getElementById('edit-mode-banner').classList.add('active')
	document.getElementById('edit-mode-name').textContent = '实体编辑'
	document.getElementById('voxel-toolbar').classList.add('active')
}
function exitEntityEditMode() {
	if (state.editMode === 'entity' && state.currentEntity) {
		state.currentEntity.name = document.getElementById('entity-name').value || '新实体'
		state.currentEntity.type = document.getElementById('entity-type').value
		state.currentEntity.physics.mass = parseFloat(document.getElementById('entity-mass').value) || 1
		state.currentEntity.physics.hardness = parseInt(document.getElementById('entity-hardness').value) || 50
		state.currentEntity.physics.elasticity = parseInt(document.getElementById('entity-elasticity').value) || 30
		state.currentEntity.physics.fragility = parseInt(document.getElementById('entity-fragility').value) || 20
		state.currentEntity.ai.type = document.getElementById('entity-ai-type').value
		state.currentEntity.ai.script = document.getElementById('entity-ai-script').value || ''
		const existing = state.entities.find(e => e.id === state.currentEntity.id)
		if (!existing) {
			state.entities.push(state.currentEntity)
			addEntityToList(state.currentEntity)
		}
		updateSpawnItemSelect()
	}
	state.editMode = null
	state.currentEntity = null
	document.getElementById('entity-props').classList.remove('active')
	document.getElementById('empty-props').style.display = 'flex'
	document.getElementById('edit-mode-banner').classList.remove('active')
	document.getElementById('voxel-toolbar').classList.remove('active')
	updateRiPnCollapse(false)
}
function addEntityToList(entity) {
	const container = document.getElementById('fld-entities')
	const btn = container.querySelector('.new-entity-btn')
	const item = document.createElement('div')
	item.className = 'pn-hd-drg'
	item.draggable = true
	item.dataset.type = 'entity'
	item.dataset.id = entity.id
	item.innerHTML = `<span class="drag-handle">⋮⋮</span><span>${entity.name}</span>`
	item.addEventListener('dragstart', e => {
		state.dragData = { type: 'entity', id: entity.id }
		item.classList.add('dragging')
		e.dataTransfer.effectAllowed = 'copy'
	})
	item.addEventListener('dragend', () => {
		item.classList.remove('dragging')
		state.dragData = null
	})
	item.addEventListener('dblclick', () => {
		const ent = state.entities.find(e => e.id === entity.id)
		if (ent) enterEntityEditMode(ent)
	})
	container.insertBefore(item, btn)
}
function renderCollisionBoxList() {
	const list = document.getElementById('collision-box-list')
	list.innerHTML = ''
	if (!state.currentEntity) return
	state.currentEntity.physics.collisionBoxes.forEach((box, idx) => {
		const item = document.createElement('div')
		item.className = 'collision-box-item'
		item.innerHTML = `
			<div class="collision-box-header">
				<span>碰撞箱 #${idx + 1}</span>
				<button class="trigger-remove" data-idx="${idx}">
					<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
				</button>
			</div>
			<div class="collision-box-fields">
				<div class="prop-row">
					<div class="prop-col">
						<div class="prop-label">X</div>
						<input type="number" class="prop-input box-x" value="${box.x}" step="0.0625">
					</div>
					<div class="prop-col">
						<div class="prop-label">Y</div>
						<input type="number" class="prop-input box-y" value="${box.y}" step="0.0625">
					</div>
					<div class="prop-col">
						<div class="prop-label">Z</div>
						<input type="number" class="prop-input box-z" value="${box.z}" step="0.0625">
					</div>
				</div>
				<div class="prop-row">
					<div class="prop-col">
						<div class="prop-label">宽</div>
						<input type="number" class="prop-input box-w" value="${box.width}" min="0.0625" step="0.0625">
					</div>
					<div class="prop-col">
						<div class="prop-label">高</div>
						<input type="number" class="prop-input box-h" value="${box.height}" min="0.0625" step="0.0625">
					</div>
					<div class="prop-col">
						<div class="prop-label">深</div>
						<input type="number" class="prop-input box-d" value="${box.depth}" min="0.0625" step="0.0625">
					</div>
				</div>
			</div>
		`
		list.appendChild(item)
		item.querySelector('.trigger-remove').addEventListener('click', () => {
			state.currentEntity.physics.removeCollisionBox(idx)
			renderCollisionBoxList()
		})
		item.querySelectorAll('input').forEach(input => {
			input.addEventListener('change', () => {
				if (input.classList.contains('box-x')) box.x = parseFloat(input.value) || 0
				if (input.classList.contains('box-y')) box.y = parseFloat(input.value) || 0
				if (input.classList.contains('box-z')) box.z = parseFloat(input.value) || 0
				if (input.classList.contains('box-w')) box.width = parseFloat(input.value) || 1
				if (input.classList.contains('box-h')) box.height = parseFloat(input.value) || 1
				if (input.classList.contains('box-d')) box.depth = parseFloat(input.value) || 1
			})
		})
	})
}
document.getElementById('new-entity-btn').addEventListener('click', () => {
	enterEntityEditMode()
})
document.getElementById('add-collision-btn').addEventListener('click', () => {
	if (!state.currentEntity) return
	state.currentEntity.physics.addCollisionBox(new CollisionBox())
	renderCollisionBoxList()
})
function renderTriggerWordList() {
	const list = document.getElementById('entity-trigger-words')
	list.innerHTML = ''
	if (!state.currentEntity) return
	state.currentEntity.triggerWords.forEach((word, idx) => {
		const tag = document.createElement('div')
		tag.className = 'trigger-word-tag'
		tag.innerHTML = `<span>${word}</span><button class="del-btn" data-idx="${idx}">×</button>`
		tag.querySelector('.del-btn').addEventListener('click', () => {
			state.currentEntity.triggerWords.splice(idx, 1)
			renderTriggerWordList()
		})
		list.appendChild(tag)
	})
}
document.getElementById('add-trigger-word-btn').addEventListener('click', () => {
	if (!state.currentEntity) return
	const input = document.getElementById('entity-trigger-word-input')
	const word = input.value.trim()
	if (word && !state.currentEntity.triggerWords.includes(word)) {
		state.currentEntity.triggerWords.push(word)
		renderTriggerWordList()
	}
	input.value = ''
})
document.getElementById('entity-trigger-word-input').addEventListener('keypress', e => {
	if (e.key === 'Enter') {
		document.getElementById('add-trigger-word-btn').click()
	}
})
function enterFurnitureEditMode(furnitureData = null) {
	state.editMode = 'furniture'
	if (!furnitureData) {
		state.currentFurniture = new Furniture()
	} else {
		state.currentFurniture = furnitureData instanceof Furniture ? furnitureData : Furniture.fromJSON(furnitureData)
	}
	document.getElementById('empty-props').style.display = 'none'
	document.getElementById('furniture-props').classList.add('active')
	updateRiPnCollapse(true)
	document.getElementById('furniture-name').value = state.currentFurniture.name
	document.getElementById('furniture-size-x').value = state.currentFurniture.sizeX
	document.getElementById('furniture-size-y').value = state.currentFurniture.sizeY
	renderFurnitureBuildingList()
	document.getElementById('edit-mode-banner').classList.add('active')
	document.getElementById('edit-mode-name').textContent = '家具编辑'
	document.getElementById('voxel-toolbar').classList.add('active')
}
function exitFurnitureEditMode() {
	if (state.editMode === 'furniture' && state.currentFurniture) {
		state.currentFurniture.name = document.getElementById('furniture-name').value || '新家具'
		state.currentFurniture.sizeX = parseInt(document.getElementById('furniture-size-x').value) || 1
		state.currentFurniture.sizeY = parseInt(document.getElementById('furniture-size-y').value) || 1
		const existing = state.furniture.find(f => f.id === state.currentFurniture.id)
		if (!existing) {
			state.furniture.push(state.currentFurniture)
			addFurnitureToList(state.currentFurniture)
		}
	}
	state.editMode = null
	state.currentFurniture = null
	document.getElementById('furniture-props').classList.remove('active')
	document.getElementById('empty-props').style.display = 'flex'
	document.getElementById('edit-mode-banner').classList.remove('active')
	document.getElementById('voxel-toolbar').classList.remove('active')
	updateRiPnCollapse(false)
}
function addFurnitureToList(furniture) {
	const container = document.getElementById('fld-furniture')
	const btn = container.querySelector('.new-furniture-btn')
	const item = document.createElement('div')
	item.className = 'pn-hd-drg'
	item.draggable = true
	item.dataset.type = 'furniture'
	item.dataset.id = furniture.id
	item.innerHTML = `<span class="drag-handle">⋮⋮</span><span>${furniture.name}</span>`
	item.addEventListener('dragstart', e => {
		state.dragData = { type: 'furniture', id: furniture.id }
		item.classList.add('dragging')
		e.dataTransfer.effectAllowed = 'copy'
	})
	item.addEventListener('dragend', () => {
		item.classList.remove('dragging')
		state.dragData = null
	})
	item.addEventListener('dblclick', () => {
		const furn = state.furniture.find(f => f.id === furniture.id)
		if (furn) enterFurnitureEditMode(furn)
	})
	container.insertBefore(item, btn)
}
function renderFurnitureBuildingList() {
	const container = document.getElementById('furniture-buildings')
	container.innerHTML = ''
	if (!state.currentFurniture) return
	state.buildings.forEach(building => {
		const item = document.createElement('div')
		item.className = 'building-select-item' + (state.currentFurniture.allowedBuildings.includes(building.id) ? ' selected' : '')
		item.textContent = building.name
		item.addEventListener('click', () => {
			const idx = state.currentFurniture.allowedBuildings.indexOf(building.id)
			if (idx >= 0) {
				state.currentFurniture.allowedBuildings.splice(idx, 1)
				item.classList.remove('selected')
			} else {
				state.currentFurniture.allowedBuildings.push(building.id)
				item.classList.add('selected')
			}
		})
		container.appendChild(item)
	})
	if (state.buildings.length === 0) {
		container.innerHTML = '<span style="color:#666;font-size:11px">暂无建筑</span>'
	}
}
document.getElementById('new-furniture-btn').addEventListener('click', () => {
	enterFurnitureEditMode()
})
function addWeatherToList(weather) {
	const list = document.getElementById('weather-list')
	const item = document.createElement('div')
	item.className = 'weather-item'
	item.dataset.id = weather.id
	item.innerHTML = `<span class="weather-item-name">${weather.name}</span><button class="weather-item-del">×</button>`
	item.addEventListener('click', e => {
		if (e.target.classList.contains('weather-item-del')) {
			state.weathers = state.weathers.filter(w => w.id !== weather.id)
			item.remove()
			if (state.currentWeather && state.currentWeather.id === weather.id) {
				state.currentWeather = null
				document.getElementById('weather-editor').style.display = 'none'
			}
			return
		}
		document.querySelectorAll('.weather-item').forEach(i => i.classList.remove('selected'))
		item.classList.add('selected')
		state.currentWeather = weather
		showWeatherEditor(weather)
	})
	list.appendChild(item)
}
function showWeatherEditor(weather) {
	document.getElementById('weather-editor').style.display = 'block'
	document.getElementById('weather-name').value = weather.name
	document.getElementById('weather-time').value = weather.timeRestriction
	document.getElementById('weather-rain').value = weather.rain
	document.getElementById('weather-lightning').value = weather.lightning
	document.getElementById('weather-light-color').value = weather.lightColor
	document.getElementById('weather-light-intensity').value = weather.lightIntensity
	document.getElementById('weather-temp').value = weather.tempAdjust
}
function updateCurrentWeather() {
	if (!state.currentWeather) return
	state.currentWeather.name = document.getElementById('weather-name').value || '新天气'
	state.currentWeather.timeRestriction = document.getElementById('weather-time').value
	state.currentWeather.rain = parseInt(document.getElementById('weather-rain').value) || 0
	state.currentWeather.lightning = parseInt(document.getElementById('weather-lightning').value) || 0
	state.currentWeather.lightColor = document.getElementById('weather-light-color').value
	state.currentWeather.lightIntensity = parseInt(document.getElementById('weather-light-intensity').value) || 100
	state.currentWeather.tempAdjust = parseInt(document.getElementById('weather-temp').value) || 0
	const item = document.querySelector(`.weather-item[data-id="${state.currentWeather.id}"]`)
	if (item) item.querySelector('.weather-item-name').textContent = state.currentWeather.name
}
document.getElementById('add-weather-btn').addEventListener('click', () => {
	const weather = new Weather()
	state.weathers.push(weather)
	addWeatherToList(weather)
	document.querySelectorAll('.weather-item').forEach(i => i.classList.remove('selected'))
	document.querySelector(`.weather-item[data-id="${weather.id}"]`).classList.add('selected')
	state.currentWeather = weather
	showWeatherEditor(weather)
})
document.getElementById('weather-name').addEventListener('input', updateCurrentWeather)
document.getElementById('weather-time').addEventListener('change', updateCurrentWeather)
document.getElementById('weather-rain').addEventListener('input', updateCurrentWeather)
document.getElementById('weather-lightning').addEventListener('input', updateCurrentWeather)
document.getElementById('weather-light-color').addEventListener('input', updateCurrentWeather)
document.getElementById('weather-light-intensity').addEventListener('input', updateCurrentWeather)
document.getElementById('weather-temp').addEventListener('input', updateCurrentWeather)
document.querySelectorAll('.skill-system-toggle').forEach(toggle => {
	toggle.addEventListener('change', () => {
		const item = toggle.closest('.skill-system-item')
		item.classList.toggle('active', toggle.checked)
	})
})
function updateSpawnUI() {
	const el = document.getElementById('spawn-type')
	if (!el) return
	const type = el.value
	document.getElementById('spawn-biome-row').style.display = type === 'biome' ? 'flex' : 'none'
	document.getElementById('spawn-zone-row').style.display = type === 'city' ? 'flex' : 'none'
}
const spawnTypeEl = document.getElementById('spawn-type')
if (spawnTypeEl) spawnTypeEl.addEventListener('change', updateSpawnUI)
updateSpawnUI()
function updateSpawnItemSelect() {
	const select = document.getElementById('spawn-item-select')
	const curVal = select.value
	select.innerHTML = '<option value="">选择物品...</option>'
	state.entities.filter(e => e.type === 'item').forEach(entity => {
		const opt = document.createElement('option')
		opt.value = entity.id
		opt.textContent = entity.name
		select.appendChild(opt)
	})
	if (curVal) select.value = curVal
}
function renderSpawnItemList() {
	const list = document.getElementById('spawn-item-list')
	list.innerHTML = ''
	state.spawnItems.forEach((item, idx) => {
		const entity = state.entities.find(e => e.id === item.entityId)
		const div = document.createElement('div')
		div.className = 'spawn-item'
		div.innerHTML = `<span class="spawn-item-name">${entity ? entity.name : '未知物品'}</span><span class="spawn-item-count">x${item.count}</span><button class="spawn-item-del" data-idx="${idx}">×</button>`
		div.querySelector('.spawn-item-del').addEventListener('click', () => {
			state.spawnItems.splice(idx, 1)
			renderSpawnItemList()
		})
		list.appendChild(div)
	})
}
const addSpawnItemBtn = document.getElementById('add-spawn-item-btn')
if (addSpawnItemBtn) addSpawnItemBtn.addEventListener('click', () => {
	const select = document.getElementById('spawn-item-select')
	const countInput = document.getElementById('spawn-item-count')
	const entityId = select.value
	const count = parseInt(countInput.value) || 1
	if (!entityId) return
	const existing = state.spawnItems.find(i => i.entityId === entityId)
	if (existing) {
		existing.count += count
	} else {
		state.spawnItems.push({ entityId, count })
	}
	renderSpawnItemList()
	select.value = ''
	countInput.value = '1'
})
function getProjectData() {
	return {
		version: '3.0.27',
		buildings: state.buildings.map(b => ({
			id: b.id,
			name: b.name,
			category: b.category,
			ensure: b.ensure,
			spawn: b.spawn,
			spawnRadius: b.spawnRadius,
			voxel: b.voxel
		})),
		furniture: state.furniture.map(f => f.toJSON()),
		entities: state.entities.map(e => e.toJSON()),
		events: state.events.map(e => e.toJSON()),
		weathers: state.weathers.map(w => w.toJSON()),
		spawnItems: state.spawnItems,
		config: {
			style: document.getElementById('cfg-style').value,
			ruined: document.getElementById('cfg-ruined').checked,
			temp: document.getElementById('cfg-temp').value,
			daylight: document.getElementById('cfg-daylight').value,
			sunColor: document.getElementById('cfg-sun-color').value,
			sunIntensity: document.getElementById('cfg-sun-intensity').value,
			moonColor: document.getElementById('cfg-moon-color').value,
			moonIntensity: document.getElementById('cfg-moon-intensity').value,
			lakeDensity: document.getElementById('cfg-lake-density').value,
			lakeRadius: document.getElementById('cfg-lake-radius').value,
			lakeDepth: document.getElementById('cfg-lake-depth').value,
			riverDensity: document.getElementById('cfg-river-density').value,
			riverWidth: document.getElementById('cfg-river-width').value,
			riverDepth: document.getElementById('cfg-river-depth').value,
			tributaryDensity: document.getElementById('cfg-tributary-density').value,
			mountainDensity: document.getElementById('cfg-mountain-density').value,
			mountainHeight: document.getElementById('cfg-mountain-height').value,
			biomes: {
				grassland: { enabled: document.getElementById('cfg-biome-grassland').checked, weight: document.getElementById('cfg-biome-grassland-weight').value },
				polar: { enabled: document.getElementById('cfg-biome-polar').checked, weight: document.getElementById('cfg-biome-polar-weight').value },
				swamp: { enabled: document.getElementById('cfg-biome-swamp').checked, weight: document.getElementById('cfg-biome-swamp-weight').value },
				desert: { enabled: document.getElementById('cfg-biome-desert').checked, weight: document.getElementById('cfg-biome-desert-weight').value },
				rainforest: { enabled: document.getElementById('cfg-biome-rainforest').checked, weight: document.getElementById('cfg-biome-rainforest-weight').value },
				tundra: { enabled: document.getElementById('cfg-biome-tundra').checked, weight: document.getElementById('cfg-biome-tundra-weight').value },
				savanna: { enabled: document.getElementById('cfg-biome-savanna').checked, weight: document.getElementById('cfg-biome-savanna-weight').value }
			},
			cityMode: document.getElementById('cfg-city-mode').value,
			citySpacing: document.getElementById('cfg-city-spacing').value,
			cityRadius: document.getElementById('cfg-city-radius').value,
			zones: {
				downtown: { enabled: document.getElementById('cfg-zone-downtown').checked, weight: document.getElementById('cfg-zone-downtown-weight').value },
				urban: { enabled: document.getElementById('cfg-zone-urban').checked, weight: document.getElementById('cfg-zone-urban-weight').value },
				suburban: { enabled: document.getElementById('cfg-zone-suburban').checked, weight: document.getElementById('cfg-zone-suburban-weight').value },
				rural: { enabled: document.getElementById('cfg-zone-rural').checked, weight: document.getElementById('cfg-zone-rural-weight').value }
			},
			spawnType: document.getElementById('spawn-type')?.value || 'city',
			spawnBiome: document.getElementById('spawn-biome')?.value || 'grassland',
			spawnZone: document.getElementById('spawn-zone')?.value || 'suburban'
		}
	}
}
function loadProjectData(data) {
	state.buildings = []
	state.furniture = []
	state.entities = []
	state.events = []
	state.weathers = []
	state.spawnItems = []
	document.getElementById('fld-buildings').querySelectorAll('.pn-hd-drg').forEach(el => el.remove())
	document.getElementById('fld-furniture').querySelectorAll('.pn-hd-drg').forEach(el => el.remove())
	document.getElementById('fld-entities').querySelectorAll('.pn-hd-drg').forEach(el => el.remove())
	document.getElementById('fld-events').querySelectorAll('.pn-hd-clk').forEach(el => el.remove())
	document.getElementById('weather-list').innerHTML = ''
	document.getElementById('spawn-item-list').innerHTML = ''
	if (data.buildings) {
		data.buildings.forEach(b => {
			state.buildings.push(b)
			addBuildingToList(b)
		})
	}
	if (data.furniture) {
		data.furniture.forEach(f => {
			const furniture = Furniture.fromJSON(f)
			state.furniture.push(furniture)
			addFurnitureToList(furniture)
		})
	}
	if (data.entities) {
		data.entities.forEach(e => {
			const entity = Entity.fromJSON(e)
			state.entities.push(entity)
			addEntityToList(entity)
		})
	}
	if (data.events) {
		data.events.forEach(e => {
			const evt = GameEvent.fromJSON(e)
			state.events.push(evt)
			addEventToList(evt)
		})
	}
	if (data.weathers) {
		data.weathers.forEach(w => {
			const weather = Weather.fromJSON(w)
			state.weathers.push(weather)
			addWeatherToList(weather)
		})
	}
	state.spawnItems = data.spawnItems || []
	renderSpawnItemList()
	updateSpawnItemSelect()
	if (data.config) {
		if (data.config.style) document.getElementById('cfg-style').value = data.config.style
		if (data.config.ruined !== undefined) document.getElementById('cfg-ruined').checked = data.config.ruined
		if (data.config.temp) document.getElementById('cfg-temp').value = data.config.temp
		if (data.config.daylight) document.getElementById('cfg-daylight').value = data.config.daylight
		if (data.config.sunColor) document.getElementById('cfg-sun-color').value = data.config.sunColor
		if (data.config.sunIntensity) document.getElementById('cfg-sun-intensity').value = data.config.sunIntensity
		if (data.config.moonColor) document.getElementById('cfg-moon-color').value = data.config.moonColor
		if (data.config.moonIntensity) document.getElementById('cfg-moon-intensity').value = data.config.moonIntensity
		if (data.config.lakeDensity) document.getElementById('cfg-lake-density').value = data.config.lakeDensity
		if (data.config.lakeRadius) document.getElementById('cfg-lake-radius').value = data.config.lakeRadius
		if (data.config.lakeDepth) document.getElementById('cfg-lake-depth').value = data.config.lakeDepth
		if (data.config.riverDensity) document.getElementById('cfg-river-density').value = data.config.riverDensity
		if (data.config.riverWidth) document.getElementById('cfg-river-width').value = data.config.riverWidth
		if (data.config.riverDepth) document.getElementById('cfg-river-depth').value = data.config.riverDepth
		if (data.config.tributaryDensity) document.getElementById('cfg-tributary-density').value = data.config.tributaryDensity
		if (data.config.mountainDensity) document.getElementById('cfg-mountain-density').value = data.config.mountainDensity
		if (data.config.mountainHeight) document.getElementById('cfg-mountain-height').value = data.config.mountainHeight
		if (data.config.biomes) {
			const biomes = ['grassland', 'polar', 'swamp', 'desert', 'rainforest', 'tundra', 'savanna']
			biomes.forEach(b => {
				if (data.config.biomes[b]) {
					document.getElementById('cfg-biome-' + b).checked = data.config.biomes[b].enabled
					document.getElementById('cfg-biome-' + b + '-weight').value = data.config.biomes[b].weight
				}
			})
		}
		if (data.config.cityMode) document.getElementById('cfg-city-mode').value = data.config.cityMode
		if (data.config.citySpacing) document.getElementById('cfg-city-spacing').value = data.config.citySpacing
		if (data.config.cityRadius) document.getElementById('cfg-city-radius').value = data.config.cityRadius
		if (data.config.zones) {
			const zones = ['downtown', 'urban', 'suburban', 'rural']
			zones.forEach(z => {
				if (data.config.zones[z]) {
					document.getElementById('cfg-zone-' + z).checked = data.config.zones[z].enabled
					document.getElementById('cfg-zone-' + z + '-weight').value = data.config.zones[z].weight
				}
			})
		}
		const spawnTypeEl = document.getElementById('spawn-type')
		const spawnBiomeEl = document.getElementById('spawn-biome')
		const spawnZoneEl = document.getElementById('spawn-zone')
		if (data.config.spawnType && spawnTypeEl) spawnTypeEl.value = data.config.spawnType
		if (data.config.spawnBiome && spawnBiomeEl) spawnBiomeEl.value = data.config.spawnBiome
		if (data.config.spawnZone && spawnZoneEl) spawnZoneEl.value = data.config.spawnZone
		updateSpawnUI()
	}
}
document.getElementById('export-btn').addEventListener('click', () => {
	const data = getProjectData()
	const json = JSON.stringify(data, null, 2)
	const blob = new Blob([json], { type: 'application/json' })
	const url = URL.createObjectURL(blob)
	const a = document.createElement('a')
	a.href = url
	a.download = 'project.json'
	a.click()
	URL.revokeObjectURL(url)
})
document.getElementById('import-btn').addEventListener('click', () => {
	const input = document.createElement('input')
	input.type = 'file'
	input.accept = '.json'
	input.onchange = e => {
		const file = e.target.files[0]
		if (!file) return
		const reader = new FileReader()
		reader.onload = ev => {
			try {
				const data = JSON.parse(ev.target.result)
				loadProjectData(data)
			} catch (err) {
				alert('导入失败: ' + err.message)
			}
		}
		reader.readAsText(file)
	}
	input.click()
})
document.getElementById('exit-edit-mode').addEventListener('click', () => {
	if (state.editMode === 'building') {
		exitEditMode()
	} else if (state.editMode === 'event') {
		exitEventEditMode()
	} else if (state.editMode === 'entity') {
		exitEntityEditMode()
	} else if (state.editMode === 'furniture') {
		exitFurnitureEditMode()
	}
})
initRenderer()
updateRiPnCollapse(false)
const aiState = {
	servers: [],
	tasks: [],
	selectedTask: null,
	processing: false,
	curMenu: 'tasks',
	curWorkflow: null,
	workflowQueue: [],
	checkpoints: [],
	selectedModel: ''
}
const WORKFLOW_STEPS = {
	texture: ['flux'],
	model: ['flux', 'hy3d', 'unirig', 'hymotion'],
	voice: ['chatterbox'],
	audio: ['stable-audio']
}
function aiAddServer(addr) {
	if (!addr) return
	if (!addr.includes(':')) addr = addr + ':9527'
	if (aiState.servers.find(s => s.addr === addr)) return
	const server = { addr, status: 'connecting', id: Date.now() }
	aiState.servers.push(server)
	aiRenderServers()
	aiCheckServer(server)
}
aiAddServer('localhost:9527')
function aiRemoveServer(id) {
	aiState.servers = aiState.servers.filter(s => s.id !== id)
	aiRenderServers()
}
async function aiCheckServer(server) {
	try {
		const res = await fetch(`http://${server.addr}/api/status`, { method: 'GET', signal: AbortSignal.timeout(5000) })
		if (res.ok) {
			server.status = 'connected'
			aiFetchCheckpoints(server)
		} else {
			server.status = 'error'
		}
	} catch (e) {
		server.status = 'error'
	}
	aiRenderServers()
}
async function aiFetchCheckpoints(server) {
	try {
		const res = await fetch(`http://${server.addr}/api/checkpoints`)
		const data = await res.json()
		if (data.ok && data.models) {
			aiState.checkpoints = data.models
			aiRenderModelSelect()
		}
	} catch (e) {}
}
function aiRenderModelSelect() {
	const sel = document.getElementById('ai-model-sel')
	if (aiState.checkpoints.length === 0) {
		sel.innerHTML = '<option value="">无可用模型</option>'
		return
	}
	sel.innerHTML = aiState.checkpoints.map(m => `<option value="${m}">${m}</option>`).join('')
	if (aiState.selectedModel && aiState.checkpoints.includes(aiState.selectedModel)) {
		sel.value = aiState.selectedModel
	} else {
		aiState.selectedModel = aiState.checkpoints[0]
		sel.value = aiState.selectedModel
	}
}
const aiModelSel = document.getElementById('ai-model-sel')
if (aiModelSel) aiModelSel.addEventListener('change', e => {
	aiState.selectedModel = e.target.value
})
function aiRenderServers() {
	const lst = document.getElementById('ai-server-lst')
	lst.innerHTML = aiState.servers.map(s => `
		<div class="ai-server-tag ${s.status === 'connected' ? 'connected' : s.status === 'connecting' ? 'connecting' : ''}">
			<span class="status-dot"></span>
			<span>${s.addr}</span>
			<button class="del-btn" data-server-id="${s.id}">&times;</button>
		</div>
	`).join('')
	lst.querySelectorAll('.del-btn').forEach(btn => {
		btn.addEventListener('click', e => {
			e.stopPropagation()
			aiRemoveServer(parseInt(btn.dataset.serverId))
		})
	})
}
function aiParseYaml(text) {
	const lines = text.split('\n')
	const items = []
	let cur = null
	for (let line of lines) {
		if (line.startsWith('- id:')) {
			if (cur) items.push(cur)
			cur = { id: line.slice(6).trim(), workflow: {} }
		} else if (cur && line.startsWith('  ')) {
			const m = line.match(/^\s+(\w+):\s*(.*)$/)
			if (m) {
				const key = m[1], val = m[2].trim()
				if (key === 'done') {
					cur.done = val === 'true' || (val !== 'false' && val)
				} else if (key === 'workflow') {
					continue
				} else {
					cur[key] = val
				}
			}
		} else if (cur && line.match(/^\s{4}\w+:/)) {
			const m = line.match(/^\s{4}(\w+):\s*(.*)$/)
			if (m) cur.workflow[m[1]] = m[2] === 'true' || (m[2] !== 'false' && m[2])
		}
	}
	if (cur) items.push(cur)
	return items.map(item => {
		const type = item.type || 'texture'
		const steps = WORKFLOW_STEPS[type] || ['flux']
		if (!Object.keys(item.workflow).length) {
			steps.forEach(s => item.workflow[s] = false)
		}
		return item
	})
}
function aiGetTaskStatus(task) {
	const steps = WORKFLOW_STEPS[task.type || 'texture'] || []
	const wfVals = steps.map(s => task.workflow[s])
	if (wfVals.some(v => v === 'error')) return 'error'
	if (wfVals.every(v => v === true)) return 'done'
	if (wfVals.some(v => v === 'running' || (typeof v === 'string' && v.startsWith('retry')))) return 'running'
	if (wfVals.some(v => v === true)) return 'running'
	return 'pending'
}
function aiRenderTasks() {
	const lst = document.getElementById('ai-task-lst')
	const empty = document.getElementById('ai-empty')
	if (!aiState.tasks.length) {
		if (empty) empty.style.display = 'flex'
		lst.innerHTML = ''
		return
	}
	if (empty) empty.style.display = 'none'
	lst.innerHTML = aiState.tasks.map(task => {
		const status = aiGetTaskStatus(task)
		const steps = WORKFLOW_STEPS[task.type || 'texture'] || []
		return `
			<div class="ai-task-item status-${status} ${aiState.selectedTask?.id === task.id ? 'selected' : ''}" data-task-id="${task.id}">
				<div class="task-hd">
					<span class="task-id">${task.id}</span>
					<span class="task-type">${task.type || 'texture'}</span>
				</div>
				<div class="task-prompt">${task.prompt || ''}</div>
				<div class="task-workflow">
					${steps.map(k => {
						const v = task.workflow[k]
						let cls = ''
						if (v === true) cls = 'done'
						else if (v === 'running') cls = 'running'
						else if (v === 'error') cls = 'error'
						else if (typeof v === 'string' && v.startsWith('retry')) cls = 'retry'
						return `<span class="wf-step ${cls}">${k}</span>`
					}).join('')}
				</div>
			</div>
		`
	}).join('')
	lst.querySelectorAll('.ai-task-item').forEach(el => {
		el.addEventListener('click', () => {
			const id = el.dataset.taskId
			aiState.selectedTask = aiState.tasks.find(t => t.id === id) || null
			aiRenderTasks()
			aiRenderTaskDetail()
		})
	})
	aiUpdateStats()
}
function aiRenderTaskDetail() {
	const cnt = document.getElementById('ai-task-detail')
	if (!aiState.selectedTask) {
		cnt.innerHTML = `<div class="ai-empty-state" style="padding:40px 0;"><span style="font-size:12px;">选择任务查看详情</span></div>`
		return
	}
	const t = aiState.selectedTask
	const steps = WORKFLOW_STEPS[t.type || 'texture'] || []
	const getStepInfo = v => {
		if (v === true) return { color: '#4ade80', text: '完成' }
		if (v === 'running') return { color: '#60a5fa', text: '处理中' }
		if (v === 'error') return { color: '#f87171', text: '失败' }
		if (typeof v === 'string' && v.startsWith('retry')) return { color: '#fbbf24', text: `重试${v.slice(5)}` }
		return { color: '#555', text: '待处理' }
	}
	cnt.innerHTML = `
		<div style="margin-bottom:12px;">
			<div style="font-size:11px;color:#666;margin-bottom:4px;">ID</div>
			<div style="font-size:12px;color:#fff;font-family:monospace;">${t.id}</div>
		</div>
		<div style="margin-bottom:12px;">
			<div style="font-size:11px;color:#666;margin-bottom:4px;">类型</div>
			<div style="font-size:12px;color:#fff;">${t.type || 'texture'}</div>
		</div>
		<div style="margin-bottom:12px;">
			<div style="font-size:11px;color:#666;margin-bottom:4px;">提示词</div>
			<div style="font-size:12px;color:#aaa;line-height:1.5;">${t.prompt || '-'}</div>
		</div>
		<div style="margin-bottom:12px;">
			<div style="font-size:11px;color:#666;margin-bottom:4px;">输出路径</div>
			<div style="font-size:12px;color:#aaa;word-break:break-all;">${t.path || '-'}</div>
		</div>
		${t.error ? `<div style="margin-bottom:12px;">
			<div style="font-size:11px;color:#666;margin-bottom:4px;">错误信息</div>
			<div style="font-size:12px;color:#f87171;">${t.error}</div>
		</div>` : ''}
		<div>
			<div style="font-size:11px;color:#666;margin-bottom:8px;">工作流状态</div>
			${steps.map(k => {
				const v = t.workflow[k]
				const info = getStepInfo(v)
				return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
					<span style="width:8px;height:8px;border-radius:50%;background:${info.color};"></span>
					<span style="font-size:12px;color:#aaa;">${k}</span>
					<span style="font-size:11px;color:#666;margin-left:auto;">${info.text}</span>
				</div>`
			}).join('')}
		</div>
	`
}
function aiUpdateStats() {
	let done = 0, running = 0, pending = 0, error = 0
	aiState.tasks.forEach(t => {
		const s = aiGetTaskStatus(t)
		if (s === 'done') done++
		else if (s === 'running') running++
		else if (s === 'error') error++
		else pending++
	})
	document.getElementById('ai-stat-done').textContent = done
	document.getElementById('ai-stat-running').textContent = running
	document.getElementById('ai-stat-pending').textContent = pending
	document.getElementById('ai-stat-error').textContent = error
	document.getElementById('ai-start-btn').disabled = !aiState.tasks.length || !aiState.servers.some(s => s.status === 'connected')
}
function aiShowMenu(menu) {
	aiState.curMenu = menu
	document.querySelectorAll('.ai-menu-item').forEach(el => {
		el.classList.toggle('active', el.dataset.aiMenu === menu)
	})
	document.getElementById('ai-cfg-model').style.display = menu === 'model' ? 'block' : 'none'
	document.getElementById('ai-cfg-texture').style.display = menu === 'texture' ? 'block' : 'none'
	document.getElementById('ai-cfg-voice').style.display = menu === 'voice' ? 'block' : 'none'
	document.getElementById('ai-cfg-audio').style.display = menu === 'audio' ? 'block' : 'none'
	document.getElementById('ai-cfg-task').style.display = menu === 'tasks' ? 'block' : 'none'
}
async function aiStartProcessing() {
	if (aiState.processing) return
	aiState.processing = true
	document.getElementById('ai-start-btn').style.display = 'none'
	document.getElementById('ai-stop-btn').style.display = 'flex'
	const connectedServers = aiState.servers.filter(s => s.status === 'connected')
	if (!connectedServers.length) {
		aiStopProcessing()
		return
	}
	const pendingTasks = aiState.tasks.filter(t => aiGetTaskStatus(t) !== 'done')
	const workflowOrder = ['flux', 'hy3d', 'unirig', 'hymotion', 'chatterbox', 'stable-audio']
	let serverIdx = 0
	for (const wfStep of workflowOrder) {
		if (!aiState.processing) break
		const tasksForStep = pendingTasks.filter(t => {
			const steps = WORKFLOW_STEPS[t.type || 'texture'] || []
			return steps.includes(wfStep) && !t.workflow[wfStep] && t.workflow[wfStep] !== 'error'
		})
		if (!tasksForStep.length) continue
		aiState.curWorkflow = wfStep
		for (const task of tasksForStep) {
			if (!aiState.processing) break
			const server = connectedServers[serverIdx % connectedServers.length]
			serverIdx++
			await aiProcessTask(task, wfStep, server)
		}
	}
	aiState.curWorkflow = null
	aiStopProcessing()
}
async function aiProcessTask(task, step, server, retries = 0) {
	const maxRetries = 3
	task.workflow[step] = 'running'
	aiRenderTasks()
	aiRenderTaskDetail()
	try {
		const endpoint = aiGetEndpoint(step, task)
		const res = await fetch(`http://${server.addr}${endpoint.url}`, {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(endpoint.body)
		})
		const data = await res.json()
		if (res.ok && data.ok) {
			task.workflow[step] = true
			if (data.output) task.outputPath = data.output
		} else {
			throw new Error(data.error || '请求失败')
		}
	} catch (e) {
		if (retries < maxRetries) {
			task.workflow[step] = `retry${retries + 1}`
			aiRenderTasks()
			aiRenderTaskDetail()
			await new Promise(r => setTimeout(r, 2000))
			return aiProcessTask(task, step, server, retries + 1)
		}
		task.workflow[step] = 'error'
		task.error = e.message || '未知错误'
	}
	aiRenderTasks()
	aiRenderTaskDetail()
}
function aiGetEndpoint(step, task) {
	const type = task.type || 'texture'
	switch (step) {
		case 'flux':
			return { url: '/api/flux/generate', body: { prompt: task.prompt, output: task.path, model: aiState.selectedModel } }
		case 'hy3d':
			return { url: '/api/hunyuan3d/generate', body: { image: task.path?.replace('.glb', '.png'), output: task.path } }
		case 'unirig':
			return { url: '/api/unirig/rig', body: { input: task.path, output: task.path } }
		case 'hymotion':
			return { url: '/api/motion/generate', body: { model: task.path, motions: task.motion || [] } }
		case 'chatterbox':
			return { url: '/api/voice/generate', body: { text: task.text || task.prompt, output: task.path } }
		case 'stable-audio':
			return { url: '/api/audio/generate', body: { prompt: task.prompt, output: task.path } }
		default:
			return { url: '/api/status', body: {} }
	}
}
function aiStopProcessing() {
	aiState.processing = false
	aiState.curWorkflow = null
	document.getElementById('ai-start-btn').style.display = 'flex'
	document.getElementById('ai-stop-btn').style.display = 'none'
	aiUpdateStats()
}
document.getElementById('ai-add-server-btn').addEventListener('click', () => {
	document.getElementById('ai-server-md').classList.add('show')
	document.getElementById('ai-server-ipt').value = ''
	document.getElementById('ai-server-ipt').focus()
})
document.getElementById('ai-server-cancel').addEventListener('click', () => {
	document.getElementById('ai-server-md').classList.remove('show')
})
document.getElementById('ai-server-confirm').addEventListener('click', () => {
	const addr = document.getElementById('ai-server-ipt').value.trim()
	if (addr) {
		aiAddServer(addr)
		document.getElementById('ai-server-md').classList.remove('show')
	}
})
document.getElementById('ai-server-ipt').addEventListener('keydown', e => {
	if (e.key === 'Enter') {
		document.getElementById('ai-server-confirm').click()
	}
})
document.getElementById('ai-load-btn').addEventListener('click', () => {
	document.getElementById('ai-yaml-file').click()
})
document.getElementById('ai-yaml-file').addEventListener('change', e => {
	const file = e.target.files[0]
	if (!file) return
	const reader = new FileReader()
	reader.onload = evt => {
		try {
			aiState.tasks = aiParseYaml(evt.target.result)
			aiState.selectedTask = null
			aiRenderTasks()
			aiRenderTaskDetail()
			aiUpdateStats()
		} catch (err) {
			alert('YAML解析失败: ' + err.message)
		}
	}
	reader.readAsText(file)
	e.target.value = ''
})
document.getElementById('ai-start-btn').addEventListener('click', () => {
	aiStartProcessing()
})
document.getElementById('ai-stop-btn').addEventListener('click', () => {
	aiStopProcessing()
})
document.querySelectorAll('.ai-menu-item').forEach(el => {
	el.addEventListener('click', () => {
		aiShowMenu(el.dataset.aiMenu)
	})
})
const bldState = {
	lyrs: [],
	curLyr: null,
	tool: 'line',
	lineWidth: 0.2,
	drawing: false,
	startPt: null,
	canvas: null,
	ctx: null
}
function initBldEditor() {
	if (!bldState.canvas) {
		bldState.canvas = document.getElementById('bld-canvas')
		bldState.ctx = bldState.canvas.getContext('2d')
		resizeBldCanvas()
		bldState.canvas.addEventListener('mousedown', onBldMouseDown)
		bldState.canvas.addEventListener('mousemove', onBldMouseMove)
		bldState.canvas.addEventListener('mouseup', onBldMouseUp)
		window.addEventListener('resize', resizeBldCanvas)
	}
	if (bldState.lyrs.length === 0) addBldLyr()
	renderBldLyrList()
	renderBldCanvas()
}
function resizeBldCanvas() {
	const ctn = document.getElementById('bld-cv-ctn')
	if (!ctn || !bldState.canvas) return
	bldState.canvas.width = ctn.clientWidth
	bldState.canvas.height = ctn.clientHeight
	renderBldCanvas()
}
function addBldLyr() {
	const lyr = {
		id: Date.now(),
		name: '第 ' + (bldState.lyrs.length + 1) + ' 层',
		height: 3,
		lines: [],
		walls: [],
		grounds: []
	}
	bldState.lyrs.unshift(lyr)
	bldState.curLyr = lyr
	renderBldLyrList()
}
function renderBldLyrList() {
	const lst = document.getElementById('bld-lyr-lst')
	if (!lst) return
	lst.innerHTML = ''
	bldState.lyrs.forEach(lyr => {
		const item = document.createElement('div')
		item.className = 'bld-lyr-item' + (bldState.curLyr === lyr ? ' sel' : '')
		item.innerHTML = '<span>' + lyr.name + '</span><span style="color:#666;font-size:11px;">' + lyr.height + 'm</span>'
		item.addEventListener('click', () => {
			bldState.curLyr = lyr
			renderBldLyrList()
		})
		lst.appendChild(item)
	})
}
function renderBldCanvas() {
	if (!bldState.ctx || !bldState.canvas) return
	const ctx = bldState.ctx
	const w = bldState.canvas.width
	const h = bldState.canvas.height
	ctx.fillStyle = '#0a0a0a'
	ctx.fillRect(0, 0, w, h)
	ctx.strokeStyle = '#222'
	ctx.lineWidth = 1
	const gridSize = 20
	for (let x = 0; x <= w; x += gridSize) {
		ctx.beginPath()
		ctx.moveTo(x, 0)
		ctx.lineTo(x, h)
		ctx.stroke()
	}
	for (let y = 0; y <= h; y += gridSize) {
		ctx.beginPath()
		ctx.moveTo(0, y)
		ctx.lineTo(w, y)
		ctx.stroke()
	}
	if (bldState.curLyr) {
		ctx.strokeStyle = '#4a9eff'
		ctx.lineWidth = 2
		bldState.curLyr.lines.forEach(line => {
			ctx.beginPath()
			ctx.moveTo(line.x1, line.y1)
			ctx.lineTo(line.x2, line.y2)
			ctx.stroke()
		})
	}
}
function onBldMouseDown(e) {
	if (bldState.tool === 'line') {
		bldState.drawing = true
		bldState.startPt = { x: e.offsetX, y: e.offsetY }
	}
}
function onBldMouseMove(e) {
	if (bldState.drawing && bldState.tool === 'line') {
		renderBldCanvas()
		const ctx = bldState.ctx
		ctx.strokeStyle = '#166d3b'
		ctx.lineWidth = 2
		ctx.beginPath()
		ctx.moveTo(bldState.startPt.x, bldState.startPt.y)
		ctx.lineTo(e.offsetX, e.offsetY)
		ctx.stroke()
		const dx = e.offsetX - bldState.startPt.x
		const dy = e.offsetY - bldState.startPt.y
		const len = Math.sqrt(dx * dx + dy * dy) / 20
		document.getElementById('bld-info').textContent = '长度: ' + len.toFixed(2) + 'm'
	}
}
function onBldMouseUp(e) {
	if (bldState.drawing && bldState.tool === 'line' && bldState.curLyr) {
		bldState.curLyr.lines.push({
			id: Date.now(),
			x1: bldState.startPt.x,
			y1: bldState.startPt.y,
			x2: e.offsetX,
			y2: e.offsetY,
			width: bldState.lineWidth
		})
		renderBldCanvas()
	}
	bldState.drawing = false
	bldState.startPt = null
	document.getElementById('bld-info').textContent = '长度: 0m'
}
document.getElementById('bld-lyr-add').addEventListener('click', addBldLyr)
document.querySelectorAll('.bld-tool-btn').forEach(btn => {
	btn.addEventListener('click', () => {
		document.querySelectorAll('.bld-tool-btn').forEach(b => b.classList.remove('active'))
		btn.classList.add('active')
		bldState.tool = btn.dataset.bldTool
		updateBldProps()
	})
})
function updateBldProps() {
	const props = document.getElementById('bld-props')
	if (!props) return
	let html = ''
	if (bldState.tool === 'line') {
		html = '<div class="config-section"><div class="config-section-title">直线属性</div><div class="config-row"><label>宽度</label><input type="number" id="bld-line-width" value="' + bldState.lineWidth + '" min="0.0625" step="0.0625"><span class="unit">m</span></div></div>'
	} else if (bldState.tool === 'ground') {
		html = '<div class="config-section"><div class="config-section-title">地面类型</div><div class="type-tabs"><button class="type-tab active">自然</button><button class="type-tab">室外</button><button class="type-tab">室内</button><button class="type-tab">屋顶</button></div></div>'
	} else if (bldState.tool === 'wall') {
		html = '<div class="config-section"><div class="config-section-title">墙壁材质</div><div class="config-row"><label>材质</label><select><option>砖墙</option><option>混凝土</option><option>木墙</option><option>玻璃</option></select></div></div>'
	} else if (bldState.tool === 'window') {
		html = '<div class="config-section"><div class="config-section-title">窗户属性</div><div class="config-row"><label>底部高度</label><input type="number" value="0.8" step="0.1"><span class="unit">m</span></div><div class="config-row"><label>顶部高度</label><input type="number" value="2.2" step="0.1"><span class="unit">m</span></div></div>'
	} else if (bldState.tool === 'door') {
		html = '<div class="config-section"><div class="config-section-title">门属性</div><div class="config-row"><label>门高度</label><input type="number" value="2.2" step="0.1"><span class="unit">m</span></div><div class="config-row"><label>门类型</label><select><option>木门</option><option>铁门</option><option>仅门框</option></select></div></div>'
	}
	props.innerHTML = html
}
document.querySelectorAll('.ast-cat-hd').forEach(hd => {
	hd.addEventListener('click', () => {
		hd.classList.toggle('open')
		const bd = hd.nextElementSibling
		if (bd) bd.classList.toggle('open')
	})
})
document.querySelectorAll('.pn-hd-fld-header').forEach(hd => {
	hd.addEventListener('click', () => {
		hd.classList.toggle('open')
		const bd = hd.nextElementSibling
		if (bd) bd.classList.toggle('open')
	})
})
document.querySelectorAll('.ast-sub-hd').forEach(hd => {
	hd.addEventListener('click', () => {
		hd.classList.toggle('open')
		const bd = hd.nextElementSibling
		if (bd) bd.classList.toggle('open')
	})
})
const astBaseUrl = 'https://raw.githubusercontent.com/Nixdorfer/mmd-iframe-template/refs/heads/main/template/3DGame/v3'
const astCfgMap = {
	buildings: { key: 'buildings', files: ['building/base.json'] },
	entities: { key: 'entities', files: ['entity/base.json'] },
	furniture: { key: 'furnitures', files: ['furniture/base.json'] },
	items: { key: 'items', files: ['item/base.json'] },
	buffs: { key: 'buffs', files: ['buff/base.json'] },
	skills: { key: 'skills', files: ['skill/base.json'] },
	walls: { key: 'walls', files: ['wall/base.json'] },
	floors: { key: 'floors', files: ['floor/base.json'] }
}
async function lodCfgFile(cfgRoot, filePath, key) {
	const url = filePath.startsWith('http') ? filePath : `${cfgRoot}/${filePath}`
	try {
		const res = await fetch(url)
		const data = await res.json()
		let items = []
		if (data.includes && Array.isArray(data.includes)) {
			for (const inc of data.includes) {
				const subItems = await lodCfgFile(cfgRoot, inc, key)
				items = items.concat(subItems)
			}
		}
		if (data[key]) items = items.concat(data[key])
		if (data.entities) items = items.concat(data.entities)
		if (data.pokemon) items = items.concat(data.pokemon.map(p => ({ ...p, category: 'pokemon' })))
		return items
	} catch (e) { return [] }
}
const cfgRoot = `${astBaseUrl}/config`
async function lodSysAst() {
	for (const [cat, cfg] of Object.entries(astCfgMap)) {
		const ctn = document.getElementById(`ast-${cat}-sys`)
		if (!ctn) continue
		let items = []
		for (const file of cfg.files) {
			const fileItems = await lodCfgFile(cfgRoot, file, cfg.key)
			items = items.concat(fileItems)
		}
		ctn.innerHTML = items.map(item =>
			`<div class="ast-item sys" data-id="${item.id}" data-cat="${cat}">${item.name}</div>`
		).join('')
	}
}
lodSysAst()
</script>
</body>
</html>
