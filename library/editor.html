<style>
#ed-panel{position:fixed;right:0;top:0;width:280px;height:100vh;background:#111;border-left:1px solid #222;display:flex;flex-direction:column;z-index:10000;font:13px system-ui,sans-serif}
#ed-list{position:fixed;left:-180px;top:0;width:180px;height:100vh;background:#111;border-right:1px solid #222;display:flex;flex-direction:column;z-index:10000;transition:left .3s}
#ed-list.open{left:0}
.ed-menu{transition:left .3s}
.ed-menu.shifted{left:200px}
.ed-tabs{display:flex;border-bottom:1px solid #222;flex-shrink:0}
.ed-tab{flex:1;padding:12px 8px;text-align:center;cursor:pointer;color:#666;transition:color .2s}
.ed-tab:hover{color:#999}
.ed-tab.on{color:#fff;border-bottom:2px solid var(--btn)}
.ed-hd{padding:12px;font-weight:bold;border-bottom:1px solid #222;color:#888}
.ed-proj{padding:10px 12px;cursor:pointer;border-bottom:1px solid #1a1a1a;transition:background .2s;color:#fff}
.ed-proj:hover{background:#1a1a1a}
.ed-proj.on{background:#1f1f1f;color:var(--btn)}
#ed-body{flex:1;overflow-y:auto;padding:12px}
.ed-sec{margin-bottom:16px}
.ed-title{color:#888;font-size:11px;margin-bottom:8px;text-transform:uppercase;font-weight:bold}
.ed-btn{width:100%;padding:10px;background:#1a1a1a;border:none;border-radius:6px;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:background .2s;margin-bottom:6px}
.ed-btn:hover{background:#252525}
.ed-btn.sm{font-size:12px;padding:8px}
.ed-btn.del{color:#ff6b6b}
.ed-btn.del:hover{background:#2a1a1a}
.ed-row{margin-bottom:10px}
.ed-row label{display:block;color:#666;margin-bottom:4px;font-size:11px}
.ed-row input,.ed-row select,.ed-row textarea{width:100%;padding:8px;background:#0d0d0d;border:1px solid #333;border-radius:4px;color:#fff;font-size:12px}
.ed-row textarea{resize:vertical;min-height:60px;font-family:inherit}
.ed-row input:focus,.ed-row select:focus,.ed-row textarea:focus{outline:none;border-color:var(--btn)}
.ed-row input[type=range]{padding:0;height:20px;background:transparent;border:none}
.ed-row input[type=checkbox]{width:auto}
.ed-row input[type=color]{width:40px;height:28px;padding:2px;cursor:pointer}
.ed-v{color:#888;font-size:11px;margin-left:8px}
.ed-up{display:flex;align-items:center;gap:8px}
.ed-up input[type=file]{width:auto;padding:4px;font-size:11px}
.ed-uv{color:#666;font-size:10px;word-break:break-all}
.ed-empty{color:#666;text-align:center;padding:20px}
.ed-color{display:flex;gap:6px;align-items:center}
.ed-color input[type=color]{flex-shrink:0}
.ed-color .ed-ctxt{flex:1}
.ed-slider{display:flex;align-items:center;gap:8px}
.ed-slider input[type=range]{flex:1}
.ed-toggle{display:flex;justify-content:space-between;align-items:center}
.ed-toggle-sw{position:relative;width:36px;height:20px;background:#333;border-radius:10px;cursor:pointer;flex-shrink:0}
.ed-toggle-sw.on{background:var(--btn)}
.ed-toggle-sw::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;background:#fff;border-radius:50%;transition:left .2s}
.ed-toggle-sw.on::after{left:18px}
.ed-drag{padding:10px 12px;margin-bottom:6px;background:#1a1a1a;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:background .2s;color:#fff}
.ed-drag:hover{background:#252525}
.ed-ctx{position:fixed;background:#1a1a1a;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.4);z-index:10001;min-width:120px;overflow:hidden}
.ed-ctx div{padding:10px 14px;cursor:pointer;transition:background .2s;color:#fff}
.ed-ctx div:hover{background:#252525}
.ed-menu{position:fixed;left:10px;top:50%;transform:translateY(-50%);background:#1a1a1a;border-radius:12px;padding:10px 8px;display:flex;flex-direction:column;gap:10px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:10000}
.ed-menu button{background:none;border:none;color:#888;cursor:pointer;padding:4px;display:flex;align-items:center;transition:color .2s}
.ed-menu button:hover{color:#fff}
.ed-toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--btn);color:#fff;padding:10px 24px;border-radius:6px;z-index:10002;animation:edFade .3s}
@keyframes edFade{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.ed-sel{outline:2px dashed var(--btn)!important;outline-offset:2px}
.ed-el{cursor:pointer;transition:outline .15s}.ed-el:hover{outline:1px dashed #666;outline-offset:2px}
.ed-col{cursor:pointer}.ed-col:hover{outline:1px dashed #888;outline-offset:-2px}.ed-col.ed-sel{outline:2px dashed var(--btn)!important;outline-offset:-2px}
.ed-device{display:flex;flex-direction:column;background:#0d0d0d;border-radius:8px;padding:2px}
.ed-device button{padding:4px 6px;border:none;background:none;color:#666;cursor:pointer;border-radius:6px;display:flex}
.ed-device button.on{background:var(--btn);color:#fff}
.ed-fold{background:#1a1a1a;border-radius:6px;margin-bottom:10px}
.ed-fold-hd{padding:8px 10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;color:#888;font-size:11px}
.ed-fold-hd:hover{color:#fff}
.ed-fold-hd .arr{transition:transform .2s}
.ed-fold-hd.open .arr{transform:rotate(90deg)}
.ed-fold-bd{max-height:0;overflow:hidden;transition:max-height .3s}
.ed-fold-bd.open{max-height:800px}
.ed-fold-bd>.ed-row{padding:0 10px}
.ed-fold-bd>.ed-row:last-child{padding-bottom:10px}
.ed-move{position:absolute;left:-8px;top:-8px;width:20px;height:20px;background:var(--btn);border-radius:4px;cursor:move;display:flex;align-items:center;justify-content:center;z-index:10001}
.ed-move svg{width:12px;height:12px;stroke:#fff}
.ed-ph{border:2px dashed var(--btn);margin:4px 0;height:4px;border-radius:2px}
.ed-drop{border:2px dashed var(--btn);margin:8px 0;height:40px;border-radius:6px;background:rgba(22,109,59,.1)}
.ed-chat{display:flex;flex-direction:column;height:100%}
.ed-chat-body{flex:1;overflow-y:auto;padding:8px 0}
.ed-chat-input{display:flex;gap:6px;padding:8px 0;border-top:1px solid #222}
.ed-chat-input textarea{flex:1;resize:none;min-height:60px}
.ed-chat-btns{display:flex;gap:6px}
.ed-chat-btns button{padding:8px 12px;background:#1a1a1a;border:none;border-radius:6px;color:#fff;cursor:pointer}
.ed-chat-btns button:hover{background:#252525}
.ed-chat-btns button.primary{background:var(--btn)}
.ed-modal{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.6);z-index:10003;display:flex;align-items:center;justify-content:center}
.ed-modal-box{background:#1a1a1a;border-radius:8px;width:320px;max-height:70vh;overflow:hidden;display:flex;flex-direction:column}
.ed-modal-hd{padding:12px 16px;border-bottom:1px solid #333;font-weight:bold;color:#fff}
.ed-modal-bd{flex:1;overflow-y:auto;padding:8px}
.ed-model-item{padding:10px 12px;cursor:pointer;border-radius:6px;margin-bottom:4px;color:#fff}
.ed-model-item:hover{background:#252525}
.ed-model-item.on{background:var(--btn)}
.ed-model-item .name{font-weight:bold}
.ed-model-item .desc{font-size:11px;color:#888;margin-top:4px}
</style>
<div id="ed-list"></div>
<div id="ed-panel">
<div class="ed-tabs"><div class="ed-tab on" data-t="0">窗口</div><div class="ed-tab" data-t="1">模块</div><div class="ed-tab" data-t="2">样式</div><div class="ed-tab" data-t="3">组</div><div class="ed-tab" data-t="4">聊天</div><div class="ed-tab" data-t="5">系统</div></div>
<div id="ed-body"></div>
</div>
<div class="ed-menu">
<button id="edList" title="项目列表"><svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></button>
<button id="edUndo" title="撤回"><svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><path d="M3 7v6h6"/><path d="M3 13a9 9 0 1 0 2.3-6.3L3 7"/></svg></button>
<button id="edRedo" title="重做"><svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><path d="M21 7v6h-6"/><path d="M21 13a9 9 0 1 1-2.3-6.3L21 7"/></svg></button>
<button id="edCopy" title="复制配置"><svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button>
<button id="edSave" title="保存文件"><svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><path d="M17 21v-8H7v8M7 3v5h8"/></svg></button>
<button id="edPreview" title="预览"><svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/></svg></button>
<div class="ed-device"><button id="edPc" class="on" title="电脑 16:9"><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></button><button id="edMobile" title="手机 9:19"><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12" y2="18.01"/></svg></button></div>
</div>
<script>
window.U={esc:function(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}};
window.E={
pj:{},cur:null,pg:0,sel:null,multiSel:[],tab:0,list:false,cfg:null,rowSel:null,data:null,hist:[],histIdx:-1,moveMode:false,preview:false,models:[],curModel:null,dragType:null,
animations:[{v:'none',l:'无'},{v:'slideUp',l:'上滑'},{v:'slideDown',l:'下滑'},{v:'slideLeft',l:'左滑'},{v:'slideRight',l:'右滑'},{v:'flipH',l:'水平翻转'},{v:'flipV',l:'垂直翻转'},{v:'fadeIn',l:'淡入'},{v:'zoomIn',l:'放大'},{v:'zoomOut',l:'缩小'}],
textProps:{size:{t:"slider",r:"10-48",d:"字号"},font:{t:"select",d:"字体"},bold:{t:"toggle",d:"加粗"},italic:{t:"toggle",d:"倾斜"},underline:{t:"toggle",d:"下划线"},strike:{t:"toggle",d:"删除线"},color:{t:"color",d:"文字颜色"},bgColor:{t:"color",d:"背景颜色"},opacity:{t:"slider",r:"0-100",d:"文字透明度",v:0},bgOpacity:{t:"slider",r:"0-100",d:"背景透明度",v:0}},
fonts:[{v:'system-ui',l:'系统字体'},{v:'serif',l:'衬线体'},{v:'monospace',l:'等宽体'},{v:'cursive',l:'手写体'}],
shapes:[{v:'rounded',l:'圆角'},{v:'rect',l:'直角'},{v:'hexagon',l:'六边形'}],
aligns:[{v:'left',l:'左对齐'},{v:'center',l:'居中'},{v:'right',l:'右对齐'}],
valigns:[{v:'top',l:'顶部'},{v:'center',l:'居中'},{v:'bottom',l:'底部'}],
imgModes:[{v:'fixedWidth',l:'固定宽度'},{v:'fixedHeight',l:'固定高度'},{v:'cover',l:'铺满'},{v:'contain',l:'包含'}],
imgClicks:[{v:'none',l:'无'},{v:'gallery',l:'查看轮播'},{v:'jumpModal',l:'跳转页面'}],
btnClicks:[{v:'none',l:'无'},{v:'jumpModal',l:'跳转页面'},{v:'message',l:'添加语句'}],
btnEffects:[{v:'none',l:'无系统级效果'},{v:'killer',l:'点击视为结束该画面'},{v:'hider',l:'点击视为隐藏该画面'}],
afterClicks:[{v:'none',l:'无'},{v:'hide',l:'隐藏按钮'},{v:'disable',l:'禁用按钮'}],
switchStyles:[{v:'capsule',l:'胶囊形'},{v:'rounded',l:'圆角'}],
colTypes:['text','image','btn','input','select','switch'],
init:function(d){
var self=this;
self.data=d;
self.cfg={
"global":{name:"全局",props:{bgColor:{t:"color",d:"背景颜色",v:"050505"},bgImgPc:{t:"upload",d:"电脑端背景图"},bgImgMobile:{t:"upload",d:"手机端背景图"},bgTransparent:{t:"toggle",d:"透明背景"},defTextSize:{t:"slider",r:"10-48",d:"默认字号",v:14},defTextColor:{t:"color",d:"默认文字颜色",v:"888888"},defTextFont:{t:"select",r:self.fonts,d:"默认字体",v:"system-ui"},defBtnBg:{t:"color",d:"默认按钮底色",v:"166d3b"},defBtnColor:{t:"color",d:"默认按钮文字色",v:"ffffff"},defBtnShape:{t:"select",r:self.shapes,d:"默认按钮外形",v:"rounded"},defBtnRadius:{t:"slider",r:"0-24",d:"默认圆角",v:8},defModalBg:{t:"color",d:"默认弹窗底色",v:"0d0d0d"},defModalOpacity:{t:"slider",r:"0-100",d:"默认弹窗透明度",v:100},defModalBlur:{t:"slider",r:"0-20",d:"默认弹窗模糊",v:0}}},
"page":{name:"页面",props:{title:{t:"input",d:"页面标题"},prevPage:{t:"page",d:"上一页",v:0},prevAnim:{t:"select",r:self.animations,d:"返回动画",v:"slideRight"},nextPage:{t:"page",d:"下一页",v:0},nextAnim:{t:"select",r:self.animations,d:"前进动画",v:"slideLeft"},modalBg:{t:"color",d:"弹窗背景色"},modalBgImg:{t:"upload",d:"弹窗背景图"},modalOpacity:{t:"slider",r:"0-100",d:"弹窗透明度"},modalBlur:{t:"slider",r:"0-20",d:"弹窗模糊度"}}},
"text":{name:"文本",props:{value:{t:"textarea",d:"内容",v:"文本内容"},size:{t:"slider",r:"10-48",d:"字号"},font:{t:"select",r:self.fonts,d:"字体"},bold:{t:"toggle",d:"加粗"},italic:{t:"toggle",d:"倾斜"},underline:{t:"toggle",d:"下划线"},strike:{t:"toggle",d:"删除线"},color:{t:"color",d:"文字颜色"},bgColor:{t:"color",d:"背景颜色"},opacity:{t:"slider",r:"0-100",d:"文字透明度",v:100},bgOpacity:{t:"slider",r:"0-100",d:"背景透明度",v:0},align:{t:"select",r:self.aligns,d:"对齐",v:"center"}}},
"image":{name:"图片",props:{url:{t:"upload",d:"图片/视频"},urlInput:{t:"input",d:"或输入URL"},clickAction:{t:"select",r:self.imgClicks,d:"点击逻辑",v:"none"},clickTarget:{t:"page",d:"目标页面"},galleryUrls:{t:"gallery",d:"轮播图片"},displayMode:{t:"select",r:self.imgModes,d:"显示模式",v:"fixedWidth"},width:{t:"slider",r:"10-100",d:"宽度%",v:100},height:{t:"slider",r:"50-500",d:"高度px",v:200},opacity:{t:"slider",r:"0-100",d:"透明度",v:100},align:{t:"select",r:self.aligns,d:"对齐",v:"center"}}},
"btn":{name:"按钮",props:{value:{t:"input",d:"按钮文字",v:"按钮"},clickAction:{t:"select",r:self.btnClicks,d:"点击功能",v:"none"},clickTarget:{t:"page",d:"目标页面"},message:{t:"input",d:"添加到用户消息的语句"},sysEffect:{t:"select",r:self.btnEffects,d:"系统级效果",v:"none"},repeatable:{t:"toggle",d:"可重复点击",v:true},afterClick:{t:"select",r:self.afterClicks,d:"禁用后效果",v:"none"},disabledStyle:{t:"color",d:"禁用时颜色",v:"333333"},logicGroup:{t:"grp",g:"logic",d:"按钮逻辑组"},logicMax:{t:"num",d:"组内最多选",v:1},styleGroup:{t:"grp",g:"style",d:"按钮格式组"},shape:{t:"select",r:self.shapes,d:"外形",v:"rounded"},radius:{t:"slider",r:"0-24",d:"圆角",v:8},hexWidth:{t:"slider",r:"5-30",d:"六边形角宽",v:15},bgColor:{t:"color",d:"底色",v:"166d3b"},borderColor:{t:"color",d:"边框颜色",v:"166d3b"},borderWidth:{t:"slider",r:"0-5",d:"边框宽度",v:0},textSize:{t:"slider",r:"10-24",d:"文字大小",v:14},textColor:{t:"color",d:"文字颜色",v:"ffffff"},textBold:{t:"toggle",d:"文字加粗"},width:{t:"slider",r:"20-100",d:"宽度%"},align:{t:"select",r:self.aligns,d:"对齐",v:"center"}}},
"input":{name:"输入框",props:{key:{t:"input",d:"数据键名",v:"input1"},title:{t:"input",d:"标题"},placeholder:{t:"input",d:"说明文字"},required:{t:"toggle",d:"必填",v:false}}},
"select":{name:"下拉框",props:{key:{t:"input",d:"数据键名",v:"select1"},title:{t:"input",d:"标题"},options:{t:"textarea",d:"选项(每行一个)"},default:{t:"slider",r:"0-20",d:"默认索引",v:0}}},
"switch":{name:"滑块",props:{key:{t:"input",d:"数据键名",v:"switch1"},title:{t:"input",d:"标题"},leftText:{t:"input",d:"左侧文字"},rightText:{t:"input",d:"右侧文字"},style:{t:"select",r:self.switchStyles,d:"样式",v:"capsule"},thumbColor:{t:"color",d:"滑块颜色",v:"ffffff"},onBg:{t:"color",d:"开启背景色",v:"166d3b"},offBg:{t:"color",d:"关闭背景色",v:"333333"},borderColor:{t:"color",d:"边框颜色",v:"444444"},onValue:{t:"input",d:"开启时值",v:"on"},offValue:{t:"input",d:"关闭时值",v:"off"},defaultOn:{t:"toggle",d:"默认开启"}}},
"collapse":{name:"折叠项",props:{title:{t:"input",d:"标题文字",v:"点击展开"},titleSize:{t:"slider",r:"10-24",d:"标题字号",v:14},titleColor:{t:"color",d:"标题颜色",v:"ffffff"},titleBold:{t:"toggle",d:"标题加粗"},titleBg:{t:"color",d:"标题背景色",v:"1a1a1a"},arrowColor:{t:"color",d:"箭头颜色",v:"888888"},contentBg:{t:"color",d:"内容背景色",v:"0d0d0d"},defaultOpen:{t:"toggle",d:"默认展开"}}},
"row":{name:"多列",props:{valign:{t:"select",r:self.valigns,d:"垂直对齐",v:"center"},heightBind:{t:"grp",g:"row",d:"高度绑定组"}}}
};
try{self.pj=JSON.parse(localStorage.getItem('d_pj')||'{}')}catch(e){self.pj={}}
self.cur=localStorage.getItem('d_cur')||null;
if(self.cur&&!self.pj[self.cur])self.cur=null;
if(!self.cur&&Object.keys(self.pj).length)self.cur=Object.keys(self.pj)[0];
if(!self.cur){self.cur='p'+Date.now();self.pj[self.cur]={name:'默认项目',data:d};self.save()}
else if(d&&d.pages)self.pj[self.cur].data=d;
if(self.cur){self.hist=[JSON.stringify(self.pj[self.cur].data)];self.histIdx=0}
self.render();
document.addEventListener('click',function(e){
var t=e.target;
if(t.closest('.ed-proj')){var el=t.closest('.ed-proj');if(el.dataset.id)self.loadP(el.dataset.id);else if(el.dataset.pg!==undefined){self.pg=parseInt(el.dataset.pg);self.sel=null;self.save();self.render()}}
if(t.closest('.ed-tab')){self.tab=parseInt(t.closest('.ed-tab').dataset.t);self.rowSel=null;self.renderR()}
if(t.id==='newPgBtn')self.newPg();
if(t.id==='delPgBtn')self.delPg();
if(t.closest('.add-col-btn'))self.addCol();
if(t.closest('.del-col-btn')){var ci=parseInt(t.closest('.del-col-btn').dataset.ci);self.delCol(ci)}
});
document.addEventListener('contextmenu',function(e){
e.preventDefault();
var p=e.target.closest('.ed-proj');
if(p){self.showCtx(e.clientX,e.clientY,p.dataset.id);return}
var lh=e.target.closest('.ed-hd');
if(lh){self.showCtx(e.clientX,e.clientY,null);return}
var el=e.target.closest('.ed-el');
if(el){self.showElCtx(e.clientX,e.clientY,parseInt(el.dataset.idx))}
});
document.addEventListener('click',function(e){
if(e.target.closest('#ed-panel')||e.target.closest('.ed-menu'))return;
if(self.moveMode&&!e.target.closest('.ed-ph')){self.moveMode=false;self.hiSel();return}
var col=e.target.closest('.ed-col');
if(col){self.multiSel=[];self.selCol(parseInt(col.dataset.ei),parseInt(col.dataset.ci));return}
var el=e.target.closest('.ed-el');
if(el){self.selEl(parseInt(el.dataset.idx),e.shiftKey)}
});
document.getElementById('edList').onclick=function(){self.list=!self.list;self.renderL()};
document.getElementById('edUndo').onclick=function(){self.undo()};
document.getElementById('edRedo').onclick=function(){self.redo()};
document.getElementById('edCopy').onclick=function(){self.copy()};
document.getElementById('edSave').onclick=function(){self.download()};
document.getElementById('edPc').onclick=function(){self.setDevice('pc')};
document.getElementById('edMobile').onclick=function(){self.setDevice('mobile')};
document.getElementById('edPreview').onclick=function(){self.togglePreview()};
window.addEventListener('message',function(e){if(e.data&&e.data.t==='exitPreview'&&self.preview)self.togglePreview()});
document.addEventListener('keydown',function(e){if(e.key==='Escape'&&self.preview){self.togglePreview();return}if(e.ctrlKey&&e.key==='z'){e.preventDefault();self.undo()}else if(e.ctrlKey&&e.key==='y'){e.preventDefault();self.redo()}else if(e.ctrlKey&&e.key==='s'){e.preventDefault();self.copy()}});
document.addEventListener('dragstart',function(e){var dr=e.target.closest('.ed-drag');if(dr&&dr.dataset.type){self.dragType=dr.dataset.type;e.dataTransfer.effectAllowed='copy'}});
document.addEventListener('dragover',function(e){if(!self.dragType)return;var mc=document.querySelector('.modal-content');if(!mc||!mc.contains(e.target))return;e.preventDefault();e.dataTransfer.dropEffect='copy';document.querySelectorAll('.ed-drop').forEach(function(d){d.remove()});var els=mc.querySelectorAll('.ed-el');var inserted=false;for(var i=0;i<els.length;i++){var rect=els[i].getBoundingClientRect();if(e.clientY<rect.top+rect.height/2){var dp=document.createElement('div');dp.className='ed-drop';dp.dataset.pos=i;els[i].parentNode.insertBefore(dp,els[i]);inserted=true;break}}if(!inserted){var dp=document.createElement('div');dp.className='ed-drop';dp.dataset.pos=els.length;mc.appendChild(dp)}});
document.addEventListener('drop',function(e){if(!self.dragType)return;var dp=e.target.closest('.ed-drop');if(dp){e.preventDefault();self.addAt(self.dragType,parseInt(dp.dataset.pos))}self.dragType=null;document.querySelectorAll('.ed-drop').forEach(function(d){d.remove()})});
document.addEventListener('dragend',function(){self.dragType=null;document.querySelectorAll('.ed-drop').forEach(function(d){d.remove()})});
document.getElementById('root').style.marginRight='280px';
setInterval(function(){if(self.cur)localStorage.setItem('d_pj',JSON.stringify(self.pj))},5000);
},
save:function(noHist){var self=this;localStorage.setItem('d_pj',JSON.stringify(this.pj));localStorage.setItem('d_cur',this.cur||'');if(!noHist&&this.cur){var s=JSON.stringify(this.pj[this.cur].data);if(this.hist.length===0||this.hist[this.histIdx]!==s){this.hist=this.hist.slice(0,this.histIdx+1);this.hist.push(s);this.histIdx=this.hist.length-1;if(this.hist.length>50){this.hist.shift();this.histIdx--}}}if(this.cur&&window.modalRender){window.modalRender(this.pj[this.cur].data);setTimeout(function(){self.hiSel()},0)}},
undo:function(){if(this.histIdx>0&&this.cur){this.histIdx--;this.pj[this.cur].data=JSON.parse(this.hist[this.histIdx]);this.sel=null;this.rowSel=null;localStorage.setItem('d_pj',JSON.stringify(this.pj));this.render();if(window.modalRender)window.modalRender(this.pj[this.cur].data)}},
redo:function(){if(this.histIdx<this.hist.length-1&&this.cur){this.histIdx++;this.pj[this.cur].data=JSON.parse(this.hist[this.histIdx]);this.sel=null;this.rowSel=null;localStorage.setItem('d_pj',JSON.stringify(this.pj));this.render();if(window.modalRender)window.modalRender(this.pj[this.cur].data)}},
newP:function(name){var id='p'+Date.now();this.pj[id]={name:name||'新项目',data:{global:{bgColor:'050505',defModalBg:'0d0d0d',defBtnBg:'166d3b',defTextColor:'888888',defBtnColor:'ffffff'},pages:[{title:'页面1',elements:[]}]}};this.cur=id;this.pg=0;this.sel=null;this.save();this.render()},
delP:function(id){if(!id||!this.pj[id])return;delete this.pj[id];if(this.cur===id){this.cur=Object.keys(this.pj)[0]||null;this.pg=0;this.sel=null}this.save();this.render()},
renP:function(id,name){if(id&&this.pj[id]){this.pj[id].name=name;this.save();this.renderL()}},
loadP:function(id){if(this.pj[id]){this.cur=id;this.pg=0;this.sel=null;this.tab=0;this.save();this.render()}},
newPg:function(){if(!this.cur)return;var d=this.pj[this.cur].data;d.pages.push({title:'页面'+(d.pages.length+1),elements:[]});this.pg=d.pages.length-1;this.sel=null;this.save();this.renderR()},
delPg:function(){if(!this.cur)return;var d=this.pj[this.cur].data;if(d.pages.length<=1)return;d.pages.splice(this.pg,1);if(this.pg>=d.pages.length)this.pg=d.pages.length-1;this.sel=null;this.save();this.renderR()},
add:function(type){if(!this.cur)return;var d=this.pj[this.cur].data;if(!d||!d.pages||!d.pages[this.pg])return;var els=d.pages[this.pg].elements;var el={type:type};var cfg=this.cfg[type];if(cfg&&cfg.props)Object.keys(cfg.props).forEach(function(k){if(cfg.props[k].v!==undefined)el[k]=cfg.props[k].v});if(type==='row'){var ratio=(el.ratio||'1:1').split(':').map(function(x){return parseInt(x)||1});el.cols=ratio.map(function(){return{type:'text',value:'文本'}})}els.push(el);this.sel=els.length-1;this.tab=2;this.save();this.renderR()},
addAt:function(type,pos){if(!this.cur)return;var d=this.pj[this.cur].data;if(!d||!d.pages||!d.pages[this.pg])return;var els=d.pages[this.pg].elements;var el={type:type};var cfg=this.cfg[type];if(cfg&&cfg.props)Object.keys(cfg.props).forEach(function(k){if(cfg.props[k].v!==undefined)el[k]=cfg.props[k].v});if(type==='row'){el.ratio=[1,1];el.cols=[{type:'text',value:'文本'},{type:'text',value:'文本'}]}els.splice(pos,0,el);this.sel=pos;this.tab=2;this.save();this.renderR()},
del:function(){if(!this.cur||this.sel===null)return;var pg=this.pj[this.cur].data.pages[this.pg];if(!pg||!pg.elements)return;pg.elements.splice(this.sel,1);this.sel=null;this.save();this.renderR()},
addCol:function(){if(!this.cur||this.sel===null)return;var pg=this.pj[this.cur].data.pages[this.pg];if(!pg||!pg.elements)return;var el=pg.elements[this.sel];if(!el||el.type!=='row')return;var ratio=Array.isArray(el.ratio)?el.ratio:(el.ratio||'1').split(':').map(function(x){return parseInt(x)||1});ratio.push(1);el.ratio=ratio;if(!el.cols)el.cols=[];el.cols.push({type:'text',value:'文本'});this.save();this.renderR()},
delCol:function(ci){if(!this.cur||this.sel===null)return;var pg=this.pj[this.cur].data.pages[this.pg];if(!pg||!pg.elements)return;var el=pg.elements[this.sel];if(!el||el.type!=='row'||!el.cols||el.cols.length<=1)return;var ratio=Array.isArray(el.ratio)?el.ratio:(el.ratio||'1').split(':').map(function(x){return parseInt(x)||1});ratio.splice(ci,1);el.ratio=ratio;el.cols.splice(ci,1);if(this.rowSel===ci)this.rowSel=null;else if(this.rowSel>ci)this.rowSel--;this.save();this.renderR()},
clearCol:function(){if(!this.cur||this.sel===null||this.rowSel===null)return;var pg=this.pj[this.cur].data.pages[this.pg];if(!pg||!pg.elements)return;var el=pg.elements[this.sel];if(!el||el.type!=='row'||!el.cols||!el.cols[this.rowSel])return;el.cols[this.rowSel]={type:'text',value:'文本'};this.save();this.renderR()},
showCtx:function(x,y,id){var old=document.querySelector('.ed-ctx');if(old)old.remove();var m=document.createElement('div');m.className='ed-ctx';m.style.left=x+'px';m.style.top=y+'px';var self=this;if(id)m.innerHTML='<div data-a="ren">重命名</div><div data-a="del">删除</div>';else m.innerHTML='<div data-a="new">新建项目</div>';m.onclick=function(e){var a=e.target.dataset.a;if(a==='new'){var n=prompt('项目名称','新项目');if(n)self.newP(n)}if(a==='ren'){var n=prompt('新名称',self.pj[id].name);if(n)self.renP(id,n)}if(a==='del'){if(confirm('确定删除?'))self.delP(id)}m.remove()};document.body.appendChild(m);setTimeout(function(){document.addEventListener('click',function h(){m.remove();document.removeEventListener('click',h)})},10)},
selEl:function(idx,shift){if(shift){var i=this.multiSel.indexOf(idx);if(i===-1)this.multiSel.push(idx);else this.multiSel.splice(i,1);this.hiSel();return}this.multiSel=[];this.sel=idx;this.rowSel=null;this.tab=2;this.renderR();this.hiSel()},
selCol:function(ei,ci){this.sel=ei;this.rowSel=ci;this.tab=2;this.renderR();this.hiSel()},
showElCtx:function(x,y,idx){var old=document.querySelector('.ed-ctx');if(old)old.remove();var m=document.createElement('div');m.className='ed-ctx';m.style.left=x+'px';m.style.top=y+'px';var self=this,h='',sels=this.multiSel.length?this.multiSel:[idx];if(sels.length>1){var pg=this.pj[this.cur].data.pages[this.pg];if(!pg||!pg.elements){m.remove();return}var types=sels.map(function(i){return pg.elements[i]?.type});var allBtn=types.every(function(t){return t==='btn'});var allRow=types.every(function(t){return t==='row'});if(allBtn){h+='<div data-a="lockW">锁定所有按钮宽度</div>';h+='<div data-a="lockH">锁定所有按钮高度</div>';h+='<div data-a="lockS">锁定所有按钮尺寸</div>'}if(allRow)h+='<div data-a="lockRH">锁定所有行高</div>';h+='<div data-a="delAll">'+this.icon('trash')+' 删除所有</div>'}else h='<div data-a="del">'+this.icon('trash')+' 删除</div>';m.innerHTML=h;m.onclick=function(e){var a=e.target.closest('[data-a]')?.dataset.a;if(a==='del'){self.sel=idx;self.del()}else if(a==='delAll')self.delMulti();else if(a==='lockW')self.lockMulti('width');else if(a==='lockH')self.lockMulti('height');else if(a==='lockS')self.lockMulti('size');else if(a==='lockRH')self.lockMulti('rowHeight');m.remove()};document.body.appendChild(m);setTimeout(function(){document.addEventListener('click',function h(){m.remove();document.removeEventListener('click',h)})},10)},
hiSel:function(){var self=this;document.querySelectorAll('.ed-move').forEach(function(m){m.remove()});document.querySelectorAll('.ed-ph').forEach(function(p){p.remove()});document.querySelectorAll('.ed-el').forEach(function(el){var i=parseInt(el.dataset.idx);var isSel=(i===self.sel&&self.rowSel===null)||self.multiSel.indexOf(i)!==-1;el.classList.toggle('ed-sel',isSel);if(i===self.sel&&self.rowSel===null&&!self.moveMode){el.style.position='relative';var mv=document.createElement('div');mv.className='ed-move';mv.innerHTML=self.icon('move');mv.onclick=function(e){e.stopPropagation();self.startMove()};el.appendChild(mv)}});document.querySelectorAll('.ed-col').forEach(function(c){c.classList.toggle('ed-sel',parseInt(c.dataset.ei)===self.sel&&parseInt(c.dataset.ci)===self.rowSel)})},
startMove:function(){var self=this;this.moveMode=true;document.querySelectorAll('.ed-move').forEach(function(m){m.remove()});document.querySelectorAll('.ed-el').forEach(function(el){var i=parseInt(el.dataset.idx);if(i===self.sel)return;var ph=document.createElement('div');ph.className='ed-ph';ph.dataset.pos=i;el.parentNode.insertBefore(ph,el);ph.onclick=function(e){e.stopPropagation();self.moveTo(i)}});var last=document.querySelector('.ed-el:last-child');if(last){var pg=this.pj[this.cur].data.pages[this.pg];var ph=document.createElement('div');ph.className='ed-ph';ph.dataset.pos=pg.elements.length;last.parentNode.appendChild(ph);ph.onclick=function(e){e.stopPropagation();self.moveTo(pg.elements.length)}}},
moveTo:function(pos){if(!this.cur||this.sel===null)return;var pg=this.pj[this.cur].data.pages[this.pg];if(!pg||!pg.elements)return;var el=pg.elements.splice(this.sel,1)[0];if(pos>this.sel)pos--;pg.elements.splice(pos,0,el);this.sel=pos;this.moveMode=false;this.save();this.hiSel()},
render:function(){this.renderL();this.renderR()},
renderL:function(){var h='<div class="ed-hd">项目</div>';var self=this;Object.keys(this.pj).forEach(function(id){h+='<div class="ed-proj'+(self.cur===id?' on':'')+'" data-id="'+id+'">'+U.esc(self.pj[id].name)+'</div>'});if(this.cur){var d=this.pj[this.cur].data;if(d&&d.pages){h+='<div class="ed-hd" style="margin-top:12px">页面</div>';d.pages.forEach(function(pg,i){h+='<div class="ed-proj'+(self.pg===i?' on':'')+'" data-pg="'+i+'">'+U.esc(pg.title||'页面'+(i+1))+'</div>'})}}document.getElementById('ed-list').innerHTML=h;document.getElementById('ed-list').classList.toggle('open',this.list);document.querySelector('.ed-menu').classList.toggle('shifted',this.list)},
renderR:function(){var p=document.getElementById('ed-body');document.querySelectorAll('.ed-tab').forEach(function(t){t.classList.toggle('on',parseInt(t.dataset.t)===this.tab)},this);if(this.tab===0)p.innerHTML=this.renderWin();else if(this.tab===1)p.innerHTML=this.renderMod();else if(this.tab===2)p.innerHTML=this.renderStyle();else if(this.tab===3)p.innerHTML=this.renderLock();else if(this.tab===4)p.innerHTML=this.renderChat();else p.innerHTML=this.renderSys();this.bindR()},
renderWin:function(){var h='<div class="ed-sec"><button class="ed-btn" id="newModalBtn">'+this.icon('plus')+' 新建Modal</button></div>';if(!this.cur)return h;var d=this.pj[this.cur].data;if(!d||!d.pages)return h;var g=d.global||{},pg=d.pages[this.pg]||{};h+='<div class="ed-sec"><div class="ed-title">页面管理</div>';h+='<button class="ed-btn sm" id="newPgBtn">'+this.icon('plus')+' 新增页面</button>';h+='<button class="ed-btn sm del" id="delPgBtn">'+this.icon('trash')+' 删除当前页</button></div>';h+='<div class="ed-sec"><div class="ed-title">当前页面</div>';var pgCfg=this.cfg.page.props,self=this;['title','prevPage','prevAnim','nextPage','nextAnim','modalBg','modalBgImg','modalOpacity','modalBlur'].forEach(function(k){h+=self.ctrl(k,pgCfg[k],pg[k],'pg')});h+='</div>';h+='<div class="ed-sec"><div class="ed-title">全局样式</div>';var gCfg=this.cfg.global.props;Object.keys(gCfg).forEach(function(k){h+=self.ctrl(k,gCfg[k],g[k],'g')});h+='</div>';return h},
renderMod:function(){var h='<div class="ed-sec"><div class="ed-title">拖拽添加元素</div>';var self=this;['text','btn','image','input','select','switch','collapse','row'].forEach(function(t){h+='<div class="ed-drag" draggable="true" data-type="'+t+'">'+self.icon(t)+' '+self.cfg[t].name+'</div>'});h+='</div>';return h},
renderStyle:function(){if(!this.cur||this.sel===null)return'<div class="ed-sec"><div class="ed-empty">点击元素进行编辑</div></div>';var d=this.pj[this.cur].data;if(!d||!d.pages||!d.pages[this.pg])return'';var el=d.pages[this.pg].elements[this.sel];if(!el)return'';var self=this;if(el.type==='row'&&this.rowSel!==null&&el.cols&&el.cols[this.rowSel]){var col=el.cols[this.rowSel];var colCfg=this.cfg[col.type];if(!colCfg)return'';var ratio=Array.isArray(el.ratio)?el.ratio:(el.ratio||'1').split(':').map(function(x){return parseInt(x)||1});var h='<div class="ed-sec"><div class="ed-title">列'+(this.rowSel+1)+' - '+colCfg.name+' <button class="back-row-btn" style="float:right;background:none;border:none;color:#888;cursor:pointer">返回行</button></div>';h+='<div class="ed-row"><label>宽度权重</label><input data-k="ratio" data-ci="'+this.rowSel+'" value="'+ratio[this.rowSel]+'"></div>';Object.keys(colCfg.props).forEach(function(k){var prop=colCfg.props[k],v=col[k];if(col.type==='btn'&&(k==='textSize'||k==='textColor'||k==='textBold'))return;if(col.type==='btn'&&k==='sysEffect'&&d.sys&&d.sys.unload)return;if(k==='options'&&Array.isArray(v))v=v.join('\n');h+=self.ctrl(k,prop,v,'col',self.rowSel)});if(col.type==='btn')h+=self.ctrlFold('按钮文本',col,'text','col',self.rowSel);if(col.type==='input')h+=self.ctrlFold('输入框标题',col,'title','col',self.rowSel);if(col.type==='select')h+=self.ctrlFold('下拉框标题',col,'title','col',self.rowSel);if(col.type==='switch')h+=self.ctrlFold('滑块标题',col,'title','col',self.rowSel);h+='<button class="ed-btn del" id="delColElBtn">'+this.icon('trash')+' 清空此列</button></div>';return h}var m=this.cfg[el.type];if(!m)return'';var h='<div class="ed-sec"><div class="ed-title">'+m.name+'</div>';if(el.type==='row'){h+=this.ctrl('valign',m.props.valign,el.valign,'el');h+=this.ctrl('heightBind',m.props.heightBind,el.heightBind,'el');h+='<div class="ed-title" style="margin-top:12px">列管理</div>';var ratio=Array.isArray(el.ratio)?el.ratio:(el.ratio||'1').split(':').map(function(x){return parseInt(x)||1});h+='<div class="ed-row"><label>列数</label><div style="display:flex;gap:6px;align-items:center"><span>'+ratio.length+'列</span><button class="add-col-btn ed-btn sm" style="margin:0;width:auto;padding:6px 12px">'+this.icon('plus')+' 添加列</button></div></div>';(el.cols||[]).forEach(function(col,ci){h+='<div class="ed-row" style="display:flex;justify-content:space-between;align-items:center;gap:8px">';h+='<span style="white-space:nowrap">列'+(ci+1)+' - '+self.cfg[col.type].name+'</span><input class="col-weight-inp" data-ci="'+ci+'" value="'+ratio[ci]+'" style="width:50px;padding:4px;background:#0d0d0d;border:1px solid #333;border-radius:4px;color:#fff;text-align:center">';if((el.cols||[]).length>1)h+='<button class="del-col-btn" data-ci="'+ci+'" style="background:none;border:none;color:#ff6b6b;cursor:pointer;flex-shrink:0">'+self.icon('trash')+'</button>';h+='</div>'})}else if(el.type==='collapse'){Object.keys(m.props).forEach(function(k){if(k==='titleSize'||k==='titleColor'||k==='titleBold')return;h+=self.ctrl(k,m.props[k],el[k],'el')});h+=self.ctrlFold('折叠项标题',el,'title','el')}else{Object.keys(m.props).forEach(function(k){if(el.type==='btn'){if(k==='clickTarget'&&el.clickAction!=='jumpModal')return;if(k==='message'&&el.clickAction!=='message')return;if(k==='sysEffect'&&d.sys&&d.sys.unload)return;if(k==='afterClick'&&el.repeatable!==false)return;if(k==='disabledStyle'&&el.afterClick!=='disable')return;if(k==='logicMax'&&!el.logicGroup)return;if(k==='radius'&&el.shape!=='rounded')return;if(k==='hexWidth'&&el.shape!=='hexagon')return;if(k==='textSize'||k==='textColor'||k==='textBold')return}if(el.type==='image'){if(k==='clickTarget'&&el.clickAction!=='jumpModal')return;if(k==='galleryUrls'&&el.clickAction!=='gallery')return}var prop=m.props[k],v=el[k];if(k==='options'&&Array.isArray(v))v=v.join('\n');if(k==='ratio'&&Array.isArray(v))v=v.join(':');h+=self.ctrl(k,prop,v,'el')});if(el.type==='btn')h+=self.ctrlFold('按钮文本',el,'text','el');if(el.type==='input')h+=self.ctrlFold('输入框标题',el,'title','el');if(el.type==='select')h+=self.ctrlFold('下拉框标题',el,'title','el');if(el.type==='switch')h+=self.ctrlFold('滑块标题',el,'title','el')}h+='<button class="ed-btn del" id="delElBtn">'+this.icon('trash')+' 删除元素</button></div>';return h},
renderLock:function(){if(!this.cur)return'<div class="ed-sec"><div class="ed-empty">无项目</div></div>';var d=this.pj[this.cur].data,self=this;if(!d.groups)d.groups={style:[],logic:[],row:[]};if(!d.groups.row)d.groups.row=[];var h='<div class="ed-sec"><div class="ed-title">按钮格式组</div><button class="ed-btn sm add-grp-btn" data-g="style">'+this.icon('plus')+' 新建格式组</button>';(d.groups.style||[]).forEach(function(g,i){h+='<div class="ed-row" style="display:flex;justify-content:space-between;align-items:center"><span>'+U.esc(g)+'</span><button class="del-grp-btn" data-g="style" data-i="'+i+'" style="background:none;border:none;color:#ff6b6b;cursor:pointer">'+self.icon('trash')+'</button></div>'});h+='</div>';h+='<div class="ed-sec"><div class="ed-title">按钮逻辑组</div><button class="ed-btn sm add-grp-btn" data-g="logic">'+this.icon('plus')+' 新建逻辑组</button>';(d.groups.logic||[]).forEach(function(g,i){h+='<div class="ed-row" style="display:flex;justify-content:space-between;align-items:center"><span>'+U.esc(g)+'</span><button class="del-grp-btn" data-g="logic" data-i="'+i+'" style="background:none;border:none;color:#ff6b6b;cursor:pointer">'+self.icon('trash')+'</button></div>'});h+='</div>';h+='<div class="ed-sec"><div class="ed-title">多列格式组</div><button class="ed-btn sm add-grp-btn" data-g="row">'+this.icon('plus')+' 新建多列组</button>';(d.groups.row||[]).forEach(function(g,i){h+='<div class="ed-row" style="display:flex;justify-content:space-between;align-items:center"><span>'+U.esc(g)+'</span><button class="del-grp-btn" data-g="row" data-i="'+i+'" style="background:none;border:none;color:#ff6b6b;cursor:pointer">'+self.icon('trash')+'</button></div>'});h+='</div>';return h},
addGrp:function(t){if(!this.cur)return;var d=this.pj[this.cur].data;if(!d.groups)d.groups={style:[],logic:[],row:[]};var labels={style:'格式组名称',logic:'逻辑组名称',row:'多列组名称'};var n=prompt(labels[t]||'组名称','组'+((d.groups[t]||[]).length+1));if(!n)return;if(!d.groups[t])d.groups[t]=[];d.groups[t].push(n);this.save();this.renderR()},
delGrp:function(t,i){if(!this.cur)return;var d=this.pj[this.cur].data;if(!d.groups||!d.groups[t])return;d.groups[t].splice(i,1);this.save();this.renderR()},
delMulti:function(){if(!this.cur||!this.multiSel.length)return;var pg=this.pj[this.cur].data.pages[this.pg];if(!pg||!pg.elements)return;this.multiSel.sort(function(a,b){return b-a}).forEach(function(i){pg.elements.splice(i,1)});this.multiSel=[];this.sel=null;this.save();this.renderR()},
lockMulti:function(type){if(!this.cur||!this.multiSel.length)return;var d=this.pj[this.cur].data,pg=d.pages[this.pg];if(!pg||!pg.elements)return;if(!d.locks)d.locks={btns:[],rows:[]};var self=this;if(type==='rowHeight'){var ids=this.multiSel.filter(function(i){return pg.elements[i]?.type==='row'});if(!ids.length)return;var h=prompt('输入行高(px)','100');if(!h)return;d.locks.rows.push({ids:ids,height:parseInt(h)||100});ids.forEach(function(i){pg.elements[i].lockHeight=parseInt(h)||100})}else{var ids=this.multiSel.filter(function(i){return pg.elements[i]?.type==='btn'});if(!ids.length)return;d.locks.btns.push({ids:ids,type:type});ids.forEach(function(i){if(type==='width'||type==='size')pg.elements[i].lockWidth=true;if(type==='height'||type==='size')pg.elements[i].lockHeight=true})}this.multiSel=[];this.save();this.renderR()},
unlock:function(t,i){if(!this.cur)return;var d=this.pj[this.cur].data,pg=d.pages[this.pg];if(!d.locks)return;if(t==='btn'&&d.locks.btns[i]){var lk=d.locks.btns[i];lk.ids.forEach(function(idx){if(pg.elements[idx]){pg.elements[idx].lockWidth=false;pg.elements[idx].lockHeight=false}});d.locks.btns.splice(i,1)}else if(t==='row'&&d.locks.rows[i]){var lk=d.locks.rows[i];lk.ids.forEach(function(idx){if(pg.elements[idx])pg.elements[idx].lockHeight=null});d.locks.rows.splice(i,1)}this.save();this.renderR()},
ctrl:function(k,prop,v,scope,ci){if(!prop)return'';var dv=prop.v;if(v===undefined||v===null||v==='')v=dv;var ciAttr=ci!==undefined?' data-ci="'+ci+'"':'';var self=this;var h='<div class="ed-row"><label>'+prop.d+'</label>';if(prop.t==='input')h+='<input data-k="'+k+'" data-s="'+scope+'"'+ciAttr+' value="'+U.esc(String(v||''))+'">';else if(prop.t==='textarea')h+='<textarea data-k="'+k+'" data-s="'+scope+'"'+ciAttr+' rows="3">'+U.esc(String(v||''))+'</textarea>';else if(prop.t==='num')h+='<input type="number" data-k="'+k+'" data-s="'+scope+'"'+ciAttr+' value="'+(v||1)+'" min="1" style="width:60px">';else if(prop.t==='color'){var cv=v||dv||'000000';h+='<div class="ed-color"><input type="color" data-k="'+k+'" data-s="'+scope+'"'+ciAttr+' value="#'+cv+'"><input data-k="'+k+'" data-s="'+scope+'"'+ciAttr+' value="'+U.esc(cv)+'" class="ed-ctxt"></div>'}else if(prop.t==='grp'){var d=this.pj[this.cur].data,grps=d.groups&&d.groups[prop.g]||[];h+='<select data-k="'+k+'" data-s="'+scope+'"'+ciAttr+'><option value=""'+((!v)?' selected':'')+'>无</option>';grps.forEach(function(g){h+='<option value="'+U.esc(g)+'"'+(v===g?' selected':'')+'>'+U.esc(g)+'</option>'});h+='</select>'}else if(prop.t==='select'){h+='<select data-k="'+k+'" data-s="'+scope+'"'+ciAttr+'>';(prop.r||[]).forEach(function(o){var ov=o.v!==undefined?o.v:o,ol=o.l||o;h+='<option value="'+ov+'"'+(String(ov)===String(v)?' selected':'')+'>'+ol+'</option>'});h+='</select>'}else if(prop.t==='page'){h+='<select data-k="'+k+'" data-s="'+scope+'"'+ciAttr+'><option value="0"'+(!v||v===0?' selected':'')+'>无</option>';var pgs=this.cur?this.pj[this.cur].data.pages.length:0;for(var i=1;i<=pgs;i++)h+='<option value="'+i+'"'+(v===i?' selected':'')+'>第'+i+'页</option>';h+='</select>'}else if(prop.t==='slider'){var rg=(prop.r||'0-100').split('-'),dv=v!==undefined&&v!==''?v:(prop.v!==undefined?prop.v:rg[0]);h+='<div class="ed-slider"><input type="range" data-k="'+k+'" data-s="'+scope+'"'+ciAttr+' min="'+rg[0]+'" max="'+rg[1]+'" value="'+dv+'"><span class="ed-v">'+dv+'</span></div>'}else if(prop.t==='toggle')return'<div class="ed-row"><div class="ed-toggle"><span style="color:#666;font-size:11px">'+prop.d+'</span><div class="ed-toggle-sw'+(v?' on':'')+'" data-k="'+k+'" data-s="'+scope+'"'+ciAttr+'></div></div></div>';else if(prop.t==='upload'){h+='<div class="ed-up">';if(v)h+='<img src="https://sexyai.top'+v+'" style="max-width:100%;max-height:80px;border-radius:4px;margin-bottom:4px"><br>';h+='<input type="file" data-k="'+k+'" data-s="'+scope+'"'+ciAttr+' accept="image/*,video/*" style="display:none"><button class="ed-btn sm upload-btn" data-k="'+k+'">'+(v?'更换':'上传')+'</button>';if(v)h+='<button class="ed-btn sm del clear-btn" data-k="'+k+'" data-s="'+scope+'"'+ciAttr+' style="margin-left:4px">清除</button>';h+='</div>'}else if(prop.t==='gallery'){h+='<div class="ed-gallery" data-k="'+k+'" data-s="'+scope+'"'+ciAttr+'>';var urls=v||[];urls.forEach(function(u,gi){h+='<div style="display:flex;gap:4px;margin-bottom:4px;align-items:center"><input data-gi="'+gi+'" value="'+U.esc(u)+'" style="flex:1"><button class="gallery-del" data-gi="'+gi+'" style="background:none;border:none;color:#ff6b6b;cursor:pointer">'+self.icon('trash')+'</button></div>'});h+='<button class="ed-btn sm gallery-add" data-k="'+k+'" data-s="'+scope+'"'+ciAttr+'>'+self.icon('plus')+' 添加图片</button></div>'}h+='</div>';return h},
ctrlFold:function(title,el,prefix,scope,ci){var self=this,h='<div class="ed-fold"><div class="ed-fold-hd"><span>'+title+'</span><span class="arr">▶</span></div><div class="ed-fold-bd">';var props=this.textProps;Object.keys(props).forEach(function(k){var pk=prefix+k.charAt(0).toUpperCase()+k.slice(1);var prop=Object.assign({},props[k]);if(k==='font')prop.r=self.fonts;h+=self.ctrl(pk,prop,el[pk],scope,ci)});return h+'</div></div>'},
bindR:function(){var self=this;var nb=document.getElementById('newModalBtn');if(nb)nb.onclick=function(){var n=prompt('项目名称','新项目');if(n)self.newP(n)};var db=document.getElementById('delElBtn');if(db)db.onclick=function(){self.del()};var dcb=document.getElementById('delColElBtn');if(dcb)dcb.onclick=function(){self.clearCol()};var brb=document.querySelector('.back-row-btn');if(brb)brb.onclick=function(){self.rowSel=null;self.renderR()};document.querySelectorAll('.unlock-btn').forEach(function(b){b.onclick=function(){self.unlock(b.dataset.t,parseInt(b.dataset.i))}});document.querySelectorAll('.add-grp-btn').forEach(function(b){b.onclick=function(){self.addGrp(b.dataset.g)}});document.querySelectorAll('.del-grp-btn').forEach(function(b){b.onclick=function(){self.delGrp(b.dataset.g,parseInt(b.dataset.i))}});document.querySelectorAll('.ed-fold-hd').forEach(function(hd){hd.onclick=function(){hd.classList.toggle('open');var bd=hd.nextElementSibling;if(bd)bd.classList.toggle('open')}});document.querySelectorAll('.ed-toggle-sw').forEach(function(sw){sw.onclick=function(){var on=sw.classList.toggle('on');self.setProp(sw.dataset.k,on,sw.dataset.s,sw.dataset.ci!==undefined?parseInt(sw.dataset.ci):null);self.renderR()}});document.querySelectorAll('.upload-btn').forEach(function(b){b.onclick=function(){var inp=b.parentElement.querySelector('input[type=file]');if(inp)inp.click()}});document.querySelectorAll('.clear-btn').forEach(function(b){b.onclick=function(){self.setProp(b.dataset.k,'',b.dataset.s,b.dataset.ci!==undefined?parseInt(b.dataset.ci):null)}});document.querySelectorAll('.col-weight-inp').forEach(function(inp){inp.oninput=function(){var ci=parseInt(inp.dataset.ci);self.setColRatio(ci,parseInt(inp.value)||1)}});document.querySelectorAll('.gallery-add').forEach(function(b){b.onclick=function(){var k=b.dataset.k,s=b.dataset.s,ci=b.dataset.ci!==undefined?parseInt(b.dataset.ci):null;var el=self.pj[self.cur].data.pages[self.pg].elements[self.sel];var urls=el[k]||[];urls.push('');el[k]=urls;self.save();self.renderR()}});document.querySelectorAll('.gallery-del').forEach(function(b){b.onclick=function(){var gi=parseInt(b.dataset.gi),g=b.closest('.ed-gallery'),k=g.dataset.k;var el=self.pj[self.cur].data.pages[self.pg].elements[self.sel];var urls=el[k]||[];urls.splice(gi,1);el[k]=urls;self.save();self.renderR()}});document.querySelectorAll('.ed-gallery input[data-gi]').forEach(function(inp){inp.oninput=function(){var gi=parseInt(inp.dataset.gi),g=inp.closest('.ed-gallery'),k=g.dataset.k;var el=self.pj[self.cur].data.pages[self.pg].elements[self.sel];var urls=el[k]||[];urls[gi]=inp.value;el[k]=urls;self.save()}});document.querySelectorAll('[data-k]').forEach(function(c){if(c.classList.contains('ed-toggle-sw'))return;var k=c.dataset.k,s=c.dataset.s,ci=c.dataset.ci!==undefined?parseInt(c.dataset.ci):null;if(c.type==='file'){c.onchange=function(){var f=c.files[0];if(!f)return;var btn=c.parentElement.querySelector('.upload-btn');if(btn)btn.textContent='上传中...';var fd=new FormData();fd.append('suffix',f.name.split('.').pop());fd.append('file',f,'file-'+Date.now());fetch('https://sexyai.top/api/file/upload',{method:'POST',body:fd}).then(function(r){return r.json()}).then(function(d){if(d.data&&d.data[0]){self.setProp(k,d.data[0],s,ci)}else if(btn)btn.textContent='失败'}).catch(function(){if(btn)btn.textContent='失败'})}}else if(c.type==='color'){c.oninput=function(){var hex=c.value.replace('#','');self.setProp(k,hex,s,ci);var txt=c.parentElement.querySelector('.ed-ctxt');if(txt)txt.value=hex}}else{c.oninput=c.onchange=function(){var v=c.type==='checkbox'?c.checked:c.type==='range'?parseInt(c.value):c.value;if(c.tagName==='SELECT'&&(k==='prevPage'||k==='nextPage'||k==='clickTarget'))v=parseInt(v);if(c.type==='range')c.parentElement.querySelector('.ed-v').textContent=v;if(c.classList.contains('ed-ctxt')){var cp=c.parentElement.querySelector('input[type=color]');if(cp)cp.value='#'+v}if(k==='ratio'&&ci!==null){self.setColRatio(ci,parseInt(v)||1);return}self.setProp(k,v,s,ci);if(k==='clickAction'||k==='repeatable'||k==='afterClick'||k==='shape'||k==='logicGroup')self.renderR()}}})},
setColRatio:function(ci,v){if(!this.cur||this.sel===null)return;var el=this.pj[this.cur].data.pages[this.pg].elements[this.sel];var ratio=Array.isArray(el.ratio)?el.ratio:(el.ratio||'1').split(':').map(function(x){return parseInt(x)||1});ratio[ci]=v;el.ratio=ratio;this.save()},
setProp:function(k,v,scope,ci){if(!this.cur)return;var d=this.pj[this.cur].data;if(scope==='g')d.global[k]=v;else if(scope==='pg')d.pages[this.pg][k]=v;else if(scope==='col'&&ci!==null&&this.sel!==null){var el=d.pages[this.pg].elements[this.sel];if(el.cols&&el.cols[ci]){if(k==='options')v=v.split('\n').filter(function(x){return x.trim()});el.cols[ci][k]=v}}else if(scope==='el'&&this.sel!==null){var el=d.pages[this.pg].elements[this.sel];if(k==='options')v=v.split('\n').filter(function(x){return x.trim()});if(k==='ratio')v=v.split(':').map(function(x){return parseInt(x)||1});el[k]=v}this.save()},
exp:function(){if(!this.cur)return'';var d=this.pj[this.cur].data;var b64=btoa(unescape(encodeURIComponent(JSON.stringify(d))));return'['+(L.project||'MODAL')+':{{char}};;{{user}};;'+b64+']'},
copy:function(){var s=this.exp();if(!s)return;navigator.clipboard.writeText(s).then(function(){var t=document.createElement('div');t.className='ed-toast';t.textContent='已复制';document.body.appendChild(t);setTimeout(function(){t.remove()},2000)})},
download:function(){var s=this.exp();if(!s)return;var now=new Date();var ts=now.getFullYear()+('0'+(now.getMonth()+1)).slice(-2)+('0'+now.getDate()).slice(-2)+'-'+('0'+now.getHours()).slice(-2)+('0'+now.getMinutes()).slice(-2)+('0'+now.getSeconds()).slice(-2);var blob=new Blob([s],{type:'text/plain'});var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=(L.project||'MODAL')+'_'+ts+'.txt';a.click()},
setDevice:function(d){var pc=document.getElementById('edPc'),mb=document.getElementById('edMobile'),r=document.getElementById('root');pc.classList.toggle('on',d==='pc');mb.classList.toggle('on',d==='mobile');if(d==='pc'){r.style.width='';r.style.height='';r.style.margin=''}else{var h=window.innerHeight,w=Math.floor(h*9/19);r.style.width=w+'px';r.style.height=h+'px';r.style.margin='0 auto'}L.platform=d},
togglePreview:function(){this.preview=!this.preview;var p=document.getElementById('ed-panel'),l=document.getElementById('ed-list'),m=document.querySelector('.ed-menu'),r=document.getElementById('root');if(this.preview){p.style.display='none';l.style.display='none';m.style.display='none';r.style.marginRight='';L.edit=false;L.preview=true;if(window.modalRender)window.modalRender(this.pj[this.cur].data)}else{p.style.display='';l.style.display='';m.style.display='';r.style.marginRight='280px';L.edit=true;L.preview=false;if(window.modalRender)window.modalRender(this.pj[this.cur].data)}},
renderChat:function(){var self=this;var h='<div class="ed-chat"><div class="ed-chat-body" id="chatBody"></div><div class="ed-chat-input"><textarea id="chatInp" placeholder="输入消息..."></textarea></div><div class="ed-chat-btns"><button id="chatModel">'+(this.curModel?this.curModel.name:'选择模型')+'</button><button id="chatSend" class="primary">发送</button></div></div>';setTimeout(function(){var mb=document.getElementById('chatModel'),sb=document.getElementById('chatSend');if(mb)mb.onclick=function(){self.showModelModal()};if(sb)sb.onclick=function(){self.sendChat()}},0);return h},
fetchModels:function(cb){var self=this;fetch('https://sexyai.top/api/model/list',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'}).then(function(r){return r.json()}).then(function(d){if(d.code===200&&d.data){self.models=d.data;if(!self.curModel&&d.data.length)self.curModel=d.data[0];if(cb)cb()}}).catch(function(){})},
showModelModal:function(){var self=this,old=document.querySelector('.ed-modal');if(old)old.remove();if(!this.models.length){this.fetchModels(function(){self.showModelModal()});return}var m=document.createElement('div');m.className='ed-modal';var h='<div class="ed-modal-box"><div class="ed-modal-hd">选择模型</div><div class="ed-modal-bd">';this.models.forEach(function(md){h+='<div class="ed-model-item'+(self.curModel&&self.curModel.id===md.id?' on':'')+'" data-id="'+md.id+'"><div class="name">'+U.esc(md.name)+'</div><div class="desc">'+U.esc(md.description||'')+'</div></div>'});h+='</div></div>';m.innerHTML=h;m.onclick=function(e){if(e.target===m){m.remove();return}var it=e.target.closest('.ed-model-item');if(it){var id=parseInt(it.dataset.id);self.curModel=self.models.find(function(x){return x.id===id});m.remove();self.renderR()}};document.body.appendChild(m)},
sendChat:function(){var inp=document.getElementById('chatInp');if(!inp||!inp.value.trim())return;var msg=inp.value.trim();inp.value='';window.parent.postMessage({t:'done',msg:msg},'*')},
renderSys:function(){var self=this;if(!this.cur)return'<div class="ed-sec"><div class="ed-empty">无项目</div></div>';var d=this.pj[this.cur].data;if(!d.sys)d.sys={};var h='<div class="ed-sec"><div class="ed-title">系统设定</div>';h+='<div class="ed-row"><div class="ed-toggle"><span style="color:#666;font-size:11px">卸载父DOM</span><div class="ed-toggle-sw'+(d.sys.unload?' on':'')+'" id="sysUnload"></div></div></div>';h+='<div style="color:#666;font-size:10px;margin-top:-6px;margin-bottom:12px">开启后完全卸载父DOM，隐藏关闭按钮，禁用killer和hider</div>';h+='</div>';setTimeout(function(){var sw=document.getElementById('sysUnload');if(sw)sw.onclick=function(){var on=sw.classList.toggle('on');d.sys.unload=on;self.save()}},0);return h},
icon:function(n){var icons={plus:'<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',trash:'<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>',text:'<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>',btn:'<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="8" width="18" height="8" rx="2"/></svg>',image:'<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>',input:'<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="6" width="18" height="12" rx="2"/><line x1="7" y1="12" x2="7" y2="12.01"/></svg>',select:'<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="6" width="18" height="12" rx="2"/><path d="M15 10l2 2 2-2"/></svg>',switch:'<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="1" y="7" width="22" height="10" rx="5"/><circle cx="16" cy="12" r="3"/></svg>',collapse:'<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 12h6M12 9v6"/></svg>',row:'<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="3" width="7" height="18"/><rect x="14" y="3" width="7" height="18"/></svg>',move:'<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/></svg>'};return icons[n]||''}
};
(function(){
var d=null;
if(L.b64){try{d=JSON.parse(decodeURIComponent(escape(atob(L.b64))))}catch(e){try{d=JSON.parse(atob(L.b64))}catch(e2){}}}
if(!d||!d.pages||!d.pages.length)d={global:{bgColor:'050505',defModalBg:'0d0d0d',defBtnBg:'166d3b',defTextColor:'888888',defBtnColor:'ffffff'},pages:[{title:'页面1',elements:[]}]};
E.init(d);
})();
</script>
