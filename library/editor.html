<style>
#ed-panel {
	position: fixed;
	right: 0;
	top: 0;
	width: 280px;
	height: 100vh;
	background: #111;
	border-left: 1px solid #222;
	display: flex;
	flex-direction: column;
	z-index: 10000;
	font: 13px system-ui, sans-serif;
	opacity: 0;
	transform: translateY(20px);
	animation: edSlideUp 0.3s ease-out forwards;
}

#ed-list {
	position: fixed;
	left: 0;
	top: 0;
	width: 180px;
	height: 100vh;
	background: #111;
	border-right: 1px solid #222;
	display: flex;
	flex-direction: column;
	z-index: 10000;
	opacity: 0;
	transform: translateX(-100%);
	pointer-events: none;
	transition: opacity 0.3s, transform 0.3s;
}
#ed-list.open {
	opacity: 1;
	transform: translateX(0);
	pointer-events: auto;
}

@keyframes edSlideUp {
	to {
		opacity: 1;
		transform: translateY(0);
	}
}

.ed-menu, .ed-close {
	transition: left 0.3s;
}

.ed-menu.shifted, .ed-close.shifted {
	left: 200px;
}

.ed-close {
	position: fixed;
	left: 10px;
	top: 10px;
	z-index: 10001;
	background: #1a1a1a;
	border: none;
	border-radius: 8px;
	padding: 8px;
	color: #888;
	cursor: pointer;
}

.ed-close:hover {
	color: #fff;
}

.ed-ltabs {
	display: flex;
	border-bottom: 1px solid #222;
}

.ed-ltab {
	flex: 1;
	padding: 10px 8px;
	text-align: center;
	cursor: pointer;
	color: #666;
	font-size: 12px;
}

.ed-ltab:hover {
	color: #999;
}

.ed-ltab.on {
	color: #fff;
	background: #1a1a1a;
}

.ed-ladd {
	background: none;
	border: none;
	color: #666;
	cursor: pointer;
	padding: 8px;
	margin-left: auto;
}

.ed-ladd:hover {
	color: #fff;
}

.ed-lbody {
	flex: 1;
	overflow-y: auto;
	transition: opacity 0.15s, transform 0.15s;
}

.ed-lbody.slide-l, .ed-lbody.slide-r {
	opacity: 0;
	transform: translateY(20px);
}

.ed-tabs {
	display: flex;
	border-bottom: 1px solid #222;
	flex-shrink: 0;
}

.ed-tab {
	flex: 1;
	padding: 12px 8px;
	text-align: center;
	cursor: pointer;
	color: #666;
	transition: color 0.2s;
}

.ed-tab:hover {
	color: #999;
}

.ed-tab.on {
	color: #fff;
	border-bottom: 2px solid var(--btn);
}

.ed-hd {
	padding: 12px;
	font-weight: bold;
	border-bottom: 1px solid #222;
	color: #888;
}

.ed-proj {
	padding: 10px 12px;
	cursor: pointer;
	border-bottom: 1px solid #1a1a1a;
	transition: background 0.2s;
	color: #fff;
}

.ed-proj:hover {
	background: #1a1a1a;
}

.ed-proj.on {
	background: #1f1f1f;
	color: var(--btn);
}

#ed-body {
	flex: 1;
	overflow-y: scroll;
	padding: 12px;
	transition: opacity 0.15s, transform 0.15s;
	scrollbar-width: none;
	-ms-overflow-style: none;
	position: relative;
}
#ed-body::-webkit-scrollbar {
	display: none;
}
.ed-scrollbar {
	position: absolute;
	right: 2px;
	top: 0;
	width: 4px;
	height: 100%;
	pointer-events: none;
}
.ed-scrollbar-thumb {
	position: absolute;
	right: 0;
	width: 4px;
	background: rgba(255,255,255,0.3);
	border-radius: 2px;
	pointer-events: auto;
	cursor: pointer;
}
.ed-scrollbar-thumb:hover {
	background: rgba(255,255,255,0.5);
}

#ed-body.slide-l, #ed-body.slide-r {
	opacity: 0;
	transform: translateY(20px);
}

.ed-sec {
	margin-bottom: 16px;
}

.ed-title {
	color: #888;
	font-size: 11px;
	margin-bottom: 8px;
	text-transform: uppercase;
	font-weight: bold;
}

.ed-btn {
	width: 100%;
	padding: 10px;
	background: #1a1a1a;
	border: none;
	border-radius: 6px;
	color: #fff;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
	gap: 6px;
	transition: background 0.2s;
	margin-bottom: 6px;
}

.ed-btn:hover {
	background: #252525;
}

.ed-btn.sm {
	font-size: 12px;
	padding: 8px;
}

.ed-btn.del {
	color: #ff6b6b;
}

.ed-btn.del:hover {
	background: #2a1a1a;
}

.ed-row {
	margin-bottom: 10px;
}

.ed-row label {
	display: block;
	color: #666;
	margin-bottom: 4px;
	font-size: 11px;
}

.ed-row input, .ed-row select, .ed-row textarea {
	width: 100%;
	padding: 8px;
	background: #0d0d0d;
	border: 1px solid #333;
	border-radius: 4px;
	color: #fff;
	font-size: 12px;
}

.ed-row textarea {
	resize: vertical;
	min-height: 60px;
	font-family: inherit;
}

.ed-row input:focus, .ed-row select:focus, .ed-row textarea:focus {
	outline: none;
	border-color: var(--btn);
}

.ed-row input[type="range"] {
	padding: 0;
	height: 20px;
	background: transparent;
	border: none;
}

.ed-row input[type="checkbox"] {
	width: auto;
}

.ed-row input[type="color"] {
	width: 40px;
	height: 28px;
	padding: 2px;
	cursor: pointer;
}

.ed-v {
	color: #888;
	font-size: 11px;
	margin-left: 8px;
}

.ed-up {
	display: flex;
	align-items: center;
	gap: 8px;
}

.ed-up input[type="file"] {
	width: auto;
	padding: 4px;
	font-size: 11px;
}

.ed-uv {
	color: #666;
	font-size: 10px;
	word-break: break-all;
}

.ed-empty {
	color: #666;
	text-align: center;
	padding: 20px;
}

.ed-color {
	display: flex;
	gap: 6px;
	align-items: center;
}

.ed-color input[type="color"] {
	flex-shrink: 0;
}

.ed-color .ed-ctxt {
	flex: 1;
}

.ed-slider {
	display: flex;
	align-items: center;
	gap: 8px;
}

.ed-slider input[type="range"] {
	flex: 1;
}

.ed-toggle {
	display: flex;
	justify-content: space-between;
	align-items: center;
}

.ed-toggle-sw {
	position: relative;
	width: 36px;
	height: 20px;
	background: #333;
	border-radius: 10px;
	cursor: pointer;
	flex-shrink: 0;
}

.ed-toggle-sw.on {
	background: var(--btn);
}

.ed-toggle-sw::after {
	content: "";
	position: absolute;
	top: 2px;
	left: 2px;
	width: 16px;
	height: 16px;
	background: #fff;
	border-radius: 50%;
	transition: left 0.2s;
}

.ed-toggle-sw.on::after {
	left: 18px;
}

.ed-drag {
	padding: 10px 12px;
	margin-bottom: 6px;
	background: #1a1a1a;
	border-radius: 6px;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 8px;
	transition: background 0.2s;
	color: #fff;
}

.ed-drag:hover {
	background: #252525;
}

.ed-ctx {
	position: fixed;
	background: #1a1a1a;
	border-radius: 6px;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
	z-index: 10001;
	min-width: 120px;
	overflow: hidden;
}

.ed-ctx div {
	padding: 10px 14px;
	cursor: pointer;
	transition: background 0.2s;
	color: #fff;
}

.ed-ctx div:hover {
	background: #252525;
}

.ed-menu {
	position: fixed;
	left: 10px;
	top: 50%;
	transform: translateY(-50%);
	background: #1a1a1a;
	border-radius: 12px;
	padding: 10px 8px;
	display: flex;
	flex-direction: column;
	gap: 10px;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
	z-index: 10001;
}

.ed-menu button {
	background: none;
	border: none;
	color: #888;
	cursor: pointer;
	padding: 4px;
	display: flex;
	align-items: center;
	transition: color 0.2s;
}

.ed-menu button:hover {
	color: #fff;
}

.ed-toast {
	position: fixed;
	bottom: 80px;
	left: 50%;
	transform: translateX(-50%);
	background: var(--btn);
	color: #fff;
	padding: 10px 24px;
	border-radius: 6px;
	z-index: 10002;
	animation: edFade 0.3s;
}

@keyframes edFade {
	from {
		opacity: 0;
		transform: translateX(-50%) translateY(10px);
	}
	to {
		opacity: 1;
		transform: translateX(-50%) translateY(0);
	}
}
.ed-status {
	position: fixed;
	bottom: 20px;
	left: 50%;
	transform: translateX(-50%);
	background: rgba(0,0,0,0.8);
	color: #fff;
	padding: 8px 16px;
	border-radius: 4px;
	z-index: 10002;
	font-size: 12px;
	pointer-events: none;
}
.ed-sel {
	outline: 2px dashed var(--btn) !important;
	outline-offset: 1px;
}

.ed-el {
	cursor: pointer;
	transition: outline 0.15s;
}

.ed-el:hover {
	outline: 1px dashed #666;
	outline-offset: 1px;
}
.ed-col {
	cursor: pointer;
	padding: 2px;
}
.ed-col:hover {
	outline: 1px dashed #888;
	outline-offset: 0px;
}
.ed-col.ed-sel {
	outline: 2px dashed var(--btn) !important;
	outline-offset: 0px;
}
.ed-col-ph {
	min-height: 40px;
	border: 1px dashed #444;
	border-radius: 4px;
	display: flex;
	align-items: center;
	justify-content: center;
	color: #666;
	font-size: 11px;
}
.ed-device {
	display: flex;
	flex-direction: column;
	background: #0d0d0d;
	border-radius: 8px;
	padding: 2px;
}

.ed-device button {
	padding: 4px 6px;
	border: none;
	background: none;
	color: #666;
	cursor: pointer;
	border-radius: 6px;
	display: flex;
}

.ed-device button.on {
	background: var(--btn);
	color: #fff;
}

.ed-fold {
	background: #1a1a1a;
	border-radius: 6px;
	margin-bottom: 10px;
}

.ed-fold-hd {
	padding: 8px 10px;
	cursor: pointer;
	display: flex;
	justify-content: space-between;
	align-items: center;
	color: #888;
	font-size: 11px;
}

.ed-fold-hd:hover {
	color: #fff;
}

.ed-fold-hd .arr {
	transition: transform 0.2s;
}

.ed-fold-hd.open .arr {
	transform: rotate(90deg);
}

.ed-fold-bd {
	max-height: 0;
	overflow: hidden;
	transition: max-height 0.3s;
}

.ed-fold-bd.open {
	max-height: 800px;
}

.ed-fold-bd>.ed-row {
	padding: 0 10px;
}

.ed-fold-bd>.ed-row:last-child {
	padding-bottom: 10px;
}

.ed-move {
	position: absolute;
	left: -8px;
	top: -8px;
	width: 20px;
	height: 20px;
	background: var(--btn);
	border-radius: 4px;
	cursor: move;
	display: flex;
	align-items: center;
	justify-content: center;
	z-index: 10001;
}

.ed-move svg {
	width: 12px;
	height: 12px;
	stroke: #fff;
}

.ed-ph {
	border: 2px dashed var(--btn);
	margin: 4px 0;
	height: 4px;
	border-radius: 2px;
}

.ed-drop {
	border: 2px dashed var(--btn);
	margin: 8px 0;
	min-height: 36px;
	border-radius: 6px;
	background: rgba(22, 109, 59, 0.1);
}
.ed-drop[data-type="text"] {
	min-height: 24px;
}
.ed-drop[data-type="btn"] {
	min-height: 40px;
}
.ed-drop[data-type="image"] {
	min-height: 60px;
}
.ed-drop[data-type="row"] {
	min-height: 50px;
}

.collapse-drop.drag-over, .ed-col.drag-over {
	border-color: var(--btn);
	background: rgba(22, 109, 59, 0.2);
	outline: 2px dashed var(--btn);
}

.ed-chat {
	display: flex;
	flex-direction: column;
	height: 100%;
}

.ed-chat-body {
	flex: 1;
	overflow-y: auto;
	padding: 8px 0;
	display: flex;
	flex-direction: column;
	gap: 4px;
}

.ed-chat-input {
	display: flex;
	gap: 6px;
	padding: 8px 0;
	border-top: 1px solid #222;
}

.ed-chat-input textarea {
	flex: 1;
	resize: none;
	min-height: 60px;
}

.ed-chat-btns {
	display: flex;
	gap: 6px;
}

.ed-chat-btns button {
	padding: 8px 12px;
	background: #1a1a1a;
	border: none;
	border-radius: 6px;
	color: #fff;
	cursor: pointer;
}

.ed-chat-btns button:hover {
	background: #252525;
}

.ed-chat-btns button.primary {
	background: var(--btn);
}

.ed-chat-msg {
	padding: 8px 12px;
	margin: 4px 0;
	border-radius: 8px;
	max-width: 90%;
	word-break: break-word;
	white-space: pre-wrap;
}

.ed-chat-msg.user {
	background: var(--btn);
	color: #fff;
	margin-left: auto;
}

.ed-chat-msg.bot {
	background: #1a1a1a;
	color: #ccc;
}

.ed-chat-msg.loading {
	color: #666;
	font-style: italic;
}

.ed-tab.disabled {
	opacity: 0.3;
	pointer-events: none;
}

.ed-modal {
	position: fixed;
	top: 0;
	left: 0;
	width: 100vw;
	height: 100vh;
	background: rgba(0, 0, 0, 0.6);
	z-index: 10003;
	display: flex;
	align-items: center;
	justify-content: center;
}

.ed-modal-box {
	background: #1a1a1a;
	border-radius: 8px;
	width: 320px;
	max-height: 70vh;
	overflow: hidden;
	display: flex;
	flex-direction: column;
}

.ed-modal-hd {
	padding: 12px 16px;
	border-bottom: 1px solid #333;
	font-weight: bold;
	color: #fff;
}

.ed-modal-bd {
	flex: 1;
	overflow-y: auto;
	padding: 8px;
}

.ed-model-item {
	padding: 10px 12px;
	cursor: pointer;
	border-radius: 6px;
	margin-bottom: 4px;
	color: #fff;
}

.ed-model-item:hover {
	background: #252525;
}

.ed-model-item.on {
	background: var(--btn);
}

.ed-model-item .name {
	font-weight: bold;
}

.ed-model-item .desc {
	font-size: 11px;
	color: #888;
	margin-top: 4px;
}

.ed-gallery-modal {
	position: fixed;
	top: 0;
	left: 0;
	width: 100vw;
	height: 100vh;
	background: rgba(0, 0, 0, 0.7);
	z-index: 10004;
	display: none;
	align-items: center;
	justify-content: center;
}

.ed-gallery-modal.open {
	display: flex;
}

.ed-gallery-box {
	background: #1a1a1a;
	border-radius: 8px;
	width: 80%;
	max-width: 800px;
	height: 80%;
	display: flex;
	flex-direction: column;
}

.ed-gallery-hd {
	padding: 12px 16px;
	border-bottom: 1px solid #333;
	display: flex;
	align-items: center;
	gap: 8px;
	color: #fff;
	flex-shrink: 0;
}

.ed-gallery-bread {
	display: flex;
	align-items: center;
	gap: 4px;
	flex: 1;
}

.ed-gallery-bread span {
	cursor: pointer;
	padding: 4px 8px;
	border-radius: 4px;
}

.ed-gallery-bread span:hover {
	background: #333;
}

.ed-gallery-bread span.drop-target {
	background: var(--btn);
}

.ed-gallery-bd {
	flex: 1;
	overflow-y: auto;
	padding: 12px;
	display: grid;
	grid-template-columns: repeat(4, 1fr);
	gap: 8px;
	align-content: start;
}

.ed-gallery-item {
	aspect-ratio: 1;
	background: #252525;
	border-radius: 6px;
	overflow: hidden;
	cursor: pointer;
	position: relative;
	display: flex;
	align-items: center;
	justify-content: center;
}

.ed-gallery-item:hover {
	outline: 2px solid var(--btn);
}

.ed-gallery-item.selected {
	outline: 2px solid var(--btn);
}

.ed-gallery-item.drag-over {
	outline: 2px dashed var(--btn);
	background: rgba(22, 109, 59, 0.2);
}

.ed-gallery-item img {
	width: 100%;
	height: 100%;
	object-fit: cover;
}

.ed-gallery-item.folder {
	flex-direction: column;
	gap: 4px;
}

.ed-gallery-item.folder svg {
	width: 40%;
	height: 40%;
	stroke: #888;
}

.ed-gallery-item.folder span {
	font-size: 11px;
	color: #888;
	text-align: center;
	padding: 0 4px;
	word-break: break-all;
}

.ed-gallery-ft {
	padding: 12px 16px;
	border-top: 1px solid #333;
	display: flex;
	justify-content: flex-end;
	gap: 8px;
	flex-shrink: 0;
}

.ed-gallery-ft button {
	padding: 8px 16px;
	border: none;
	border-radius: 6px;
	cursor: pointer;
	font-size: 13px;
}

.ed-gallery-ft .gal-upload {
	background: #333;
	color: #fff;
}

.ed-gallery-ft .gal-folder {
	background: #333;
	color: #fff;
}

.ed-gallery-ft .gal-confirm {
	background: var(--btn);
	color: #fff;
}

.ed-gallery-ft button:hover {
	filter: brightness(1.2);
}

.ed-gallery-ctx {
	position: fixed;
	background: #252525;
	border-radius: 6px;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
	z-index: 10005;
	min-width: 100px;
	overflow: hidden;
}

.ed-gallery-ctx div {
	padding: 8px 12px;
	cursor: pointer;
	color: #fff;
	font-size: 13px;
}

.ed-gallery-ctx div:hover {
	background: #333;
}

.ed-gallery-ctx div.del {
	color: #ff6b6b;
}

#ed-version {
	position: fixed;
	bottom: 8px;
	left: 50%;
	transform: translateX(-50%);
	color: #555;
	font-size: 11px;
	z-index: 9999;
	pointer-events: none;
}

.ed-row-wrap {
	display: flex;
	align-items: flex-start;
	gap: 6px;
}

.ed-row-wrap > .ed-row {
	flex: 1;
	margin-bottom: 0;
}

.ed-mod-dot {
	width: 8px;
	height: 8px;
	border-radius: 50%;
	background: #166d3b;
	cursor: pointer;
	flex-shrink: 0;
	margin-top: 6px;
	opacity: 0;
	transition: opacity 0.2s;
}

.ed-row-wrap.modified .ed-mod-dot {
	opacity: 1;
}

.ed-mod-dot:hover {
	background: #1a8f4a;
}

.ed-style-menu {
	position: fixed;
	background: #1a1a1a;
	border-radius: 6px;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
	z-index: 10006;
	min-width: 140px;
	overflow: hidden;
}

.ed-style-menu div {
	padding: 10px 14px;
	cursor: pointer;
	transition: background 0.2s;
	color: #fff;
	font-size: 12px;
}

.ed-style-menu div:hover {
	background: #252525;
}
</style>
<div id="ed-version"></div>
<div id="ed-list"></div>
<div id="ed-panel">
  <div class="ed-tabs">
    <div class="ed-tab on" data-t="0">窗口</div>
    <div class="ed-tab" data-t="1">模块</div>
    <div class="ed-tab" data-t="2">样式</div>
    <div class="ed-tab" data-t="3">组</div>
    <div class="ed-tab" data-t="4">聊天</div>
    <div class="ed-tab" data-t="5">系统</div>
  </div>
  <div id="ed-body"></div>
</div>
<div class="ed-menu">
  <button id="edList" title="项目列表">
    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2">
      <line x1="8" y1="6" x2="21" y2="6" />
      <line x1="8" y1="12" x2="21" y2="12" />
      <line x1="8" y1="18" x2="21" y2="18" />
      <line x1="3" y1="6" x2="3.01" y2="6" />
      <line x1="3" y1="12" x2="3.01" y2="12" />
      <line x1="3" y1="18" x2="3.01" y2="18" />
    </svg>
  </button>
  <button id="edUndo" title="撤回">
    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2">
      <path d="M3 7v6h6" />
      <path d="M3 13a9 9 0 1 0 2.3-6.3L3 7" />
    </svg>
  </button>
  <button id="edRedo" title="重做">
    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2">
      <path d="M21 7v6h-6" />
      <path d="M21 13a9 9 0 1 1-2.3-6.3L21 7" />
    </svg>
  </button>
  <button id="edCopy" title="复制配置">
    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2">
      <rect x="9" y="9" width="13" height="13" rx="2" />
      <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" />
    </svg>
  </button>
  <button id="edSave" title="保存文件">
    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2">
      <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z" />
      <path d="M17 21v-8H7v8M7 3v5h8" />
    </svg>
  </button>
  <button id="edPreview" title="预览">
    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2">
      <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3" />
    </svg>
  </button>
  <button id="edGallery" title="图库">
    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <circle cx="8.5" cy="8.5" r="1.5"/>
      <path d="M21 15l-5-5L5 21"/>
    </svg>
  </button>
  <div class="ed-device">
    <button id="edPc" class="on" title="电脑 16:9">
      <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2">
        <rect x="2" y="3" width="20" height="14" rx="2" />
        <line x1="8" y1="21" x2="16" y2="21" />
        <line x1="12" y1="17" x2="12" y2="21" />
      </svg>
    </button>
    <button id="edMobile" title="手机 9:19">
      <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2">
        <rect x="5" y="2" width="14" height="20" rx="2" />
        <line x1="12" y1="18" x2="12" y2="18.01" />
      </svg>
    </button>
  </div>
</div>
<div class="ed-gallery-modal" id="galModal">
  <div class="ed-gallery-box">
    <div class="ed-gallery-hd">
      <div class="ed-gallery-bread" id="galBread"></div>
    </div>
    <div class="ed-gallery-bd" id="galBody"></div>
    <div class="ed-gallery-ft">
      <button class="gal-upload" id="galUpload">上传</button>
      <button class="gal-folder" id="galAddUrl">添加URL</button>
      <button class="gal-folder" id="galNewFolder">新建文件夹</button>
      <button class="gal-confirm" id="galConfirm">确定</button>
    </div>
  </div>
</div>
<input type="file" id="galFileInput" multiple accept="image/*,video/*" style="display:none">
<script>
  window.LZS = (function() {
    var k = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
    var r = {};
    for (var i = 0; i < k.length; i++) r[k.charAt(i)] = i;
    function c(u) {
      if (u == null) return "";
      var o = [], c = 0, p = 0, w = 16, cc = {}, cd = {}, dv, dc = 2, cv = 0, nv = 0;
      for (var ii = 0; ii < u.length; ii++) {
        var ch = u.charAt(ii);
        if (!cc.hasOwnProperty(ch)) { cc[ch] = dc++; cd[ch] = true; }
      }
      dv = u.charAt(0);
      for (var ii = 1; ii <= u.length; ii++) {
        var ch = ii < u.length ? u.charAt(ii) : null;
        if (ch !== null && cc.hasOwnProperty(dv + ch)) { dv += ch; }
        else {
          if (cd.hasOwnProperty(dv)) {
            if (dv.charCodeAt(0) < 256) {
              for (var i = 0; i < nv; i++) { cv <<= 1; if (++p == w) { p = 0; o.push(String.fromCharCode(cv)); cv = 0; } }
              nv = 8;
              var v = dv.charCodeAt(0);
              for (var i = 0; i < nv; i++) { cv = (cv << 1) | (v & 1); v >>= 1; if (++p == w) { p = 0; o.push(String.fromCharCode(cv)); cv = 0; } }
            } else {
              var v = 1;
              for (var i = 0; i < nv; i++) { cv = (cv << 1) | (v & 1); v >>= 1; if (++p == w) { p = 0; o.push(String.fromCharCode(cv)); cv = 0; } }
              nv = 16;
              v = dv.charCodeAt(0);
              for (var i = 0; i < nv; i++) { cv = (cv << 1) | (v & 1); v >>= 1; if (++p == w) { p = 0; o.push(String.fromCharCode(cv)); cv = 0; } }
            }
            dc--;
            if (dc == 0) { dc = 1 << c; c++; }
            delete cd[dv];
          } else {
            var v = cc[dv];
            for (var i = 0; i < nv; i++) { cv = (cv << 1) | (v & 1); v >>= 1; if (++p == w) { p = 0; o.push(String.fromCharCode(cv)); cv = 0; } }
          }
          dc--;
          if (dc == 0) { dc = 1 << c; c++; }
          if (ch !== null) { cc[dv + ch] = dc++; dc--; if (dc == 0) { dc = 1 << c; c++; } dv = ch; }
        }
        nv = c;
      }
      if (dv !== "") {
        if (cd.hasOwnProperty(dv)) {
          if (dv.charCodeAt(0) < 256) {
            for (var i = 0; i < nv; i++) { cv <<= 1; if (++p == w) { p = 0; o.push(String.fromCharCode(cv)); cv = 0; } }
            nv = 8;
            var v = dv.charCodeAt(0);
            for (var i = 0; i < nv; i++) { cv = (cv << 1) | (v & 1); v >>= 1; if (++p == w) { p = 0; o.push(String.fromCharCode(cv)); cv = 0; } }
          } else {
            var v = 1;
            for (var i = 0; i < nv; i++) { cv = (cv << 1) | (v & 1); v >>= 1; if (++p == w) { p = 0; o.push(String.fromCharCode(cv)); cv = 0; } }
            nv = 16;
            v = dv.charCodeAt(0);
            for (var i = 0; i < nv; i++) { cv = (cv << 1) | (v & 1); v >>= 1; if (++p == w) { p = 0; o.push(String.fromCharCode(cv)); cv = 0; } }
          }
          dc--;
          if (dc == 0) { dc = 1 << c; c++; }
          delete cd[dv];
        } else {
          var v = cc[dv];
          for (var i = 0; i < nv; i++) { cv = (cv << 1) | (v & 1); v >>= 1; if (++p == w) { p = 0; o.push(String.fromCharCode(cv)); cv = 0; } }
        }
      }
      var v = 2;
      for (var i = 0; i < nv; i++) { cv = (cv << 1) | (v & 1); v >>= 1; if (++p == w) { p = 0; o.push(String.fromCharCode(cv)); cv = 0; } }
      while (true) { cv <<= 1; if (++p == w) break; }
      o.push(String.fromCharCode(cv));
      var s = o.join("");
      var b = "";
      for (var i = 0; i < s.length * 2; i += 3) {
        var c1 = i / 2 < s.length ? s.charCodeAt(i / 2) : 0;
        var c2 = (i + 1) / 2 < s.length ? s.charCodeAt((i + 1) / 2) : 0;
        var n = ((i % 2 == 0 ? c1 >> 8 : c1 & 255) << 16) | ((i % 2 == 0 ? c1 & 255 : c2 >> 8) << 8) | (i % 2 == 0 ? c2 >> 8 : c2 & 255);
        b += k.charAt((n >> 18) & 63) + k.charAt((n >> 12) & 63) + k.charAt((n >> 6) & 63) + k.charAt(n & 63);
      }
      switch (s.length % 3) { case 1: b = b.slice(0, -2) + "=="; break; case 2: b = b.slice(0, -1) + "="; break; }
      return b;
    }
    function d(input) {
      if (input == null || input === "") return null;
      input = input.replace(/[^A-Za-z0-9+/=]/g, "");
      var s = "", ol = input.length / 4 * 3;
      if (input.charAt(input.length - 1) == "=") ol--;
      if (input.charAt(input.length - 2) == "=") ol--;
      var u = [];
      for (var i = 0; i < input.length; i += 4) {
        var n = (r[input.charAt(i)] << 18) | (r[input.charAt(i + 1)] << 12) | (r[input.charAt(i + 2)] << 6) | r[input.charAt(i + 3)];
        u.push((n >> 16) & 255, (n >> 8) & 255, n & 255);
      }
      u = u.slice(0, ol);
      var str = "";
      for (var i = 0; i < u.length; i += 2) str += String.fromCharCode((u[i] << 8) | (u[i + 1] || 0));
      var dic = [0, 1, 2], next = 3, ew = 2, en = 4, data = { v: 0, p: 0, i: 0, s: str };
      function rd(n) {
        var r = 0, mx = 1 << n;
        for (var i = 0; i < n; i++) {
          var b = data.v & data.p;
          data.p >>= 1;
          if (data.p == 0) { data.p = 32768; data.v = data.s.charCodeAt(data.i++); }
          r |= (b > 0 ? 1 : 0) * mx / 2;
          mx >>= 1;
        }
        return r;
      }
      data.v = str.charCodeAt(0); data.p = 32768;
      var b = rd(2);
      if (b == 0) { dic[3] = String.fromCharCode(rd(8)); next = 4; }
      else if (b == 1) { dic[3] = String.fromCharCode(rd(16)); next = 4; }
      else if (b == 2) return "";
      var w = dic[3], result = [w], entry;
      while (true) {
        if (data.i > str.length) return "";
        b = rd(ew);
        if (b == 0) { dic[next++] = String.fromCharCode(rd(8)); b = next - 1; en--; }
        else if (b == 1) { dic[next++] = String.fromCharCode(rd(16)); b = next - 1; en--; }
        else if (b == 2) return result.join("");
        if (en == 0) { en = 1 << ew; ew++; }
        if (dic[b]) entry = dic[b];
        else if (b == next) entry = w + w.charAt(0);
        else return null;
        result.push(entry);
        dic[next++] = w + entry.charAt(0);
        en--;
        if (en == 0) { en = 1 << ew; ew++; }
        w = entry;
      }
    }
    return { c: c, d: d };
  })();
  window.U = {
    esc: function(s) {
      return String(s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;")
    }
  };
  window.FS = {
    read: async function(n) {
      try {
        var r = await navigator.storage.getDirectory(),
          f = await r.getFileHandle(n),
          t = await f.getFile();
        return await t.text()
      } catch (e) {
        return null
      }
    },
    write: async function(n, d) {
      try {
        var r = await navigator.storage.getDirectory(),
          f = await r.getFileHandle(n, {
            create: true
          }),
          w = await f.createWritable();
        await w.write(d);
        await w.close()
      } catch (e) {}
    }
  };
  window.E = {
    pj: {},
    cur: null,
    pg: 0,
    sel: null,
    zone: 'content',
    multiSel: [],
    tab: 0,
    list: false,
    listTab: 0,
    cfg: null,
    rowSel: null,
    data: null,
    hist: [],
    histIdx: -1,
    moveMode: false,
    preview: false,
    models: [],
    curModel: null,
    conversationId: null,
    chatMessages: [],
    chatSending: false,
    dragType: null,
    dragZone: null,
    curApp: null,
    clickStack: [],
    clickIdx: 0,
    lastClickPos: null,
    statusEl: null,
    displayModes: [{v:'none',l:'无'},{v:'userInput',l:'用户输入'},{v:'userAndSys',l:'用户输入和系统输入'}],
    animations: [{
      v: 'none',
      l: '无'
    }, {
      v: 'slideUp',
      l: '上滑'
    }, {
      v: 'slideDown',
      l: '下滑'
    }, {
      v: 'slideLeft',
      l: '左滑'
    }, {
      v: 'slideRight',
      l: '右滑'
    }, {
      v: 'flipH',
      l: '水平翻转'
    }, {
      v: 'flipV',
      l: '垂直翻转'
    }, {
      v: 'fadeIn',
      l: '淡入'
    }, {
      v: 'zoomIn',
      l: '放大'
    }, {
      v: 'zoomOut',
      l: '缩小'
    }],
    textProps: {
      size: {
        t: "slider",
        r: "10-48",
        d: "字号"
      },
      font: {
        t: "select",
        d: "字体"
      },
      bold: {
        t: "toggle",
        d: "加粗"
      },
      italic: {
        t: "toggle",
        d: "倾斜"
      },
      underline: {
        t: "toggle",
        d: "下划线"
      },
      strike: {
        t: "toggle",
        d: "删除线"
      },
      color: {
        t: "color",
        d: "文字颜色",
        v: "ffffff"
      },
      bgColor: {
        t: "color",
        d: "背景颜色",
        v: "000000"
      },
      opacity: {
        t: "slider",
        r: "0-100",
        d: "文字透明度",
        v: 0
      },
      bgOpacity: {
        t: "slider",
        r: "0-100",
        d: "背景透明度",
        v: 0
      },
      align: {
        t: "select",
        d: "对齐"
      }
    },
    fonts: [{
      v: 'system-ui',
      l: '系统字体'
    }, {
      v: 'serif',
      l: '衬线体'
    }, {
      v: 'monospace',
      l: '等宽体'
    }, {
      v: 'cursive',
      l: '手写体'
    }],
    shapes: [{
      v: 'rounded',
      l: '圆角'
    }, {
      v: 'rect',
      l: '直角'
    }, {
      v: 'hexagon',
      l: '六边形'
    }],
    aligns: [{
      v: 'left',
      l: '左对齐'
    }, {
      v: 'center',
      l: '居中'
    }, {
      v: 'right',
      l: '右对齐'
    }],
    valigns: [{
      v: 'top',
      l: '顶部'
    }, {
      v: 'center',
      l: '居中'
    }, {
      v: 'bottom',
      l: '底部'
    }],
    imgModes: [{
      v: 'fixedWidth',
      l: '固定宽度'
    }, {
      v: 'fixedHeight',
      l: '固定高度'
    }, {
      v: 'cover',
      l: '铺满'
    }, {
      v: 'contain',
      l: '包含'
    }],
    imgClicks: [{
      v: 'none',
      l: '无'
    }, {
      v: 'gallery',
      l: '查看轮播'
    }, {
      v: 'jumpModal',
      l: '跳转页面'
    }],
    btnClicks: [{
      v: 'none',
      l: '无'
    }, {
      v: 'jumpModal',
      l: '跳转页面'
    }, {
      v: 'message',
      l: '添加语句'
    }],
    btnEffects: [{
      v: 'none',
      l: '无系统级效果'
    }, {
      v: 'killer',
      l: '点击视为结束该画面'
    }, {
      v: 'hider',
      l: '点击视为隐藏该画面'
    }],
    afterClicks: [{
      v: 'none',
      l: '无'
    }, {
      v: 'hide',
      l: '隐藏按钮'
    }, {
      v: 'disable',
      l: '禁用按钮'
    }],
    switchStyles: [{
      v: 'capsule',
      l: '胶囊形'
    }, {
      v: 'rounded',
      l: '圆角'
    }],
    colTypes: ['text', 'image', 'btn', 'input', 'select', 'switch'],
    init: function(d) {
      var self = this;
      self.data = d;
      self.cfg = {
        "global": {
          name: "全局",
          props: {
            bgColor: {
              t: "color",
              d: "背景颜色",
              v: "050505"
            },
            bgImgPc: {
              t: "upload",
              d: "电脑端背景图"
            },
            bgImgMobile: {
              t: "upload",
              d: "手机端背景图"
            },
            bgTransparent: {
              t: "toggle",
              d: "透明背景"
            },
            defTextSize: {
              t: "slider",
              r: "10-48",
              d: "默认字号",
              v: 14
            },
            defTextColor: {
              t: "color",
              d: "默认文字颜色",
              v: "888888"
            },
            defTextFont: {
              t: "select",
              r: self.fonts,
              d: "默认字体",
              v: "system-ui"
            },
            defBtnBg: {
              t: "color",
              d: "默认按钮底色",
              v: "166d3b"
            },
            defBtnColor: {
              t: "color",
              d: "默认按钮文字色",
              v: "ffffff"
            },
            defBtnShape: {
              t: "select",
              r: self.shapes,
              d: "默认按钮外形",
              v: "rounded"
            },
            defBtnRadius: {
              t: "slider",
              r: "0-24",
              d: "默认圆角",
              v: 8
            },
            defModalBg: {
              t: "color",
              d: "默认弹窗底色",
              v: "0d0d0d"
            },
            defModalOpacity: {
              t: "slider",
              r: "0-100",
              d: "默认弹窗透明度",
              v: 100
            },
            defModalBlur: {
              t: "slider",
              r: "0-20",
              d: "默认弹窗模糊",
              v: 0
            }
          }
        },
        "page": {
          name: "页面",
          props: {
            title: {
              t: "input",
              d: "页面标题"
            },
            widthPct: {
              t: "slider",
              r: "10-100",
              d: "宽度%",
              v: 80
            },
            heightPct: {
              t: "slider",
              r: "10-100",
              d: "高度%",
              v: 80
            },
            maxWidthPct: {
              t: "slider",
              r: "10-200",
              d: "最大宽度(高度%)",
              v: 100
            },
            headerPct: {
              t: "slider",
              r: "0-50",
              d: "头部%",
              v: 0
            },
            footerPct: {
              t: "slider",
              r: "0-50",
              d: "底部%",
              v: 0
            },
            modalBg: {
              t: "color",
              d: "弹窗背景色"
            },
            modalBgImg: {
              t: "upload",
              d: "弹窗背景图"
            },
            modalOpacity: {
              t: "slider",
              r: "0-100",
              d: "弹窗透明度"
            },
            modalBlur: {
              t: "slider",
              r: "0-20",
              d: "弹窗模糊度"
            }
          }
        },
        "text": {
          name: "文本",
          props: {
            value: {
              t: "textarea",
              d: "内容",
              v: "文本内容"
            },
            size: {
              t: "slider",
              r: "10-48",
              d: "字号",
              v: 14
            },
            font: {
              t: "select",
              r: self.fonts,
              d: "字体"
            },
            bold: {
              t: "toggle",
              d: "加粗"
            },
            italic: {
              t: "toggle",
              d: "倾斜"
            },
            underline: {
              t: "toggle",
              d: "下划线"
            },
            strike: {
              t: "toggle",
              d: "删除线"
            },
            color: {
              t: "color",
              d: "文字颜色",
              v: "ffffff"
            },
            bgColor: {
              t: "color",
              d: "背景颜色"
            },
            opacity: {
              t: "slider",
              r: "0-100",
              d: "文字透明度",
              v: 0
            },
            bgOpacity: {
              t: "slider",
              r: "0-100",
              d: "背景透明度",
              v: 0
            },
            align: {
              t: "select",
              r: self.aligns,
              d: "对齐",
              v: "center"
            }
          }
        },
        "image": {
          name: "图片",
          props: {
            url: {
              t: "upload",
              d: "图片/视频"
            },
            urlInput: {
              t: "input",
              d: "或输入URL"
            },
            clickAction: {
              t: "select",
              r: self.imgClicks,
              d: "点击逻辑",
              v: "none"
            },
            clickTarget: {
              t: "page",
              d: "目标页面"
            },
            galleryUrls: {
              t: "gallery",
              d: "轮播图片"
            },
            displayMode: {
              t: "select",
              r: self.imgModes,
              d: "显示模式",
              v: "fixedWidth"
            },
            width: {
              t: "slider",
              r: "10-100",
              d: "宽度%",
              v: 100
            },
            height: {
              t: "slider",
              r: "50-500",
              d: "高度px",
              v: 200
            },
            opacity: {
              t: "slider",
              r: "0-100",
              d: "透明度",
              v: 100
            },
            align: {
              t: "select",
              r: self.aligns,
              d: "对齐",
              v: "center"
            }
          }
        },
        "btn": {
          name: "按钮",
          props: {
            value: {
              t: "input",
              d: "按钮文字",
              v: "按钮"
            },
            clickAction: {
              t: "select",
              r: self.btnClicks,
              d: "点击功能",
              v: "none"
            },
            clickTarget: {
              t: "page",
              d: "目标页面"
            },
            message: {
              t: "input",
              d: "添加到用户消息的语句"
            },
            sysEffect: {
              t: "select",
              r: self.btnEffects,
              d: "系统级效果",
              v: "none"
            },
            modelSelect: {
              t: "model",
              d: "选择模型"
            },
            repeatable: {
              t: "toggle",
              d: "可重复点击",
              v: true
            },
            afterClick: {
              t: "select",
              r: self.afterClicks,
              d: "禁用后效果",
              v: "none"
            },
            disabledStyle: {
              t: "color",
              d: "禁用时颜色",
              v: "333333"
            },
            logicGroup: {
              t: "grp",
              g: "logic",
              d: "按钮逻辑组"
            },
            logicMax: {
              t: "num",
              d: "组内最多选",
              v: 1
            },
            styleGroup: {
              t: "grp",
              g: "style",
              d: "按钮格式组"
            },
            shape: {
              t: "select",
              r: self.shapes,
              d: "外形",
              v: "rounded"
            },
            radius: {
              t: "slider",
              r: "0-24",
              d: "圆角",
              v: 8
            },
            hexWidth: {
              t: "slider",
              r: "5-30",
              d: "六边形角宽",
              v: 15
            },
            bgColor: {
              t: "color",
              d: "底色",
              v: "166d3b"
            },
            borderColor: {
              t: "color",
              d: "边框颜色",
              v: "166d3b"
            },
            borderWidth: {
              t: "slider",
              r: "0-5",
              d: "边框宽度",
              v: 0
            },
            textSize: {
              t: "slider",
              r: "10-24",
              d: "文字大小",
              v: 14
            },
            textColor: {
              t: "color",
              d: "文字颜色",
              v: "ffffff"
            },
            textBold: {
              t: "toggle",
              d: "文字加粗"
            },
            width: {
              t: "slider",
              r: "1-100",
              d: "宽度%"
            },
            align: {
              t: "select",
              r: self.aligns,
              d: "对齐",
              v: "center"
            }
          }
        },
        "input": {
          name: "输入框",
          props: {
            key: {
              t: "input",
              d: "数据键名",
              v: "input1"
            },
            title: {
              t: "input",
              d: "标题"
            },
            placeholder: {
              t: "input",
              d: "说明文字"
            },
            required: {
              t: "toggle",
              d: "必填",
              v: false
            },
            displayMode: {
              t: "select",
              r: self.displayModes,
              d: "显示内容",
              v: "none"
            },
            width: {
              t: "slider",
              r: "1-100",
              d: "宽度%",
              v: 100
            }
          }
        },
        "select": {
          name: "下拉框",
          props: {
            key: {
              t: "input",
              d: "数据键名",
              v: "select1"
            },
            title: {
              t: "input",
              d: "标题"
            },
            options: {
              t: "textarea",
              d: "选项(每行一个)"
            },
            default: {
              t: "slider",
              r: "0-20",
              d: "默认索引",
              v: 0
            }
          }
        },
        "switch": {
          name: "滑块",
          props: {
            key: {
              t: "input",
              d: "数据键名",
              v: "switch1"
            },
            title: {
              t: "input",
              d: "标题"
            },
            leftText: {
              t: "input",
              d: "左侧文字"
            },
            rightText: {
              t: "input",
              d: "右侧文字"
            },
            style: {
              t: "select",
              r: self.switchStyles,
              d: "样式",
              v: "capsule"
            },
            thumbColor: {
              t: "color",
              d: "滑块颜色",
              v: "ffffff"
            },
            onBg: {
              t: "color",
              d: "开启背景色",
              v: "166d3b"
            },
            offBg: {
              t: "color",
              d: "关闭背景色",
              v: "333333"
            },
            borderColor: {
              t: "color",
              d: "边框颜色",
              v: "444444"
            },
            onValue: {
              t: "input",
              d: "开启时值",
              v: "on"
            },
            offValue: {
              t: "input",
              d: "关闭时值",
              v: "off"
            },
            defaultOn: {
              t: "toggle",
              d: "默认开启"
            }
          }
        },
        "collapse": {
          name: "折叠项",
          props: {
            title: {
              t: "input",
              d: "标题文字",
              v: "点击展开"
            },
            titleSize: {
              t: "slider",
              r: "10-24",
              d: "标题字号",
              v: 14
            },
            titleColor: {
              t: "color",
              d: "标题颜色",
              v: "ffffff"
            },
            titleBold: {
              t: "toggle",
              d: "标题加粗"
            },
            titleBg: {
              t: "color",
              d: "标题背景色",
              v: "1a1a1a"
            },
            arrowColor: {
              t: "color",
              d: "箭头颜色",
              v: "888888"
            },
            contentBg: {
              t: "color",
              d: "内容背景色",
              v: "0d0d0d"
            },
            defaultOpen: {
              t: "toggle",
              d: "默认展开"
            }
          }
        },
        "row": {
          name: "多列",
          props: {
            valign: {
              t: "select",
              r: self.valigns,
              d: "垂直对齐",
              v: "center"
            },
            heightBind: {
              t: "grp",
              g: "row",
              d: "高度绑定组"
            }
          }
        }
      };
      self.loadFS(d);
      document.addEventListener('click', function(e) {
        var t = e.target;
        if (t.closest('.ed-proj')) {
          var el = t.closest('.ed-proj');
          if (el.dataset.id) self.loadP(el.dataset.id);
          else if (el.dataset.pg !== undefined) {
            var newPg = parseInt(el.dataset.pg);
            if (newPg !== self.pg) {
              self.pg = newPg;
              self.sel = null;
              self.curApp = null;
              self.zone = 'content';
              self.save();
              self.render()
            }
          }
        }
        if (t.closest('.ed-tab')) {
          var nt = parseInt(t.closest('.ed-tab').dataset.t);
          if (nt !== self.tab) {
            var dir = nt > self.tab ? 'l' : 'r';
            self.tab = nt;
            self.rowSel = null;
            self.slideR(dir)
          }
        }
        if (t.closest('.ed-ltab')) {
          var nt = parseInt(t.closest('.ed-ltab').dataset.lt);
          if (nt !== self.listTab) {
            var dir = nt > self.listTab ? 'l' : 'r';
            self.listTab = nt;
            self.slideL(dir)
          }
        }
        if (t.closest('.ed-close')) {
          if (self.preview) {
            self.togglePreview();
            return
          }
          self.list = false;
          self.renderL()
        }
        if (t.id === 'newPgBtn') self.newPg();
        if (t.id === 'delPgBtn') self.delPg();
        if (t.closest('.add-col-btn')) self.addCol();
        if (t.closest('.del-col-btn')) {
          var ci = parseInt(t.closest('.del-col-btn').dataset.ci);
          self.delCol(ci)
        }
        if (t.closest('.col-mode-opt')) {
          var opt = t.closest('.col-mode-opt');
          var ci = parseInt(opt.parentElement.dataset.ci);
          var mode = opt.dataset.mode;
          self.setColMode(ci, mode)
        }
      });
      document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        var p = e.target.closest('.ed-proj');
        if (p) {
          self.showCtx(e.clientX, e.clientY, p.dataset.id);
          return
        }
        var lh = e.target.closest('.ed-hd');
        if (lh) {
          self.showCtx(e.clientX, e.clientY, null);
          return
        }
        var el = e.target.closest('.ed-el');
        if (el) {
          self.zone = el.dataset.zone || 'content';
          self.showElCtx(e.clientX, e.clientY, parseInt(el.dataset.idx));
          return
        }
        self.showGlobalCtx(e.clientX, e.clientY)
      });
      document.addEventListener('click', function(e) {
        if (e.target.closest('#ed-panel') || e.target.closest('.ed-menu')) return;
        if (self.moveMode && !e.target.closest('.ed-ph')) {
          self.moveMode = false;
          self.hiSel();
          return
        }
        var clickables = [];
        var col = e.target.closest('.ed-col');
        var el = e.target.closest('.ed-el');
        if (col) clickables.push({type:'col', el:col, ei:parseInt(col.dataset.ei), ci:parseInt(col.dataset.ci), zone:col.dataset.zone||'content'});
        if (el) clickables.push({type:'el', el:el, idx:parseInt(el.dataset.idx), zone:el.dataset.zone||'content'});
        if (clickables.length === 0) return;
        var pos = e.clientX + ',' + e.clientY;
        if (self.lastClickPos === pos && clickables.length > 1) {
          self.clickIdx = (self.clickIdx + 1) % clickables.length
        } else {
          self.clickIdx = 0;
          self.lastClickPos = pos
        }
        var item = clickables[self.clickIdx];
        if (item.type === 'col') {
          self.multiSel = [];
          self.selCol(item.ei, item.ci, item.zone);
          self.showStatus('多列 - 列' + (item.ci + 1))
        } else {
          self.selEl(item.idx, e.shiftKey, item.zone);
          var pg = self.pj[self.cur]?.data?.pages?.[self.pg];
          var els = self.getEls(item.zone);
          var elData = els[item.idx];
          if (elData) {
            var cfg = self.cfg[elData.type];
            self.showStatus(cfg ? cfg.name : elData.type)
          }
        }
      });
      document.getElementById('ed-version').textContent = 'v' + (L.version || '1.0.0');
      document.getElementById('edList').onclick = function() {
        self.list = !self.list;
        self.renderL()
      };
      document.getElementById('edUndo').onclick = function() {
        self.undo()
      };
      document.getElementById('edRedo').onclick = function() {
        self.redo()
      };
      document.getElementById('edCopy').onclick = function() {
        self.copy()
      };
      document.getElementById('edSave').onclick = function() {
        self.download()
      };
      document.getElementById('edPc').onclick = function() {
        self.setDevice('pc')
      };
      document.getElementById('edMobile').onclick = function() {
        self.setDevice('mobile')
      };
      document.getElementById('edPreview').onclick = function() {
        self.togglePreview()
      };
      document.getElementById('edGallery').onclick = function() {
        G.open()
      };
      window.addEventListener('message', function(e) {
        if (e.data && e.data.t === 'exitPreview' && self.preview) self.togglePreview()
      });
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && self.preview) {
          self.togglePreview();
          return
        }
        if (e.ctrlKey && e.key === 'z') {
          e.preventDefault();
          self.undo()
        } else if (e.ctrlKey && e.key === 'y') {
          e.preventDefault();
          self.redo()
        } else if (e.ctrlKey && e.key === 's') {
          e.preventDefault();
          self.copy()
        }
      });
      document.addEventListener('dragstart', function(e) {
        var dr = e.target.closest('.ed-drag');
        if (dr && dr.dataset.type) {
          self.dragType = dr.dataset.type;
          e.dataTransfer.effectAllowed = 'copy'
        }
      });
      document.addEventListener('dragover', function(e) {
        if (!self.dragType && !self.dragEl) return;
        var root = document.getElementById('root');
        if (!root) return;
        var rr = root.getBoundingClientRect();
        var inModal = e.clientX >= rr.left && e.clientX <= rr.right && e.clientY >= rr.top && e.clientY <= rr.bottom;
        document.querySelectorAll('.collapse-drop,.ed-col').forEach(function(d) {
          d.classList.remove('drag-over')
        });
        if (!inModal) {
          document.querySelectorAll('.ed-drop').forEach(function(d) {
            d.remove()
          });
          return
        }
        var cd = document.elementFromPoint(e.clientX, e.clientY);
        if (cd) {
          var cdp = cd.closest('.collapse-drop');
          if (cdp) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            cdp.classList.add('drag-over');
            document.querySelectorAll('.ed-drop').forEach(function(d) {
              d.remove()
            });
            return
          }
          var edc = cd.closest('.ed-col');
          if (edc && self.dragType) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            edc.classList.add('drag-over');
            document.querySelectorAll('.ed-drop').forEach(function(d) {
              d.remove()
            });
            return
          }
        }
        var zones = ['modal-header', 'modal-content', 'modal-footer'];
        var zone = null,
          container = null;
        for (var i = 0; i < zones.length; i++) {
          var z = document.querySelector('.' + zones[i]);
          if (z) {
            var r = z.getBoundingClientRect();
            if (e.clientY >= r.top && e.clientY <= r.bottom) {
              zone = z.dataset.zone;
              container = z;
              break
            }
          }
        }
        if (!container) {
          document.querySelectorAll('.ed-drop').forEach(function(d) {
            d.remove()
          });
          return
        }
        e.preventDefault();
        e.dataTransfer.dropEffect = self.dragEl ? 'move' : 'copy';
        var els = Array.from(container.children).filter(function(c) {
          return c.classList.contains('ed-el')
        });
        var pos = els.length;
        for (var i = 0; i < els.length; i++) {
          var rect = els[i].getBoundingClientRect();
          if (e.clientY < rect.top + rect.height / 2) {
            pos = i;
            break
          }
        }
        var dp = document.querySelector('.ed-drop');
        if (!dp) {
          dp = document.createElement('div');
          dp.className = 'ed-drop'
        }
        dp.dataset.pos = pos;
        dp.dataset.zone = zone;
        if (self.dragType) dp.dataset.type = self.dragType;
        self.dragZone = zone;
        if (pos < els.length) container.insertBefore(dp, els[pos]);
        else container.appendChild(dp)
      });
      document.addEventListener('drop', function(e) {
        if (!self.dragType && !self.dragEl) return;
        e.preventDefault();
        var dp = document.querySelector('.ed-drop');
        if (self.dragEl && dp) {
          self.moveElTo(self.dragEl.idx, self.dragEl.zone, parseInt(dp.dataset.pos), dp.dataset.zone)
        } else if (self.dragType) {
          var cd = e.target.closest('.collapse-drop');
          var ec = e.target.closest('.ed-col');
          if (cd) {
            var wrap = cd.closest('.ed-el');
            if (wrap) {
              var idx = parseInt(wrap.dataset.idx),
                zone = wrap.dataset.zone || 'content';
              self.addToCollapse(self.dragType, idx, zone)
            }
          } else if (ec) {
            var ei = parseInt(ec.dataset.ei),
              ci = parseInt(ec.dataset.ci),
              zone = ec.closest('.ed-el').dataset.zone || 'content';
            self.replaceCol(self.dragType, ei, ci, zone)
          } else if (dp) {
            self.addAt(self.dragType, parseInt(dp.dataset.pos), dp.dataset.zone)
          }
        }
        self.dragType = null;
        self.dragEl = null;
        self.dragZone = null;
        document.querySelectorAll('.ed-drop').forEach(function(d) {
          d.remove()
        })
      });
      document.addEventListener('dragend', function() {
        self.dragType = null;
        self.dragEl = null;
        document.querySelectorAll('.ed-drop').forEach(function(d) {
          d.remove()
        });
        document.querySelectorAll('.collapse-drop,.ed-col').forEach(function(d) {
          d.classList.remove('drag-over')
        })
      });
      document.getElementById('root').style.marginRight = '280px';
      setInterval(function() {
        if (self.cur) self.saveFS()
      }, 5000);
      window.addEventListener('beforeunload', function() {
        if (self.cur) {
          localStorage.setItem('d_pj', JSON.stringify(self.pj));
          localStorage.setItem('d_cur', self.cur)
        }
      });
    },
    loadFS: async function(d) {
      var self = this;
      var pjStr = await FS.read('d_pj');
      var curStr = await FS.read('d_cur');
      if (!pjStr) pjStr = localStorage.getItem('d_pj');
      if (!curStr) curStr = localStorage.getItem('d_cur');
      try {
        self.pj = JSON.parse(pjStr || '{}')
      } catch (e) {
        self.pj = {}
      }
      self.cur = curStr || null;
      if (self.cur && !self.pj[self.cur]) self.cur = null;
      if (!self.cur && Object.keys(self.pj).length) self.cur = Object.keys(self.pj)[0];
      if (!self.cur) {
        self.cur = 'p' + Date.now();
        self.pj[self.cur] = {
          name: '默认项目',
          data: d
        };
        self.save()
      } else if (d && d.pages) self.pj[self.cur].data = d;
      if (self.cur) {
        self.hist = [JSON.stringify(self.pj[self.cur].data)];
        self.histIdx = 0
      }
      self.render()
    },
    saveFS: async function() {
      if (!this.cur) return;
      await FS.write('d_pj', JSON.stringify(this.pj));
      await FS.write('d_cur', this.cur)
    },
    save: function(noHist) {
      var self = this;
      this.saveFS();
      localStorage.setItem('d_pj', JSON.stringify(this.pj));
      localStorage.setItem('d_cur', this.cur || '');
      if (!noHist && this.cur) {
        var s = JSON.stringify(this.pj[this.cur].data);
        if (this.hist.length === 0 || this.hist[this.histIdx] !== s) {
          this.hist = this.hist.slice(0, this.histIdx + 1);
          this.hist.push(s);
          this.histIdx = this.hist.length - 1;
          if (this.hist.length > 50) {
            this.hist.shift();
            this.histIdx--
          }
        }
      }
      if (this.cur) {
        var d = this.pj[this.cur].data,
          pg = d && d.pages && d.pages[this.pg];
        if (pg && pg.type === 'phone') {
          if (window.phoneRender) window.phoneRender(pg)
        } else {
          if (window.modalRender) window.modalRender(d)
        }
        setTimeout(function() {
          self.hiSel()
        }, 0)
      }
    },
    undo: function() {
      if (this.histIdx > 0 && this.cur) {
        this.histIdx--;
        this.pj[this.cur].data = JSON.parse(this.hist[this.histIdx]);
        this.sel = null;
        this.rowSel = null;
        this.saveFS();
        this.render();
        var d = this.pj[this.cur].data,
          pg = d && d.pages && d.pages[this.pg];
        if (pg && pg.type === 'phone') {
          if (window.phoneRender) window.phoneRender(pg)
        } else {
          if (window.modalRender) window.modalRender(d)
        }
      }
    },
    redo: function() {
      if (this.histIdx < this.hist.length - 1 && this.cur) {
        this.histIdx++;
        this.pj[this.cur].data = JSON.parse(this.hist[this.histIdx]);
        this.sel = null;
        this.rowSel = null;
        this.saveFS();
        this.render();
        var d = this.pj[this.cur].data,
          pg = d && d.pages && d.pages[this.pg];
        if (pg && pg.type === 'phone') {
          if (window.phoneRender) window.phoneRender(pg)
        } else {
          if (window.modalRender) window.modalRender(d)
        }
      }
    },
    newP: function(name) {
      var id = 'p' + Date.now();
      this.pj[id] = {
        name: name || '新项目',
        data: {
          global: {
            bgColor: '050505',
            defModalBg: '0d0d0d',
            defBtnBg: '166d3b',
            defTextColor: '888888',
            defBtnColor: 'ffffff'
          },
          pages: [{
            title: '对话框1',
            type: 'modal',
            elements: []
          }]
        }
      };
      this.cur = id;
      this.pg = 0;
      this.sel = null;
      this.save();
      this.render()
    },
    delP: function(id) {
      if (!id || !this.pj[id]) return;
      delete this.pj[id];
      if (this.cur === id) {
        this.cur = Object.keys(this.pj)[0] || null;
        this.pg = 0;
        this.sel = null
      }
      this.save();
      this.render()
    },
    renP: function(id, name) {
      if (id && this.pj[id]) {
        this.pj[id].name = name;
        this.save();
        this.renderL()
      }
    },
    loadP: function(id) {
      if (this.pj[id]) {
        this.cur = id;
        this.pg = 0;
        this.sel = null;
        this.zone = 'content';
        this.tab = 0;
        this.listTab = 1;
        this.save();
        this.render()
      }
    },
    newPg: function(type) {
      if (!this.cur) return;
      var d = this.pj[this.cur].data;
      if (type === 'phone') {
        d.pages.push({
          title: '手机' + (d.pages.length + 1),
          type: 'phone',
          apps: {
            setting: {
              enabled: true,
              items: []
            },
            map: {
              enabled: true,
              bgImage: '',
              markers: []
            },
            album: {
              enabled: true,
              photos: []
            },
            camera: {
              enabled: true,
              frameImage: ''
            },
            calendar: {
              enabled: true,
              marked: [],
              events: {}
            },
            browser: {
              enabled: true,
              url: '',
              screenshot: ''
            },
            backpack: {
              enabled: true,
              cols: 4,
              rows: 6,
              items: []
            },
            warehouse: {
              enabled: true,
              cols: 6,
              rows: 8,
              items: []
            },
            wechat: {
              enabled: true,
              chats: []
            },
            brainwash: {
              enabled: true,
              texts: [],
              speed: 2,
              effect: 'scroll'
            },
            database: {
              enabled: true,
              categories: []
            },
            clock: {
              enabled: true,
              mode: 'realtime',
              fixedTime: '12:00'
            },
            mail: {
              enabled: true,
              mails: []
            },
            phone: {
              enabled: true,
              contacts: []
            },
            wallet: {
              enabled: true,
              balance: 0,
              currency: '金币',
              transactions: []
            }
          }
        })
      } else {
        d.pages.push({
          title: '对话框' + (d.pages.length + 1),
          type: 'modal',
          elements: []
        })
      }
      this.pg = d.pages.length - 1;
      this.sel = null;
      this.curApp = null;
      this.zone = 'content';
      this.save();
      this.render()
    },
    delPg: function() {
      if (!this.cur) return;
      var d = this.pj[this.cur].data;
      if (d.pages.length <= 1) return;
      d.pages.splice(this.pg, 1);
      if (this.pg >= d.pages.length) this.pg = d.pages.length - 1;
      this.sel = null;
      this.zone = 'content';
      this.save();
      this.render()
    },
    add: function(type) {
      if (!this.cur) return;
      var d = this.pj[this.cur].data;
      if (!d || !d.pages || !d.pages[this.pg]) return;
      var els = d.pages[this.pg].elements;
      var el = {
        type: type
      };
      var cfg = this.cfg[type];
      if (cfg && cfg.props) Object.keys(cfg.props).forEach(function(k) {
        if (cfg.props[k].v !== undefined) el[k] = cfg.props[k].v
      });
      if (type === 'row') {
        var ratio = (el.ratio || '1:1').split(':').map(function(x) {
          return parseInt(x) || 1
        });
        el.cols = ratio.map(function() {
          return {type: 'placeholder'}
        })
      }
      els.push(el);
      this.sel = els.length - 1;
      this.tab = 2;
      this.save();
      this.renderR()
    },
    addAt: function(type, pos, zone) {
      if (!this.cur) return;
      var d = this.pj[this.cur].data;
      if (!d || !d.pages || !d.pages[this.pg]) return;
      var pg = d.pages[this.pg];
      zone = zone || 'content';
      var key = zone === 'header' ? 'headerElements' : (zone === 'footer' ? 'footerElements' : 'elements');
      if (!pg[key]) pg[key] = [];
      var els = pg[key];
      var el = {
        type: type
      };
      var cfg = this.cfg[type];
      if (cfg && cfg.props) Object.keys(cfg.props).forEach(function(k) {
        if (cfg.props[k].v !== undefined) el[k] = cfg.props[k].v
      });
      if (type === 'row') {
        el.ratio = [1, 1];
        el.cols = [{type: 'placeholder'}, {type: 'placeholder'}]
      }
      els.splice(pos, 0, el);
      this.sel = pos;
      this.zone = zone;
      this.tab = 2;
      this.save();
      this.renderR()
    },
    addToCollapse: function(type, idx, zone) {
      if (!this.cur) return;
      var pg = this.pj[this.cur].data.pages[this.pg];
      if (!pg) return;
      var key = zone === 'header' ? 'headerElements' : (zone === 'footer' ? 'footerElements' : 'elements');
      var els = pg[key] || [];
      var col = els[idx];
      if (!col || col.type !== 'collapse') return;
      if (!col.items) col.items = [];
      var el = {
        type: type
      };
      var cfg = this.cfg[type];
      if (cfg && cfg.props) Object.keys(cfg.props).forEach(function(k) {
        if (cfg.props[k].v !== undefined) el[k] = cfg.props[k].v
      });
      col.items.push(el);
      this.save();
      this.renderR()
    },
    replaceCol: function(type, ei, ci, zone) {
      if (!this.cur) return;
      var pg = this.pj[this.cur].data.pages[this.pg];
      if (!pg) return;
      var key = zone === 'header' ? 'headerElements' : (zone === 'footer' ? 'footerElements' : 'elements');
      var els = pg[key] || [];
      var row = els[ei];
      if (!row || row.type !== 'row' || !row.cols) return;
      var el = {
        type: type
      };
      var cfg = this.cfg[type];
      if (cfg && cfg.props) Object.keys(cfg.props).forEach(function(k) {
        if (cfg.props[k].v !== undefined) el[k] = cfg.props[k].v
      });
      row.cols[ci] = el;
      this.sel = ei;
      this.rowSel = ci;
      this.zone = zone;
      this.tab = 2;
      this.save();
      this.renderR()
    },
    getEls: function(zone) {
      var pg = this.pj[this.cur].data.pages[this.pg];
      if (!pg) return [];
      var key = zone === 'header' ? 'headerElements' : (zone === 'footer' ? 'footerElements' : 'elements');
      return pg[key] || []
    },
    del: function() {
      if (!this.cur || this.sel === null) return;
      var pg = this.pj[this.cur].data.pages[this.pg];
      if (!pg) return;
      var key = this.zone === 'header' ? 'headerElements' : (this.zone === 'footer' ? 'footerElements' : 'elements');
      if (!pg[key]) return;
      pg[key].splice(this.sel, 1);
      this.sel = null;
      this.save();
      this.renderR()
    },
    addCol: function() {
      if (!this.cur || this.sel === null) return;
      var els = this.getEls(this.zone);
      var el = els[this.sel];
      if (!el || el.type !== 'row') return;
      var ratio = Array.isArray(el.ratio) ? el.ratio : (el.ratio || '1').split(':').map(function(x) {
        return parseInt(x) || 1
      });
      ratio.push(1);
      el.ratio = ratio;
      if (!el.cols) el.cols = [];
      el.cols.push({type: 'placeholder'});
      this.save();
      this.renderR()
    },
    delCol: function(ci) {
      if (!this.cur || this.sel === null) return;
      var els = this.getEls(this.zone);
      var el = els[this.sel];
      if (!el || el.type !== 'row' || !el.cols || el.cols.length <= 1) return;
      var ratio = Array.isArray(el.ratio) ? el.ratio : (el.ratio || '1').split(':').map(function(x) {
        return parseInt(x) || 1
      });
      ratio.splice(ci, 1);
      el.ratio = ratio;
      el.cols.splice(ci, 1);
      if (this.rowSel === ci) this.rowSel = null;
      else if (this.rowSel > ci) this.rowSel--;
      this.save();
      this.renderR()
    },
    clearCol: function() {
      if (!this.cur || this.sel === null || this.rowSel === null) return;
      var els = this.getEls(this.zone);
      var el = els[this.sel];
      if (!el || el.type !== 'row' || !el.cols || !el.cols[this.rowSel]) return;
      el.cols[this.rowSel] = {type: 'placeholder'};
      this.save();
      this.renderR()
    },
    setColMode: function(ci, mode) {
      if (!this.cur || this.sel === null) return;
      var els = this.getEls(this.zone);
      var el = els[this.sel];
      if (!el || el.type !== 'row') return;
      if (!el.colMode) el.colMode = [];
      el.colMode[ci] = mode;
      this.save();
      this.renderR()
    },
    setColPriority: function(priority) {
      if (!this.cur || this.sel === null) return;
      var els = this.getEls(this.zone);
      var el = els[this.sel];
      if (!el || el.type !== 'row') return;
      el.colPriority = priority;
      this.save();
      this.renderR()
    },
    showCtx: function(x, y, id) {
      var old = document.querySelector('.ed-ctx');
      if (old) old.remove();
      var m = document.createElement('div');
      m.className = 'ed-ctx';
      m.style.left = x + 'px';
      m.style.top = y + 'px';
      var self = this;
      if (id) m.innerHTML = '<div data-a="ren">重命名</div><div data-a="del">删除</div>';
      else m.innerHTML = '<div data-a="new">新建项目</div>';
      m.onclick = function(e) {
        var a = e.target.dataset.a;
        if (a === 'new') {
          var n = prompt('项目名称', '新项目');
          if (n) self.newP(n)
        }
        if (a === 'ren') {
          var n = prompt('新名称', self.pj[id].name);
          if (n) self.renP(id, n)
        }
        if (a === 'del') {
          if (confirm('确定删除?')) self.delP(id)
        }
        m.remove()
      };
      document.body.appendChild(m);
      setTimeout(function() {
        document.addEventListener('click', function h() {
          m.remove();
          document.removeEventListener('click', h)
        })
      }, 10)
    },
    showGlobalCtx: function(x, y) {
      var old = document.querySelector('.ed-ctx');
      if (old) old.remove();
      var m = document.createElement('div');
      m.className = 'ed-ctx';
      m.style.left = x + 'px';
      m.style.top = y + 'px';
      var self = this;
      m.innerHTML = '<div data-a="undo">撤回 (Ctrl+Z)</div><div data-a="redo">重做 (Ctrl+Y)</div><div data-a="preview">全屏预览</div><div data-a="copy">复制项目 (Ctrl+S)</div><div data-a="download">下载项目</div><div data-a="import">导入项目</div>';
      m.onclick = function(e) {
        switch (e.target.dataset.a) {
          case 'undo': self.undo(); break;
          case 'redo': self.redo(); break;
          case 'preview': self.togglePreview(); break;
          case 'copy': self.copy(); break;
          case 'download': self.download(); break;
          case 'import': self.importData(); break;
        }
        m.remove()
      };
      document.body.appendChild(m);
      setTimeout(function() {
        document.addEventListener('click', function h() {
          m.remove();
          document.removeEventListener('click', h)
        })
      }, 10)
    },
    importData: function() {
      var self = this;
      var inp = prompt('粘贴导出的内容');
      if (!inp || !inp.trim()) return;
      inp = inp.trim();
      var match = inp.match(/\[([^\]]+):([^;]*);([^;]*);([^\]]+)\]/);
      if (!match) {
        alert('格式无效');
        return
      }
      try {
        var d = JSON.parse(LZS.d(match[4].slice(1)));
        if (!d || !d.pages) throw new Error('');
        if (this.cur) {
          this.pj[this.cur].data = d;
          this.save()
        }
      } catch (e) {
        alert('导入失败');
      }
    },
    showStatus: function(text) {
      if (this.statusEl) this.statusEl.remove();
      var s = document.createElement('div');
      s.className = 'ed-status';
      s.textContent = '当前选中: ' + text;
      document.body.appendChild(s);
      this.statusEl = s;
      var self = this;
      setTimeout(function() {
        if (self.statusEl === s) {
          s.remove();
          self.statusEl = null
        }
      }, 2000)
    },
    selEl: function(idx, shift, zone) {
      if (shift) {
        var i = this.multiSel.indexOf(idx);
        if (i === -1) this.multiSel.push(idx);
        else this.multiSel.splice(i, 1);
        this.hiSel();
        return
      }
      this.multiSel = [];
      this.sel = idx;
      this.zone = zone || 'content';
      this.rowSel = null;
      this.tab = 2;
      this.renderR();
      this.hiSel()
    },
    selCol: function(ei, ci, zone) {
      this.sel = ei;
      this.zone = zone || 'content';
      this.rowSel = ci;
      this.tab = 2;
      this.renderR();
      this.hiSel()
    },
    showElCtx: function(x, y, idx) {
      var old = document.querySelector('.ed-ctx');
      if (old) old.remove();
      var m = document.createElement('div');
      m.className = 'ed-ctx';
      m.style.left = x + 'px';
      m.style.top = y + 'px';
      var self = this,
        h = '',
        sels = this.multiSel.length ? this.multiSel : [idx];
      if (sels.length > 1) {
        var pg = this.pj[this.cur].data.pages[this.pg];
        if (!pg || !pg.elements) {
          m.remove();
          return
        }
        var types = sels.map(function(i) {
          return pg.elements[i]?.type
        });
        var allBtn = types.every(function(t) {
          return t === 'btn'
        });
        var allRow = types.every(function(t) {
          return t === 'row'
        });
        if (allBtn) {
          h += '<div data-a="lockW">锁定所有按钮宽度</div>';
          h += '<div data-a="lockH">锁定所有按钮高度</div>';
          h += '<div data-a="lockS">锁定所有按钮尺寸</div>'
        }
        if (allRow) h += '<div data-a="lockRH">锁定所有行高</div>';
        h += '<div data-a="delAll">' + this.icon('trash') + ' 删除所有</div>'
      } else h = '<div data-a="del">' + this.icon('trash') + ' 删除</div>';
      m.innerHTML = h;
      m.onclick = function(e) {
        switch (e.target.closest('[data-a]')?.dataset.a) {
          case 'del': self.sel = idx; self.del(); break;
          case 'delAll': self.delMulti(); break;
          case 'lockW': self.lockMulti('width'); break;
          case 'lockH': self.lockMulti('height'); break;
          case 'lockS': self.lockMulti('size'); break;
          case 'lockRH': self.lockMulti('rowHeight'); break;
        }
        m.remove()
      };
      document.body.appendChild(m);
      setTimeout(function() {
        document.addEventListener('click', function h() {
          m.remove();
          document.removeEventListener('click', h)
        })
      }, 10)
    },
    hiSel: function() {
      var self = this;
      document.querySelectorAll('.ed-move').forEach(function(m) {
        m.remove()
      });
      document.querySelectorAll('.ed-ph').forEach(function(p) {
        p.remove()
      });
      document.querySelectorAll('.ed-el').forEach(function(el) {
        var i = parseInt(el.dataset.idx);
        var z = el.dataset.zone || 'content';
        var isSel = (i === self.sel && z === self.zone && self.rowSel === null) || self.multiSel.indexOf(i) !== -1;
        el.classList.toggle('ed-sel', isSel);
        if (i === self.sel && z === self.zone && self.rowSel === null && !self.moveMode) {
          el.style.position = 'relative';
          var mv = document.createElement('div');
          mv.className = 'ed-move';
          mv.innerHTML = self.icon('move');
          mv.draggable = true;
          mv.ondragstart = function(e) {
            e.stopPropagation();
            self.dragEl = {
              idx: i,
              zone: z
            };
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', '')
          };
          el.appendChild(mv)
        }
      });
      document.querySelectorAll('.ed-col').forEach(function(c) {
        var z = c.dataset.zone || 'content';
        c.classList.toggle('ed-sel', parseInt(c.dataset.ei) === self.sel && z === self.zone && parseInt(c.dataset.ci) === self.rowSel)
      })
    },
    startMove: function() {
      var self = this;
      this.moveMode = true;
      document.querySelectorAll('.ed-move').forEach(function(m) {
        m.remove()
      });
      document.querySelectorAll('.ed-el').forEach(function(el) {
        var i = parseInt(el.dataset.idx);
        if (i === self.sel) return;
        var ph = document.createElement('div');
        ph.className = 'ed-ph';
        ph.dataset.pos = i;
        el.parentNode.insertBefore(ph, el);
        ph.onclick = function(e) {
          e.stopPropagation();
          self.moveTo(i)
        }
      });
      var last = document.querySelector('.ed-el:last-child');
      if (last) {
        var pg = this.pj[this.cur].data.pages[this.pg];
        var ph = document.createElement('div');
        ph.className = 'ed-ph';
        ph.dataset.pos = pg.elements.length;
        last.parentNode.appendChild(ph);
        ph.onclick = function(e) {
          e.stopPropagation();
          self.moveTo(pg.elements.length)
        }
      }
    },
    moveTo: function(pos) {
      if (!this.cur || this.sel === null) return;
      var pg = this.pj[this.cur].data.pages[this.pg];
      if (!pg || !pg.elements) return;
      var el = pg.elements.splice(this.sel, 1)[0];
      if (pos > this.sel) pos--;
      pg.elements.splice(pos, 0, el);
      this.sel = pos;
      this.moveMode = false;
      this.save();
      this.hiSel()
    },
    moveElTo: function(fi, fz, ti, tz) {
      if (!this.cur) return;
      var pg = this.pj[this.cur].data.pages[this.pg];
      if (!pg) return;
      var fk = fz === 'header' ? 'headerElements' : (fz === 'footer' ? 'footerElements' : 'elements');
      var tk = tz === 'header' ? 'headerElements' : (tz === 'footer' ? 'footerElements' : 'elements');
      var fa = pg[fk] || [],
        ta = pg[tk] || [];
      var el = fa.splice(fi, 1)[0];
      if (!el) return;
      if (fk === tk && ti > fi) ti--;
      ta.splice(ti, 0, el);
      pg[fk] = fa;
      pg[tk] = ta;
      this.sel = ti;
      this.zone = tz;
      this.save();
      this.hiSel()
    },
    moveElTo: function(srcIdx, srcZone, dstPos, dstZone) {
      if (!this.cur) return;
      var pg = this.pj[this.cur].data.pages[this.pg];
      if (!pg) return;
      var srcKey = srcZone === 'header' ? 'headerElements' : (srcZone === 'footer' ? 'footerElements' : 'elements');
      var dstKey = dstZone === 'header' ? 'headerElements' : (dstZone === 'footer' ? 'footerElements' : 'elements');
      if (!pg[srcKey]) return;
      var el = pg[srcKey].splice(srcIdx, 1)[0];
      if (!el) return;
      if (!pg[dstKey]) pg[dstKey] = [];
      if (srcKey === dstKey && dstPos > srcIdx) dstPos--;
      pg[dstKey].splice(dstPos, 0, el);
      this.sel = dstPos;
      this.zone = dstZone;
      this.save();
      this.hiSel()
    },
    render: function() {
      this.renderL();
      this.renderR()
    },
    slideR: function(dir) {
      var self = this,
        p = document.getElementById('ed-body');
      p.classList.add('slide-' + dir);
      setTimeout(function() {
        self.renderR();
        p.classList.remove('slide-' + dir)
      }, 150)
    },
    slideL: function(dir) {
      var self = this,
        p = document.getElementById('ed-lbody');
      if (!p) return self.renderLContent();
      p.classList.add('slide-' + dir);
      setTimeout(function() {
        self.renderLContent();
        p.classList.remove('slide-' + dir)
      }, 150)
    },
    renderLContent: function() {
      var self = this,
        h = '',
        d = this.cur ? this.pj[this.cur].data : null;
      if (this.listTab === 0) {
        Object.keys(this.pj).forEach(function(id) {
          h += '<div class="ed-proj' + (self.cur === id ? ' on' : '') + '" data-id="' + id + '">' + U.esc(self.pj[id].name) + '</div>'
        })
      } else if (this.cur && d && d.pages) {
        d.pages.forEach(function(p, i) {
          h += '<div class="ed-proj' + (self.pg === i ? ' on' : '') + '" data-pg="' + i + '">' + U.esc(p.title || (p.type === 'phone' ? '手机' : '对话框') + (i + 1)) + '</div>'
        })
      }
      var lb = document.getElementById('ed-lbody');
      if (lb) lb.innerHTML = h;
      document.querySelectorAll('.ed-ltab').forEach(function(t) {
        t.classList.toggle('on', parseInt(t.dataset.lt) === self.listTab)
      })
    },
    renderL: function() {
      var self = this,
        h = '<div class="ed-ltabs"><div class="ed-ltab' + (this.listTab === 0 ? ' on' : '') + '" data-lt="0">项目</div><div class="ed-ltab' + (this.listTab === 1 ? ' on' : '') + '" data-lt="1">页面</div><button class="ed-ladd" id="edLAdd">' + this.icon('plus') + '</button></div><div class="ed-lbody" id="ed-lbody"></div>';
      document.getElementById('ed-list').innerHTML = h;
      this.renderLContent();
      document.getElementById('ed-list').classList.toggle('open', this.list);
      document.querySelector('.ed-menu').classList.toggle('shifted', this.list);
      var cb = document.querySelector('.ed-close');
      if (cb) cb.classList.toggle('shifted', this.list);
      document.getElementById('edLAdd').onclick = function(e) {
        self.showAddMenu(e.clientX, e.clientY)
      }
    },
    showAddMenu: function(x, y) {
      var old = document.querySelector('.ed-ctx');
      if (old) old.remove();
      var m = document.createElement('div');
      m.className = 'ed-ctx';
      m.style.left = x + 'px';
      m.style.top = y + 'px';
      var self = this;
      if (this.listTab === 0) m.innerHTML = '<div data-a="proj">新建项目</div>';
      else m.innerHTML = '<div data-a="page">新建对话框</div><div data-a="phone">新建手机界面</div>';
      m.onclick = function(e) {
        switch (e.target.dataset.a) {
          case 'proj': var n = prompt('项目名称', '新项目'); if (n) self.newP(n); break;
          case 'page': self.newPg('modal'); break;
          case 'phone': self.newPg('phone'); break;
        }
        m.remove()
      };
      document.body.appendChild(m);
      setTimeout(function() {
        document.addEventListener('click', function h() {
          m.remove();
          document.removeEventListener('click', h)
        })
      }, 10)
    },
    renderR: function() {
      var p = document.getElementById('ed-body'),
        d = this.cur ? this.pj[this.cur].data : null,
        pg = d && d.pages && d.pages[this.pg],
        isPhone = pg && pg.type === 'phone';
      var openFolds = [];
      document.querySelectorAll('.ed-fold-hd.open').forEach(function(hd, i) {
        openFolds.push(i)
      });
      var tabs = document.querySelectorAll('.ed-tab');
      var chatEnabled = L.roleId === '174750' || L.roleId === '230974';
      tabs.forEach(function(t) {
        t.classList.toggle('on', parseInt(t.dataset.t) === this.tab);
        if (t.dataset.t === '1') t.textContent = isPhone ? '应用' : '模块';
        if (t.dataset.t === '4') t.classList.toggle('disabled', !chatEnabled)
      }, this);
      switch (this.tab) {
        case 0: p.innerHTML = this.renderWin(); break;
        case 1: p.innerHTML = this.renderMod(); break;
        case 2: p.innerHTML = this.renderStyle(); break;
        case 3: p.innerHTML = this.renderLock(); break;
        case 4: p.innerHTML = this.renderChat(); break;
        default: p.innerHTML = this.renderSys();
      }
      this.bindR();
      openFolds.forEach(function(i) {
        var hds = document.querySelectorAll('.ed-fold-hd');
        if (hds[i]) {
          hds[i].classList.add('open');
          var bd = hds[i].nextElementSibling;
          if (bd) bd.classList.add('open')
        }
      });
      this.updateScrollbar()
    },
    updateScrollbar: function() {
      var p = document.getElementById('ed-body');
      if (!p) return;
      var sb = document.getElementById('edScrollbar');
      if (!sb) {
        var panel = document.getElementById('ed-panel');
        sb = document.createElement('div');
        sb.id = 'edScrollbar';
        sb.className = 'ed-scrollbar';
        sb.innerHTML = '<div class="ed-scrollbar-thumb" id="edScrollThumb"></div>';
        panel.appendChild(sb)
      }
      var thumb = document.getElementById('edScrollThumb');
      var self = this;
      var update = function() {
        var sh = p.scrollHeight, ch = p.clientHeight, st = p.scrollTop;
        if (sh <= ch) {
          thumb.style.display = 'none';
          return
        }
        thumb.style.display = 'block';
        var ratio = ch / sh;
        var h = Math.max(30, ch * ratio);
        thumb.style.height = h + 'px';
        thumb.style.top = (st / (sh - ch)) * (ch - h) + 'px'
      };
      p.onscroll = update;
      update();
      thumb.onmousedown = function(e) {
        e.preventDefault();
        var startY = e.clientY, startTop = p.scrollTop;
        var sh = p.scrollHeight, ch = p.clientHeight;
        var move = function(e) {
          var dy = e.clientY - startY;
          var ratio = (sh - ch) / (ch - thumb.offsetHeight);
          p.scrollTop = startTop + dy * ratio
        };
        var up = function() {
          document.removeEventListener('mousemove', move);
          document.removeEventListener('mouseup', up)
        };
        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', up)
      }
    },
    renderWin: function() {
      if (!this.cur) return '<div class="ed-sec"><div class="ed-empty">无项目</div></div>';
      var d = this.pj[this.cur].data,
        self = this;
      if (!d || !d.pages) return '';
      var pg = d.pages[this.pg] || {};
      if (pg.type === 'phone') {
        var h = '<div class="ed-sec"><div class="ed-title">手机窗口</div>';
        h += this.ctrl('title', {
          t: 'input',
          d: '页面标题'
        }, pg.title, 'pg');
        h += this.ctrl('scale', {
          t: 'slider',
          r: '50-150',
          d: '缩放%'
        }, pg.scale || 100, 'pg');
        h += this.ctrl('wallpaper', {
          t: 'upload',
          d: '手机壁纸'
        }, pg.wallpaper, 'pg');
        h += '</div>';
        return h
      }
      var h = '<div class="ed-sec"><div class="ed-title">当前页面</div>';
      var pgCfg = this.cfg.page.props;
      ['title', 'widthPct', 'heightPct', 'maxWidthPct', 'headerPct', 'footerPct', 'modalBg', 'modalBgImg', 'modalOpacity', 'modalBlur'].forEach(function(k) {
        h += self.ctrl(k, pgCfg[k], pg[k], 'pg')
      });
      h += '</div>';
      return h
    },
    renderMod: function() {
      var self = this,
        d = this.cur ? this.pj[this.cur].data : null,
        pg = d && d.pages && d.pages[this.pg];
      if (pg && pg.type === 'phone') {
        var APPS = {
          setting: '设置',
          map: '地图',
          album: '相册',
          camera: '相机',
          calendar: '日历',
          browser: '浏览器',
          backpack: '背包',
          warehouse: '仓库',
          wechat: '微信',
          brainwash: '洗脑',
          database: '知识',
          clock: '时钟',
          mail: '邮件',
          phone: '电话',
          wallet: '钱包'
        };
        if (this.curApp && pg.apps && pg.apps[this.curApp]) {
          var a = this.curApp,
            app = pg.apps[a];
          var h = '<div class="ed-sec"><div class="ed-title"><span class="back-app" style="cursor:pointer;margin-right:8px">◀</span>' + APPS[a] + '</div>';
          h += this.ctrl('enabled', {
            t: 'toggle',
            d: '显示'
          }, app.enabled !== false, 'app');
          h += this.renderAppSettings(a, app);
          h += '</div>';
          return h
        }
        var h = '<div class="ed-sec"><div class="ed-title">应用列表</div>';
        Object.keys(APPS).forEach(function(k) {
          var app = pg.apps && pg.apps[k] || {
            enabled: true
          };
          h += '<div class="ed-row" style="display:flex;justify-content:space-between;align-items:center"><span class="app-item" data-app="' + k + '" style="cursor:pointer;flex:1">' + APPS[k] + '</span><div class="ed-toggle-sw' + (app.enabled !== false ? ' on' : '') + '" data-k="enabled" data-app="' + k + '"></div></div>'
        });
        h += '</div>';
        return h
      }
      var h = '<div class="ed-sec"><div class="ed-title">拖拽添加元素</div>';
      ['text', 'btn', 'image', 'input', 'select', 'switch', 'collapse', 'row'].forEach(function(t) {
        h += '<div class="ed-drag" draggable="true" data-type="' + t + '">' + self.icon(t) + ' ' + self.cfg[t].name + '</div>'
      });
      h += '</div>';
      return h
    },
    renderAppSettings: function(a, app) {
      var h = '', self = this;
      switch (a) {
        case 'setting':
          h += '<div class="ed-title" style="margin-top:12px">设置项</div>';
          (app.items || []).forEach(function(it, i) {
            h += '<div class="ed-row" style="display:flex;gap:8px;align-items:center"><span style="flex:1">' + U.esc(it.label || '') + '</span><button class="del-app-item" data-i="' + i + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer">' + self.icon('trash') + '</button></div>'
          });
          h += '<button class="ed-btn sm add-setting-item">' + this.icon('plus') + ' 添加设置项</button>';
          break;
        case 'map':
          h += this.ctrl('bgImage', {t: 'upload', d: '地图背景图'}, app.bgImage, 'app');
          h += '<div class="ed-title" style="margin-top:12px">标记点</div>';
          (app.markers || []).forEach(function(m, i) {
            h += '<div class="ed-row" style="display:flex;gap:4px"><input data-mk="' + i + '" data-f="x" value="' + m.x + '" style="width:40px" placeholder="X%"><input data-mk="' + i + '" data-f="y" value="' + m.y + '" style="width:40px" placeholder="Y%"><input data-mk="' + i + '" data-f="label" value="' + U.esc(m.label || '') + '" style="flex:1" placeholder="标签"><button class="del-marker" data-i="' + i + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer">' + self.icon('trash') + '</button></div>'
          });
          h += '<button class="ed-btn sm add-marker">' + this.icon('plus') + ' 添加标记</button>';
          break;
        case 'album':
          h += '<div class="ed-title" style="margin-top:12px">照片</div>';
          (app.photos || []).forEach(function(p, i) {
            h += '<div class="ed-row"><div style="display:flex;gap:4px;align-items:center;margin-bottom:4px"><span>照片' + (i + 1) + '</span><button class="del-photo" data-i="' + i + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer;margin-left:auto">' + self.icon('trash') + '</button></div>';
            h += self.ctrl('url', {t: 'upload', d: '图片'}, p.url, 'photo-' + i);
            h += self.ctrl('time', {t: 'input', d: '拍摄时间'}, p.time, 'photo-' + i);
            h += '</div>'
          });
          h += '<button class="ed-btn sm add-photo">' + this.icon('plus') + ' 添加照片</button>';
          break;
        case 'camera':
          h += this.ctrl('frameImage', {t: 'upload', d: '取景框边框图'}, app.frameImage, 'app');
          break;
        case 'calendar':
          h += '<div class="ed-title" style="margin-top:12px">标记日期</div>';
          (app.marked || []).forEach(function(d, i) {
            h += '<div class="ed-row" style="display:flex;gap:4px"><input data-marked="' + i + '" value="' + d + '" style="flex:1" placeholder="YYYY-MM-DD"><button class="del-marked" data-i="' + i + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer">' + self.icon('trash') + '</button></div>'
          });
          h += '<button class="ed-btn sm add-marked">' + this.icon('plus') + ' 添加日期</button>';
          h += '<div class="ed-title" style="margin-top:12px">日期事件</div>';
          Object.keys(app.events || {}).forEach(function(k, i) {
            h += '<div class="ed-row" style="display:flex;gap:4px"><input data-ev-k="' + i + '" value="' + k + '" style="width:100px" placeholder="日期"><input data-ev-v="' + k + '" value="' + U.esc(app.events[k] || '') + '" style="flex:1" placeholder="事件"><button class="del-event" data-k="' + k + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer">' + self.icon('trash') + '</button></div>'
          });
          h += '<button class="ed-btn sm add-event">' + this.icon('plus') + ' 添加事件</button>';
          break;
        case 'browser':
          h += this.ctrl('url', {t: 'input', d: '网址'}, app.url, 'app');
          h += this.ctrl('screenshot', {t: 'upload', d: '网页截图'}, app.screenshot, 'app');
          break;
        case 'backpack':
        case 'warehouse':
          h += this.ctrl('cols', {t: 'slider', r: '2-8', d: '列数'}, app.cols, 'app');
          h += this.ctrl('rows', {t: 'slider', r: '2-12', d: '行数'}, app.rows, 'app');
          h += '<div class="ed-title" style="margin-top:12px">物品</div>';
          (app.items || []).forEach(function(it, i) {
            h += '<div class="ed-row"><div style="display:flex;gap:4px;margin-bottom:4px"><span>格子' + it.slot + '</span><button class="del-item" data-i="' + i + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer;margin-left:auto">' + self.icon('trash') + '</button></div>';
            h += self.ctrl('icon', {t: 'upload', d: '图标'}, it.icon, 'item-' + i);
            h += self.ctrl('name', {t: 'input', d: '名称'}, it.name, 'item-' + i);
            h += self.ctrl('count', {t: 'slider', r: '1-999', d: '数量'}, it.count, 'item-' + i);
            h += '</div>'
          });
          h += '<button class="ed-btn sm add-item">' + this.icon('plus') + ' 添加物品</button>';
          break;
        case 'wechat':
          h += '<div class="ed-title" style="margin-top:12px">联系人</div>';
          (app.chats || []).forEach(function(c, i) {
            h += '<div class="ed-row"><div style="display:flex;gap:4px;margin-bottom:4px"><span>' + U.esc(c.name || '联系人' + (i + 1)) + '</span><button class="del-chat" data-i="' + i + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer;margin-left:auto">' + self.icon('trash') + '</button></div>';
            h += self.ctrl('avatar', {t: 'upload', d: '头像'}, c.avatar, 'chat-' + i);
            h += self.ctrl('name', {t: 'input', d: '名称'}, c.name, 'chat-' + i);
            h += self.ctrl('lastMsg', {t: 'input', d: '最后消息'}, c.lastMsg, 'chat-' + i);
            h += '</div>'
          });
          h += '<button class="ed-btn sm add-chat">' + this.icon('plus') + ' 添加联系人</button>';
          break;
        case 'brainwash':
          h += '<div class="ed-title" style="margin-top:12px">洗脑文字</div>';
          (app.texts || []).forEach(function(t, i) {
            h += '<div class="ed-row" style="display:flex;gap:4px"><input data-txt="' + i + '" value="' + U.esc(t) + '" style="flex:1"><button class="del-txt" data-i="' + i + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer">' + self.icon('trash') + '</button></div>'
          });
          h += '<button class="ed-btn sm add-txt">' + this.icon('plus') + ' 添加文字</button>';
          h += this.ctrl('speed', {t: 'slider', r: '1-10', d: '速度'}, app.speed, 'app');
          h += this.ctrl('effect', {t: 'select', r: [{v: 'scroll', l: '滚动'}, {v: 'flash', l: '闪烁'}], d: '效果'}, app.effect, 'app');
          break;
        case 'database':
          h += '<div class="ed-title" style="margin-top:12px">分类</div>';
          (app.categories || []).forEach(function(cat, i) {
            h += '<div class="ed-row"><div style="display:flex;gap:4px;margin-bottom:4px"><span>' + U.esc(cat.name || '分类' + (i + 1)) + '</span><button class="del-cat" data-i="' + i + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer;margin-left:auto">' + self.icon('trash') + '</button></div>';
            h += self.ctrl('name', {t: 'input', d: '分类名'}, cat.name, 'cat-' + i);
            h += '</div>'
          });
          h += '<button class="ed-btn sm add-cat">' + this.icon('plus') + ' 添加分类</button>';
          break;
        case 'clock':
          h += this.ctrl('mode', {t: 'select', r: [{v: 'realtime', l: '实时'}, {v: 'fixed', l: '固定'}], d: '模式'}, app.mode, 'app');
          h += this.ctrl('fixedTime', {t: 'input', d: '固定时间(HH:MM)'}, app.fixedTime, 'app');
          break;
        case 'mail':
          h += '<div class="ed-title" style="margin-top:12px">邮件</div>';
          (app.mails || []).forEach(function(m, i) {
            h += '<div class="ed-row"><div style="display:flex;gap:4px;margin-bottom:4px"><span>' + U.esc(m.subject || '邮件' + (i + 1)) + '</span><button class="del-mail" data-i="' + i + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer;margin-left:auto">' + self.icon('trash') + '</button></div>';
            h += self.ctrl('from', {t: 'input', d: '发件人'}, m.from, 'mail-' + i);
            h += self.ctrl('subject', {t: 'input', d: '标题'}, m.subject, 'mail-' + i);
            h += self.ctrl('body', {t: 'textarea', d: '正文'}, m.body, 'mail-' + i);
            h += self.ctrl('time', {t: 'input', d: '时间'}, m.time, 'mail-' + i);
            h += '</div>'
          });
          h += '<button class="ed-btn sm add-mail">' + this.icon('plus') + ' 添加邮件</button>';
          break;
        case 'phone':
          h += '<div class="ed-title" style="margin-top:12px">联系人</div>';
          (app.contacts || []).forEach(function(c, i) {
            h += '<div class="ed-row"><div style="display:flex;gap:4px;margin-bottom:4px"><span>' + U.esc(c.name || '联系人' + (i + 1)) + '</span><button class="del-contact" data-i="' + i + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer;margin-left:auto">' + self.icon('trash') + '</button></div>';
            h += self.ctrl('avatar', {t: 'upload', d: '头像'}, c.avatar, 'contact-' + i);
            h += self.ctrl('name', {t: 'input', d: '名称'}, c.name, 'contact-' + i);
            h += self.ctrl('number', {t: 'input', d: '号码'}, c.number, 'contact-' + i);
            h += '</div>'
          });
          h += '<button class="ed-btn sm add-contact">' + this.icon('plus') + ' 添加联系人</button>';
          break;
        case 'wallet':
          h += this.ctrl('balance', {t: 'slider', r: '0-99999', d: '余额'}, app.balance, 'app');
          h += this.ctrl('currency', {t: 'input', d: '货币单位'}, app.currency, 'app');
          h += '<div class="ed-title" style="margin-top:12px">交易记录</div>';
          (app.transactions || []).forEach(function(t, i) {
            h += '<div class="ed-row"><div style="display:flex;gap:4px;margin-bottom:4px"><span>' + U.esc(t.desc || '交易' + (i + 1)) + '</span><button class="del-tx" data-i="' + i + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer;margin-left:auto">' + self.icon('trash') + '</button></div>';
            h += self.ctrl('desc', {t: 'input', d: '描述'}, t.desc, 'tx-' + i);
            h += self.ctrl('amount', {t: 'slider', r: '-9999-9999', d: '金额'}, t.amount, 'tx-' + i);
            h += self.ctrl('time', {t: 'input', d: '时间'}, t.time, 'tx-' + i);
            h += '</div>'
          });
          h += '<button class="ed-btn sm add-tx">' + this.icon('plus') + ' 添加交易</button>';
          break;
      }
      return h
    },
    renderStyle: function() {
      if (!this.cur || this.sel === null) return '<div class="ed-sec"><div class="ed-empty">点击元素进行编辑</div></div>';
      var d = this.pj[this.cur].data;
      if (!d || !d.pages || !d.pages[this.pg]) return '';
      var els = this.getEls(this.zone);
      var el = els[this.sel];
      if (!el) return '';
      var self = this;
      if (el.type === 'row' && this.rowSel !== null && el.cols && el.cols[this.rowSel]) {
        var col = el.cols[this.rowSel];
        var ratio = Array.isArray(el.ratio) ? el.ratio : (el.ratio || '1').split(':').map(function(x) {
          return parseInt(x) || 1
        });
        var colMode = el.colMode || [];
        var mode = colMode[this.rowSel] || 'ratio';
        if (col.type === 'placeholder') {
          var h = '<div class="ed-sec"><div class="ed-title">列' + (this.rowSel + 1) + ' - 占位符 <button class="back-row-btn" style="float:right;background:none;border:none;color:#888;cursor:pointer">返回行</button></div>';
          h += '<div class="ed-row" style="flex-direction:column;gap:6px"><label>宽度模式</label>';
          h += '<div style="display:flex;align-items:center;gap:8px">';
          h += '<div class="col-mode-toggle" data-ci="' + this.rowSel + '" style="display:flex;background:#0d0d0d;border-radius:4px;overflow:hidden;flex:1">';
          h += '<div class="col-mode-opt' + (mode === 'ratio' ? ' active' : '') + '" data-mode="ratio" style="flex:1;padding:4px 8px;text-align:center;font-size:11px;cursor:pointer;' + (mode === 'ratio' ? 'background:#166d3b;color:#fff' : 'color:#888') + '">固定比例</div>';
          h += '<div class="col-mode-opt' + (mode === 'fit' ? ' active' : '') + '" data-mode="fit" style="flex:1;padding:4px 8px;text-align:center;font-size:11px;cursor:pointer;' + (mode === 'fit' ? 'background:#166d3b;color:#fff' : 'color:#888') + '">适应内容</div>';
          h += '</div>';
          if (mode === 'ratio') h += '<input class="col-weight-inp" data-ci="' + this.rowSel + '" value="' + ratio[this.rowSel] + '" style="width:50px;padding:4px;background:#0d0d0d;border:1px solid #333;border-radius:4px;color:#fff;text-align:center">';
          h += '</div></div>';
          h += '<div style="color:#666;font-size:12px;padding:12px;text-align:center">拖入元素到此列</div></div>';
          return h
        }
        var colCfg = this.cfg[col.type];
        if (!colCfg) return '';
        var h = '<div class="ed-sec"><div class="ed-title">列' + (this.rowSel + 1) + ' - ' + colCfg.name + ' <button class="back-row-btn" style="float:right;background:none;border:none;color:#888;cursor:pointer">返回行</button></div>';
        h += '<div class="ed-row" style="flex-direction:column;gap:6px"><label>宽度模式</label>';
        h += '<div style="display:flex;align-items:center;gap:8px">';
        h += '<div class="col-mode-toggle" data-ci="' + this.rowSel + '" style="display:flex;background:#0d0d0d;border-radius:4px;overflow:hidden;flex:1">';
        h += '<div class="col-mode-opt' + (mode === 'ratio' ? ' active' : '') + '" data-mode="ratio" style="flex:1;padding:4px 8px;text-align:center;font-size:11px;cursor:pointer;' + (mode === 'ratio' ? 'background:#166d3b;color:#fff' : 'color:#888') + '">固定比例</div>';
        h += '<div class="col-mode-opt' + (mode === 'fit' ? ' active' : '') + '" data-mode="fit" style="flex:1;padding:4px 8px;text-align:center;font-size:11px;cursor:pointer;' + (mode === 'fit' ? 'background:#166d3b;color:#fff' : 'color:#888') + '">适应内容</div>';
        h += '</div>';
        if (mode === 'ratio') h += '<input class="col-weight-inp" data-ci="' + this.rowSel + '" value="' + ratio[this.rowSel] + '" style="width:50px;padding:4px;background:#0d0d0d;border:1px solid #333;border-radius:4px;color:#fff;text-align:center">';
        h += '</div></div>';
        Object.keys(colCfg.props).forEach(function(k) {
          var prop = colCfg.props[k],
            v = col[k];
          if (col.type === 'btn' && (k === 'textSize' || k === 'textColor' || k === 'textBold')) return;
          if (col.type === 'btn' && k === 'sysEffect' && d.sys && d.sys.unload) return;
          if (k === 'options' && Array.isArray(v)) v = v.join('\n');
          h += self.ctrl(k, prop, v, 'col', self.rowSel)
        });
        if (col.type === 'btn') h += self.ctrlFold('按钮文本', col, 'text', 'col', self.rowSel);
        if (col.type === 'input') h += self.ctrlFold('输入框标题', col, 'title', 'col', self.rowSel);
        if (col.type === 'select') h += self.ctrlFold('下拉框标题', col, 'title', 'col', self.rowSel);
        if (col.type === 'switch') h += self.ctrlFold('滑块标题', col, 'title', 'col', self.rowSel);
        h += '<button class="ed-btn del" id="delColElBtn">' + this.icon('trash') + ' 清空此列</button></div>';
        return h
      }
      var m = this.cfg[el.type];
      if (!m) return '';
      var h = '<div class="ed-sec"><div class="ed-title">' + m.name + '</div>';
      if (el.type === 'row') {
        h += this.ctrl('valign', m.props.valign, el.valign, 'el');
        h += this.ctrl('heightBind', m.props.heightBind, el.heightBind, 'el');
        h += '<div class="ed-title" style="margin-top:12px">列管理</div>';
        var ratio = Array.isArray(el.ratio) ? el.ratio : (el.ratio || '1').split(':').map(function(x) {
          return parseInt(x) || 1
        });
        var colMode = el.colMode || [];
        var colPriority = el.colPriority || [];
        h += '<div class="ed-row"><label>列数</label><div style="display:flex;gap:6px;align-items:center"><span>' + ratio.length + '列</span><button class="add-col-btn ed-btn sm" style="margin:0;width:auto;padding:6px 12px">' + this.icon('plus') + ' 添加列</button></div></div>';
        (el.cols || []).forEach(function(col, ci) {
          var mode = colMode[ci] || 'ratio';
          h += '<div class="ed-row" style="flex-direction:column;align-items:stretch;gap:6px">';
          h += '<div style="display:flex;justify-content:space-between;align-items:center;gap:8px">';
          h += '<span style="white-space:nowrap">列' + (ci + 1) + ' - ' + self.cfg[col.type].name + '</span>';
          if ((el.cols || []).length > 1) h += '<button class="del-col-btn" data-ci="' + ci + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer;flex-shrink:0">' + self.icon('trash') + '</button>';
          h += '</div>';
          h += '<div style="display:flex;align-items:center;gap:8px">';
          h += '<div class="col-mode-toggle" data-ci="' + ci + '" style="display:flex;background:#0d0d0d;border-radius:4px;overflow:hidden;flex:1">';
          h += '<div class="col-mode-opt' + (mode === 'ratio' ? ' active' : '') + '" data-mode="ratio" style="flex:1;padding:4px 8px;text-align:center;font-size:11px;cursor:pointer;' + (mode === 'ratio' ? 'background:#166d3b;color:#fff' : 'color:#888') + '">固定比例</div>';
          h += '<div class="col-mode-opt' + (mode === 'fit' ? ' active' : '') + '" data-mode="fit" style="flex:1;padding:4px 8px;text-align:center;font-size:11px;cursor:pointer;' + (mode === 'fit' ? 'background:#166d3b;color:#fff' : 'color:#888') + '">适应内容</div>';
          h += '</div>';
          if (mode === 'ratio') h += '<input class="col-weight-inp" data-ci="' + ci + '" value="' + ratio[ci] + '" style="width:50px;padding:4px;background:#0d0d0d;border:1px solid #333;border-radius:4px;color:#fff;text-align:center">';
          h += '</div></div>';
        });
        var fitCols = [];
        (el.cols || []).forEach(function(col, ci) {
          if ((colMode[ci] || 'ratio') === 'fit') fitCols.push(ci);
        });
        if (fitCols.length > 1) {
          var sortedFit = colPriority.filter(function(ci) { return fitCols.indexOf(ci) > -1; });
          fitCols.forEach(function(ci) { if (sortedFit.indexOf(ci) === -1) sortedFit.push(ci); });
          h += '<div class="ed-title" style="margin-top:12px">适应列优先级 <span style="font-weight:normal;color:#666;font-size:11px">(拖动排序，末位占剩余)</span></div>';
          h += '<div class="col-priority-list" style="background:#0d0d0d;border-radius:6px;padding:4px">';
          sortedFit.forEach(function(ci, pi) {
            var col = el.cols[ci];
            var isLast = pi === sortedFit.length - 1;
            h += '<div class="col-priority-item" draggable="true" data-ci="' + ci + '" style="display:flex;align-items:center;gap:8px;padding:8px;margin:2px 0;background:#1a1a1a;border-radius:4px;cursor:grab' + (isLast ? ';border:1px dashed #444' : '') + '">';
            h += '<span style="color:#666">' + self.icon('drag') + '</span>';
            h += '<span style="flex:1">列' + (ci + 1) + ' - ' + self.cfg[col.type].name + '</span>';
            if (isLast) h += '<span style="color:#888;font-size:11px">占剩余</span>';
            h += '</div>';
          });
          h += '</div>';
        }
      } else if (el.type === 'collapse') {
        Object.keys(m.props).forEach(function(k) {
          if (k === 'titleSize' || k === 'titleColor' || k === 'titleBold') return;
          h += self.ctrl(k, m.props[k], el[k], 'el')
        });
        h += self.ctrlFold('折叠项标题', el, 'title', 'el')
      } else {
        Object.keys(m.props).forEach(function(k) {
          if (el.type === 'btn') {
            switch (k) {
              case 'clickTarget': if (el.clickAction !== 'jumpModal') return; break;
              case 'message': if (el.clickAction !== 'message') return; break;
              case 'sysEffect': if (d.sys && d.sys.unload) return; break;
              case 'afterClick': if (el.repeatable !== false) return; break;
              case 'disabledStyle': if (el.afterClick !== 'disable') return; break;
              case 'logicMax': if (!el.logicGroup) return; break;
              case 'radius': if (el.shape !== 'rounded') return; break;
              case 'hexWidth': if (el.shape !== 'hexagon') return; break;
              case 'textSize': case 'textColor': case 'textBold': return;
            }
          }
          if (el.type === 'image') {
            switch (k) {
              case 'clickTarget': if (el.clickAction !== 'jumpModal') return; break;
              case 'galleryUrls': if (el.clickAction !== 'gallery') return; break;
            }
          }
          var prop = m.props[k], v = el[k];
          switch (k) {
            case 'options': if (Array.isArray(v)) v = v.join('\n'); break;
            case 'ratio': if (Array.isArray(v)) v = v.join(':'); break;
          }
          h += self.ctrl(k, prop, v, 'el')
        });
        switch (el.type) {
          case 'btn': h += self.ctrlFold('按钮文本', el, 'text', 'el'); break;
          case 'input': h += self.ctrlFold('输入框标题', el, 'title', 'el'); break;
          case 'select': h += self.ctrlFold('下拉框标题', el, 'title', 'el'); break;
          case 'switch': h += self.ctrlFold('滑块标题', el, 'title', 'el'); break;
        }
      }
      h += '<button class="ed-btn del" id="delElBtn">' + this.icon('trash') + ' 删除元素</button></div>';
      return h
    },
    renderLock: function() {
      if (!this.cur) return '<div class="ed-sec"><div class="ed-empty">无项目</div></div>';
      var d = this.pj[this.cur].data,
        self = this;
      if (!d.groups) d.groups = {
        style: [],
        logic: [],
        row: []
      };
      if (!d.groups.row) d.groups.row = [];
      var h = '<div class="ed-sec"><div class="ed-title">按钮格式组</div><button class="ed-btn sm add-grp-btn" data-g="style">' + this.icon('plus') + ' 新建格式组</button>';
      (d.groups.style || []).forEach(function(g, i) {
        h += '<div class="ed-row" style="display:flex;justify-content:space-between;align-items:center"><span>' + U.esc(g) + '</span><button class="del-grp-btn" data-g="style" data-i="' + i + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer">' + self.icon('trash') + '</button></div>'
      });
      h += '</div>';
      h += '<div class="ed-sec"><div class="ed-title">按钮逻辑组</div><button class="ed-btn sm add-grp-btn" data-g="logic">' + this.icon('plus') + ' 新建逻辑组</button>';
      (d.groups.logic || []).forEach(function(g, i) {
        h += '<div class="ed-row" style="display:flex;justify-content:space-between;align-items:center"><span>' + U.esc(g) + '</span><button class="del-grp-btn" data-g="logic" data-i="' + i + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer">' + self.icon('trash') + '</button></div>'
      });
      h += '</div>';
      h += '<div class="ed-sec"><div class="ed-title">多列格式组</div><button class="ed-btn sm add-grp-btn" data-g="row">' + this.icon('plus') + ' 新建多列组</button>';
      (d.groups.row || []).forEach(function(g, i) {
        h += '<div class="ed-row" style="display:flex;justify-content:space-between;align-items:center"><span>' + U.esc(g) + '</span><button class="del-grp-btn" data-g="row" data-i="' + i + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer">' + self.icon('trash') + '</button></div>'
      });
      h += '</div>';
      return h
    },
    addGrp: function(t) {
      if (!this.cur) return;
      var d = this.pj[this.cur].data;
      if (!d.groups) d.groups = {
        style: [],
        logic: [],
        row: []
      };
      var labels = {
        style: '格式组名称',
        logic: '逻辑组名称',
        row: '多列组名称'
      };
      var n = prompt(labels[t] || '组名称', '组' + ((d.groups[t] || []).length + 1));
      if (!n) return;
      if (!d.groups[t]) d.groups[t] = [];
      d.groups[t].push(n);
      this.save();
      this.renderR()
    },
    delGrp: function(t, i) {
      if (!this.cur) return;
      var d = this.pj[this.cur].data;
      if (!d.groups || !d.groups[t]) return;
      d.groups[t].splice(i, 1);
      this.save();
      this.renderR()
    },
    delMulti: function() {
      if (!this.cur || !this.multiSel.length) return;
      var pg = this.pj[this.cur].data.pages[this.pg];
      if (!pg || !pg.elements) return;
      this.multiSel.sort(function(a, b) {
        return b - a
      }).forEach(function(i) {
        pg.elements.splice(i, 1)
      });
      this.multiSel = [];
      this.sel = null;
      this.save();
      this.renderR()
    },
    lockMulti: function(type) {
      if (!this.cur || !this.multiSel.length) return;
      var d = this.pj[this.cur].data,
        pg = d.pages[this.pg];
      if (!pg || !pg.elements) return;
      if (!d.locks) d.locks = {
        btns: [],
        rows: []
      };
      var self = this;
      if (type === 'rowHeight') {
        var ids = this.multiSel.filter(function(i) {
          return pg.elements[i]?.type === 'row'
        });
        if (!ids.length) return;
        var h = prompt('输入行高(px)', '100');
        if (!h) return;
        d.locks.rows.push({
          ids: ids,
          height: parseInt(h) || 100
        });
        ids.forEach(function(i) {
          pg.elements[i].lockHeight = parseInt(h) || 100
        })
      } else {
        var ids = this.multiSel.filter(function(i) {
          return pg.elements[i]?.type === 'btn'
        });
        if (!ids.length) return;
        d.locks.btns.push({
          ids: ids,
          type: type
        });
        ids.forEach(function(i) {
          if (type === 'width' || type === 'size') pg.elements[i].lockWidth = true;
          if (type === 'height' || type === 'size') pg.elements[i].lockHeight = true
        })
      }
      this.multiSel = [];
      this.save();
      this.renderR()
    },
    unlock: function(t, i) {
      if (!this.cur) return;
      var d = this.pj[this.cur].data,
        pg = d.pages[this.pg];
      if (!d.locks) return;
      if (t === 'btn' && d.locks.btns[i]) {
        var lk = d.locks.btns[i];
        lk.ids.forEach(function(idx) {
          if (pg.elements[idx]) {
            pg.elements[idx].lockWidth = false;
            pg.elements[idx].lockHeight = false
          }
        });
        d.locks.btns.splice(i, 1)
      } else if (t === 'row' && d.locks.rows[i]) {
        var lk = d.locks.rows[i];
        lk.ids.forEach(function(idx) {
          if (pg.elements[idx]) pg.elements[idx].lockHeight = null
        });
        d.locks.rows.splice(i, 1)
      }
      this.save();
      this.renderR()
    },
    ctrl: function(k, prop, v, scope, ci) {
      if (!prop) return '';
      var dv = prop.v;
      var origV = v;
      if (v === undefined || v === null || v === '') v = dv;
      var ciAttr = ci !== undefined ? ' data-ci="' + ci + '"' : '';
      var self = this;
      var modified = origV !== undefined && origV !== null && origV !== '' && origV !== dv;
      var dotAttr = ' data-pk="' + k + '" data-ps="' + scope + '"' + ciAttr;
      var wrapCls = 'ed-row-wrap' + (modified ? ' modified' : '');
      var h = '<div class="' + wrapCls + '"><div class="ed-mod-dot"' + dotAttr + '></div><div class="ed-row"><label>' + prop.d + '</label>';
      if (prop.t === 'input') h += '<input data-k="' + k + '" data-s="' + scope + '"' + ciAttr + ' value="' + U.esc(String(v || '')) + '">';
      else if (prop.t === 'textarea') h += '<textarea data-k="' + k + '" data-s="' + scope + '"' + ciAttr + ' rows="3">' + U.esc(String(v || '')) + '</textarea>';
      else if (prop.t === 'num') h += '<input type="number" data-k="' + k + '" data-s="' + scope + '"' + ciAttr + ' value="' + (v || 1) + '" min="1" style="width:60px">';
      else if (prop.t === 'color') {
        var cv = v || dv || '000000';
        h += '<div class="ed-color"><input type="color" data-k="' + k + '" data-s="' + scope + '"' + ciAttr + ' value="#' + cv + '"><input data-k="' + k + '" data-s="' + scope + '"' + ciAttr + ' value="' + U.esc(cv) + '" class="ed-ctxt"></div>'
      } else if (prop.t === 'grp') {
        var d = this.pj[this.cur].data,
          grps = d.groups && d.groups[prop.g] || [];
        h += '<select data-k="' + k + '" data-s="' + scope + '"' + ciAttr + '><option value=""' + ((!v) ? ' selected' : '') + '>无</option>';
        grps.forEach(function(g) {
          h += '<option value="' + U.esc(g) + '"' + (v === g ? ' selected' : '') + '>' + U.esc(g) + '</option>'
        });
        h += '</select>'
      } else if (prop.t === 'select') {
        h += '<select data-k="' + k + '" data-s="' + scope + '"' + ciAttr + '>';
        (prop.r || []).forEach(function(o) {
          var ov = o.v !== undefined ? o.v : o,
            ol = o.l || o;
          h += '<option value="' + ov + '"' + (String(ov) === String(v) ? ' selected' : '') + '>' + ol + '</option>'
        });
        h += '</select>'
      } else if (prop.t === 'page') {
        h += '<select data-k="' + k + '" data-s="' + scope + '"' + ciAttr + '><option value="0"' + (!v || v === 0 ? ' selected' : '') + '>无</option>';
        var pgs = this.cur ? this.pj[this.cur].data.pages.length : 0;
        for (var i = 1; i <= pgs; i++) {
          h += '<option value="' + i + '"' + (v === i ? ' selected' : '') + '>第' + i + '页</option>'
        }
        h += '</select>'
      } else if (prop.t === 'slider') {
        var rg = (prop.r || '0-100').split('-'),
          dv = v !== undefined && v !== '' ? v : (prop.v !== undefined ? prop.v : rg[0]);
        h += '<div class="ed-slider"><input type="range" data-k="' + k + '" data-s="' + scope + '"' + ciAttr + ' min="' + rg[0] + '" max="' + rg[1] + '" value="' + dv + '"><span class="ed-v">' + dv + '</span></div>'
      } else if (prop.t === 'toggle') {
        var tMod = origV !== undefined && origV !== null && origV !== dv;
        var tWrap = 'ed-row-wrap' + (tMod ? ' modified' : '');
        return '<div class="' + tWrap + '"><div class="ed-mod-dot"' + dotAttr + '></div><div class="ed-row"><div class="ed-toggle"><span style="color:#666;font-size:11px">' + prop.d + '</span><div class="ed-toggle-sw' + (v ? ' on' : '') + '" data-k="' + k + '" data-s="' + scope + '"' + ciAttr + '></div></div></div></div>'
      } else if (prop.t === 'upload') {
        h += '<div class="ed-up">';
        if (v) {
          var imgSrc = v.indexOf('://') > -1 ? v.replace('https://sexyai.top/', 'https://r2.sexyai.top/') : 'https://r2.sexyai.top/' + (v.charAt(0) === '/' ? v.slice(1) : v);
          h += '<img src="' + imgSrc + '" style="max-width:100%;max-height:80px;border-radius:4px;margin-bottom:4px"><br>';
        }
        h += '<button class="ed-btn sm upload-btn" data-k="' + k + '" data-s="' + scope + '"' + ciAttr + '>' + (v ? '更换' : '选择') + '</button>';
        if (v) h += '<button class="ed-btn sm del clear-btn" data-k="' + k + '" data-s="' + scope + '"' + ciAttr + ' style="margin-left:4px">清除</button>';
        h += '</div>'
      } else if (prop.t === 'gallery') {
        h += '<div class="ed-gallery" data-k="' + k + '" data-s="' + scope + '"' + ciAttr + '>';
        var urls = v || [];
        urls.forEach(function(u, gi) {
          h += '<div style="margin-bottom:8px;padding:8px;background:#1a1a1a;border-radius:6px">';
          h += '<div style="display:flex;gap:4px;align-items:center">';
          if (gi > 0) h += '<button class="gallery-mv" data-gi="' + gi + '" data-d="-1" style="background:none;border:none;color:#888;cursor:pointer">◀</button>';
          else h += '<span style="width:16px"></span>';
          h += '<span style="flex:1;text-align:center;color:#666;font-size:11px">' + (gi + 1) + '</span>';
          if (gi < urls.length - 1) h += '<button class="gallery-mv" data-gi="' + gi + '" data-d="1" style="background:none;border:none;color:#888;cursor:pointer">▶</button>';
          else h += '<span style="width:16px"></span>';
          h += '<button class="gallery-del" data-gi="' + gi + '" style="background:none;border:none;color:#ff6b6b;cursor:pointer">' + self.icon('trash') + '</button></div>';
          h += '<div style="display:flex;gap:4px;margin-top:4px"><button class="ed-btn sm gal-up" data-gi="' + gi + '">选择</button><input data-gi="' + gi + '" value="' + U.esc(u) + '" placeholder="或输入URL" style="flex:1"></div></div>'
        });
        h += '<button class="ed-btn sm gallery-add" data-k="' + k + '" data-s="' + scope + '"' + ciAttr + '>' + self.icon('plus') + ' 添加图片</button></div>'
      } else if (prop.t === 'model') {
        h += '<select data-k="' + k + '" data-s="' + scope + '"' + ciAttr + '><option value=""' + ((!v) ? ' selected' : '') + '>无</option>';
        (self.models || []).forEach(function(m) {
          h += '<option value="' + U.esc(m.id || m) + '"' + (v === (m.id || m) ? ' selected' : '') + '>' + U.esc(m.name || m) + '</option>'
        });
        h += '</select>'
      }
      h += '</div></div>';
      return h
    },
    ctrlFold: function(title, el, prefix, scope, ci) {
      var self = this,
        h = '<div class="ed-fold"><div class="ed-fold-hd"><span>' + title + '</span><span class="arr">▶</span></div><div class="ed-fold-bd">';
      var props = this.textProps;
      Object.keys(props).forEach(function(k) {
        var pk = prefix + k.charAt(0).toUpperCase() + k.slice(1);
        var prop = Object.assign({}, props[k]);
        if (k === 'font') prop.r = self.fonts;
        if (k === 'align') prop.r = self.aligns;
        h += self.ctrl(pk, prop, el[pk], scope, ci)
      });
      return h + '</div></div>'
    },
    bindR: function() {
      var self = this;
      var db = document.getElementById('delElBtn');
      if (db) db.onclick = function() {
        self.del()
      };
      var dcb = document.getElementById('delColElBtn');
      if (dcb) dcb.onclick = function() {
        self.clearCol()
      };
      var brb = document.querySelector('.back-row-btn');
      if (brb) brb.onclick = function() {
        self.rowSel = null;
        self.renderR()
      };
      document.querySelectorAll('.unlock-btn').forEach(function(b) {
        b.onclick = function() {
          self.unlock(b.dataset.t, parseInt(b.dataset.i))
        }
      });
      document.querySelectorAll('.add-grp-btn').forEach(function(b) {
        b.onclick = function() {
          self.addGrp(b.dataset.g)
        }
      });
      document.querySelectorAll('.del-grp-btn').forEach(function(b) {
        b.onclick = function() {
          self.delGrp(b.dataset.g, parseInt(b.dataset.i))
        }
      });
      document.querySelectorAll('.ed-fold-hd').forEach(function(hd) {
        hd.onclick = function() {
          hd.classList.toggle('open');
          var bd = hd.nextElementSibling;
          if (bd) bd.classList.toggle('open')
        }
      });
      document.querySelectorAll('.ed-toggle-sw').forEach(function(sw) {
        sw.onclick = function() {
          var on = sw.classList.toggle('on');
          if (sw.dataset.app) {
            var pg = self.pj[self.cur].data.pages[self.pg];
            if (pg && pg.apps && pg.apps[sw.dataset.app]) pg.apps[sw.dataset.app].enabled = on;
            self.save();
            return
          }
          self.setProp(sw.dataset.k, on, sw.dataset.s, sw.dataset.ci !== undefined ? parseInt(sw.dataset.ci) : null);
          self.renderR()
        }
      });
      document.querySelectorAll('.app-item').forEach(function(it) {
        it.onclick = function() {
          self.curApp = it.dataset.app;
          self.renderR()
        }
      });
      var backApp = document.querySelector('.back-app');
      if (backApp) backApp.onclick = function() {
        self.curApp = null;
        self.renderR()
      };
      document.querySelectorAll('.upload-btn').forEach(function(b) {
        b.onclick = function() {
          var k = b.dataset.k, s = b.dataset.s, ci = b.dataset.ci;
          G.open(function(url) {
            if (url) {
              self.setProp(k, url, s, ci !== undefined ? parseInt(ci) : null);
              if (k === 'url') self.setProp('urlInput', '', s, ci !== undefined ? parseInt(ci) : null);
              self.renderR()
            }
          })
        }
      });
      document.querySelectorAll('.clear-btn').forEach(function(b) {
        b.onclick = function() {
          self.setProp(b.dataset.k, '', b.dataset.s, b.dataset.ci !== undefined ? parseInt(b.dataset.ci) : null);
          self.renderR()
        }
      });
      document.querySelectorAll('.col-weight-inp').forEach(function(inp) {
        inp.oninput = function() {
          var ci = parseInt(inp.dataset.ci);
          self.setColRatio(ci, parseInt(inp.value) || 1)
        }
      });
      document.querySelectorAll('.gallery-add').forEach(function(b) {
        b.onclick = function() {
          var k = b.dataset.k,
            s = b.dataset.s,
            ci = b.dataset.ci !== undefined ? parseInt(b.dataset.ci) : null;
          var el = self.pj[self.cur].data.pages[self.pg].elements[self.sel];
          var urls = el[k] || [];
          urls.push('');
          el[k] = urls;
          self.save();
          self.renderR()
        }
      });
      document.querySelectorAll('.gallery-del').forEach(function(b) {
        b.onclick = function() {
          var gi = parseInt(b.dataset.gi),
            g = b.closest('.ed-gallery'),
            k = g.dataset.k;
          var el = self.pj[self.cur].data.pages[self.pg].elements[self.sel];
          var urls = el[k] || [];
          urls.splice(gi, 1);
          el[k] = urls;
          self.save();
          self.renderR()
        }
      });
      document.querySelectorAll('.gallery-mv').forEach(function(b) {
        b.onclick = function() {
          var gi = parseInt(b.dataset.gi),
            d = parseInt(b.dataset.d),
            g = b.closest('.ed-gallery'),
            k = g.dataset.k;
          var el = self.pj[self.cur].data.pages[self.pg].elements[self.sel];
          var urls = el[k] || [];
          var ni = gi + d;
          if (ni < 0 || ni >= urls.length) return;
          var tmp = urls[gi];
          urls[gi] = urls[ni];
          urls[ni] = tmp;
          el[k] = urls;
          self.save();
          self.renderR()
        }
      });
      document.querySelectorAll('.gal-up').forEach(function(b) {
        b.onclick = function() {
          var gi = parseInt(b.dataset.gi), g = b.closest('.ed-gallery'), k = g.dataset.k;
          G.open(function(url) {
            if (url) {
              var el = self.pj[self.cur].data.pages[self.pg].elements[self.sel];
              var urls = el[k] || [];
              urls[gi] = url;
              el[k] = urls;
              self.save();
              self.renderR()
            }
          })
        }
      });
      document.querySelectorAll('.ed-gallery input[data-gi]').forEach(function(inp) {
        inp.oninput = function() {
          var gi = parseInt(inp.dataset.gi),
            g = inp.closest('.ed-gallery'),
            k = g.dataset.k;
          var el = self.pj[self.cur].data.pages[self.pg].elements[self.sel];
          var urls = el[k] || [];
          urls[gi] = inp.value;
          el[k] = urls;
          self.save()
        }
      });
      document.querySelectorAll('[data-k]').forEach(function(c) {
        if (c.classList.contains('ed-toggle-sw')) return;
        var k = c.dataset.k,
          s = c.dataset.s,
          ci = c.dataset.ci !== undefined ? parseInt(c.dataset.ci) : null;
        if (c.type === 'file') {
          c.onchange = function() {
            var f = c.files[0];
            if (!f) return;
            var btn = c.parentElement.querySelector('.upload-btn');
            if (btn) btn.textContent = '上传中...';
            var fd = new FormData();
            fd.append('suffix', f.name.split('.').pop());
            fd.append('file', f, 'file-' + Date.now());
            fetch('https://sexyai.top/api/file/upload', {
              method: 'POST',
              body: fd
            }).then(function(r) {
              return r.json()
            }).then(function(d) {
              if (d.data && d.data[0]) {
                self.setProp(k, d.data[0], s, ci);
                if (k === 'url') self.setProp('urlInput', '', s, ci);
                self.renderR()
              } else if (btn) btn.textContent = '失败'
            }).catch(function() {
              if (btn) btn.textContent = '失败'
            })
          }
        } else if (c.type === 'color') {
          c.oninput = function() {
            var hex = c.value.replace('#', '');
            self.setProp(k, hex, s, ci);
            var txt = c.parentElement.querySelector('.ed-ctxt');
            if (txt) txt.value = hex
          }
        } else {
          c.oninput = c.onchange = function() {
            var v = c.type === 'checkbox' ? c.checked : c.type === 'range' ? parseInt(c.value) : c.value;
            if (c.tagName === 'SELECT' && k === 'clickTarget') v = parseInt(v);
            if (c.type === 'range') c.parentElement.querySelector('.ed-v').textContent = v;
            if (c.classList.contains('ed-ctxt')) {
              var cp = c.parentElement.querySelector('input[type=color]');
              if (cp) cp.value = '#' + v
            }
            if (k === 'ratio' && ci !== null) {
              self.setColRatio(ci, parseInt(v) || 1);
              return
            }
            if (k === 'urlInput' && v) self.setProp('url', '', s, ci);
            self.setProp(k, v, s, ci);
            if (k === 'clickAction' || k === 'repeatable' || k === 'afterClick' || k === 'shape' || k === 'logicGroup') self.renderR()
          }
        }
      });
      document.querySelectorAll('.ed-v').forEach(function(sp) {
        sp.ondblclick = function() {
          var rng = sp.parentElement.querySelector('input[type=range]');
          if (!rng) return;
          var min = parseInt(rng.min),
            max = parseInt(rng.max),
            val = parseInt(rng.value);
          var inp = document.createElement('input');
          inp.type = 'number';
          inp.value = val;
          inp.min = min;
          inp.max = max;
          inp.style.cssText = 'width:50px;padding:2px 4px;background:#0d0d0d;border:1px solid #333;border-radius:4px;color:#fff;font-size:11px';
          sp.style.display = 'none';
          sp.parentElement.appendChild(inp);
          inp.focus();
          inp.select();
          var done = function() {
            if (!inp.parentElement) return;
            var nv = Math.max(min, Math.min(max, parseInt(inp.value) || min));
            rng.value = nv;
            sp.textContent = nv;
            sp.style.display = '';
            inp.remove();
            rng.dispatchEvent(new Event('input', {
              bubbles: true
            }))
          };
          inp.onkeydown = function(e) {
            if (e.key === 'Enter') done()
          };
          inp.onblur = done
        }
      });
      var dragCi = null;
      document.querySelectorAll('.col-priority-item').forEach(function(it) {
        it.ondragstart = function(e) {
          dragCi = parseInt(it.dataset.ci);
          it.style.opacity = '0.5'
        };
        it.ondragend = function() {
          it.style.opacity = '1';
          dragCi = null
        };
        it.ondragover = function(e) {
          e.preventDefault();
          it.style.background = '#333'
        };
        it.ondragleave = function() {
          it.style.background = '#1a1a1a'
        };
        it.ondrop = function(e) {
          e.preventDefault();
          it.style.background = '#1a1a1a';
          if (dragCi === null) return;
          var targetCi = parseInt(it.dataset.ci);
          if (dragCi === targetCi) return;
          var list = document.querySelector('.col-priority-list');
          if (!list) return;
          var items = Array.from(list.querySelectorAll('.col-priority-item'));
          var order = items.map(function(el) { return parseInt(el.dataset.ci) });
          var fromIdx = order.indexOf(dragCi);
          var toIdx = order.indexOf(targetCi);
          order.splice(fromIdx, 1);
          order.splice(toIdx, 0, dragCi);
          self.setColPriority(order)
        }
      });
      document.querySelectorAll('.ed-mod-dot').forEach(function(dot) {
        dot.onclick = function(e) {
          e.stopPropagation();
          self.showStyleMenu(dot, e)
        }
      })
    },
    showStyleMenu: function(dot, e) {
      var self = this;
      var old = document.querySelector('.ed-style-menu');
      if (old) old.remove();
      var pk = dot.dataset.pk;
      var ps = dot.dataset.ps;
      var ci = dot.dataset.ci !== undefined ? parseInt(dot.dataset.ci) : null;
      var menu = document.createElement('div');
      menu.className = 'ed-style-menu';
      menu.innerHTML = '<div data-act="pageDef">设为该页默认</div><div data-act="globalDef">设为全局默认</div><div data-act="applyPage">应用到该页已有</div><div data-act="applyGlobal">应用到全局已有</div>';
      var r = dot.getBoundingClientRect();
      menu.style.left = (r.left + 12) + 'px';
      menu.style.top = r.top + 'px';
      document.body.appendChild(menu);
      var closeMenu = function() {
        menu.remove();
        document.removeEventListener('click', closeMenu)
      };
      setTimeout(function() {
        document.addEventListener('click', closeMenu)
      }, 0);
      menu.querySelectorAll('[data-act]').forEach(function(it) {
        it.onclick = function(ev) {
          ev.stopPropagation();
          self.applyStyleAction(it.dataset.act, pk, ps, ci);
          closeMenu()
        }
      })
    },
    applyStyleAction: function(act, pk, ps, ci) {
      if (!this.cur) return;
      var d = this.pj[this.cur].data;
      var pg = d.pages[this.pg];
      var val;
      if (ps === 'el' && this.sel !== null) {
        var els = this.getEls(this.zone);
        var el = els[this.sel];
        if (el) val = el[pk]
      } else if (ps === 'col' && ci !== null && this.sel !== null) {
        var els = this.getEls(this.zone);
        var el = els[this.sel];
        if (el && el.cols && el.cols[ci]) val = el.cols[ci][pk]
      }
      if (val === undefined) return;
      var defKey = this.getDefKey(pk);
      var elType = this.getElType(ps, ci);
      if (act === 'pageDef' && defKey) {
        pg[defKey] = val;
        this.toast('已设为该页默认')
      } else if (act === 'globalDef' && defKey) {
        if (!d.global) d.global = {};
        d.global[defKey] = val;
        this.toast('已设为全局默认')
      } else if (act === 'applyPage') {
        this.applyToElements(pg, pk, val, elType);
        this.toast('已应用到该页')
      } else if (act === 'applyGlobal') {
        var self = this;
        d.pages.forEach(function(p) {
          self.applyToElements(p, pk, val, elType)
        });
        this.toast('已应用到全局')
      }
      this.save();
      this.renderR()
    },
    getDefKey: function(pk) {
      var map = {
        size: 'defTextSize', color: 'defTextColor', font: 'defTextFont',
        bgColor: 'defBtnBg', textColor: 'defBtnColor', shape: 'defBtnShape', radius: 'defBtnRadius'
      };
      return map[pk] || null
    },
    getElType: function(ps, ci) {
      if (ps === 'col' && ci !== null && this.sel !== null) {
        var els = this.getEls(this.zone);
        var el = els[this.sel];
        if (el && el.cols && el.cols[ci]) return el.cols[ci].type
      } else if (ps === 'el' && this.sel !== null) {
        var els = this.getEls(this.zone);
        var el = els[this.sel];
        if (el) return el.type
      }
      return null
    },
    applyToElements: function(pg, pk, val, elType) {
      var self = this;
      var zones = ['headerElements', 'elements', 'footerElements'];
      zones.forEach(function(z) {
        (pg[z] || []).forEach(function(el) {
          if (el.type === elType) el[pk] = val;
          else if (el.type === 'row' && el.cols) {
            el.cols.forEach(function(col) {
              if (col.type === elType) col[pk] = val
            })
          }
          if (el.type === 'collapse' && el.items) {
            el.items.forEach(function(it) {
              if (it.type === elType) it[pk] = val
            })
          }
        })
      })
    },
    setColRatio: function(ci, v) {
      if (!this.cur || this.sel === null) return;
      var els = this.getEls(this.zone);
      var el = els[this.sel];
      if (!el) return;
      var ratio = Array.isArray(el.ratio) ? el.ratio : (el.ratio || '1').split(':').map(function(x) {
        return parseInt(x) || 1
      });
      ratio[ci] = v;
      el.ratio = ratio;
      this.save()
    },
    setProp: function(k, v, scope, ci) {
      if (!this.cur) return;
      var d = this.pj[this.cur].data;
      if (scope === 'g') d.global[k] = v;
      else if (scope === 'pg') d.pages[this.pg][k] = v;
      else if (scope === 'col' && ci !== null && this.sel !== null) {
        var els = this.getEls(this.zone);
        var el = els[this.sel];
        if (el && el.cols && el.cols[ci]) {
          if (k === 'options') v = v.split('\n').filter(function(x) {
            return x.trim()
          });
          el.cols[ci][k] = v
        }
      } else if (scope === 'el' && this.sel !== null) {
        var els = this.getEls(this.zone);
        var el = els[this.sel];
        if (el) {
          if (k === 'options') v = v.split('\n').filter(function(x) {
            return x.trim()
          });
          if (k === 'ratio') v = v.split(':').map(function(x) {
            return parseInt(x) || 1
          });
          el[k] = v
        }
      }
      this.save()
    },
    stripDefaults: function(data) {
      var self = this;
      var result = {};
      if (data.global) {
        var gCfg = this.cfg.global.props;
        var g = {};
        Object.keys(data.global).forEach(function(k) {
          var def = gCfg[k] && gCfg[k].v;
          if (data.global[k] !== def && data.global[k] !== undefined && data.global[k] !== '') g[k] = data.global[k]
        });
        if (Object.keys(g).length) result.global = g
      }
      if (data.sys && Object.keys(data.sys).length) result.sys = data.sys;
      if (data.groups && Object.keys(data.groups).length) result.groups = data.groups;
      if (data.pages) {
        result.pages = data.pages.map(function(pg) {
          var p = {};
          var pgCfg = self.cfg.page.props;
          Object.keys(pg).forEach(function(k) {
            if (k === 'elements' || k === 'headerElements' || k === 'footerElements') {
              var els = (pg[k] || []).map(function(el) { return self.stripEl(el) });
              if (els.length) p[k] = els
            } else {
              var def = pgCfg[k] && pgCfg[k].v;
              if (pg[k] !== def && pg[k] !== undefined && pg[k] !== '') p[k] = pg[k]
            }
          });
          return p
        })
      }
      return result
    },
    stripEl: function(el) {
      var self = this;
      var cfg = this.cfg[el.type];
      if (!cfg) return {type: el.type};
      var r = {type: el.type};
      Object.keys(el).forEach(function(k) {
        if (k === 'type') return;
        if (k === 'cols' && el.cols) {
          r.cols = el.cols.map(function(c) { return self.stripEl(c) });
          return
        }
        if (k === 'items' && el.items) {
          r.items = el.items.map(function(i) { return self.stripEl(i) });
          return
        }
        var def = cfg.props && cfg.props[k] && cfg.props[k].v;
        if (el[k] !== def && el[k] !== undefined && el[k] !== '') r[k] = el[k]
      });
      return r
    },
    exp: function() {
      if (!this.cur) return '';
      var d = this.stripDefaults(this.pj[this.cur].data);
      var json = JSON.stringify(d);
      var lz = LZS.c(json);
      return '[' + (L.project || 'MODAL') + '@' + (L.major || '1') + ':{{char}};;{{user}};;Z' + lz + ']'
    },
    copy: function() {
      var s = this.exp();
      if (!s) return;
      navigator.clipboard.writeText(s).then(function() {
        var t = document.createElement('div');
        t.className = 'ed-toast';
        t.textContent = '已复制';
        document.body.appendChild(t);
        setTimeout(function() {
          t.remove()
        }, 2000)
      })
    },
    download: function() {
      var s = this.exp();
      if (!s) return;
      var now = new Date();
      var ts = now.getFullYear() + ('0' + (now.getMonth() + 1)).slice(-2) + ('0' + now.getDate()).slice(-2) + '-' + ('0' + now.getHours()).slice(-2) + ('0' + now.getMinutes()).slice(-2) + ('0' + now.getSeconds()).slice(-2);
      var blob = new Blob([s], {
        type: 'text/plain'
      });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (L.project || 'MODAL') + '_' + ts + '.txt';
      a.click()
    },
    setDevice: function(d) {
      var pc = document.getElementById('edPc'),
        mb = document.getElementById('edMobile'),
        r = document.getElementById('root');
      pc.classList.toggle('on', d === 'pc');
      mb.classList.toggle('on', d === 'mobile');
      if (d === 'pc') {
        r.style.width = '';
        r.style.height = '';
        r.style.margin = ''
      } else {
        var h = window.innerHeight,
          w = Math.floor(h * 9 / 19);
        r.style.width = w + 'px';
        r.style.height = h + 'px';
        r.style.margin = '0 auto'
      }
      L.platform = d
    },
    togglePreview: function() {
      this.preview = !this.preview;
      var p = document.getElementById('ed-panel'),
        l = document.getElementById('ed-list'),
        m = document.querySelector('.ed-menu'),
        r = document.getElementById('root');
      if (this.preview) {
        p.style.display = 'none';
        l.style.display = 'none';
        m.style.display = 'none';
        r.style.marginRight = '';
        L.edit = false;
        L.preview = true;
        if (window.modalRender) window.modalRender(this.pj[this.cur].data)
      } else {
        p.style.display = '';
        l.style.display = '';
        m.style.display = '';
        r.style.marginRight = '280px';
        L.edit = true;
        L.preview = false;
        if (window.modalRender) window.modalRender(this.pj[this.cur].data)
      }
    },
    renderChat: function() {
      var self = this;
      var oldInp = document.getElementById('chatInp');
      var oldVal = oldInp ? oldInp.value : '';
      var msgs = '';
      this.chatMessages.forEach(function(m) {
        msgs += '<div class="ed-chat-msg ' + m.role + '">' + U.esc(m.content) + '</div>'
      });
      if (this.chatSending) msgs += '<div class="ed-chat-msg bot loading">生成中...</div>';
      var h = '<div class="ed-chat"><div class="ed-chat-body" id="chatBody">' + msgs + '</div><div class="ed-chat-input"><textarea id="chatInp" placeholder="输入消息...">' + U.esc(oldVal) + '</textarea></div><div class="ed-chat-btns"><button id="chatModel">' + (this.curModel ? this.curModel.name : '选择模型') + '</button><button id="chatSend" class="primary">' + (this.chatSending ? '...' : '发送') + '</button></div></div>';
      setTimeout(function() {
        var mb = document.getElementById('chatModel'),
          sb = document.getElementById('chatSend'),
          cb = document.getElementById('chatBody');
        if (cb) cb.scrollTop = cb.scrollHeight;
        if (mb) mb.onclick = function() {
          self.showModelModal()
        };
        if (sb) sb.onclick = function() {
          self.sendChat()
        }
      }, 0);
      return h
    },
    fetchModels: function(cb) {
      var self = this;
      fetch('https://sexyai.top/api/model/list', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: '{}'
      }).then(function(r) {
        return r.json()
      }).then(function(d) {
        if (d.code === 200 && d.data) {
          self.models = d.data;
          if (!self.curModel && d.data.length) self.curModel = d.data[0];
          if (cb) cb()
        }
      }).catch(function() {})
    },
    showModelModal: function() {
      var self = this,
        old = document.querySelector('.ed-modal');
      if (old) old.remove();
      if (!this.models.length) {
        this.fetchModels(function() {
          self.showModelModal()
        });
        return
      }
      var m = document.createElement('div');
      m.className = 'ed-modal';
      var h = '<div class="ed-modal-box"><div class="ed-modal-hd">选择模型</div><div class="ed-modal-bd">';
      this.models.forEach(function(md) {
        h += '<div class="ed-model-item' + (self.curModel && self.curModel.id === md.id ? ' on' : '') + '" data-id="' + md.id + '"><div class="name">' + U.esc(md.name) + '</div><div class="desc">' + U.esc(md.description || '') + '</div></div>'
      });
      h += '</div></div>';
      m.innerHTML = h;
      m.onclick = function(e) {
        if (e.target === m) {
          m.remove();
          return
        }
        var it = e.target.closest('.ed-model-item');
        if (it) {
          var id = parseInt(it.dataset.id);
          self.curModel = self.models.find(function(x) {
            return x.id === id
          });
          m.remove();
          self.renderR()
        }
      };
      document.body.appendChild(m)
    },
    createConversation: function(cb) {
      var self = this;
      fetch('https://sexyai.top/api/conversation2/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({roleId: L.roleId})
      }).then(function(r) { return r.json() }).then(function(d) {
        if (d.code === 200 && d.data) {
          self.conversationId = d.data.id;
          if (cb) cb()
        }
      }).catch(function() {})
    },
    sendChat: function() {
      var self = this;
      var inp = document.getElementById('chatInp');
      if (!inp || !inp.value.trim() || this.chatSending) return;
      if (!this.curModel) {
        this.fetchModels(function() { self.sendChat() });
        return
      }
      var msg = inp.value.trim();
      inp.value = '';
      this.chatMessages.push({role: 'user', content: msg});
      this.chatSending = true;
      this.renderR();
      var doSend = function() {
        fetch('https://sexyai.top/api/chat/completions/stream', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            roleId: L.roleId,
            content: msg,
            modelId: self.curModel.id,
            maxToken: self.curModel.maxTokenList && self.curModel.maxTokenList[0] ? self.curModel.maxTokenList[0].maxToken : 8000
          })
        }).then(function(r) {
          var reader = r.body.getReader();
          var decoder = new TextDecoder();
          var buf = '';
          var botMsg = {role: 'bot', content: ''};
          self.chatMessages.push(botMsg);
          self.chatSending = false;
          var read = function() {
            reader.read().then(function(res) {
              if (res.done) {
                self.renderR();
                return
              }
              buf += decoder.decode(res.value, {stream: true});
              var lines = buf.split('\n');
              buf = lines.pop();
              lines.forEach(function(line) {
                if (line.startsWith('data:')) {
                  var d = line.substring(5);
                  try {
                    var j = JSON.parse(d);
                    if (j.content && typeof j.content === 'string') return
                  } catch(e) {}
                  if (d && d !== '[DONE]') botMsg.content += d
                }
              });
              self.renderR();
              read()
            }).catch(function() {
              self.chatSending = false;
              self.renderR()
            })
          };
          read()
        }).catch(function() {
          self.chatSending = false;
          self.chatMessages.push({role: 'bot', content: '发送失败'});
          self.renderR()
        })
      };
      if (!this.conversationId) {
        this.createConversation(doSend)
      } else {
        doSend()
      }
    },
    renderSys: function() {
      var self = this;
      if (!this.cur) return '<div class="ed-sec"><div class="ed-empty">无项目</div></div>';
      var d = this.pj[this.cur].data;
      if (!d.sys) d.sys = {};
      var g = d.global || {};
      var h = '<div class="ed-sec"><div class="ed-title">系统设定</div>';
      h += '<div class="ed-row"><div class="ed-toggle"><span style="color:#666;font-size:11px">隐藏系统效果</span><div class="ed-toggle-sw' + (d.sys.unload ? ' on' : '') + '" id="sysUnload"></div></div></div>';
      h += '<div style="color:#666;font-size:10px;margin-top:-6px;margin-bottom:12px">开启后隐藏按钮的killer和hider选项</div>';
      h += '</div>';
      h += '<div class="ed-sec"><div class="ed-title">全局样式</div>';
      var gCfg = this.cfg.global.props;
      Object.keys(gCfg).forEach(function(k) {
        h += self.ctrl(k, gCfg[k], g[k], 'g')
      });
      h += '</div>';
      setTimeout(function() {
        var sw = document.getElementById('sysUnload');
        if (sw) sw.onclick = function() {
          var on = sw.classList.toggle('on');
          d.sys.unload = on;
          self.save();
          if (self.tab === 2) self.renderR()
        }
      }, 0);
      return h
    },
    icon: function(n) {
      var icons = {
        plus: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',
        trash: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>',
        text: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>',
        btn: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="8" width="18" height="8" rx="2"/></svg>',
        image: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>',
        input: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="6" width="18" height="12" rx="2"/><line x1="7" y1="12" x2="7" y2="12.01"/></svg>',
        select: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="6" width="18" height="12" rx="2"/><path d="M15 10l2 2 2-2"/></svg>',
        switch: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="1" y="7" width="22" height="10" rx="5"/><circle cx="16" cy="12" r="3"/></svg>',
        collapse: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 12h6M12 9v6"/></svg>',
        row: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="3" width="7" height="18"/><rect x="14" y="3" width="7" height="18"/></svg>',
        move: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/></svg>',
        drag: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><circle cx="9" cy="6" r="1"/><circle cx="15" cy="6" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="9" cy="18" r="1"/><circle cx="15" cy="18" r="1"/></svg>'
      };
      return icons[n] || ''
    }
  };
  (function() {
    var d = null;
    if (L.b64) {
      try {
        d = JSON.parse(LZS.d(L.b64.slice(1)));
      } catch (e) {}
    }
    if (!d || !d.pages || !d.pages.length) d = {
      global: {
        bgColor: '050505',
        defModalBg: '0d0d0d',
        defBtnBg: '166d3b',
        defTextColor: '888888',
        defBtnColor: 'ffffff'
      },
      pages: [{
        title: '对话框1',
        elements: []
      }]
    };
    E.init(d);
  })();
  window.G = {
    ready: false,
    path: [],
    items: [],
    selected: null,
    callback: null,
    dragItem: null,
    init: function() {
      var self = this;
      window.addEventListener('message', function(ev) {
        if (!ev.data || !ev.data.t) return;
        switch (ev.data.t) {
          case 'store:data':
            self.items = ev.data.items || [];
            self.ready = true;
            self.render();
            break;
          case 'store:added':
          case 'store:updated':
          case 'store:deleted':
            self.load();
            break;
        }
      });
      self.ready = true;
      document.getElementById('galModal').onclick = function(e) {
        if (e.target.id === 'galModal') self.close();
      };
      document.getElementById('galUpload').onclick = function() {
        document.getElementById('galFileInput').click();
      };
      document.getElementById('galFileInput').onchange = function() {
        var files = this.files;
        if (!files.length) return;
        self.uploadFiles(files);
        this.value = '';
      };
      document.getElementById('galAddUrl').onclick = function() {
        var url = prompt('输入图片URL');
        if (url && url.trim()) self.addUrl(url.trim());
      };
      document.getElementById('galNewFolder').onclick = function() {
        var name = prompt('文件夹名称');
        if (name && name.trim()) self.createFolder(name.trim());
      };
      document.getElementById('galConfirm').onclick = function() {
        if (self.selected && self.callback) {
          var item = self.items.find(function(i) { return i.id === self.selected; });
          if (item && item.type === 'image') self.callback(item.url);
        }
        self.close();
      };
    },
    open: function(cb) {
      this.callback = cb || null;
      this.path = [];
      this.selected = null;
      document.getElementById('galModal').classList.add('open');
      this.load();
    },
    close: function() {
      document.getElementById('galModal').classList.remove('open');
      this.callback = null;
      this.selected = null;
      var ctx = document.querySelector('.ed-gallery-ctx');
      if (ctx) ctx.remove();
    },
    load: function() {
      parent.postMessage({t: 'store:load'}, '*');
    },
    render: function() {
      var self = this;
      var parent = this.path.length ? this.path[this.path.length - 1] : null;
      var filtered = this.items.filter(function(i) { return i.parent === parent; }).sort(function(a, b) {
        if (a.type === 'folder' && b.type !== 'folder') return -1;
        if (a.type !== 'folder' && b.type === 'folder') return 1;
        var na = (a.name || a.url || '').toLowerCase(), nb = (b.name || b.url || '').toLowerCase();
        return na < nb ? -1 : na > nb ? 1 : 0;
      });
      var bread = document.getElementById('galBread');
      var bh = '<span data-p="">根目录</span>';
      var cp = [];
      this.path.forEach(function(pid) {
        cp.push(pid);
        var f = self.items.find(function(i) { return i.id === pid; });
        bh += ' / <span data-p="' + cp.join(',') + '">' + (f ? f.name : '?') + '</span>';
      });
      bread.innerHTML = bh;
      bread.querySelectorAll('span').forEach(function(sp) {
        sp.onclick = function() {
          var p = sp.dataset.p;
          self.path = p ? p.split(',').map(Number) : [];
          self.selected = null;
          self.render();
        };
        sp.ondragover = function(e) {
          e.preventDefault();
          sp.classList.add('drop-target');
        };
        sp.ondragleave = function() {
          sp.classList.remove('drop-target');
        };
        sp.ondrop = function(e) {
          e.preventDefault();
          sp.classList.remove('drop-target');
          if (!self.dragItem) return;
          var p = sp.dataset.p;
          var newParent = p ? Number(p.split(',').pop()) : null;
          self.moveItem(self.dragItem, newParent);
          self.dragItem = null;
        };
      });
      var body = document.getElementById('galBody');
      var h = '';
      filtered.forEach(function(item) {
        if (item.type === 'folder') {
          h += '<div class="ed-gallery-item folder' + (self.selected === item.id ? ' selected' : '') + '" data-id="' + item.id + '" draggable="true"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span>' + U.esc(item.name) + '</span></div>';
        } else {
          var src = item.url.indexOf('://') > -1 ? item.url.replace('https://sexyai.top/', 'https://r2.sexyai.top/') : 'https://r2.sexyai.top/' + (item.url.charAt(0) === '/' ? item.url.slice(1) : item.url);
          h += '<div class="ed-gallery-item' + (self.selected === item.id ? ' selected' : '') + '" data-id="' + item.id + '" draggable="true"><img src="' + src + '"></div>';
        }
      });
      body.innerHTML = h || '<div style="grid-column:1/-1;text-align:center;color:#666;padding:40px">空</div>';
      body.querySelectorAll('.ed-gallery-item').forEach(function(el) {
        var id = parseInt(el.dataset.id);
        var item = self.items.find(function(i) { return i.id === id; });
        el.onclick = function() {
          if (item.type === 'folder') {
            self.path.push(id);
            self.selected = null;
            self.render();
          } else {
            self.selected = id;
            body.querySelectorAll('.ed-gallery-item').forEach(function(e) { e.classList.remove('selected'); });
            el.classList.add('selected');
          }
        };
        el.ondblclick = function() {
          if (item.type === 'image' && self.callback) {
            self.callback(item.url);
            self.close();
          }
        };
        el.oncontextmenu = function(e) {
          e.preventDefault();
          self.showCtx(e.clientX, e.clientY, id);
        };
        el.ondragstart = function(e) {
          self.dragItem = id;
          e.dataTransfer.effectAllowed = 'move';
        };
        el.ondragend = function() {
          self.dragItem = null;
        };
        if (item.type === 'folder') {
          el.ondragover = function(e) {
            e.preventDefault();
            el.classList.add('drag-over');
          };
          el.ondragleave = function() {
            el.classList.remove('drag-over');
          };
          el.ondrop = function(e) {
            e.preventDefault();
            el.classList.remove('drag-over');
            if (self.dragItem && self.dragItem !== id) {
              self.moveItem(self.dragItem, id);
              self.dragItem = null;
            }
          };
        }
      });
    },
    showCtx: function(x, y, id) {
      var self = this;
      var item = this.items.find(function(i) { return i.id === id; });
      var old = document.querySelector('.ed-gallery-ctx');
      if (old) old.remove();
      var ctx = document.createElement('div');
      ctx.className = 'ed-gallery-ctx';
      ctx.style.left = x + 'px';
      ctx.style.top = y + 'px';
      var h = '';
      if (item && item.type === 'folder') h += '<div class="rename">改名</div>';
      h += '<div class="del">删除</div>';
      ctx.innerHTML = h;
      var ren = ctx.querySelector('.rename');
      if (ren) ren.onclick = function() {
        var name = prompt('文件夹名称', item.name || '');
        if (name && name.trim()) self.renameFolder(id, name.trim());
        ctx.remove();
      };
      ctx.querySelector('.del').onclick = function() {
        self.deleteItem(id);
        ctx.remove();
      };
      document.body.appendChild(ctx);
      setTimeout(function() {
        document.addEventListener('click', function rm() {
          ctx.remove();
          document.removeEventListener('click', rm);
        }, {once: true});
      }, 0);
    },
    renameFolder: function(id, name) {
      var item = this.items.find(function(i) { return i.id === id; });
      if (!item) return;
      item.name = name;
      parent.postMessage({t: 'store:put', item: item}, '*');
    },
    uploadFiles: function(files) {
      var self = this;
      var pid = this.path.length ? this.path[this.path.length - 1] : null;
      var pending = files.length;
      Array.from(files).forEach(function(f) {
        var fd = new FormData();
        fd.append('suffix', f.name.split('.').pop());
        fd.append('file', f, 'file-' + Date.now());
        fetch('https://sexyai.top/api/file/upload', {
          method: 'POST',
          body: fd
        }).then(function(r) { return r.json(); }).then(function(d) {
          if (d.data && d.data[0]) {
            self.addItem({type: 'image', url: d.data[0], parent: pid});
          }
          if (--pending === 0) self.load();
        }).catch(function() {
          if (--pending === 0) self.load();
        });
      });
    },
    addUrl: function(url) {
      var pid = this.path.length ? this.path[this.path.length - 1] : null;
      this.addItem({type: 'image', url: url, parent: pid});
      this.load();
    },
    createFolder: function(name) {
      var pid = this.path.length ? this.path[this.path.length - 1] : null;
      this.addItem({type: 'folder', name: name, parent: pid});
      this.load();
    },
    addItem: function(item) {
      parent.postMessage({t: 'store:add', item: item}, '*');
    },
    deleteItem: function(id) {
      var self = this;
      var children = this.items.filter(function(i) { return i.parent === id; });
      children.forEach(function(c) { self.deleteItem(c.id); });
      parent.postMessage({t: 'store:delete', id: id}, '*');
    },
    moveItem: function(id, newParent) {
      var item = this.items.find(function(i) { return i.id === id; });
      if (!item || item.id === newParent) return;
      item.parent = newParent;
      parent.postMessage({t: 'store:put', item: item}, '*');
    }
  };
  G.init();
</script>