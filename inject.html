<div class="iFrEdt"><img src="" onerror='
(function(c, p) {
	console.log("[Inject] 开始, once:", p.indexOf("ONCE:") === 0);
	var base = "https://raw.githubusercontent.com/Nixdorfer/mmd-iframe-template/refs/heads/main/", o, f, mH, unloaded = false;
	var once = p.indexOf("ONCE:") === 0;
	if (once) p = p.slice(5);
	console.log("[Inject] P长度:", p.length);
	c.style.position = "relative";
	var b = document.createElement("button");
	b.style.cssText = "padding:12px 24px;background:#b8860b;border:none;border-radius:8px;color:#fff;cursor:not-allowed;font-size:16px;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif";
	b.textContent = "加载中...";
	b.disabled = true;
	c.appendChild(b);

	function TA() {
		return document.querySelector(".chat .chat-bottom .uni-textarea .chat-input-scope textarea");
	}
	
	function SEND() {
		return document.querySelector(".chat .chat-bottom .uni-textarea .chat-input-scope uni-image.btn-icon");
	}

	function show() {
		o.style.display = "flex";
		f.style.opacity = "0";
		f.style.transform = "translateY(-30px)";
		setTimeout(function() {
			f.style.opacity = "1";
			f.style.transform = "translateY(0)";
		}, 10);
	}

	function hide() {
		f.style.opacity = "0";
		f.style.transform = "translateY(-30px)";
		setTimeout(function() {
			o.style.display = "none";
		}, 400);
	}

	function cleanup() {
		window.removeEventListener("message", mH);
		if (o) o.remove();
		c.remove();
	}

	function showError(msg) {
		cleanup();
		var d = document.createElement("div");
		d.className = "iFrEdt";
		d.style.cssText = "padding:16px;background:#8b0000;border:none;border-radius:8px;color:#fff;font-size:16px;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif";
		d.textContent = msg || "加载失败";
		if (c.parentNode) c.parentNode.insertBefore(d, c);
	}

	function showComplete() {
		b.remove();
		var d = document.createElement("div");
		d.style.cssText = "padding:16px;background:#166d3b;border:none;border-radius:8px;color:#fff;font-size:16px;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif";
		d.textContent = "操作已完成";
		c.appendChild(d);
	}

	function getCookie(name) {
		var m = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
		return m ? m[2] : "";
	}

	function checkConversation(roleId) {
		var rptoken = getCookie("rptoken");
		return fetch("https://sexyai.top/api/conversation2/list", {
			method: "POST",
			headers: {
				"accept": "*/*",
				"content-type": "application/json",
				"authorization": rptoken
			},
			body: JSON.stringify({roleId: roleId}),
			credentials: "include"
		}).then(function(r) { return r.json(); });
	}

	function setup(h) {
		console.log("[Inject] setup开始");
		var rId = new URLSearchParams(location.search).get("roleId") || "";
		var pStr = JSON.stringify(p).replace(/</g, "\\u003c");
		console.log("[Inject] pStr长度:", pStr.length);
		var ht = h.replace("/*__INJECT__*/", "window.P=" + pStr + ";window.R=\"" + window.innerWidth + "x" + window.innerHeight + "\";window.ROLEID=\"" + rId + "\";");
		console.log("[Inject] ht长度:", ht.length);
		o = document.createElement("div");
		o.style.cssText = "position:fixed;top:0;left:0;width:100vw;height:100vh;background:#242424;z-index:99999;display:none;align-items:center;justify-content:center";
		f = document.createElement("iframe");
		f.style.cssText = "width:100vw;height:100vh;border:none;opacity:0;transform:translateY(-30px);transition:opacity 0.4s,transform 0.4s";
		f.srcdoc = ht;
		o.appendChild(f);
		document.body.appendChild(o);
		console.log("[Inject] iframe已添加到DOM");

		var sH = window.initStore ? window.initStore(f) : null;

		mH = function(ev) {
			if (!ev.data || !ev.data.t) return;
			var t = ev.data.t;
			var a, btn;

			if (t === "input") {
				a = TA();
				if (a) {
					a.focus();
					a.value += ev.data.msg || "";
					a.dispatchEvent(new Event("input", {bubbles: true}));
				}
			}
			else if (t === "clear") {
				a = TA();
				if (a) {
					a.focus();
					a.value = "";
					a.dispatchEvent(new Event("input", {bubbles: true}));
				}
			}
			else if (t === "set") {
				a = TA();
				if (a) {
					a.focus();
					a.value = ev.data.msg || "";
					a.dispatchEvent(new Event("input", {bubbles: true}));
				}
			}
			else if (t === "send") {
				btn = SEND();
				if (btn) btn.click();
			}
			else if (t === "done") {
				if (unloaded) return;
				cleanup();
			}
			else if (t === "hide") {
				if (unloaded) return;
				hide();
			}
			else if (t === "show") {
				if (unloaded) return;
				show();
			}
			else if (t === "unload") {
				unloaded = true;
				var chatBottom = document.querySelector(".chat .chat-bottom");
				document.body.innerHTML = "";
				if (chatBottom) document.body.appendChild(chatBottom);
				f.style.cssText = "width:100vw;height:100vh;border:none;position:fixed;top:0;left:0;z-index:99999";
				document.body.appendChild(f);
			}
			else if (t === "error") {
				showError(ev.data.msg);
			}
			else if (sH) {
				sH(ev);
			}
		};

		window.addEventListener("message", mH);
		b.onclick = show;
		console.log("[Inject] 调用show");
		show();
	}

	function ready(r) {
		console.log("[Inject] ready, 设置按钮");
		b.disabled = false;
		b.style.background = "#166d3b";
		b.style.cursor = "pointer";
		b.textContent = "打开";
		if (r[1]) new Function(r[1])();
		console.log("[Inject] 调用setup");
		setup(r[0]);
	}

	console.log("[Inject] 开始加载资源");
	Promise.all([
		fetch(base + "loader/loader.html").then(function(r) { console.log("[Inject] loader状态:", r.status); return r.ok ? r.text() : Promise.reject(); }),
		fetch(base + "library/store.js").then(function(r) { console.log("[Inject] store状态:", r.status); return r.ok ? r.text() : ""; })
	]).then(function(r) {
		console.log("[Inject] 资源加载完成, loader长度:", r[0].length);
		if (once) {
			var roleId = new URLSearchParams(location.search).get("roleId") || "";
			console.log("[Inject] ONCE模式, 检查对话, roleId:", roleId);
			checkConversation(roleId).then(function(res) {
				console.log("[Inject] 对话检查结果:", res);
				if (res.data && res.data.total !== 0) {
					console.log("[Inject] 已有对话, 显示完成");
					showComplete();
				} else {
					console.log("[Inject] 无对话, 继续");
					ready(r);
				}
			}).catch(function(e) {
				console.error("[Inject] 对话检查失败:", e);
				ready(r);
			});
		} else {
			ready(r);
		}
	}).catch(function(e) {
		console.error("[Inject] 资源加载失败:", e);
		b.disabled = false;
		b.style.background = "#8b0000";
		b.style.cursor = "pointer";
		b.textContent = "加载失败";
		b.onclick = function() { location.reload(); };
	});
})(this.closest(".iFR"), "$1")
'></div>
