<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<style>
* {
	margin: 0;
	padding: 0;
	box-sizing: border-box;
}

body {
	background: #242424;
	font-family: system-ui, sans-serif;
}
	</style>
</head>
<body>
<script>/*__INJECT__*/</script>
<script>
window.L = {
	loaded: {},
	base: "https://raw.githubusercontent.com/Nixdorfer/mmd-iframe-template/refs/heads/main/",
	edit: false,
	project: "",
	char: "",
	user: "",
	b64: "",
	roleId: window.ROLEID || "",
	res: window.R || window.innerWidth + "x" + window.innerHeight,
	platform: (function() {
		var w = window.innerWidth, h = window.innerHeight, r = w / h;
		return Math.abs(r - 16/9) < Math.abs(r - 9/19) ? "pc" : "mobile";
	})(),
	load: function(libs, cb) {
		var self = this, pending = libs.filter(function(n) { return !self.loaded[n]; });
		if (!pending.length) return cb && cb();
		var c = pending.length;
		pending.forEach(function(n) {
			self.loaded[n] = 1;
			fetch(self.base + (n === "store" || n === "util" ? "library/" : "template/modal/v2/library/") + n + ".js").then(function(r) {
				return r.text();
			}).then(function(t) {
				new Function(t)();
				if (--c === 0 && cb) cb();
			});
		});
	}
};

(function() {
	function M(t) {
		document.body.innerHTML = "<div style=\"display:flex;align-items:center;justify-content:center;height:100vh;color:#fff\">" + t + "</div>";
	}
	function E(msg) {
		M(msg);
		parent.postMessage({t: "error", msg: msg}, "*");
	}

	console.log("[Loader] 开始");
	M("加载中...");
	var p = window.P;
	console.log("[Loader] P =", p ? p.substring(0, 100) + "..." : p);
	if (!p) { E("参数为空"); return; }
	if (p.charAt(0) === "[" && p.charAt(p.length - 1) === "]") p = p.slice(1, -1);

	var m = p.match(/^(?:(EDIT):)?([^_:]+)(?:_(\d+))?:(.+)$/);
	console.log("[Loader] 匹配结果:", m ? {edit: m[1], project: m[2], major: m[3]} : null);
	if (!m) { E("格式错误"); return; }

	L.edit = !!m[1];
	L.project = m[2];
	L.paramMajor = m[3] || "";
	var params = m[4].split(";;");
	L.char = params[0] || "";
	L.user = params[1] || "";
	L.b64 = params[2] || "";
	console.log("[Loader] 项目:", L.project, "编辑:", L.edit);

	fetch(L.base + "navigator.json").then(function(r) {
		console.log("[Loader] navigator.json 状态:", r.status);
		return r.json();
	}).then(function(nav) {
		var proj = nav.projects[L.project];
		var inst = nav.instances[L.project];
		console.log("[Loader] 查找结果: proj=", !!proj, "inst=", !!inst);

		if (inst) {
			console.log("[Loader] 加载instance:", inst.index);
			if (L.edit) { E("instance不支持编辑"); return; }
			fetch(L.base + inst.index + "/index.html").then(function(r) {
				console.log("[Loader] instance状态:", r.status);
				return r.text();
			}).then(function(h) {
				console.log("[Loader] instance长度:", h.length);
				document.open();
				document.write(h);
				document.close();
			}).catch(function(e) { console.error("[Loader] instance失败:", e); E("加载失败"); });
			return;
		}

		if (!proj) { E("未找到: " + L.project); return; }

		L.version = proj.version;
		L.major = L.paramMajor || proj.version.split(".")[0];
		var templateUrl = L.base + proj.index + "/v" + L.major + "/index.html";
		console.log("[Loader] 加载模板:", templateUrl);

		fetch(templateUrl).then(function(r) {
			console.log("[Loader] 模板状态:", r.status);
			return r.text();
		}).then(function(h) {
			console.log("[Loader] 模板长度:", h.length);
			var cfg = "window.L=" + JSON.stringify({
				loaded: {},
				base: L.base,
				edit: L.edit,
				project: L.project,
				char: L.char,
				user: L.user,
				b64: L.b64,
				roleId: L.roleId,
				res: L.res,
				platform: L.platform,
				version: L.version,
				major: L.major
			}).replace(/</g, "\\u003c") + ";L.load=function(libs,cb){var self=this,pending=libs.filter(function(n){return!self.loaded[n]});if(!pending.length)return cb&&cb();var c=pending.length;pending.forEach(function(n){self.loaded[n]=1;fetch(self.base+(n===\"store\"||n===\"util\"?\"library/\":\"template/modal/v2/library/\")+n+\".js\").then(function(r){return r.text()}).then(function(t){new Function(t)();if(--c===0&&cb)cb()})})};";

			function W(e) {
				console.log("[Loader] 写入文档, editor:", e ? e.length : 0);
				var doc = h.replace("</head>", "<script>" + cfg + "<\/script></head>") + (e || "");
				document.open();
				document.write(doc);
				document.close();
				console.log("[Loader] 文档写入完成");
			}

			if (L.edit && proj.editor) {
				console.log("[Loader] 加载编辑器:", proj.editor);
				fetch(L.base + proj.editor).then(function(r) {
					console.log("[Loader] 编辑器状态:", r.status);
					return r.text();
				}).then(function(e) {
					console.log("[Loader] 编辑器长度:", e.length);
					W(e);
				}).catch(function(err) { console.error("[Loader] 编辑器失败:", err); W(); });
			} else {
				W();
			}
		}).catch(function(e) { console.error("[Loader] 模板失败:", e); E("加载失败"); });
	}).catch(function(e) { console.error("[Loader] 导航失败:", e); E("导航失败"); });
})();
</script>
</body>
</html>
