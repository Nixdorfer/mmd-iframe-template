<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<style>
* {
	margin: 0;
	padding: 0;
	box-sizing: border-box;
}

body {
	background: #242424;
	font-family: system-ui, sans-serif;
}
	</style>
</head>
<body>
<script>/*__INJECT__*/</script>
<script>
window.L = {
	loaded: {},
	base: "https://raw.githubusercontent.com/Nixdorfer/mmd-iframe-template/refs/heads/main/",
	edit: false,
	project: "",
	char: "",
	user: "",
	b64: "",
	roleId: window.ROLEID || "",
	res: window.R || window.innerWidth + "x" + window.innerHeight,
	platform: (function() {
		var w = window.innerWidth, h = window.innerHeight, r = w / h;
		return Math.abs(r - 16/9) < Math.abs(r - 9/19) ? "pc" : "mobile";
	})(),
	load: function(libs, cb) {
		var self = this, pending = libs.filter(function(n) { return !self.loaded[n]; });
		if (!pending.length) return cb && cb();
		var c = pending.length;
		pending.forEach(function(n) {
			self.loaded[n] = 1;
			fetch(self.base + (n === "store" || n === "util" ? "library/" : "template/modal/v2/library/") + n + ".js").then(function(r) {
				return r.text();
			}).then(function(t) {
				new Function(t)();
				if (--c === 0 && cb) cb();
			});
		});
	}
};

(function() {
	function M(t) {
		document.body.innerHTML = "<div style=\"display:flex;align-items:center;justify-content:center;height:100vh;color:#fff\">" + t + "</div>";
	}
	function E(msg) {
		M(msg);
		parent.postMessage({t: "error", msg: msg}, "*");
	}

	M("加载中...");
	var p = window.P;
	if (!p) { E("参数为空"); return; }
	if (p.charAt(0) === "[" && p.charAt(p.length - 1) === "]") p = p.slice(1, -1);

	var m = p.match(/^(?:(EDIT):)?([^_:]+)(?:_(\d+))?:(.+)$/);
	if (!m) { E("格式错误"); return; }

	L.edit = !!m[1];
	L.project = m[2];
	L.paramMajor = m[3] || "";
	var params = m[4].split(";;");
	L.char = params[0] || "";
	L.user = params[1] || "";
	L.b64 = params[2] || "";

	fetch(L.base + "navigator.json").then(function(r) {
		return r.json();
	}).then(function(nav) {
		var proj = nav.projects[L.project];
		var inst = nav.instances[L.project];

		if (inst) {
			if (L.edit) { E("instance不支持编辑"); return; }
			fetch(L.base + inst.index + "/index.html").then(function(r) {
				return r.text();
			}).then(function(h) {
				document.open();
				document.write("<!DOCTYPE html><html><head><meta charset=\"utf-8\"></head><body>" + h + "</body></html>");
				document.close();
			}).catch(function() { E("加载失败"); });
			return;
		}

		if (!proj) { E("未找到: " + L.project); return; }

		L.version = proj.version;
		L.major = L.paramMajor || proj.version.split(".")[0];
		var templateUrl = L.base + proj.index + "/v" + L.major + "/index.html";

		fetch(templateUrl).then(function(r) {
			return r.text();
		}).then(function(h) {
			var cfg = "window.L=" + JSON.stringify({
				loaded: {},
				base: L.base,
				edit: L.edit,
				project: L.project,
				char: L.char,
				user: L.user,
				b64: L.b64,
				roleId: L.roleId,
				res: L.res,
				platform: L.platform,
				version: L.version,
				major: L.major
			}) + ";L.load=function(libs,cb){var self=this,pending=libs.filter(function(n){return!self.loaded[n]});if(!pending.length)return cb&&cb();var c=pending.length;pending.forEach(function(n){self.loaded[n]=1;fetch(self.base+(n===\"store\"||n===\"util\"?\"library/\":\"template/modal/v2/library/\")+n+\".js\").then(function(r){return r.text()}).then(function(t){new Function(t)();if(--c===0&&cb)cb()})})};";

			function W(e) {
				document.open();
				document.write("<!DOCTYPE html><html><head><meta charset=\"utf-8\"></head><body><script>" + cfg + "<\/script>" + h + (e || "") + "</body></html>");
				document.close();
			}

			if (L.edit && proj.editor) {
				fetch(L.base + proj.editor).then(function(r) {
					return r.text();
				}).then(function(e) {
					W(e);
				}).catch(function() { W(); });
			} else {
				W();
			}
		}).catch(function() { E("加载失败"); });
	}).catch(function() { E("导航失败"); });
})();
</script>
</body>
</html>
